<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Analytics Console</title>

  <!-- External Libraries & Fonts -->
  <script src="https://cdn.tailwindcss.com/3.4.1"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Core Styles for Redesign -->
  <style>
    /* 1. COLOR AND VISUAL STYLE - Based on the new Beauty Guide */
    :root {
      /* Primary & Accent Colors */
      --primary-blue: #2563EB;     /* Deep Royal Blue for primary actions */
      --secondary-green: #059669; /* Emerald Green for accents */
      --aqua-tone: #0D9488;       /* Teal/Aqua for gradient transition */

      /* Neutral Colors */
      --background: #F8FAFC;      /* Very pale gray for main background */
      --card-background: #FFFFFF;
      --border: #E2E8F0;          /* Soft light gray for separators */
      
      /* Text Colors */
      --text-primary: #1E293B;     /* Dark charcoal for readability */
      --text-secondary: #64748B;   /* Softer gray for secondary text */
      --text-on-dark: #E2E8F0;     /* Light text for the dark sidebar */

      /* Gradients & Shadows */
      --sidebar-gradient: linear-gradient(180deg, var(--primary-blue), var(--aqua-tone), var(--secondary-green));
      --button-gradient: linear-gradient(135deg, var(--primary-blue), var(--secondary-green));
      --soft-shadow: 0 4px 14px 0 rgba(0, 0, 0, 0.05); /* Gentle, elevated shadow */
    }
    
    /* 5. FONT STYLE - POPPINS */
    body {
      background-color: var(--background);
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Custom Scrollbar for a polished look */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb {
      background: rgba(37, 99, 235, 0.3); 
      border-radius: 8px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(37, 99, 235, 0.5);
    }

    /* Main App Layout */
    .app-shell {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
      transition: grid-template-columns 0.3s ease-in-out;
    }
    .main-content-area {
      padding: 1.5rem 2rem;
      overflow-y: auto;
    }
    #pageTitle {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
    }

    /* 4. GRADIENT DESIGN FOR NAVIGATION MENU */
    .sidebar {
      background: var(--sidebar-gradient);
      display: flex;
      flex-direction: column;
      padding: 1rem;
      transition: width 0.3s ease-in-out, padding 0.3s ease-in-out;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    .brand {
      padding: 1rem 0.5rem 1.5rem 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .brand .logo {
      font-size: 2rem;
      color: white;
    }
    .brand .brand-text {
        font-weight: 700;
        color: white;
    }
    
    .nav-list {
      padding-top: 1rem;
      flex-grow: 1;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      border-radius: 12px;
      font-weight: 600;
      color: var(--text-on-dark);
      transition: all 0.3s;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      position: relative;
    }
    .nav-item i { font-size: 1.1rem; width: 20px; text-align: center; }
    .nav-item:hover {
      background-color: rgba(255, 255, 255, 0.1); /* Subtle glow on hover */
      color: white;
    }
    .nav-item.active {
      background-color: rgba(255, 255, 255, 0.15); /* Glowing effect for active tab */
      color: white;
      font-weight: 700;
    }
    
    /* Sidebar bottom button */
    #refreshBtn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        font-weight: 600;
    }
     #refreshBtn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }
    
    /* Top Bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    /* 7. CARD AND TABLE STYLES - Light, airy with soft shadows */
    .data-card {
      background: var(--card-background);
      border-radius: 1rem;
      padding: 1.5rem;
      border: none;
      box-shadow: var(--soft-shadow);
    }
    .summary-card {
      border-radius: 1rem;
      box-shadow: var(--soft-shadow);
      border: none;
      padding: 20px; text-align: center;
    }
    .summary-card h3 { font-size: 1rem; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;}
    .summary-card p { font-size: 2rem; font-weight: 700; }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
    }
    th {
      text-align: left;
      padding: 12px;
      background: #F8FAFC; /* Soft gray header */
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      text-transform: capitalize;
      position: sticky; top: 0; z-index: 5;
    }
    td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      color: var(--text-secondary);
      font-weight: 400;
    }
    td.font-medium { font-weight: 600; color: var(--text-primary); }
    tbody tr:hover td {
      background-color: #EFF6FF; /* Pale blue hover */
    }
    .data-card > div > table, table {
      border-radius: 12px;
      overflow: hidden;
    }
    
    /* 8. BUTTONS & INTERACTION STYLE */
    .btn {
      font-weight: 600;
      border-radius: 12px;
      padding: 10px 16px;
      transition: all 0.2s;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: 1px solid transparent;
    }
    .btn:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .btn-primary {
      background: var(--button-gradient);
      color: white;
      box-shadow: 0 2px 8px 0 rgba(37, 99, 235, 0.3);
    }
    .btn-secondary {
      background: white;
      border-color: var(--border);
      color: var(--text-primary);
    }
    .btn-secondary:hover { border-color: var(--primary-blue); color: var(--primary-blue); }

    input, select, textarea {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      transition: border 0.2s, box-shadow 0.2s;
      width: 100%;
      background-color: white;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }
    .search-input { position: relative; }
    .search-input i { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #9ca3af; }
    .search-input input { padding-left: 2.5rem; width: 280px; }

    /* Modals - Glass-like transparency effect */
    .modal-backdrop {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(5px);
      transition: opacity 0.3s ease;
    }
    .modal-content {
       background-color: white;
       border-radius: 1rem;
       padding: 1.5rem;
       box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
       max-height: 90vh;
       overflow-y: auto;
       transform: scale(0.95);
       opacity: 0;
       transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .modal-backdrop:not(.hidden) .modal-content {
        transform: scale(1);
        opacity: 1;
    }
    
    /* Gentle fade-in animation for content */
    .tab-content { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .app-shell { grid-template-columns: 70px 1fr; }
      .sidebar { width: 70px; padding: 1rem 0.5rem; }
      .nav-item span, .brand .brand-text { display: none; }
      .nav-item, .brand { justify-content: center; }
      .top-bar { flex-direction: column; gap: 1rem; align-items: stretch; }
      .search-input input { width: 100%; }
      body { font-size: 13px; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Original Tab Buttons (Hidden but required for original JS logic) -->
  <div id="original-tabs" class="hidden">
    <button class="tab-btn" data-tab="dashboard"></button>
    <button class="tab-btn" data-tab="all"></button>
    <button class="tab-btn" data-tab="best"></button>
    <button class="tab-btn" data-tab="favourites"></button>
    <button class="tab-btn" data-tab="insights"></button>
    <button class="tab-btn" data-tab="comparison"></button>
    <button class="tab-btn" data-tab="insight-analytics"></button>
    <button class="tab-btn" data-tab="yesterday"></button>
    <button class="tab-btn" data-tab="analytics"></button>
  </div>

  <div class="app-shell">
    <!-- 1. Sidebar Navigation -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo"><i class="fa-solid fa-chart-pie"></i></div>
        <div class="brand-text text-lg">Smart Analytics</div>
      </div>
      <nav class="nav-list">
        <button class="nav-item active" data-tab="dashboard"><i class="fa-solid fa-chart-pie"></i><span>Dashboard</span></button>
        <button class="nav-item" data-tab="all"><i class="fa-solid fa-table-list"></i><span>All Matches</span></button>
        <button class="nav-item" data-tab="best"><i class="fa-solid fa-star"></i><span>Best Predictions</span></button>
        <button class="nav-item" data-tab="favourites"><i class="fa-solid fa-heart"></i><span>Favourites</span></button>
        <button class="nav-item" data-tab="insights"><i class="fa-solid fa-lightbulb"></i><span>Insights</span></button>
        <button class="nav-item" data-tab="comparison"><i class="fa-solid fa-layer-group"></i><span>Comparison</span></button>
        <button class="nav-item" data-tab="insight-analytics"><i class="fa-solid fa-magnifying-glass-chart"></i><span>Insight Analytics</span></button>
        <button class="nav-item" data-tab="yesterday"><i class="fa-solid fa-calendar-day"></i><span>Yesterday</span></button>
        <button class="nav-item" data-tab="analytics"><i class="fa-solid fa-chart-simple"></i><span>Analytics</span></button>
      </nav>
      <div class="p-2 border-t border-[rgba(255,255,255,0.1)] mt-auto">
         <button id="refreshBtn" class="w-full btn text-sm">
            <i class="fa-solid fa-arrows-rotate"></i>
            <span>Refresh Data</span>
        </button>
      </div>
    </aside>

    <!-- 2. Main Content Area -->
    <div class="main-content-area">
      <!-- Top Bar -->
      <header class="top-bar">
        <h1 id="pageTitle" class="text-2xl font-bold">Dashboard</h1>
        <div class="flex items-center gap-4">
          <div class="search-input">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input id="searchInput" type="text" placeholder="Search match..."/>
          </div>
          <button id="dashboardMoreFiltersBtn" class="btn btn-primary">
            <i class="fa-solid fa-sliders"></i>
            <span>More Filters</span>
          </button>
        </div>
      </header>
      
      <!-- Content container for all tabs -->
      <main id="content">
        <!-- Dashboard Tab Content -->
        <div id="dashboardTab" class="tab-content space-y-6">
            <div id="dashboardCharts" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                <div class="data-card"><h2 class="text-md font-semibold text-gray-700 mb-3 flex justify-between items-center">Model 1 Overview</h2><div style="height: 300px;"><canvas id="model1PerformanceChart"></canvas></div></div>
                <div class="data-card"><h2 class="text-md font-semibold text-gray-700 mb-3 flex justify-between items-center">Model 2 Overview</h2><div style="height: 300px;"><canvas id="model2PerformanceChart"></canvas></div></div>
                <div class="data-card"><h2 class="text-md font-semibold text-gray-700 mb-3 flex justify-between items-center">Model 3 Overview</h2><div style="height: 300px;"><canvas id="model3PerformanceChart"></canvas></div></div>
                <div class="data-card"><h2 class="text-md font-semibold text-gray-700 mb-3 flex justify-between items-center">Model 4 Overview</h2><div style="height: 300px;"><canvas id="model4PerformanceChart"></canvas></div></div>
            </div>
            <div id="dashboardFilters" class="data-card">
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 items-end">
                    <div><label for="dashboardMatchDateFilter" class="block text-sm font-medium mb-1">Match Date:</label><select id="dashboardMatchDateFilter"></select></div>
                    <div><label class="block text-sm font-medium mb-1">Winning Streak:</label><div class="flex gap-2"><input type="number" id="dashboardMinWinStreak" placeholder="Min"><input type="number" id="dashboardMaxWinStreak" placeholder="Max"></div></div>
                    <div><label class="block text-sm font-medium mb-1">Losing Streak:</label><div class="flex gap-2"><input type="number" id="dashboardMinLoseStreak" placeholder="Min"><input type="number" id="dashboardMaxLoseStreak" placeholder="Max"></div></div>
                    <div class="flex items-center justify-end gap-2 col-start-auto lg:col-start-5">
                      <button id="dashboardClearFilters" class="btn btn-secondary text-sm">Clear</button>
                    </div>
                </div>
            </div>
            <div id="dashboardCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="dashboardTables" class="space-y-8">
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <div id="dashboardTable1Container"></div>
                    <div id="dashboardTable2Container"></div>
                </div>
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <div id="dashboardTable3Container"></div>
                    <div id="dashboardTable4Container"></div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab Content -->
        <div id="analyticsTab" class="tab-content hidden"><div id="analyticsCharts" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6"></div></div>
        
        <!-- Generic Main Content for other tabs -->
        <div id="mainContent" class="tab-content hidden space-y-6">
          <div id="predictionSummaryCard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
          <div id="summaryCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
          <div class="data-card">
              <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 items-end">
                  <div><label for="mainMatchDateFilter" class="block text-sm font-medium mb-1">Match Date:</label><select id="mainMatchDateFilter"></select></div>
                  <div><label for="mainModel1PredFilter" class="block text-sm font-medium mb-1">Model 1 Pred:</label><select id="mainModel1PredFilter"></select></div>
                  <div><label class="block text-sm font-medium mb-1">Prob 1 (%):</label><div class="flex gap-2"><input type="number" id="mainMinProb1" placeholder="Min"><input type="number" id="mainMaxProb1" placeholder="Max"></div></div>
                  <div><label for="mainModel2PredFilter" class="block text-sm font-medium mb-1">Model 2 Pred:</label><select id="mainModel2PredFilter"></select></div>
                  <div><label class="block text-sm font-medium mb-1">Prob 2 (%):</label><div class="flex gap-2"><input type="number" id="mainMinProb2" placeholder="Min"><input type="number" id="mainMaxProb2" placeholder="Max"></div></div>
                  <div><label for="mainModel3PredFilter" class="block text-sm font-medium mb-1">Model 3 Pred:</label><select id="mainModel3PredFilter"></select></div>
                  <div><label class="block text-sm font-medium mb-1">Prob 3 (%):</label><div class="flex gap-2"><input type="number" id="mainMinProb3" placeholder="Min"><input type="number" id="mainMaxProb3" placeholder="Max"></div></div>
                  <div class="flex items-center justify-end gap-2">
                    <button id="mainClearFilters" class="btn btn-secondary text-sm">Clear</button>
                  </div>
              </div>
          </div>
          <div class="data-card overflow-x-auto">
            <div class="overflow-x-auto">
              <table id="matchesTable">
                <thead id="tableHeaders"><tr>
                    <th data-column="star"><i class="fa-solid fa-star"></i></th><th data-column="MatchDate">Date</th><th data-column="Match">Match</th><th data-column="Model 1">Model 1 (Pred)</th><th data-column="Probability 1">Prob 1 (%)</th><th data-column="Model 2">Model 2 (Pred)</th><th data-column="Probability 2">Prob 2 (%)</th><th data-column="Predicted Odd">Predicted Odd</th><th data-column="Model 3">Model 3 (Pred)</th><th data-column="Probability 3">Prob 3 (%)</th><th data-column="Prediction">Prediction</th><th data-column="Stake">Stake</th><th data-column="Tip Probability">Tip Prob (%)</th><th data-column="Match Tip">Match Tip</th><th data-column="Result">Result</th><th>View</th>
                </tr></thead>
                <tbody id="tableBody"></tbody>
              </table>
            </div>
          </div>
          <div id="paginationControls" class="flex justify-center items-center gap-4"><button id="prevPageBtn" class="btn btn-secondary" disabled>Previous</button><span id="pageIndicator">Page 1 of 1</span><button id="nextPageBtn" class="btn btn-secondary" disabled>Next</button></div>
        </div>

        <!-- ... other tabs ... -->
        
        <div id="insightsTab" class="tab-content hidden space-y-6">
            <div id="insightsSummaryCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div class="data-card">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 items-start">
                    <div><label for="insightsMatchDateFilter" class="block text-sm font-medium mb-1">Match Date:</label><select id="insightsMatchDateFilter" multiple class="h-24"></select></div>
                    <div><label for="insightsLeagueFilter" class="block text-sm font-medium mb-1">League:</label><select id="insightsLeagueFilter" multiple class="h-24"></select></div>
                    <div><label for="insightsAnalysisFilter" class="block text-sm font-medium mb-1">Match Analysis:</label><select id="insightsAnalysisFilter" multiple class="h-24"></select></div>
                    <div><label class="block text-sm font-medium mb-1">Winning Streak:</label><div class="flex gap-2"><input type="number" id="insightsMinWinStreak" placeholder="Min"><input type="number" id="insightsMaxWinStreak" placeholder="Max"></div></div>
                    <div><label class="block text-sm font-medium mb-1">Losing Streak:</label><div class="flex gap-2"><input type="number" id="insightsMinLoseStreak" placeholder="Min"><input type="number" id="insightsMaxLoseStreak" placeholder="Max"></div></div>
                    <div class="flex items-end justify-end h-full"><button id="insightsClearFilters" class="btn btn-secondary text-sm">Clear Filters</button></div>
                </div>
            </div>
            <div class="data-card overflow-x-auto">
              <div class="overflow-x-auto">
                <table id="insightsTable">
                    <thead id="insightsTableHeaders"><tr>
                        <th data-column="star"><i class="fa-solid fa-star"></i></th><th>C</th><th data-column="MatchDate">Date</th><th data-column="Match">Match</th><th data-column="Result">Result</th><th data-column="Model 1">Model 1</th><th data-column="Probability 1">Prob 1</th><th data-column="Model 2">Model 2</th><th data-column="Probability 2">Prob 2</th><th data-column="Model 3">Model 3</th><th data-column="Probability 3">Prob 3</th><th data-column="Prediction">Prediction</th><th data-column="Stake">Stake</th><th data-column="Tip Probability">Tip Prob</th><th data-column="Match Tip">Match Tip</th><th>View</th>
                    </tr></thead><tbody id="insightsTableBody"></tbody>
                </table>
              </div>
            </div>
            <div id="insightsPaginationControls" class="flex justify-center items-center gap-4"><button id="insightsPrevPageBtn" class="btn btn-secondary" disabled>Previous</button><span id="insightsPageIndicator">Page 1 of 1</span><button id="insightsNextPageBtn" class="btn btn-secondary" disabled>Next</button></div>
        </div>
        <div id="comparisonTab" class="tab-content hidden space-y-6">
            <div id="comparisonStatsCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div class="data-card">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 items-start">
                    <div><label for="comparisonMatchDateFilter" class="block text-sm font-medium mb-1">Match Date:</label><select id="comparisonMatchDateFilter" multiple class="h-24"></select></div>
                    <div><label for="comparisonLeagueFilter" class="block text-sm font-medium mb-1">League:</label><select id="comparisonLeagueFilter" multiple class="h-24"></select></div>
                    <div><label for="comparisonAnalysisFilter" class="block text-sm font-medium mb-1">Analysis:</label><select id="comparisonAnalysisFilter" multiple class="h-24"></select></div>
                    <div><label class="block text-sm font-medium mb-1">Win Streak:</label><div class="flex gap-2"><input type="number" id="comparisonMinWinStreak" placeholder="Min"><input type="number" id="comparisonMaxWinStreak" placeholder="Max"></div></div>
                    <div><label class="block text-sm font-medium mb-1">Lose Streak:</label><div class="flex gap-2"><input type="number" id="comparisonMinLoseStreak" placeholder="Min"><input type="number" id="comparisonMaxLoseStreak" placeholder="Max"></div></div>
                    <div class="flex items-end justify-between h-full">
                      <button id="comparisonClearFilters" class="btn btn-secondary text-sm">Clear</button>
                      <button id="bookmarkBtn" class="btn btn-primary text-sm" style="background: var(--light-orange);"><i class="fa-solid fa-bookmark"></i> Bookmark</button>
                    </div>
                </div>
            </div>
            <details id="comparisonTableContainer" open class="data-card">
                <summary class="text-lg font-semibold cursor-pointer hover:text-[var(--indigo)]">Comparison Table</summary>
                <p class="text-sm text-gray-600 my-4">Select matches from the 'Insights' tab using the 'C' checkbox column to compare them here.</p>
                <div class="overflow-x-auto">
                    <table id="comparisonTable">
                        <thead id="comparisonTableHeaders"><tr>
                            <th><input type="checkbox" id="selectAllBookmark"></th><th data-column="Match">Match</th><th data-column="MatchDate">Date</th><th data-column="Prediction Model 1">Model 1</th><th data-column="Confidence Model 1">Conf 1</th><th data-column="Prediction Model 2">Model 2</th><th data-column="Confidence Model 2">Conf 2</th><th data-column="Prediction Model 3">Model 3</th><th data-column="Confidence Model 3">Conf 3</th><th data-column="Prediction">Prediction</th><th data-column="Stake">Stake</th><th data-column="Tip Probability">Tip Prob</th><th data-column="Match Tip">Match Tip</th><th data-column="Result">Result</th><th>Remove</th>
                        </tr></thead>
                        <tbody id="comparisonTableBody"></tbody>
                    </table>
                </div>
            </details>
            <div id="bookmarkSection"></div>
            <div id="comparisonAnalyticsSection" class="data-card">
              <h2 class="text-xl font-bold text-center mb-6">Comparison Analytics</h2>
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                  <div class="border rounded-lg p-4"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 1: Win %</h3><div style="height:300px"><canvas id="model1WinRateChart"></canvas></div></div>
                  <div class="border rounded-lg p-4"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 2: Win %</h3><div style="height:300px"><canvas id="model2WinRateChart"></canvas></div></div>
                  <div class="border rounded-lg p-4"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 3: Win %</h3><div style="height:300px"><canvas id="model3WinRateChart"></canvas></div></div>
              </div>
              <div class="border rounded-lg p-4"><h3 class="font-semibold text-center mb-2 text-gray-700">Wins by Probability (All Models)</h3><div style="height: 400px;"><canvas id="probabilityWinChart"></canvas></div></div>
            </div>
        </div>
        <div id="insightAnalyticsTab" class="tab-content hidden space-y-6">
            <div id="insightAnalyticsSummaryCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div class="data-card">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 items-start">
                    <div><label for="iaMatchDateFilter" class="block text-sm font-medium mb-1">Date:</label><select id="iaMatchDateFilter" multiple class="h-24"></select></div>
                    <div><label for="iaLeagueFilter" class="block text-sm font-medium mb-1">League:</label><select id="iaLeagueFilter" multiple class="h-24"></select></div>
                    <div><label for="iaAnalysisFilter" class="block text-sm font-medium mb-1">Analysis:</label><select id="iaAnalysisFilter" multiple class="h-24"></select></div>
                    <div><label class="block text-sm font-medium mb-1">Win Streak:</label><div class="flex gap-2"><input type="number" id="iaMinWinStreak" placeholder="Min"><input type="number" id="iaMaxWinStreak" placeholder="Max"></div></div>
                    <div><label class="block text-sm font-medium mb-1">Lose Streak:</label><div class="flex gap-2"><input type="number" id="iaMinLoseStreak" placeholder="Min"><input type="number" id="iaMaxLoseStreak" placeholder="Max"></div></div>
                    <div class="flex items-end justify-end h-full"><button id="iaClearFilters" class="btn btn-secondary text-sm">Clear</button></div>
                </div>
            </div>
            <div id="iaOverviewTableContainer" class="data-card"></div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="data-card"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 1: Performance</h3><div style="height:300px"><canvas id="iaModel1CatChart"></canvas></div></div>
                <div class="data-card"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 2: Performance</h3><div style="height:300px"><canvas id="iaModel2CatChart"></canvas></div></div>
                <div class="data-card"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 3: Performance</h3><div style="height:300px"><canvas id="iaModel3CatChart"></canvas></div></div>
                <div class="data-card"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 1: Wins by Prob</h3><div style="height:300px"><canvas id="iaModel1ProbChart"></canvas></div></div>
                <div class="data-card"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 2: Wins by Prob</h3><div style="height:300px"><canvas id="iaModel2ProbChart"></canvas></div></div>
                <div class="data-card"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 3: Wins by Prob</h3><div style="height:300px"><canvas id="iaModel3ProbChart"></canvas></div></div>
            </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Modals -->
  <div id="moreFiltersModal" class="fixed inset-0 hidden items-center justify-center z-50 p-4 modal-backdrop">
    <div class="modal-content w-11/12 max-w-6xl">
      <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-800">More Filters</h2><button id="closeMoreFiltersModal" class="text-gray-400 hover:text-gray-700 text-3xl leading-none">&times;</button></div>
      <div class="space-y-6">
        <!-- ... modal content ... -->
        <div><h3 class="text-lg text-gray-700 font-semibold mb-3 border-b pb-2">Predictions & Tips</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label for="mfPredictionFilter" class="block text-sm font-medium mb-1">Prediction:</label><select id="mfPredictionFilter"></select></div><div><label class="block text-sm font-medium mb-1">Stake:</label><div class="flex gap-2"><input type="number" id="mfStakeMin" placeholder="Min"><input type="number" id="mfStakeMax" placeholder="Max"></div></div><div><label class="block text-sm font-medium mb-1">Tip Probability (%):</label><div class="flex gap-2"><input type="number" id="mfTipProbMin" placeholder="Min"><input type="number" id="mfTipProbMax" placeholder="Max"></div></div><div><label for="mfMatchTipFilter" class="block text-sm font-medium mb-1">Match Tip:</label><select id="mfMatchTipFilter"></select></div></div></div>
        <div><h3 class="text-lg text-gray-700 font-semibold mb-3 border-b pb-2">Home Team Stats</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label class="block text-sm font-medium mb-1">Home Wins:</label><div class="flex gap-2"><input type="number" id="mfHomeWinsMin" placeholder="Min"><input type="number" id="mfHomeWinsMax" placeholder="Max"></div></div><div><label class="block text-sm font-medium mb-1">Home Draws:</label><div class="flex gap-2"><input type="number" id="mfHomeDrawsMin" placeholder="Min"><input type="number" id="mfHomeDrawsMax" placeholder="Max"></div></div><div><label class="block text-sm font-medium mb-1">Home Losses:</label><div class="flex gap-2"><input type="number" id="mfHomeLossesMin" placeholder="Min"><input type="number" id="mfHomeLossesMax" placeholder="Max"></div></div><div><label class="block text-sm font-medium mb-1">Home Scored:</label><div class="flex gap-2"><input type="number" id="mfHomeScoredMin" placeholder="Min"><input type="number" id="mfHomeScoredMax" placeholder="Max"></div></div><div><label class="block text-sm font-medium mb-1">Home Scored (Avg):</label><div class="flex gap-2"><input type="number" id="mfHomeScoredAvgMin" placeholder="Min"><input type="number" id="mfHomeScoredAvgMax" placeholder="Max"></div></div><div><label class="block text-sm font-medium mb-1">Home Conceded:</label><div class="flex gap-2"><input type="number" id="mfHomeConcededMin" placeholder="Min"><input type="number" id="mfHomeConcededMax" placeholder="Max"></div></div><div><label class="block text-sm font-medium mb-1">Home Conceded (Avg):</label><div class="flex gap-2"><input type="number" id="mfHomeConcededAvgMin" placeholder="Min"><input type="number" id="mfHomeConcededAvgMax" placeholder="Max"></div></div></div></div>
        <div><h3 class="text-lg text-gray-700 font-semibold mb-3 border-b pb-2">Away Team Stats</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label class="block text-sm font-medium mb-1">Away Wins:</label><div class="flex gap-2"><input type="number" id="mfAwayWinsMin" placeholder="Min"><input type="number" id="mfAwayWinsMax" placeholder="Max"></div></div><div><label class="block text-sm font-medium mb-1">Away Draws:</label><div class="flex gap-2"><input type="number" id="mfAwayDrawsMin" placeholder="Min"><input type="number" id="mfAwayDrawsMax" placeholder="Max"></div></div><div><label class="block text-sm font-medium mb-1">Away Losses:</label><div class="flex gap-2"><input type="number" id="mfAwayLossesMin" placeholder="Min"><input type="number" id="mfAwayLossesMax" placeholder="Max"></div></div><div><label class="block text-sm font-medium mb-1">Away Scored:</label><div class="flex gap-2"><input type="number" id="mfAwayScoredMin" placeholder="Min"><input type="number" id="mfAwayScoredMax" placeholder="Max"></div></div><div><label class="block text-sm font-medium mb-1">Away Scored (Avg):</label><div class="flex gap-2"><input type="number" id="mfAwayScoredAvgMin" placeholder="Min"><input type="number" id="mfAwayScoredAvgMax" placeholder="Max"></div></div><div><label class="block text-sm font-medium mb-1">Away Conceded:</label><div class="flex gap-2"><input type="number" id="mfAwayConcededMin" placeholder="Min"><input type="number" id="mfAwayConcededMax" placeholder="Max"></div></div><div><label class="block text-sm font-medium mb-1">Away Conceded (Avg):</label><div class="flex gap-2"><input type="number" id="mfAwayConcededAvgMin" placeholder="Min"><input type="number" id="mfAwayConcededAvgMax" placeholder="Max"></div></div></div></div>
        <div><h3 class="text-lg text-gray-700 font-semibold mb-3 border-b pb-2">Streaks & Analysis</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label class="block text-sm font-medium mb-1">Winning Streak:</label><div class="flex gap-2"><input type="number" id="mfWinningStreakMin" placeholder="Min"><input type="number" id="mfWinningStreakMax" placeholder="Max"></div></div><div><label class="block text-sm font-medium mb-1">Losing Streak:</label><div class="flex gap-2"><input type="number" id="mfLosingStreakMin" placeholder="Min"><input type="number" id="mfLosingStreakMax" placeholder="Max"></div></div><div><label for="mfMatchAnalysisFilter" class="block text-sm font-medium mb-1">Match Analysis:</label><select id="mfMatchAnalysisFilter"></select></div><div><label for="mfTotalGoalsPredictionFilter" class="block text-sm font-medium mb-1">Total Goals Prediction:</label><select id="mfTotalGoalsPredictionFilter"></select></div></div></div>
        <div><h3 class="text-lg text-gray-700 font-semibold mb-3 border-b pb-2">H2H & Position Stats</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label class="block text-sm font-medium mb-1">H2H Home Wins:</label><div class="flex gap-2"><input type="number" id="mfH2HHomeWinsMin" placeholder="Min"><input type="number" id="mfH2HHomeWinsMax" placeholder="Max"></div></div><div><label class="block text-sm font-medium mb-1">H2H Away Wins:</label><div class="flex gap-2"><input type="number" id="mfH2HAwayWinsMin" placeholder="Min"><input type="number" id="mfH2HAwayWinsMax" placeholder="Max"></div></div><div><label class="block text-sm font-medium mb-1">H2H Draws:</label><div class="flex gap-2"><input type="number" id="mfH2HDrawsMin" placeholder="Min"><input type="number" id="mfH2HDrawsMax" placeholder="Max"></div></div><div class="grid grid-cols-2 gap-2"><div><label class="block text-sm font-medium mb-1">Home Pos:</label><div class="flex gap-2"><input type="number" id="mfHomeTeamPositionMin" placeholder="Min"><input type="number"id="mfHomeTeamPositionMax" placeholder="Max"></div></div><div><label class="block text-sm font-medium mb-1">Away Pos:</label><div class="flex gap-2"><input type="number" id="mfAwayTeamPositionMin" placeholder="Min"><input type="number" id="mfAwayTeamPositionMax" placeholder="Max"></div></div></div></div></div>
      </div>
      <div class="mt-8 flex justify-end space-x-4"><button id="resetMoreFilters" class="btn btn-secondary">Clear</button><button id="applyMoreFilters" class="btn btn-primary">Apply Filters</button></div>
    </div>
  </div>

  <div id="modal" class="fixed inset-0 hidden items-center justify-center z-40 p-4 modal-backdrop"><div class="modal-content w-full max-w-3xl"><button id="closeModal" class="absolute top-4 right-4 text-gray-500 text-xl z-10">&times;</button><div id="modalContent"></div></div></div>
  <div id="bookmarkNameModal" class="fixed inset-0 hidden items-center justify-center z-40 p-4 modal-backdrop"><div class="modal-content w-full max-w-sm"><button id="closeBookmarkModal" class="absolute top-3 right-4 text-gray-500 text-xl z-10">&times;</button><h3 class="text-lg font-bold mb-4">Name Bookmark Group</h3><p class="text-sm text-gray-600 mb-3">Enter a name for this group of matches. If the name already exists, matches will be added to it.</p><input type="text" id="bookmarkGroupName" placeholder="e.g., Weekend Wins"><div class="mt-4 flex justify-end gap-3"><button id="cancelBookmark" class="btn btn-secondary">Cancel</button><button id="saveBookmark" class="btn btn-primary">Save</button></div></div></div>
  <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"><div id="loadingText" class="text-white text-xl animate-pulse">Loading data...</div></div>

  <!-- UI Interaction & Application Logic Script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');
        const pageTitle = document.getElementById('pageTitle');
        const originalTabButtons = document.querySelectorAll('#original-tabs .tab-btn');

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const tabName = item.dataset.tab;

                navItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                const titleSpan = item.querySelector('span');
                if (titleSpan) pageTitle.textContent = titleSpan.textContent;
                
                tabContents.forEach(content => content.classList.add('hidden'));

                let contentToShowId;
                switch(tabName) {
                    case 'dashboard': contentToShowId = 'dashboardTab'; break;
                    case 'analytics': contentToShowId = 'analyticsTab'; break;
                    case 'insights': contentToShowId = 'insightsTab'; break;
                    case 'comparison': contentToShowId = 'comparisonTab'; break;
                    case 'insight-analytics': contentToShowId = 'insightAnalyticsTab'; break;
                    default: contentToShowId = 'mainContent'; break;
                }
                const contentEl = document.getElementById(contentToShowId);
                if (contentEl) contentEl.classList.remove('hidden');

                const originalButton = Array.from(originalTabButtons).find(btn => btn.dataset.tab === tabName);
                if (originalButton) originalButton.click();
            });
        });
        
        // Modal logic
        const openModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if(modal) {
                modal.classList.add('flex');
                modal.classList.remove('hidden');
            }
        }
        const closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if(modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        document.getElementById('dashboardMoreFiltersBtn').addEventListener('click', () => openModal('moreFiltersModal'));
        document.getElementById('closeMoreFiltersModal').addEventListener('click', () => closeModal('moreFiltersModal'));
        document.getElementById('moreFiltersModal').addEventListener('click', (e) => { if(e.target.id === 'moreFiltersModal') closeModal('moreFiltersModal'); });
        
        document.getElementById('bookmarkBtn').addEventListener('click', () => { if (document.querySelectorAll('.bookmark-checkbox:checked').length > 0) openModal('bookmarkNameModal'); else alert('Please select at least one match to bookmark.'); });
        document.getElementById('closeBookmarkModal').addEventListener('click', () => closeModal('bookmarkNameModal'));
        document.getElementById('cancelBookmark').addEventListener('click', () => closeModal('bookmarkNameModal'));
        document.getElementById('bookmarkNameModal').addEventListener('click', (e) => { if(e.target.id === 'bookmarkNameModal') closeModal('bookmarkNameModal'); });
        
        document.getElementById('modal').addEventListener('click', (e) => { if(e.target.id === 'modal') closeModal('modal'); });
        document.getElementById('closeModal').addEventListener('click', () => closeModal('modal'));
    });

    // --- State & Config ---
    const DATA_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH-Uue5Ctuo4aU-4S81U9QvoXxslOq6YjKHnVkPjyOeJqci4p19cs2iZ8y5GgzsSh_vQHxPYb-gl-5/pub?gid=0&single=true&output=csv';
    let allMatches = [], filteredMatches = [], favourites = new Set(), currentTab = 'dashboard';
    let insightsMatches = [], filteredInsightsMatches = [], matchesForComparison = new Set();
    let filteredInsightAnalyticsMatches = [];
    let bookmarkedMatches = {};
    let charts = {};
    let currentPage = 1, insightsCurrentPage = 1, bookmarkPages = {};
    const rowsPerPage = 30;
    let sortConfig = { column: 'MatchDate', direction: 'desc' };
    let insightsSortConfig = { column: 'MatchDate', direction: 'desc' };
    let comparisonSortConfig = { column: 'MatchDate', direction: 'desc' };
    let filterTimeout;

    // --- Data Fetching & Processing ---
    async function fetchCsv(url) {
        const cacheBustUrl = `${url}&_=${new Date().getTime()}`;
        try {
            const response = await fetch(cacheBustUrl);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const csvText = await response.text();
            return new Promise((resolve, reject) => {
                Papa.parse(csvText, {
                    header: true, skipEmptyLines: true, transformHeader: h => h.trim(),
                    complete: results => resolve(results.data),
                    error: err => reject(new Error(`Failed to parse CSV: ${err.message}`))
                });
            });
        } catch (e) { throw new Error(`Failed to fetch CSV: ${e.message}`); }
    }

    function normalizeRows(rows) {
        return rows.filter(r => r && r.Match).map(r => {
            const row = {};
            for (const k in r) row[k.trim()] = (r[k] || '').toString().trim();
            
            row.MatchDate = row['Match Date'] || 'N/A';
            row.uniqueId = encodeURIComponent(`${row.Match}-${row.MatchDate}`);
            
            const numericKeys = [
                'Probability (%)', 'Prediction Confidence (%)', 'Winning Probability', 'Probability of 3 Goals', 
                'Winning Chance', 'Outcome Probability', 'Winning Streak', 'Losing Streak', 
                'Home Wins', 'Home Draws', 'Home Losses', 'Home Scored', 'Home Scored (Avg)', 'Home Conceded', 'Home Conceded (Avg)', 
                'Away Wins', 'Away Draws', 'Away Losses', 'Away Scored', 'Away Scored (Avg)', 'Away Conceded', 'Away Conceded (Avg)', 
                'Home Odds', 'Draw Odds', 'Away Odds',
                'Odds (Prediction)', 'Stake', 'Total Goals Prediction',
                'H2H Home Wins', 'H2H Away Wins', 'H2H Draws', 'Home Team Position', 'Away Team Position',
                'Tip Probability'
            ];
            numericKeys.forEach(key => { row[key] = parseFloat(String(row[key] || '').replace(/[^0-9.\-%]/g, '')) || 0; });

            if (row['Predicted Outcome3'] === 'Home Win') {
                row['Predicted Odd'] = row['Home Odds'];
            } else if (row['Predicted Outcome3'] === 'Away Win') {
                row['Predicted Odd'] = row['Away Odds'];
            } else if (row['Predicted Outcome3'] === 'Draw') {
                row['Predicted Odd'] = row['Draw Odds'];
            } else {
                row['Predicted Odd'] = 0;
            }
            return row;
        });
    }
    
    function showErrorOverlay(message) {
        const overlay = document.getElementById('loadingOverlay');
        const text = document.getElementById('loadingText');
        text.textContent = message;
        text.classList.remove('animate-pulse');
        overlay.classList.remove('hidden');
    }

    async function loadData() {
        document.getElementById('loadingOverlay').classList.add('flex');
        document.getElementById('loadingOverlay').classList.remove('hidden');
        document.getElementById('loadingText').textContent = 'Loading data...';
        try {
            const rawData = await fetchCsv(DATA_CSV_URL);
            allMatches = normalizeRows(rawData);
            insightsMatches = allMatches;
            filteredInsightAnalyticsMatches = allMatches;
            populateAllFilters(allMatches);
            populateDynamicFilters(allMatches);
            applyFilters();
            applyInsightsFilters();
            renderInsightAnalyticsPage(filteredInsightAnalyticsMatches);
            renderDashboard();
        } catch (err) { 
            console.error('Failed to load CSV data:', err);
            showErrorOverlay(`Failed to load data. Error: ${err.message}`);
        } finally { 
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('loadingOverlay').classList.remove('flex');
        }
    }
    
    // --- Filter Population & Logic ---
    function populateAllFilters(data) {
        const createOptions = (arr, sort = 'desc') => {
            const opts = [...new Set(arr)].filter(Boolean).sort();
            if (sort === 'numeric-asc') opts.sort((a,b) => a - b);
            else if (sort === 'numeric-desc') opts.sort((a,b) => b - a);
            else if (sort === 'asc') opts.sort();
            else opts.reverse();
            return opts;
        }
        const matchDates = createOptions(data.map(r => r.MatchDate), 'desc');
        const leagues = createOptions(data.map(r => r.League), 'asc');
        const analyses = createOptions(data.map(r => r['Match Analysis']), 'asc');
        const predictions = createOptions(data.map(r => r['Prediction']), 'asc');
        const matchTips = createOptions(data.map(r => r['Match Tip']), 'asc');

        const predictionTypes = createOptions(data.flatMap(r => [r['Predicted Outcome'], r['Predicted Outcome3'], r['Prediction Outcome1']]));
        populateSelect('mainMatchDateFilter', matchDates);
        populateSelect('dashboardMatchDateFilter', matchDates);
        populateSelect('mainModel1PredFilter', predictionTypes);
        populateSelect('mainModel2PredFilter', predictionTypes);
        populateSelect('mainModel3PredFilter', predictionTypes);
        
        populateSelect('insightsMatchDateFilter', matchDates, true);
        populateSelect('insightsLeagueFilter', leagues, true);
        populateSelect('insightsAnalysisFilter', analyses, true);
        
        populateSelect('comparisonMatchDateFilter', matchDates, true);
        populateSelect('comparisonLeagueFilter', leagues, true);
        populateSelect('comparisonAnalysisFilter', analyses, true);
        
        populateSelect('iaMatchDateFilter', matchDates, true);
        populateSelect('iaLeagueFilter', leagues, true);
        populateSelect('iaAnalysisFilter', analyses, true);
        
        populateSelect('mfPredictionFilter', predictions);
        populateSelect('mfMatchTipFilter', matchTips);
    }
    
    function populateSelect(id, options, isMulti = false) {
        const select = document.getElementById(id);
        if (!select) return;
        select.innerHTML = isMulti ? '' : '<option value="">All</option>';
        options.forEach(opt => select.add(new Option(opt, opt)));
    }

    function populateDynamicFilters(data) {
        const numericColumns = {
            'Home Wins': 'mfHomeWins', 'Home Draws': 'mfHomeDraws', 'Home Losses': 'mfHomeLosses',
            'Away Wins': 'mfAwayWins', 'Away Draws': 'mfAwayDraws', 'Away Losses': 'mfAwayLosses',
            'Home Scored': 'mfHomeScored', 'Home Scored (Avg)': 'mfHomeScoredAvg',
            'Home Conceded': 'mfHomeConceded', 'Home Conceded (Avg)': 'mfHomeConcededAvg',
            'Away Scored': 'mfAwayScored', 'Away Scored (Avg)': 'mfAwayScoredAvg',
            'Away Conceded': 'mfAwayConceded', 'Away Conceded (Avg)': 'mfAwayConcededAvg',
            'Winning Streak': 'mfWinningStreak', 'Losing Streak': 'mfLosingStreak',
            'H2H Home Wins': 'mfH2HHomeWins', 'H2H Away Wins': 'mfH2HAwayWins', 'H2H Draws': 'mfH2HDraws',
            'Home Team Position': 'mfHomeTeamPosition', 'Away Team Position': 'mfAwayTeamPosition',
            'Tip Probability': 'mfTipProb',
            'Stake': 'mfStake'
        };
        const dropdownColumns = { 'Match Analysis': 'mfMatchAnalysisFilter', 'Total Goals Prediction': 'mfTotalGoalsPredictionFilter' };

        for (const colName in numericColumns) {
            const values = data.map(row => row[colName]).filter(v => v !== null && v !== undefined && v !== '');
            if (values.length === 0) continue;
            const min = Math.min(...values);
            const max = Math.max(...values);
            const idPrefix = numericColumns[colName];
            const minEl = document.getElementById(`${idPrefix}Min`);
            const maxEl = document.getElementById(`${idPrefix}Max`);
            if (minEl) minEl.placeholder = `Min (${min})`;
            if (maxEl) maxEl.placeholder = `Max (${max})`;
        }

        for (const colName in dropdownColumns) {
            const uniqueVals = [...new Set(data.map(row => row[colName]))].filter(Boolean).sort();
            const selectId = dropdownColumns[colName];
            populateSelect(selectId, uniqueVals, false);
        }
    }


    function getSelectedOptions(id) { return Array.from(document.getElementById(id).selectedOptions).map(o => o.value); }

    function applyGenericFilters(data, prefix = '') {
        const getNum = id => parseFloat(document.getElementById(id)?.value.trim());

        const selectedDates = getSelectedOptions(`${prefix}MatchDateFilter`);
        const selectedLeagues = getSelectedOptions(`${prefix}LeagueFilter`);
        const selectedAnalyses = getSelectedOptions(`${prefix}AnalysisFilter`);
        const minWinStreak = getNum(`${prefix}MinWinStreak`);
        const maxWinStreak = getNum(`${prefix}MaxWinStreak`);
        const minLoseStreak = getNum(`${prefix}MinLoseStreak`);
        const maxLoseStreak = getNum(`${prefix}MaxLoseStreak`);

        return data.filter(r => {
            const winStreak = r['Winning Streak'];
            const loseStreak = r['Losing Streak'];
            
            return (selectedDates.length === 0 || selectedDates.includes(r.MatchDate)) &&
                   (selectedLeagues.length === 0 || selectedLeagues.includes(r.League)) &&
                   (selectedAnalyses.length === 0 || selectedAnalyses.includes(r['Match Analysis'])) &&
                   (isNaN(minWinStreak) || winStreak >= minWinStreak) &&
                   (isNaN(maxWinStreak) || winStreak <= maxWinStreak) &&
                   (isNaN(minLoseStreak) || loseStreak >= minLoseStreak) &&
                   (isNaN(maxLoseStreak) || loseStreak <= maxLoseStreak);
        });
    }

    function _getFilteredData(dataToFilter) {
        const getVal = id => document.getElementById(id)?.value.trim() || '';
        const getNum = id => parseFloat(getVal(id));

        const mf = {
            prediction: getVal('mfPredictionFilter'),
            stakeMin: getNum('mfStakeMin'), stakeMax: getNum('mfStakeMax'),
            tipProbMin: getNum('mfTipProbMin'), tipProbMax: getNum('mfTipProbMax'),
            matchTip: getVal('mfMatchTipFilter'),
            homeWinsMin: getNum('mfHomeWinsMin'), homeWinsMax: getNum('mfHomeWinsMax'),
            homeDrawsMin: getNum('mfHomeDrawsMin'), homeDrawsMax: getNum('mfHomeDrawsMax'),
            homeLossesMin: getNum('mfHomeLossesMin'), homeLossesMax: getNum('mfHomeLossesMax'),
            homeScoredMin: getNum('mfHomeScoredMin'), homeScoredMax: getNum('mfHomeScoredMax'),
            homeScoredAvgMin: getNum('mfHomeScoredAvgMin'), homeScoredAvgMax: getNum('mfHomeScoredAvgMax'),
            homeConcededMin: getNum('mfHomeConcededMin'), homeConcededMax: getNum('mfHomeConcededMax'),
            homeConcededAvgMin: getNum('mfHomeConcededAvgMin'), homeConcededAvgMax: getNum('mfHomeConcededAvgMax'),
            awayWinsMin: getNum('mfAwayWinsMin'), awayWinsMax: getNum('mfAwayWinsMax'),
            awayDrawsMin: getNum('mfAwayDrawsMin'), awayDrawsMax: getNum('mfAwayDrawsMax'),
            awayLossesMin: getNum('mfAwayLossesMin'), awayLossesMax: getNum('mfAwayLossesMax'),
            awayScoredMin: getNum('mfAwayScoredMin'), awayScoredMax: getNum('mfAwayScoredMax'),
            awayScoredAvgMin: getNum('mfAwayScoredAvgMin'), awayScoredAvgMax: getNum('mfAwayScoredAvgMax'),
            awayConcededMin: getNum('mfAwayConcededMin'), awayConcededMax: getNum('mfAwayConcededMax'),
            awayConcededAvgMin: getNum('mfAwayConcededAvgMin'), awayConcededAvgMax: getNum('mfAwayConcededAvgMax'),
            winningStreakMin: getNum('mfWinningStreakMin'), winningStreakMax: getNum('mfWinningStreakMax'),
            losingStreakMin: getNum('mfLosingStreakMin'), losingStreakMax: getNum('mfLosingStreakMax'),
            matchAnalysis: getVal('mfMatchAnalysisFilter'),
            totalGoalsPrediction: getVal('mfTotalGoalsPredictionFilter'),
            h2hHomeWinsMin: getNum('mfH2HHomeWinsMin'), h2hHomeWinsMax: getNum('mfH2HHomeWinsMax'),
            h2hAwayWinsMin: getNum('mfH2HAwayWinsMin'), h2hAwayWinsMax: getNum('mfH2HAwayWinsMax'),
            h2hDrawsMin: getNum('mfH2HDrawsMin'), h2hDrawsMax: getNum('mfH2HDrawsMax'),
            homeTeamPositionMin: getNum('mfHomeTeamPositionMin'), homeTeamPositionMax: getNum('mfHomeTeamPositionMax'),
            awayTeamPositionMin: getNum('mfAwayTeamPositionMin'), awayTeamPositionMax: getNum('mfAwayTeamPositionMax'),
        };
        
        let tabDate, model1Pred, minProb1, maxProb1, model2Pred, minProb2, maxProb2, model3Pred, minProb3, maxProb3;
        let tabMinWinStreak, tabMaxWinStreak, tabMinLoseStreak, tabMaxLoseStreak;

        if (currentTab === 'dashboard') {
            tabDate = getVal("dashboardMatchDateFilter");
            tabMinWinStreak = getNum('dashboardMinWinStreak');
            tabMaxWinStreak = getNum('dashboardMaxWinStreak');
            tabMinLoseStreak = getNum('dashboardMinLoseStreak');
            tabMaxLoseStreak = getNum('dashboardMaxLoseStreak');
        } else {
            tabDate = getVal("mainMatchDateFilter");
            model1Pred = getVal("mainModel1PredFilter"); minProb1 = getNum('mainMinProb1'); maxProb1 = getNum('mainMaxProb1');
            model2Pred = getVal("mainModel2PredFilter"); minProb2 = getNum('mainMinProb2'); maxProb2 = getNum('mainMaxProb2');
            model3Pred = getVal("mainModel3PredFilter"); minProb3 = getNum('mainMinProb3'); maxProb3 = getNum('mainMaxProb3');
        }

        let tempFiltered = dataToFilter.filter(r => {
            const checkRange = (val, min, max) => (isNaN(min) || val >= min) && (isNaN(max) || val <= max);
            
            const effectiveMinWin = Math.max(tabMinWinStreak || -Infinity, mf.winningStreakMin || -Infinity);
            const effectiveMaxWin = Math.min(tabMaxWinStreak || Infinity, mf.winningStreakMax || Infinity);
            const effectiveMinLose = Math.max(tabMinLoseStreak || -Infinity, mf.losingStreakMin || -Infinity);
            const effectiveMaxLose = Math.min(tabMaxLoseStreak || Infinity, mf.losingStreakMax || Infinity);

            return (!tabDate || r.MatchDate === tabDate) &&
                   (!model1Pred || r['Predicted Outcome'] === model1Pred) && checkRange(r['Probability (%)'], minProb1, maxProb1) &&
                   (!model2Pred || r['Predicted Outcome3'] === model2Pred) && checkRange(r['Prediction Confidence (%)'], minProb2, maxProb2) &&
                   (!model3Pred || r['Prediction Outcome1'] === model3Pred) && checkRange(r['Winning Probability'], minProb3, maxProb3) &&
                   (!mf.prediction || r['Prediction'] === mf.prediction) && checkRange(r['Stake'], mf.stakeMin, mf.stakeMax) &&
                   checkRange(r['Tip Probability'], mf.tipProbMin, mf.tipProbMax) &&
                   (!mf.matchTip || r['Match Tip'] === mf.matchTip) &&
                   checkRange(r['Home Wins'], mf.homeWinsMin, mf.homeWinsMax) && checkRange(r['Home Draws'], mf.homeDrawsMin, mf.homeDrawsMax) &&
                   checkRange(r['Home Losses'], mf.homeLossesMin, mf.homeLossesMax) && checkRange(r['Home Scored'], mf.homeScoredMin, mf.homeScoredMax) &&
                   checkRange(r['Home Scored (Avg)'], mf.homeScoredAvgMin, mf.homeScoredAvgMax) && checkRange(r['Home Conceded'], mf.homeConcededMin, mf.homeConcededMax) &&
                   checkRange(r['Home Conceded (Avg)'], mf.homeConcededAvgMin, mf.homeConcededAvgMax) && checkRange(r['Away Wins'], mf.awayWinsMin, mf.awayWinsMax) &&
                   checkRange(r['Away Draws'], mf.awayDrawsMin, mf.awayDrawsMax) && checkRange(r['Away Losses'], mf.awayLossesMin, mf.awayLossesMax) &&
                   checkRange(r['Away Scored'], mf.awayScoredMin, mf.awayScoredMax) && checkRange(r['Away Scored (Avg)'], mf.awayScoredAvgMin, mf.awayScoredAvgMax) &&
                   checkRange(r['Away Conceded'], mf.awayConcededMin, mf.awayConcededMax) && checkRange(r['Away Conceded (Avg)'], mf.awayConcededAvgMin, mf.awayConcededAvgMax) &&
                   checkRange(r['Winning Streak'], effectiveMinWin, effectiveMaxWin) && checkRange(r['Losing Streak'], effectiveMinLose, effectiveMaxLose) &&
                   (!mf.matchAnalysis || r['Match Analysis'] === mf.matchAnalysis) && (!mf.totalGoalsPrediction || r['Total Goals Prediction'] == mf.totalGoalsPrediction) &&
                   checkRange(r['H2H Home Wins'], mf.h2hHomeWinsMin, mf.h2hHomeWinsMax) && checkRange(r['H2H Away Wins'], mf.h2hAwayWinsMin, mf.h2hAwayWinsMax) &&
                   checkRange(r['H2H Draws'], mf.h2hDrawsMin, mf.h2hDrawsMax) && checkRange(r['Home Team Position'], mf.homeTeamPositionMin, mf.homeTeamPositionMax) &&
                   checkRange(r['Away Team Position'], mf.awayTeamPositionMin, mf.awayTeamPositionMax);
        });
        
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        if (q) {
            tempFiltered = tempFiltered.filter(r => (r.Match || '').toLowerCase().includes(q));
        }

        return tempFiltered;
    }

    function applyFilters(resetPage = true) {
        if (resetPage) currentPage = 1;
        
        let tempFiltered = _getFilteredData(allMatches);
        
        if (currentTab !== 'dashboard') {
            if (currentTab === 'best') {
                tempFiltered = tempFiltered.filter(r => {
                    const predConf = r['Prediction Confidence (%)'];
                    const predOdds = r['Predicted Odd'];
                    return predConf > 50 && predOdds >= 1.4 && predOdds <= 1.9;
                });
            } else if (currentTab === 'favourites') {
                tempFiltered = tempFiltered.filter(r => {
                    const m1 = r['Predicted Outcome'];
                    const m2 = r['Predicted Outcome3'];
                    const m3 = r['Prediction Outcome1'];
                    return m1 && m1 === m2 && m2 === m3;
                });
            } else if (currentTab === 'yesterday') {
                const y = new Date(); y.setDate(y.getDate() - 1);
                const yesterdayStr = y.toISOString().split('T')[0];
                tempFiltered = tempFiltered.filter(r => r.MatchDate === yesterdayStr);
            }
        }
        
        if (sortConfig.column) {
            tempFiltered.sort((a,b) => {
                let valA = a[sortConfig.column];
                let valB = b[sortConfig.column];
                if (sortConfig.column.startsWith('Probability')) {
                    const keyMap = {'Probability 1': 'Probability (%)', 'Probability 2': 'Prediction Confidence (%)', 'Probability 3': 'Winning Probability', 'Tip Probability': 'Tip Probability'};
                    valA = a[keyMap[sortConfig.column]] || 0;
                    valB = b[keyMap[sortConfig.column]] || 0;
                }
                if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        filteredMatches = tempFiltered;
        if (!['dashboard', 'analytics', 'insights', 'comparison', 'insight-analytics'].includes(currentTab)) {
            updateSummaryCards(filteredMatches);
            renderPredictionSummary(filteredMatches);
        }
        
        if (currentTab === 'analytics') renderAnalytics(filteredMatches);
        else if (currentTab === 'dashboard') renderDashboard();
        else if (!['insights', 'comparison', 'insight-analytics'].includes(currentTab)) renderPaginatedTable(filteredMatches);
    }

    function applyInsightsFilters(resetPage = true) {
        if (resetPage) insightsCurrentPage = 1;
        let tempFiltered = applyGenericFilters(insightsMatches, 'insights');
        
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        if (q) {
            tempFiltered = tempFiltered.filter(r => (r.Match || '').toLowerCase().includes(q));
        }

        if (insightsSortConfig.column) tempFiltered.sort((a,b) => (String(a[insightsSortConfig.column] || '') > String(b[insightsSortConfig.column] || '') ? 1 : -1) * (insightsSortConfig.direction === 'asc' ? 1 : -1));
        filteredInsightsMatches = tempFiltered;
        updateInsightsSummaryCards(filteredInsightsMatches);
        renderInsightsPaginatedTable(filteredInsightsMatches);
    }

    function applyInsightAnalyticsFilters() {
      filteredInsightAnalyticsMatches = applyGenericFilters(allMatches, 'ia');
      renderInsightAnalyticsPage(filteredInsightAnalyticsMatches);
    }
    
    // --- Rendering Functions ---
    function evaluatePrediction(predicted, result) {
      if (!predicted || !result || !result.includes('-')) return null;
      const scores = result.split(/[:-]/).map(s => parseInt(s.trim(), 10));
      if (scores.some(isNaN) || scores.length !== 2) return null;
      const [home, away] = scores;
      const outcome = home > away ? "Home Win" : home < away ? "Away Win" : "Draw";
      if (predicted === "Draw") return outcome === "Draw";
      if (predicted === "Home Win" || predicted === "Home") return outcome === "Home Win";
      if (predicted === "Away Win" || predicted === "Away") return outcome === "Away Win";
      return false;
    }

    const getPredictionBgClass = (isCorrect) => {
        if (isCorrect === null) return '';
        return isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
    };

    const detectOutcome = (res) => {
      if (!res || !res.includes('-')) return null;
      const scores = res.split(/[:-]/).map(Number);
      if (scores.length !== 2) return null;
      if (scores[0] > scores[1]) return 'Home';
      if (scores[0] < scores[1]) return 'Away';
      return 'Draw';
    };

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = data.length ? '' : `<tr><td colspan="16" class="text-center p-4">No matches found.</td></tr>`;
        data.forEach(row => {
            const id = row.uniqueId;
            const isCorrect1 = evaluatePrediction(row['Predicted Outcome'], row.Result);
            const isCorrect2 = evaluatePrediction(row['Predicted Outcome3'], row.Result);
            const isCorrect3 = evaluatePrediction(row['Prediction Outcome1'], row.Result);
            
            const actualOutcome = detectOutcome(row.Result);
            const prediction = row.Prediction;
            let predictionBgClass = '';
            if(actualOutcome && prediction) {
                predictionBgClass = (actualOutcome.toLowerCase() === prediction.toLowerCase()) ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            }

            const tr = document.createElement('tr');

            let starClass = 'text-slate-300';
            const m1 = row['Predicted Outcome'];
            const m2 = row['Predicted Outcome3'];
            const m3 = row['Prediction Outcome1'];
            const allModelsMatch = m1 && m1 === m2 && m2 === m3;

            if (allModelsMatch) {
                if (!favourites.has(id)) {
                    favourites.add(id);
                    localStorage.setItem('favourites', JSON.stringify([...favourites]));
                }
                starClass = evaluatePrediction(m1, row.Result) === true ? 'text-green-500' : 'text-blue-500';
            } else {
                starClass = favourites.has(id) ? 'text-amber-400' : 'text-slate-300';
            }

            tr.innerHTML = `
              <td class='text-center'><button class='fav-btn text-lg ${starClass}' data-id='${id}'><i class="fa-solid fa-star"></i></button></td>
              <td>${row.MatchDate}</td><td class='font-medium'>${row.Match}</td>
              <td class='${getPredictionBgClass(isCorrect1)}'>${row['Predicted Outcome'] || 'N/A'}</td>
              <td>${row['Probability (%)']}%</td>
              <td class='${getPredictionBgClass(isCorrect2)}'>${row['Predicted Outcome3'] || 'N/A'}</td>
              <td>${row['Prediction Confidence (%)']}%</td>
              <td class='font-semibold'>${row['Predicted Odd'] > 0 ? row['Predicted Odd'].toFixed(2) : 'N/A'}</td>
              <td class='${getPredictionBgClass(isCorrect3)}'>${row['Prediction Outcome1'] || 'N/A'}</td>
              <td>${row['Winning Probability']}%</td>
              <td class='${predictionBgClass}'>${row['Prediction'] || 'N/A'}</td>
              <td>${row['Stake'] || 'N/A'}</td>
              <td>${row['Tip Probability'] || 'N/A'}%</td>
              <td>${row['Match Tip'] || 'N/A'}</td>
              <td>${row.Result || ''}</td>
              <td><button class='view-btn btn btn-primary text-xs py-1 px-2' data-match='${encodeURIComponent(JSON.stringify(row))}'>View</button></td>`;
            tbody.appendChild(tr);
        });
    }

    function renderInsightsTable(data) {
        const tbody = document.getElementById('insightsTableBody');
        const q = document.getElementById('searchInput').value.trim();
        const emptyMessage = q ? 'No matches found for your search.' : 'No matches found.';
        tbody.innerHTML = data.length ? '' : `<tr><td colspan="16" class="text-center p-4">${emptyMessage}</td></tr>`;
        
        data.forEach(row => {
            const id = row.uniqueId;
            const tr = document.createElement('tr');
            
            const m1 = row['Predicted Outcome'];
            const m2 = row['Predicted Outcome3'];
            const m3 = row['Prediction Outcome1'];
            const allModelsMatch = m1 && m1 === m2 && m2 === m3;

            let starClass = 'text-slate-300';
            if (allModelsMatch) {
                if (!favourites.has(id)) {
                    favourites.add(id);
                    localStorage.setItem('favourites', JSON.stringify([...favourites]));
                }
                starClass = evaluatePrediction(m1, row.Result) === true ? 'text-green-500' : 'text-blue-500';
            } else {
                starClass = favourites.has(id) ? 'text-amber-400' : 'text-slate-300';
            }

            const isCorrect1 = evaluatePrediction(m1, row.Result);
            const isCorrect2 = evaluatePrediction(m2, row.Result);
            const isCorrect3 = evaluatePrediction(m3, row.Result);
            
            const actualOutcome = detectOutcome(row.Result);
            const prediction = row.Prediction;
            let predictionBgClass = '';
            if(actualOutcome && prediction) {
                predictionBgClass = (actualOutcome.toLowerCase() === prediction.toLowerCase()) ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            }

            tr.innerHTML = `
                <td class='text-center'><button class='fav-btn text-lg ${starClass}' data-id='${id}'><i class="fa-solid fa-star"></i></button></td>
                <td class='text-center'><input type="checkbox" class="compare-checkbox" data-id='${id}' ${matchesForComparison.has(id) ? 'checked' : ''}></td>
                <td>${row.MatchDate}</td>
                <td class='font-medium'>${row.Match}</td>
                <td>${row.Result || ''}</td>
                <td class='${getPredictionBgClass(isCorrect1)}'>${m1 || 'N/A'}</td>
                <td>${row['Probability (%)']}%</td>
                <td class='${getPredictionBgClass(isCorrect2)}'>${m2 || 'N/A'}</td>
                <td>${row['Prediction Confidence (%)']}%</td>
                <td class='${getPredictionBgClass(isCorrect3)}'>${m3 || 'N/A'}</td>
                <td>${row['Winning Probability']}%</td>
                <td class='${predictionBgClass}'>${row['Prediction'] || 'N/A'}</td>
                <td>${row['Stake'] || 'N/A'}</td>
                <td>${row['Tip Probability'] || 'N/A'}%</td>
                <td>${row['Match Tip'] || 'N/A'}</td>
                <td><button class='view-btn btn btn-primary text-xs py-1 px-2' data-match='${encodeURIComponent(JSON.stringify(row))}'>View</button></td>`;
            tbody.appendChild(tr);
        });
    }
    
    function renderPaginatedTable(data) {
        const start = (currentPage - 1) * rowsPerPage;
        renderTable(data.slice(start, start + rowsPerPage));
        const totalPages = Math.ceil(data.length / rowsPerPage) || 1;
        document.getElementById('pageIndicator').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prevPageBtn').disabled = currentPage === 1;
        document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
    }

     function renderInsightsPaginatedTable(data) {
        const start = (insightsCurrentPage - 1) * rowsPerPage;
        renderInsightsTable(data.slice(start, start + rowsPerPage));
        const totalPages = Math.ceil(data.length / rowsPerPage) || 1;
        document.getElementById('insightsPageIndicator').textContent = `Page ${insightsCurrentPage} of ${totalPages}`;
        document.getElementById('insightsPrevPageBtn').disabled = insightsCurrentPage === 1;
        document.getElementById('insightsNextPageBtn').disabled = insightsCurrentPage >= totalPages;
    }
    
    function updateSummaryCards(data) {
        const container = document.getElementById('summaryCards');
        if (!data || !container) return;
        const total = data.length;
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        const won1 = completed.filter(r => evaluatePrediction(r['Predicted Outcome'], r.Result)).length;
        const won2 = completed.filter(r => evaluatePrediction(r['Predicted Outcome3'], r.Result)).length;
        const won3 = completed.filter(r => evaluatePrediction(r['Prediction Outcome1'], r.Result)).length;
        
        container.innerHTML = `<div class="summary-card bg-blue-50"><h3>Total Matches</h3><p class="text-[var(--primary-blue)]">${total}</p></div><div class="summary-card bg-green-50"><h3>Model 1 Wins</h3><p class="text-[var(--secondary-green)]">${won1}</p></div><div class="summary-card bg-green-50"><h3>Model 2 Wins</h3><p class="text-[var(--secondary-green)]">${won2}</p></div><div class="summary-card bg-green-50"><h3>Model 3 Wins</h3><p class="text-[var(--secondary-green)]">${won3}</p></div>`;
    }

    function renderPredictionSummary(data) {
        const container = document.getElementById('predictionSummaryCard');
        if (!container) return;

        const completed = data.filter(r => r.Result && r.Result.includes('-') && r.Prediction);
        const totalPredictions = completed.length;
        
        let wins = 0;
        completed.forEach(row => {
            const actualOutcome = detectOutcome(row.Result);
            const prediction = row.Prediction;
            if (actualOutcome && prediction && actualOutcome.toLowerCase() === prediction.toLowerCase()) {
                wins++;
            }
        });

        const winPercentage = totalPredictions > 0 ? ((wins / totalPredictions) * 100).toFixed(1) : 0;

        container.innerHTML = `
            <div class="summary-card bg-white col-span-full">
                <h3 class="font-bold text-gray-700">Prediction Summary</h3>
                <div class="flex justify-center items-center gap-8 mt-2">
                    <div><p class="text-green-600 text-3xl">${wins}</p><p class="text-sm text-gray-600">Total Wins</p></div>
                    <div><p class="text-blue-600 text-3xl">${winPercentage}%</p><p class="text-sm text-gray-600">Winning Percentage</p></div>
                </div>
            </div>
        `;
    }

    function updateInsightsSummaryCards(data) {
        const container = document.getElementById('insightsSummaryCards');
        if (!data || !container) return;
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        if (completed.length === 0) { container.innerHTML = `<div class="summary-card bg-gray-100"><h3>Model 1 Wins</h3><p>0 (0%)</p></div><div class="summary-card bg-gray-100"><h3>Model 2 Wins</h3><p>0 (0%)</p></div><div class="summary-card bg-gray-100"><h3>Model 3 Wins</h3><p>0 (0%)</p></div>`; return; }
        const model1Wins = completed.filter(r => evaluatePrediction(r['Predicted Outcome'], r.Result)).length;
        const model2Wins = completed.filter(r => evaluatePrediction(r['Predicted Outcome3'], r.Result)).length;
        const model3Wins = completed.filter(r => evaluatePrediction(r['Prediction Outcome1'], r.Result)).length;
        container.innerHTML = `<div class="summary-card bg-green-50"><h3>Model 1 Wins</h3><p class="text-[var(--secondary-green)]">${model1Wins} (${((model1Wins / completed.length) * 100).toFixed(0)}%)</p></div><div class="summary-card bg-green-50"><h3>Model 2 Wins</h3><p class="text-[var(--secondary-green)]">${model2Wins} (${((model2Wins / completed.length) * 100).toFixed(0)}%)</p></div><div class="summary-card bg-green-50"><h3>Model 3 Wins</h3><p class="text-[var(--secondary-green)]">${model3Wins} (${((model3Wins / completed.length) * 100).toFixed(0)}%)</p></div>`;
    }
    
    function renderAnalytics(data) {
        const container = document.getElementById('analyticsCharts');
        container.innerHTML = '';
        if (!data.length) { container.innerHTML = '<p class="col-span-full text-center py-8 text-gray-500">No data available for analytics.</p>'; return; }
        const chartFields = ['Goals Analysis', 'Winning Probability', 'Probability of 3 Goals', 'Winning Chance', 'Over 3 Goals', 'Match Prediction', 'Outcome Probability', 'Total Goals Prediction'];
        chartFields.forEach(field => {
            const canvasContainer = document.createElement('div');
            canvasContainer.className = 'data-card';
            const chartId = `chart-${field.replace(/[^a-zA-Z0-9]/g, '')}`;
            canvasContainer.innerHTML = `<h3 class="font-semibold text-center mb-2 text-gray-700">${field}</h3><div style="height:300px"><canvas id="${chartId}"></canvas></div>`;
            container.appendChild(canvasContainer);
            const counts = data.reduce((acc, r) => { const val = r[field] || 'N/A'; acc[val] = (acc[val] || 0) + 1; return acc; }, {});
            createChart(chartId, 'bar', field, Object.keys(counts), Object.values(counts));
        });
    }

    function renderDashboard() {
        const completedMatches = allMatches.filter(r => r.Result && r.Result.includes('-'));
        const performanceByDate = completedMatches.reduce((acc, match) => {
            const date = match.MatchDate;
            if (!acc[date]) acc[date] = { model1: 0, model2: 0, model3: 0, model4: 0 };
            if (evaluatePrediction(match['Prediction'], match.Result)) acc[date].model1++;
            if (evaluatePrediction(match['Predicted Outcome'], match.Result)) acc[date].model2++;
            if (evaluatePrediction(match['Prediction Outcome1'], match.Result)) acc[date].model3++;
            if (evaluatePrediction(match['Predicted Outcome3'], match.Result)) acc[date].model4++;
            return acc;
        }, {});

        const dates = Object.keys(performanceByDate).sort();
        
        createChart('model1PerformanceChart', 'bar', 'Model 1 Wins', dates, dates.map(d => performanceByDate[d].model1), { backgroundColor: '#059669' });
        createChart('model2PerformanceChart', 'bar', 'Model 2 Wins', dates, dates.map(d => performanceByDate[d].model2), { backgroundColor: '#2563EB' });
        createChart('model3PerformanceChart', 'bar', 'Model 3 Wins', dates, dates.map(d => performanceByDate[d].model3), { backgroundColor: '#8B5CF6' });
        createChart('model4PerformanceChart', 'bar', 'Model 4 Wins', dates, dates.map(d => performanceByDate[d].model4), { backgroundColor: '#0D9488' });


        const container = document.getElementById('dashboardCards');
        container.innerHTML = '';
        const models = [
            { name: 'Model 1', predKey: 'Predicted Outcome' }, { name: 'Model 2', predKey: 'Predicted Outcome3' }, { name: 'Model 3', predKey: 'Prediction Outcome1' },
        ];
        
        models.forEach(model => {
            const modelMatches = allMatches.filter(r => r[model.predKey]);
            const pending = modelMatches.filter(r => !r.Result || !r.Result.includes('-')).length;
            const completed = modelMatches.filter(r => r.Result && r.Result.includes('-'));
            const wins = completed.filter(r => evaluatePrediction(r[model.predKey], r.Result)).length;
            const winPercent = completed.length > 0 ? ((wins / completed.length) * 100).toFixed(1) : 0;
            
            const card = document.createElement('div');
            card.className = 'summary-card bg-white';
            card.innerHTML = `<h3 class="font-bold">${model.name}</h3><p class="text-[var(--primary-blue)]">${wins} <span class="text-base font-normal">Wins</span></p><div class="text-sm text-gray-500 mt-2"><span>${winPercent}% Won</span> | <span>${pending} Pending</span></div>`;
            container.appendChild(card);
        });
        
        renderDashboardTables();
    }

    function renderDashboardTables() {
        const filters = {
            table1: r => r['Probability (%)'] > 58 && r['Predicted Odd'] > 1.35,
            table2: r => r['Outcome Probability'] > 58 && r['Predicted Odd'] > 1.35,
            table3: r => r['Prediction Confidence (%)'] > 58 && r['Predicted Odd'] > 1.35,
            table4: r => r['Match Tip'] === 'Home Win'
        };
        
        const filteredData1 = _getFilteredData(allMatches.filter(filters.table1));
        const filteredData2 = _getFilteredData(allMatches.filter(filters.table2));
        const filteredData3 = _getFilteredData(allMatches.filter(filters.table3));
        const filteredData4 = _getFilteredData(allMatches.filter(filters.table4));

        renderDashboardTable('dashboardTable1Container', 'Predicted Outcome', filteredData1, 'Predicted Outcome');
        renderDashboardTable('dashboardTable2Container', 'Prediction Outcome1', filteredData2, 'Prediction Outcome1');
        renderDashboardTable('dashboardTable3Container', 'Predicted Outcome3', filteredData3, 'Predicted Outcome3');
        renderDashboardTable('dashboardTable4Container', 'Match Tip', filteredData4, 'Match Tip');
    }
    
    function renderDashboardTable(containerId, title, data, valueKey) {
        const container = document.getElementById(containerId);
        let tableHTML = `<div class="data-card"><div class="flex justify-between items-center mb-2"><h3 class="font-semibold text-lg">${title}</h3></div><div class="overflow-x-auto"><table class="w-full text-xs"><thead><tr><th>Home</th><th>Away</th><th>Date</th><th>${valueKey}</th><th>Result</th><th>View</th></tr></thead><tbody>`;
        if (data.length === 0) tableHTML += `<tr><td colspan="6" class="text-center p-4 text-gray-500">No matching matches.</td></tr>`;
        else data.slice(0, 20).forEach(row => { const teams = row.Match.split(' vs '); tableHTML += `<tr><td>${teams[0] || 'N/A'}</td><td>${teams[1] || 'N/A'}</td><td>${row.MatchDate}</td><td>${row[valueKey] || 'N/A'}</td><td>${row.Result || ''}</td><td><button class='view-btn btn btn-primary text-xs py-1 px-2' data-match='${encodeURIComponent(JSON.stringify(row))}'>View</button></td></tr>`; });
        tableHTML += `</tbody></table></div></div>`;
        container.innerHTML = tableHTML;
    }

    function createChart(id, type, label, labels, data, chartOptions = {}) {
        const ctx = document.getElementById(id)?.getContext('2d');
        if (!ctx) return;
        if (charts[id]) charts[id].destroy();
        const defaultColors = ['#2563EB', '#059669', '#8B5CF6', '#0D9488', '#F97316', '#64748B'];
        const datasets = chartOptions.datasets || [{ label, data, backgroundColor: chartOptions.backgroundColor || defaultColors, borderRadius: 4 }];
        charts[id] = new Chart(ctx, { type, data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: !!chartOptions.datasets } }, scales: type === 'bar' ? { y: { beginAtZero: true, suggestedMax: chartOptions.yMax } } : {} } });
    }

    function showMatchModal(data) {
        const modalContent = document.getElementById('modalContent');
        const getStat = (key, def = 'N/A') => data[key] || def;
        const isCorrect1 = evaluatePrediction(data['Predicted Outcome'], data.Result), isCorrect2 = evaluatePrediction(data['Predicted Outcome3'], data.Result), isCorrect3 = evaluatePrediction(data['Prediction Outcome1'], data.Result);
        const getResultContent = (isCorrect) => isCorrect === null ? `<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-200 text-gray-700">Pending</span>` : isCorrect ? `<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-200 text-green-800">Correct <i class="fa-solid fa-check"></i></span>` : `<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-200 text-red-800">Incorrect <i class="fa-solid fa-times"></i></span>`;
        modalContent.innerHTML = `<div class="text-center border-b pb-4 mb-4"><h3 class="text-2xl font-bold">${getStat('Match')}</h3><p class="text-sm text-gray-500">${getStat('MatchDate')}</p><p class="text-lg font-bold mt-2">Result: ${getStat('Result', '')}</p></div><div class="space-y-4 mb-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="bg-gray-50 p-3 rounded-lg border shadow-sm"><h5 class="font-bold text-gray-700 mb-2 text-center">Home Team Stats</h5><div class="grid grid-cols-3 gap-2 text-center text-sm"><div><p class="text-xs text-gray-500">Wins</p><p class="font-semibold text-base">${getStat('Home Wins')}</p></div><div><p class="text-xs text-gray-500">Draws</p><p class="font-semibold text-base">${getStat('Home Draws')}</p></div><div><p class="text-xs text-gray-500">Losses</p><p class="font-semibold text-base">${getStat('Home Losses')}</p></div></div></div><div class="bg-gray-50 p-3 rounded-lg border shadow-sm"><h5 class="font-bold text-gray-700 mb-2 text-center">Away Team Stats</h5><div class="grid grid-cols-3 gap-2 text-center text-sm"><div><p class="text-xs text-gray-500">Wins</p><p class="font-semibold text-base">${getStat('Away Wins')}</p></div><div><p class="text-xs text-gray-500">Draws</p><p class="font-semibold text-base">${getStat('Away Draws')}</p></div><div><p class="text-xs text-gray-500">Losses</p><p class="font-semibold text-base">${getStat('Away Losses')}</p></div></div></div></div><div class="bg-gray-50 p-3 rounded-lg border shadow-sm"><div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center text-sm"><div><p class="text-xs text-gray-500">Home Scored (Avg)</p><p class="font-semibold">${getStat('Home Scored')} (${getStat('Home Scored (Avg)')})</p></div><div><p class="text-xs text-gray-500">Home Conceded (Avg)</p><p class="font-semibold">${getStat('Home Conceded')} (${getStat('Home Conceded (Avg)')})</p></div><div><p class="text-xs text-gray-500">Away Scored (Avg)</p><p class="font-semibold">${getStat('Away Scored')} (${getStat('Away Scored (Avg)')})</p></div><div><p class="text-xs text-gray-500">Away Conceded (Avg)</p><p class="font-semibold">${getStat('Away Conceded')} (${getStat('Away Conceded (Avg)')})</p></div></div></div><div class="bg-gray-50 p-3 rounded-lg border shadow-sm"><h5 class="font-bold text-gray-700 mb-2 text-center">Odds</h5><div class="grid grid-cols-3 gap-2 text-center text-sm"><div><p class="text-xs text-gray-500">Home Odds</p><p class="font-semibold text-base">${getStat('Home Odds', 'N/A')}</p></div><div><p class="text-xs text-gray-500">Draw Odds</p><p class="font-semibold text-base">${getStat('Draw Odds', 'N/A')}</p></div><div><p class="text-xs text-gray-500">Away Odds</p><p class="font-semibold text-base">${getStat('Away Odds', 'N/A')}</p></div></div></div><div class="bg-gray-50 p-3 rounded-lg border shadow-sm"><h5 class="font-bold text-gray-700 mb-2 text-center">Head-to-Head & Standings</h5><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"><div class="text-center"><p class="text-xs text-gray-500">H2H</p><div class="grid grid-cols-3 gap-1 mt-1"><div><p class="font-semibold text-base">${getStat('H2H Home Wins')}</p><p class="text-xs">Home</p></div><div><p class="font-semibold text-base">${getStat('H2H Draws')}</p><p class="text-xs">Draws</p></div><div><p class="font-semibold text-base">${getStat('H2H Away Wins')}</p><p class="text-xs">Away</p></div></div></div><div class="text-center"><p class="text-xs text-gray-500">League Position</p><div class="grid grid-cols-2 gap-1 mt-1"><div><p class="font-semibold text-base">${getStat('Home Team Position')}</p><p class="text-xs">Home</p></div><div><p class="font-semibold text-base">${getStat('Away Team Position')}</p><p class="text-xs">Away</p></div></div></div></div></div></div><h4 class="text-lg font-semibold text-gray-800 mb-3 text-center">Model Predictions</h4><div class="bg-gray-50 rounded-xl p-4 shadow-inner space-y-2"><div class="flex justify-between items-center py-2 border-b"><span class="flex items-center gap-3 text-sm text-gray-600"><i class="fa-solid fa-bullseye w-5 text-blue-500"></i> Model 1</span><span class="font-semibold">${getStat('Predicted Outcome')} at ${getStat('Probability (%)')}%</span>${getResultContent(isCorrect1)}</div><div class="flex justify-between items-center py-2 border-b"><span class="flex items-center gap-3 text-sm text-gray-600"><i class="fa-solid fa-bullseye w-5 text-indigo-500"></i> Model 2</span><span class="font-semibold">${getStat('Predicted Outcome3')} at ${getStat('Prediction Confidence (%)')}%</span>${getResultContent(isCorrect2)}</div><div class="flex justify-between items-center py-2 border-b"><span class="flex items-center gap-3 text-sm text-gray-600"><i class="fa-solid fa-bullseye w-5 text-purple-500"></i> Model 3</span><span class="font-semibold">${getStat('Prediction Outcome1')} at ${getStat('Winning Probability')}%</span>${getResultContent(isCorrect3)}</div><div class="flex justify-between items-center py-2"><span class="flex items-center gap-3 text-sm text-gray-600"><i class="fa-solid fa-lightbulb w-5 text-yellow-500"></i> Prediction</span><span class="font-semibold">${getStat('Prediction')} (Stake: ${getStat('Stake')})</span></div></div><a href="${getStat('URL', '#')}" target="_blank" class="block text-center mt-6 text-blue-600 hover:underline">View Source <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>`;
        document.getElementById('modal').classList.add('flex');
        document.getElementById('modal').classList.remove('hidden');
    }
    
    function renderComparisonPage() {
        let currentComparisonData = allMatches.filter(m => matchesForComparison.has(m.uniqueId));
        currentComparisonData = applyGenericFilters(currentComparisonData, 'comparison');
        
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        if (q) currentComparisonData = currentComparisonData.filter(r => (r.Match || '').toLowerCase().includes(q));

        if (comparisonSortConfig.column) currentComparisonData.sort((a,b) => (String(a[comparisonSortConfig.column] || '') > String(b[comparisonSortConfig.column] || '') ? 1 : -1) * (comparisonSortConfig.direction === 'asc' ? 1 : -1));
        updateComparisonStats(currentComparisonData);
        renderComparisonTable(currentComparisonData);
        renderBookmarkSection();
        renderComparisonAnalytics(currentComparisonData);
    }

    function updateComparisonStats(data) {
        const container = document.getElementById('comparisonStatsCards');
        if (!data) return;
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        if (completed.length === 0) { container.innerHTML = `<div class="summary-card bg-gray-100"><h3>Model 1 Win %</h3><p>N/A</p></div><div class="summary-card bg-gray-100"><h3>Model 2 Win %</h3><p>N/A</p></div><div class="summary-card bg-gray-100"><h3>Model 3 Win %</h3><p>N/A</p></div>`; return; }
        const model1Wins = completed.filter(r => evaluatePrediction(r['Predicted Outcome'], r.Result)).length;
        const model2Wins = completed.filter(r => evaluatePrediction(r['Predicted Outcome3'], r.Result)).length;
        const model3Wins = completed.filter(r => evaluatePrediction(r['Prediction Outcome1'], r.Result)).length;
        container.innerHTML = `<div class="summary-card bg-blue-50"><h3>Prediction Model 1 Win %</h3><p class="text-blue-800">${((model1Wins/completed.length)*100).toFixed(0)}%</p></div><div class="summary-card bg-indigo-50"><h3>Prediction Model 2 Win %</h3><p class="text-indigo-800">${((model2Wins/completed.length)*100).toFixed(0)}%</p></div><div class="summary-card bg-purple-50"><h3>Prediction Model 3 Win %</h3><p class="text-purple-800">${((model3Wins/completed.length)*100).toFixed(0)}%</p></div>`;
    }

    function renderComparisonTable(data) {
        const table = document.getElementById('comparisonTable');
        const tbody = document.getElementById('comparisonTableBody');
        const q = document.getElementById('searchInput').value.trim();
        let emptyMessage = 'No matches selected for comparison.';
        if (matchesForComparison.size > 0 && q && data.length === 0) emptyMessage = 'No matches found for your search.';
        tbody.innerHTML = data.length ? '' : `<tr><td colspan="15" class="text-center p-4">${emptyMessage}</td></tr>`;
        
        let wins1 = 0, wins2 = 0, wins3 = 0;
        data.forEach(row => {
            const isCorrect1 = evaluatePrediction(row['Predicted Outcome'], row.Result), isCorrect2 = evaluatePrediction(row['Predicted Outcome3'], row.Result), isCorrect3 = evaluatePrediction(row['Prediction Outcome1'], row.Result);
            if (isCorrect1) wins1++; if (isCorrect2) wins2++; if (isCorrect3) wins3++;
            const actualOutcome = detectOutcome(row.Result), prediction = row.Prediction;
            let predictionBgClass = '';
            if(actualOutcome && prediction) predictionBgClass = (actualOutcome.toLowerCase() === prediction.toLowerCase()) ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="text-center"><input type="checkbox" class="bookmark-checkbox" data-id="${row.uniqueId}"></td><td class="font-medium">${row.Match}</td><td>${row.MatchDate}</td><td class="${getPredictionBgClass(isCorrect1)}">${row['Predicted Outcome']}</td><td>${row['Probability (%)']}%</td><td class="${getPredictionBgClass(isCorrect2)}">${row['Predicted Outcome3']}</td><td>${row['Prediction Confidence (%)']}%</td><td class="${getPredictionBgClass(isCorrect3)}">${row['Prediction Outcome1']}</td><td>${row['Winning Probability']}%</td><td class='${predictionBgClass}'>${row['Prediction'] || 'N/A'}</td><td>${row['Stake'] || 'N/A'}</td><td>${row['Tip Probability'] || 'N/A'}%</td><td>${row['Match Tip'] || 'N/A'}</td><td>${row.Result || ''}</td><td class="text-center"><button class="remove-comparison-btn text-red-500 hover:text-red-700 text-lg" data-id="${row.uniqueId}" title="Remove"><i class="fa-solid fa-trash-can"></i></button></td>`;
            tbody.appendChild(tr);
        });
        const existingTfoot = table.querySelector('tfoot'); if (existingTfoot) existingTfoot.remove();
        if (data.length > 0) { const tfoot = table.createTFoot(); const footerRow = tfoot.insertRow(); footerRow.className = 'bg-blue-100 font-bold'; footerRow.innerHTML = `<td class="p-2" colspan="3">Number of Wins</td><td class="text-center">${wins1}</td><td></td><td class="text-center">${wins2}</td><td></td><td class="text-center">${wins3}</td><td colspan="7"></td>`; }
    }

    function renderBookmarkSection() { 
        const container = document.getElementById('bookmarkSection');
        container.innerHTML = '';
        const groupNames = Object.keys(bookmarkedMatches);
        if (groupNames.length === 0) { container.innerHTML = `<div class="data-card mt-8"><h2 class="text-xl font-semibold">Bookmarked Matches</h2><p class="text-gray-500 mt-2">No bookmarks yet. Select matches and click 'Bookmark'.</p></div>`; return; }
        groupNames.sort().forEach(groupName => {
            const groupContainer = document.createElement('div');
            groupContainer.className = 'data-card mt-8';
            const matches = bookmarkedMatches[groupName];
            let wins1 = 0, wins2 = 0, wins3 = 0;
            matches.forEach(row => { if (evaluatePrediction(row['Predicted Outcome'], row.Result)) wins1++; if (evaluatePrediction(row['Predicted Outcome3'], row.Result)) wins2++; if (evaluatePrediction(row['Prediction Outcome1'], row.Result)) wins3++; });
            const page = bookmarkPages[groupName] || 1, totalPages = Math.ceil(matches.length / rowsPerPage) || 1, start = (page - 1) * rowsPerPage, paginatedMatches = matches.slice(start, start + rowsPerPage);
            let tableHTML = `<div class="flex justify-between items-center mb-2"><h2 class="text-xl font-semibold">Bookmarks: ${groupName} (${matches.length})</h2></div><div class="overflow-x-auto"><table><thead class="bg-yellow-100"><tr><th>Match</th><th>Date</th><th>Model 1</th><th>Conf 1</th><th>Model 2</th><th>Conf 2</th><th>Model 3</th><th>Conf 3</th><th>Result</th><th>Remove</th></tr></thead><tbody>`;
            paginatedMatches.forEach(row => { tableHTML += `<tr><td class="font-medium">${row.Match}</td><td>${row.MatchDate}</td><td class="${getPredictionBgClass(evaluatePrediction(row['Predicted Outcome'], row.Result))}">${row['Predicted Outcome']}</td><td>${row['Probability (%)']}%</td><td class="${getPredictionBgClass(evaluatePrediction(row['Predicted Outcome3'], row.Result))}">${row['Predicted Outcome3']}</td><td>${row['Prediction Confidence (%)']}%</td><td class="${getPredictionBgClass(evaluatePrediction(row['Prediction Outcome1'], row.Result))}">${row['Prediction Outcome1']}</td><td>${row['Winning Probability']}%</td><td>${row.Result || ''}</td><td class="text-center"><button class="remove-bookmark-btn text-red-500 hover:text-red-700" data-id="${row.uniqueId}" data-group="${groupName}"><i class="fa-solid fa-trash-can"></i></button></td></tr>`; });
            tableHTML += `</tbody>`;
            if (matches.length > 0) tableHTML += `<tfoot class="bg-yellow-50 font-bold"><tr><td colspan="2">Number of Wins</td><td class="text-center">${wins1}</td><td></td><td class="text-center">${wins2}</td><td></td><td class="text-center">${wins3}</td><td colspan="3"></td></tr></tfoot>`;
            tableHTML += `</table></div>`;
            let paginationHTML = `<div class="flex justify-center items-center gap-4 my-3"><button class="bookmark-prev-btn btn btn-secondary text-xs ${page === 1 ? 'opacity-50' : ''}" data-group="${groupName}" ${page === 1 ? 'disabled' : ''}>Prev</button><span>Page ${page} of ${totalPages}</span><button class="bookmark-next-btn btn btn-secondary text-xs ${page >= totalPages ? 'opacity-50' : ''}" data-group="${groupName}" ${page >= totalPages ? 'disabled' : ''}>Next</button></div>`;
            groupContainer.innerHTML = tableHTML + paginationHTML;
            container.appendChild(groupContainer);
        });
    }

    function renderComparisonAnalytics(data) { 
        const calculateWinRate = (dataset, modelPredKey, predictionType) => {
            const relevant = dataset.filter(r => r[modelPredKey] === predictionType && r.Result && r.Result.includes('-'));
            if (relevant.length === 0) return 0;
            const wins = relevant.filter(r => evaluatePrediction(r[modelPredKey], r.Result)).length;
            return (wins / relevant.length) * 100;
        };
        const predictionTypes = ['Home Win', 'Away Win', 'Draw'];
        createChart('model1WinRateChart', 'bar', 'Win %', predictionTypes, predictionTypes.map(type => calculateWinRate(data, 'Predicted Outcome', type)), { backgroundColor: '#2563EB' });
        createChart('model2WinRateChart', 'bar', 'Win %', predictionTypes, predictionTypes.map(type => calculateWinRate(data, 'Predicted Outcome3', type)), { backgroundColor: '#8B5CF6' });
        createChart('model3WinRateChart', 'bar', 'Win %', predictionTypes, predictionTypes.map(type => calculateWinRate(data, 'Prediction Outcome1', type)), { backgroundColor: '#059669' });
        
        const calculateWinsInProbRanges = (dataset, modelPredKey, modelProbKey) => {
            const wins = dataset.filter(r => evaluatePrediction(r[modelPredKey], r.Result));
            const ranges = { '0-50%': 0, '51-70%': 0, '71-100%': 0 };
            wins.forEach(win => { const prob = win[modelProbKey]; if (prob <= 50) ranges['0-50%']++; else if (prob <= 70) ranges['51-70%']++; else ranges['71-100%']++; });
            return Object.values(ranges);
        };
        const probLabels = ['0-50%', '51-70%', '71-100%'];
        const probChartData = { datasets: [ 
            { label: 'Model 1', data: calculateWinsInProbRanges(data, 'Predicted Outcome', 'Probability (%)'), backgroundColor: '#2563EB' }, 
            { label: 'Model 2', data: calculateWinsInProbRanges(data, 'Predicted Outcome3', 'Prediction Confidence (%)'), backgroundColor: '#8B5CF6' }, 
            { label: 'Model 3', data: calculateWinsInProbRanges(data, 'Prediction Outcome1', 'Winning Probability'), backgroundColor: '#059669' } 
        ] };
        createChart('probabilityWinChart', 'bar', 'Wins', probLabels, [], probChartData);
    }
    
    // --- INSIGHT ANALYTICS TAB FUNCTIONS ---
    function renderInsightAnalyticsPage(data) {
        updateInsightAnalyticsSummaryCards(data);
        renderOverviewTable(data);
        renderModelCategoryGraphs(data);
        renderProbabilityWinsGraphs(data);
    }

    function getModelStats(data) {
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        const models = [
            { name: 'Model 1', predKey: 'Predicted Outcome', wins: 0, matches: 0 },
            { name: 'Model 2', predKey: 'Predicted Outcome3', wins: 0, matches: 0 },
            { name: 'Model 3', predKey: 'Prediction Outcome1', wins: 0, matches: 0 },
        ];
        models.forEach(model => {
            const modelMatches = completed.filter(r => r[model.predKey]);
            model.matches = modelMatches.length;
            model.wins = modelMatches.filter(r => evaluatePrediction(r[model.predKey], r.Result)).length;
            model.winRate = model.matches > 0 ? (model.wins / model.matches) * 100 : 0;
        });
        return { models, totalMatches: data.length, totalCompleted: completed.length };
    }

    function updateInsightAnalyticsSummaryCards(data) {
        const container = document.getElementById('insightAnalyticsSummaryCards');
        const { models, totalMatches } = getModelStats(data);
        const totalWinRate = models.reduce((acc, m) => acc + m.winRate, 0) / models.length;
        const bestModel = models.reduce((best, current) => current.winRate > best.winRate ? current : best, models[0]);
        container.innerHTML = `<div class="summary-card bg-blue-50"><h3>Total Matches Analyzed</h3><p class="text-[var(--primary-blue)]">${totalMatches}</p></div><div class="summary-card bg-yellow-50"><h3>Avg. Win Rate</h3><p class="text-yellow-800">${totalWinRate.toFixed(1)}%</p></div><div class="summary-card bg-green-50"><h3>Best Performing Model</h3><p class="text-[var(--secondary-green)]">${bestModel.name} (${bestModel.winRate.toFixed(1)}%)</p></div>`;
    }

    function renderOverviewTable(data) {
        const container = document.getElementById('iaOverviewTableContainer');
        const categories = ['Home Win', 'Draw', 'Away Win'];
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        let tableHTML = `<h2 class="text-xl font-semibold mb-4">Model Performance Overview</h2><div class="overflow-x-auto"><table><thead><tr class="text-left"><th>Model</th><th>Category</th><th>Total Wins</th><th>Total Matches</th><th>Win Percentage</th></tr></thead><tbody>`;
        ['Model 1', 'Model 2', 'Model 3'].forEach(modelName => {
            categories.forEach(cat => {
                const predKey = modelName === 'Model 1' ? 'Predicted Outcome' : modelName === 'Model 2' ? 'Predicted Outcome3' : 'Prediction Outcome1';
                const catMatches = completed.filter(r => r[predKey] === cat);
                const totalCatMatches = catMatches.length;
                const totalCatWins = catMatches.filter(r => evaluatePrediction(r[predKey], r.Result)).length;
                const winPercent = totalCatMatches > 0 ? ((totalCatWins / totalCatMatches) * 100).toFixed(1) + '%' : 'N/A';
                tableHTML += `<tr><td>${modelName}</td><td>${cat}</td><td>${totalCatWins}</td><td>${totalCatMatches}</td><td>${winPercent}</td></tr>`;
            });
        });
        tableHTML += `</tbody></table></div>`;
        container.innerHTML = tableHTML;
    }

    function renderModelCategoryGraphs(data) {
        const categories = ['Home Win', 'Draw', 'Away Win'];
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        const calcWinRate = (predKey, cat) => {
            const catMatches = completed.filter(r => r[predKey] === cat);
            if (catMatches.length === 0) return 0;
            const wins = catMatches.filter(r => evaluatePrediction(r[predKey], r.Result)).length;
            return (wins / catMatches.length) * 100;
        };
        createChart('iaModel1CatChart', 'bar', 'Win %', categories, categories.map(cat => calcWinRate('Predicted Outcome', cat)), { yMax: 100, backgroundColor: '#2563EB' });
        createChart('iaModel2CatChart', 'bar', 'Win %', categories, categories.map(cat => calcWinRate('Predicted Outcome3', cat)), { yMax: 100, backgroundColor: '#8B5CF6' });
        createChart('iaModel3CatChart', 'bar', 'Win %', categories, categories.map(cat => calcWinRate('Prediction Outcome1', cat)), { yMax: 100, backgroundColor: '#059669' });
    }

    function renderProbabilityWinsGraphs(data) {
        const probLabels = ['0-50%', '51-70%', '71-100%'];
        const calcWinsInRanges = (predKey, probKey) => {
            const wins = data.filter(r => evaluatePrediction(r[predKey], r.Result));
            const ranges = { '0-50%': 0, '51-70%': 0, '71-100%': 0 };
            wins.forEach(win => { const prob = win[probKey]; if (prob <= 50) ranges['0-50%']++; else if (prob <= 70) ranges['51-70%']++; else ranges['71-100%']++; });
            return Object.values(ranges);
        };
        const generateChartForModel = (chartId, predKey, probKey, color) => {
            const modelData = calcWinsInRanges(predKey, probKey);
            createChart(chartId, 'bar', '# of Wins', probLabels, modelData, { backgroundColor: color });
        };
        generateChartForModel('iaModel1ProbChart', 'Predicted Outcome', 'Probability (%)', '#2563EB');
        generateChartForModel('iaModel2ProbChart', 'Predicted Outcome3', 'Prediction Confidence (%)', '#8B5CF6');
        generateChartForModel('iaModel3ProbChart', 'Prediction Outcome1', 'Winning Probability', '#059669');
    }

    // --- Setup Event Listeners ---
    function setupEventListeners() {
        document.getElementById('refreshBtn').addEventListener('click', loadData);
        
        document.querySelectorAll('#original-tabs .tab-btn').forEach(btn => btn.addEventListener('click', e => {
            currentTab = e.currentTarget.dataset.tab;
            if (currentTab === 'insights') applyInsightsFilters();
            else if (currentTab === 'comparison') renderComparisonPage();
            else if (currentTab === 'insight-analytics') applyInsightAnalyticsFilters();
            else applyFilters();
        }));

        document.getElementById('mainClearFilters').addEventListener('click', () => {
             const form = document.querySelector('#mainContent .data-card');
             form.querySelectorAll('select, input').forEach(el => { el.value = ''; });
             applyFilters();
        });

        ['insightsClearFilters', 'comparisonClearFilters', 'iaClearFilters'].forEach(id => {
            document.getElementById(id)?.addEventListener('click', (e) => {
                const form = e.target.closest('.data-card');
                form.querySelectorAll('select, input').forEach(el => {
                    if (el.type === 'number') el.value = '';
                    else if (el.multiple) Array.from(el.options).forEach(o => o.selected = false);
                    else el.value = '';
                });
                if (id.startsWith('insights')) applyInsightsFilters();
                else if (id.startsWith('comparison')) renderComparisonPage();
                else if (id.startsWith('ia')) applyInsightAnalyticsFilters();
            });
        });
        
        const mainFilterHandler = () => { clearTimeout(filterTimeout); filterTimeout = setTimeout(applyFilters, 300); };
        document.querySelectorAll('#mainContent select, #mainContent input').forEach(el => { el.addEventListener('input', mainFilterHandler); el.addEventListener('change', mainFilterHandler); });
        
        const filterHandler = (tab) => { clearTimeout(filterTimeout); filterTimeout = setTimeout(() => { if (tab === 'insights') applyInsightsFilters(); else if (tab === 'comparison') renderComparisonPage(); else if (tab === 'ia') applyInsightAnalyticsFilters(); }, 300); };
        ['insights', 'comparison', 'ia'].forEach(prefix => {
            ['MatchDateFilter', 'LeagueFilter', 'AnalysisFilter'].forEach(filter => document.getElementById(`${prefix}${filter}`)?.addEventListener('change', () => filterHandler(prefix)));
            ['MinWinStreak', 'MaxWinStreak', 'MinLoseStreak', 'MaxLoseStreak'].forEach(filter => document.getElementById(`${prefix}${filter}`)?.addEventListener('input', () => filterHandler(prefix)));
        });
        
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                switch (currentTab) {
                    case 'insights': applyInsightsFilters(); break;
                    case 'comparison': renderComparisonPage(); break;
                    case 'dashboard': renderDashboard(); break;
                    default: applyFilters(); break;
                }
            }, 300);
        });
        
        document.body.addEventListener('click', e => {
            const viewBtn = e.target.closest('.view-btn');
            if (viewBtn) showMatchModal(JSON.parse(decodeURIComponent(viewBtn.dataset.match)));
            
            const favBtn = e.target.closest('.fav-btn');
            if (favBtn) { const id = favBtn.dataset.id; if(favourites.has(id)) favourites.delete(id); else favourites.add(id); localStorage.setItem('favourites', JSON.stringify([...favourites])); if (currentTab === 'insights') applyInsightsFilters(false); else applyFilters(false); }
            
            if (e.target.matches('.compare-checkbox')) { const id = e.target.dataset.id; if (e.target.checked) matchesForComparison.add(id); else matchesForComparison.delete(id); }
            
            const removeBookmarkBtn = e.target.closest('.remove-bookmark-btn');
            if (removeBookmarkBtn) { const {id, group} = removeBookmarkBtn.dataset; bookmarkedMatches[group] = bookmarkedMatches[group].filter(m => m.uniqueId !== id); if(bookmarkedMatches[group].length === 0) delete bookmarkedMatches[group]; localStorage.setItem('bookmarkedMatches', JSON.stringify(bookmarkedMatches)); renderComparisonPage(); }
            
            const removeComparisonBtn = e.target.closest('.remove-comparison-btn');
            if (removeComparisonBtn) { const id = removeComparisonBtn.dataset.id; matchesForComparison.delete(id); renderComparisonPage(); const insightsCheckbox = document.querySelector(`#insightsTableBody .compare-checkbox[data-id='${id}']`); if (insightsCheckbox) insightsCheckbox.checked = false; }
            
            const prevBookmarkBtn = e.target.closest('.bookmark-prev-btn');
            if (prevBookmarkBtn) { const group = prevBookmarkBtn.dataset.group; if(bookmarkPages[group] > 1) bookmarkPages[group]--; renderBookmarkSection(); }

            const nextBookmarkBtn = e.target.closest('.bookmark-next-btn');
            if (nextBookmarkBtn) { const group = nextBookmarkBtn.dataset.group; const totalPages = Math.ceil((bookmarkedMatches[group] || []).length / rowsPerPage); if(!bookmarkPages[group]) bookmarkPages[group] = 1; if(bookmarkPages[group] < totalPages) bookmarkPages[group]++; renderBookmarkSection(); }
        });

        document.getElementById('tableHeaders').addEventListener('click', e => {
            const th = e.target.closest('th[data-column]');
            if(!th) return;
            const column = th.dataset.column;
            document.querySelectorAll('#tableHeaders th').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
            sortConfig.direction = (sortConfig.column === column && sortConfig.direction === 'asc') ? 'desc' : 'asc';
            sortConfig.column = column;
            th.classList.add(sortConfig.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
            applyFilters(false);
        });
        
        document.getElementById('applyMoreFilters').addEventListener('click', () => { if (currentTab === 'dashboard') renderDashboard(); else if (currentTab === 'insights') applyInsightsFilters(); else applyFilters(); document.getElementById('moreFiltersModal').classList.add('hidden'); document.getElementById('moreFiltersModal').classList.remove('flex'); });
        document.getElementById('resetMoreFilters').addEventListener('click', () => { document.getElementById('moreFiltersModal').querySelectorAll('input[type="number"], select').forEach(el => el.value = ''); if (currentTab === 'dashboard') renderDashboard(); else applyFilters(); });

        const dashboardFilterHandler = () => { clearTimeout(filterTimeout); filterTimeout = setTimeout(renderDashboard, 300); };
        ['dashboardMatchDateFilter', 'dashboardMinWinStreak', 'dashboardMaxWinStreak', 'dashboardMinLoseStreak', 'dashboardMaxLoseStreak'].forEach(id => { const el = document.getElementById(id); if (el) { el.addEventListener('input', dashboardFilterHandler); el.addEventListener('change', dashboardFilterHandler); } });
        document.getElementById('dashboardClearFilters').addEventListener('click', () => { document.getElementById('dashboardMatchDateFilter').value = ''; document.getElementById('dashboardMinWinStreak').value = ''; document.getElementById('dashboardMaxWinStreak').value = ''; document.getElementById('dashboardMinLoseStreak').value = ''; document.getElementById('dashboardMaxLoseStreak').value = ''; document.getElementById('moreFiltersModal').querySelectorAll('input[type="number"], select').forEach(el => el.value = ''); renderDashboard(); });

        ['prevPageBtn', 'nextPageBtn'].forEach(id => document.getElementById(id).addEventListener('click', e => { const totalPages = Math.ceil(filteredMatches.length/rowsPerPage); if(e.target.id==='nextPageBtn' && currentPage < totalPages) currentPage++; else if(e.target.id==='prevPageBtn' && currentPage > 1) currentPage--; renderPaginatedTable(filteredMatches); }));
        ['insightsPrevPageBtn', 'insightsNextPageBtn'].forEach(id => document.getElementById(id).addEventListener('click', e => { const totalPages = Math.ceil(filteredInsightsMatches.length/rowsPerPage); if(e.target.id==='insightsNextPageBtn' && insightsCurrentPage < totalPages) insightsCurrentPage++; else if(e.target.id==='insightsPrevPageBtn' && insightsCurrentPage > 1) insightsCurrentPage--; renderInsightsPaginatedTable(filteredInsightsMatches); }));
        
        document.getElementById('saveBookmark').addEventListener('click', () => {
            const groupName = document.getElementById('bookmarkGroupName').value.trim();
            if (!groupName) { alert('Please enter a group name.'); return; }
            if (!bookmarkedMatches[groupName]) bookmarkedMatches[groupName] = [];
            const existingIds = new Set(bookmarkedMatches[groupName].map(m => m.uniqueId));
            const selectedIds = new Set(Array.from(document.querySelectorAll('#comparisonTableBody .bookmark-checkbox:checked')).map(cb => cb.dataset.id));
            const matchesToAdd = allMatches.filter(m => selectedIds.has(m.uniqueId) && !existingIds.has(m.uniqueId));
            bookmarkedMatches[groupName].push(...matchesToAdd);
            localStorage.setItem('bookmarkedMatches', JSON.stringify(bookmarkedMatches));
            document.querySelectorAll('#comparisonTableBody .bookmark-checkbox:checked').forEach(cb => cb.checked = false);
            document.getElementById('selectAllBookmark').checked = false;
            document.getElementById('bookmarkGroupName').value = '';
            document.getElementById('bookmarkNameModal').classList.add('hidden');
            document.getElementById('bookmarkNameModal').classList.remove('flex');
            renderComparisonPage();
        });
        document.getElementById('selectAllBookmark').addEventListener('click', e => document.querySelectorAll('#comparisonTableBody .bookmark-checkbox').forEach(cb => cb.checked = e.target.checked));
    }

    // --- Initial Load ---
    window.addEventListener('load', () => {
      favourites = new Set(JSON.parse(localStorage.getItem('favourites') || '[]'));
      bookmarkedMatches = JSON.parse(localStorage.getItem('bookmarkedMatches') || '{}');
      setupEventListeners();
      loadData();
      document.querySelector('.nav-item[data-tab="dashboard"]').click();
    });
  </script>
</body>
</html>

