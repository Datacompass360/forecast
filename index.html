<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Football Predictions Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    /* Small extra styles for better presentation */
    .active { font-weight: 600; }
    .fav-btn { background: transparent; border: none; cursor: pointer; font-size: 16px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <nav class="flex justify-between items-center bg-white shadow px-6 py-3 sticky top-0 z-10">
    <div class="flex items-center gap-4">
      <h1 class="text-xl font-bold text-blue-600">⚽ Predictions Dashboard</h1>
      <button id="refreshBtn" class="text-sm px-3 py-1 bg-blue-100 text-blue-800 rounded">Refresh</button>
    </div>
    <input id="searchInput" type="text" placeholder="Search match..." class="border rounded px-3 py-1 text-sm" />
  </nav>

  <div class="tabs flex justify-center bg-blue-100 py-2 space-x-2">
    <button class="tab-btn active bg-white px-4 py-1 rounded shadow-sm" data-tab="all">All Matches</button>
    <button class="tab-btn px-4 py-1 rounded" data-tab="best">Best Predictions</button>
    <button class="tab-btn px-4 py-1 rounded" data-tab="favourites">Favourites</button>
    <button class="tab-btn px-4 py-1 rounded" data-tab="yesterday">Yesterday</button>
    <button class="tab-btn px-4 py-1 rounded" data-tab="analytics">Analytics</button>
  </div>

  <main id="content" class="p-4">
    <!-- Filters -->
    <div class="flex flex-wrap gap-4 mb-4 items-end bg-white p-3 rounded-lg shadow">
      <label class="text-sm font-medium">Winning % Min <input id="minWinProb" type="number" class="border rounded px-2 py-1 w-20 mt-1 block" step="0.01" min="0" max="1"></label>
      <label class="text-sm font-medium">Winning % Max <input id="maxWinProb" type="number" class="border rounded px-2 py-1 w-20 mt-1 block" step="0.01" min="0" max="1"></label>
      <label class="text-sm font-medium">Over 3 Goals Min <input id="minGoalsProb" type="number" class="border rounded px-2 py-1 w-20 mt-1 block" step="0.01" min="0" max="1"></label>
      <label class="text-sm font-medium">Over 3 Goals Max <input id="maxGoalsProb" type="number" class="border rounded px-2 py-1 w-20 mt-1 block" step="0.01" min="0" max="1"></label>
      <label class="text-sm font-medium">Winning Chance Min <input id="minWinChance" type="number" class="border rounded px-2 py-1 w-20 mt-1 block" step="0.01" min="0" max="1"></label>
      <label class="text-sm font-medium">Winning Chance Max <input id="maxWinChance" type="number" class="border rounded px-2 py-1 w-20 mt-1 block" step="0.01" min="0" max="1"></label>
      
      <label class="text-sm font-medium">Winning Streak ≥ <input type="number" id="minWinningStreak" class="border rounded px-2 py-1 w-20 mt-1 block" min="0"></label>
      <label class="text-sm font-medium">Losing Streak ≤ <input type="number" id="maxLosingStreak" class="border rounded px-2 py-1 w-20 mt-1 block" min="0"></label>
      <label class="text-sm font-medium">Match Analysis 
        <select id="matchAnalysis" class="border rounded px-2 py-1 mt-1 block">
          <option value="">All</option>
          <option value="Best Home Tip">Best Home Tip</option>
          <option value="Best Away Tip">Best Away Tip</option>
          <option value="Good Home Tip">Good Home Tip</option>
          <option value="Good Away Tip">Good Away Tip</option>
          <option value="Normal Tip">Normal Tip</option>
        </select>
      </label>
      <label class="text-sm font-medium">Goals Analysis 
        <select id="goalsAnalysis" class="border rounded px-2 py-1 mt-1 block">
          <option value="">All</option>
          <option value="Over 2.5 Check">Over 2.5 Check</option>
          <option value="Over 2.5 Analyze">Over 2.5 Analyze</option>
        </select>
      </label>

      <div class="flex items-center gap-2 pt-5">
        <button id="applyFilters" class="bg-blue-600 text-white px-4 py-1.5 rounded text-sm hover:bg-blue-700">Apply</button>
        <button id="clearFilters" class="bg-gray-200 text-gray-800 px-4 py-1.5 rounded text-sm hover:bg-gray-300">Clear</button>
      </div>
    </div>

    <table id="matchesTable" class="min-w-full bg-white rounded shadow overflow-hidden text-sm">
      <thead class="bg-blue-200">
        <tr>
          <th class="p-2 text-left">★</th>
          <th class="p-2 text-left">Match</th>
          <th class="p-2 text-left">League</th>
          <th class="p-2 text-left">Date</th>
          <th class="p-2 text-left">Prediction</th>
          <th class="p-2 text-left">Winning %</th>
          <th class="p-2 text-left">Over 3 Goals</th>
          <th class="p-2 text-left">Result</th>
          <th class="p-2 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <div id="analyticsTab" class="hidden mt-6">
      <h2 class="text-lg font-semibold mb-2">Analytics Overview</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-white p-4 rounded shadow">
          <canvas id="probabilityChart" class="w-full"></canvas>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-semibold mb-2">Quick KPIs</h3>
          <ul id="kpiList" class="text-sm space-y-1">
            <li>Total matches: <span id="kpiTotal">0</span></li>
            <li>Average winning probability: <span id="kpiAvgWin">0</span></li>
            <li>Percent Over 3 Goals: <span id="kpiOver3">0</span></li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-20">
    <div class="bg-white rounded-lg w-11/12 md:w-2/3 lg:w-1/2 p-6 relative max-h-screen overflow-y-auto">
      <button id="closeModal" class="absolute top-2 right-2 text-gray-600">✖</button>
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="text-white text-xl animate-pulse">Loading data...</div>
  </div>

  <script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH-Uue5Ctuo4aU-4S81U9QvoXxslOq6YjKHnVkPjyOeJqci4p19cs2iZ8y5GgzsSh_vQHxPYb-gl-5/pub?gid=0&single=true&output=csv';
    let matches = [], favourites = new Set(), currentTab = 'all', chartInstance = null;

    async function loadData() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      const tableBody = document.getElementById('tableBody');
      loadingOverlay.classList.remove('hidden');

      try {
        const res = await fetch(CSV_URL);
        if (!res.ok) {
            throw new Error(`Failed to fetch data: ${res.status} ${res.statusText}`);
        }
        const text = await res.text();
        const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
        
        if (parsed.errors.length) {
            console.error('CSV Parsing errors:', parsed.errors);
        }

        matches = parsed.data.filter(r => r.Match);
        // normalize and coerce numeric fields
        matches.forEach(r => {
          r['Winning Probability'] = parseFloat(r['Winning Probability']) || 0;
          r['Probability of 3 Goals'] = parseFloat(r['Probability of 3 Goals']) || 0;
          r['Winning Chance'] = parseFloat(r['Winning Chance']) || 0;
          r['Winning Streak'] = parseInt(r['Winning Streak']) || 0;
          r['Losing Streak'] = parseInt(r['Losing Streak']) || 0;
          r['Match Date'] = r['Match Date'] ? r['Match Date'] : r['Date'] || '';
        });
        applyFilters();
        renderChart(matches);
        renderKPIs(matches);
      } catch (err) {
        console.error('Failed to load CSV', err);
        tableBody.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-red-500">Failed to load data. Please check your network connection and the Google Sheet link.</td></tr>`;
      } finally {
        loadingOverlay.classList.add('hidden');
      }
    }

    function renderTable(data) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-gray-500">No matches found for the selected filters.</td></tr>`;
        return;
      }
      data.forEach(row => {
        const id = encodeURIComponent(`${row.Match}-${row['Match Date']}`);
        const isFav = favourites.has(id);
        
        const result = row.Result || '';
        let resultColorClass = '';
        let resultIcon = '';

        if (result && row.Prediction) {
          const scores = result.match(/(\d+)\s*[:-–]\s*(\d+)/);
          if (scores) {
            const homeGoals = parseInt(scores[1], 10);
            const awayGoals = parseInt(scores[2], 10);

            if (!isNaN(homeGoals) && !isNaN(awayGoals)) {
              let actualOutcome = '';
              if (homeGoals > awayGoals) actualOutcome = 'Home';
              else if (homeGoals < awayGoals) actualOutcome = 'Away';
              else actualOutcome = 'Draw';

              const pred = (row.Prediction || '').toLowerCase();
              const isCorrect =
                (actualOutcome === 'Home' && pred.includes('home')) ||
                (actualOutcome === 'Away' && pred.includes('away')) ||
                (actualOutcome === 'Draw' && pred.includes('draw'));
              
              resultColorClass = isCorrect ? 'bg-green-100' : 'bg-red-100';
              resultIcon = isCorrect ? `<span class='text-green-600'>✔</span>` : `<span class='text-red-600'>✖</span>`;
            }
          }
        }

        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-gray-50';
        tr.innerHTML = `
          <td class='p-2 text-center'><button class='fav-btn ${isFav ? 'text-yellow-400' : 'text-gray-400'}' data-id='${id}' title='Toggle favourite'>★</button></td>
          <td class='p-2'>${row.Match}</td>
          <td class='p-2'>${row.League}</td>
          <td class='p-2'>${row['Match Date']}</td>
          <td class='p-2'>${row.Prediction}</td>
          <td class='p-2'>${(row['Winning Probability']*100).toFixed(0)}%</td>
          <td class='p-2'>${row['Over 3 Goals'] || ''}</td>
          <td class='p-2 ${resultColorClass}'>${result || '—'} ${resultIcon}</td>
          <td class='p-2'>
            <button class='view-btn text-blue-600 underline text-xs' data-match='${encodeURIComponent(JSON.stringify(row))}'>View</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function applyFilters() {
      const minWin = parseFloat(document.getElementById('minWinProb').value) || 0;
      const maxWin = parseFloat(document.getElementById('maxWinProb').value) || 1;
      const minGoals = parseFloat(document.getElementById('minGoalsProb').value) || 0;
      const maxGoals = parseFloat(document.getElementById('maxGoalsProb').value) || 1;
      const minWinChance = parseFloat(document.getElementById('minWinChance').value) || 0;
      const maxWinChance = parseFloat(document.getElementById('maxWinChance').value) || 1;
      const minWinningStreak = parseInt(document.getElementById('minWinningStreak').value) || 0;
      const maxLosingStreak = document.getElementById('maxLosingStreak').value === '' ? 1000 : parseInt(document.getElementById('maxLosingStreak').value);
      const matchAnalysis = document.getElementById('matchAnalysis').value;
      const goalsAnalysis = document.getElementById('goalsAnalysis').value;

      let filtered = matches.filter(r => {
        const probFilters = (r['Winning Probability'] >= minWin && r['Winning Probability'] <= maxWin) &&
                            (r['Probability of 3 Goals'] >= minGoals && r['Probability of 3 Goals'] <= maxGoals) &&
                            (r['Winning Chance'] >= minWinChance && r['Winning Chance'] <= maxWinChance);
        
        const streakFilters = (r['Winning Streak'] >= minWinningStreak) && (r['Losing Streak'] <= maxLosingStreak);
        
        const analysisFilters = (!matchAnalysis || r['Match Analysis'] === matchAnalysis) && 
                                (!goalsAnalysis || r['Goals Analysis'] === goalsAnalysis);
        
        return probFilters && streakFilters && analysisFilters;
      });

      if (currentTab === 'best') {
        filtered = filtered.filter(r => /best|good/i.test(r['Match Analysis'] || '') || (r['Winning Probability'] > 0.55));
      } else if (currentTab === 'favourites') {
        filtered = filtered.filter(r => favourites.has(encodeURIComponent(`${r.Match}-${r['Match Date']}`)));
      } else if (currentTab === 'yesterday') {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yStr = yesterday.toISOString().split('T')[0];
        filtered = filtered.filter(r => (r['Match Date'] || '').startsWith(yStr));
      }

      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      if (q) {
        filtered = filtered.filter(r => (r.Match + ' ' + r['Home Team'] + ' ' + r['Away Team'] + ' ' + (r.League||'')).toLowerCase().includes(q));
      }

      renderTable(filtered);
    }

    function clearFilters(){
      document.getElementById('minWinProb').value = '';
      document.getElementById('maxWinProb').value = '';
      document.getElementById('minGoalsProb').value = '';
      document.getElementById('maxGoalsProb').value = '';
      document.getElementById('minWinChance').value = '';
      document.getElementById('maxWinChance').value = '';
      document.getElementById('minWinningStreak').value = '';
      document.getElementById('maxLosingStreak').value = '';
      document.getElementById('matchAnalysis').value = '';
      document.getElementById('goalsAnalysis').value = '';
      document.getElementById('searchInput').value = '';
      applyFilters();
    }

    function renderChart(data) {
      const ctx = document.getElementById('probabilityChart').getContext('2d');
      const probs = data.map(r => r['Winning Probability']).filter(v => v > 0);
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: probs.map((_, i) => `Match ${i + 1}`),
          datasets: [{ 
            label: 'Winning Probability', 
            data: probs.map(p => (p*100).toFixed(0)),
            backgroundColor: 'rgba(59, 130, 246, 0.5)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 1
          }]
        },
        options: { scales: { y: { beginAtZero: true, max: 100, ticks: { callback: value => `${value}%` } } } }
      });
    }

    function renderKPIs(data){
      const dataLength = data.length || 1;
      document.getElementById('kpiTotal').textContent = data.length;
      const avg = data.reduce((s,r)=>s + r['Winning Probability'],0) / dataLength;
      document.getElementById('kpiAvgWin').textContent = (avg*100).toFixed(1) + '%';
      const over3Count = data.filter(r => (r['Over 3 Goals']||'').toLowerCase().includes('over')).length;
      document.getElementById('kpiOver3').textContent = ((over3Count/dataLength)*100).toFixed(1) + '%';
    }

    document.getElementById('applyFilters').addEventListener('click', applyFilters);
    document.getElementById('clearFilters').addEventListener('click', clearFilters);
    document.getElementById('refreshBtn').addEventListener('click', loadData);
    document.getElementById('searchInput').addEventListener('input', () => { setTimeout(applyFilters, 200); });

    document.body.addEventListener('click', e => {
      if (e.target.classList.contains('view-btn')) {
        const data = JSON.parse(decodeURIComponent(e.target.dataset.match));
        const modal = document.getElementById('modal');
        document.getElementById('modalContent').innerHTML = `
          <h3 class='text-xl font-bold mb-4 text-center'>${data.Match}</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div class="bg-gray-50 p-3 rounded-lg border">
                  <h4 class="font-semibold mb-2 text-blue-700">${data['Home Team'] || 'Home Team'} Stats</h4>
                  <ul class="text-sm space-y-1">
                  <li>Wins: <strong>${data['Home Wins'] || 'N/A'}</strong></li>
                  <li>Draws: <strong>${data['Home Draws'] || 'N/A'}</strong></li>
                  <li>Losses: <strong>${data['Home Losses'] || 'N/A'}</strong></li>
                  <li>Scored: <strong>${data['Home Team Scored'] || 'N/A'}</strong></li>
                  <li>Avg Scored: <strong>${data['Home Avg Scored'] || 'N/A'}</strong></li>
                  <li>Conceded: <strong>${data['Home Conceded'] || 'N/A'}</strong></li>
                  <li>Avg Conceded: <strong>${data['Home Avg Conceded'] || 'N/A'}</strong></li>
                  </ul>
              </div>
              <div class="bg-gray-50 p-3 rounded-lg border">
                  <h4 class="font-semibold mb-2 text-red-700">${data['Away Team'] || 'Away Team'} Stats</h4>
                  <ul class="text-sm space-y-1">
                  <li>Wins: <strong>${data['Away Wins'] || 'N/A'}</strong></li>
                  <li>Draws: <strong>${data['Away Draws'] || 'N/A'}</strong></li>
                  <li>Losses: <strong>${data['Away Losses'] || 'N/A'}</strong></li>
                  <li>Scored: <strong>${data['Away Team Scored'] || 'N/A'}</strong></li>
                  <li>Avg Scored: <strong>${data['Away Avg Scored'] || 'N/A'}</strong></li>
                  <li>Conceded: <strong>${data['Away Conceded'] || 'N/A'}</strong></li>
                  <li>Avg Conceded: <strong>${data['Away Avg Conceded'] || 'N/A'}</strong></li>
                  </ul>
              </div>
          </div>

          <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-200">
               <h4 class="font-semibold mb-2 text-indigo-800">Prediction Details</h4>
               <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm">
                  <p><strong>Match Analysis:</strong> ${data['Match Analysis'] || 'N/A'}</p>
                  <p><strong>Goals Analysis:</strong> ${data['Goals Analysis'] || 'N/A'}</p>
                  <p><strong>Winning Probability:</strong> ${(data['Winning Probability']*100).toFixed(0)}%</p>
                  <p><strong>Probability of >3 Goals:</strong> ${(data['Probability of 3 Goals']*100).toFixed(0)}%</p>
                  <p><strong>Outcome Probability:</strong> ${data['Outcome Probability'] || 'N/A'}</p>
                  <p><strong>Correct Score:</strong> ${data['Correct Score'] || '—'}</p>
                  <p><strong>Result:</strong> ${data['Result'] || '—'}</p>
               </div>
               <a href='${data.URL}' target='_blank' class='text-blue-600 underline mt-3 inline-block text-sm'>View Source</a>
          </div>
        `;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      } else if (e.target.id === 'closeModal' || e.target.id === 'modal') {
        document.getElementById('modal').classList.add('hidden');
        document.getElementById('modal').classList.remove('flex');
      } else if (e.target.classList.contains('fav-btn')) {
        const id = e.target.dataset.id;
        if (favourites.has(id)) favourites.delete(id); else favourites.add(id);
        localStorage.setItem('favourites', JSON.stringify([...favourites]));
        applyFilters();
      } else if (e.target.classList.contains('tab-btn')) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active','bg-white','shadow-sm'));
        e.target.classList.add('active','bg-white','shadow-sm');
        currentTab = e.target.dataset.tab;
        document.getElementById('analyticsTab').classList.toggle('hidden', currentTab !== 'analytics');
        document.getElementById('matchesTable').classList.toggle('hidden', currentTab === 'analytics');
        applyFilters();
      }
    });

    window.addEventListener('load', () => {
      favourites = new Set(JSON.parse(localStorage.getItem('favourites') || '[]'));
      loadData();
    });
  </script>
</body>
</html>

