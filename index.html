<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Analytics Console</title>

  <!-- External Libraries & Fonts -->
  <script src="https://cdn.tailwindcss.com/3.4.1"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Core Styles for Redesign -->
  <style>
    /* 1. Base Styles & Theme Variables */
    :root {
      --primary: #4f46e5;
      --accent: #10b981;
      --bg: #f7fafc;
      --card: #ffffff;
      --border: #e6eef8;
      --muted: #6b7280;
      --text-main: #0f172a;
    }
    body {
      background-color: var(--bg);
      font-family: 'Inter', sans-serif;
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* 2. System Layout */
    .app-shell {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh;
    }
    .main-content-area {
      padding: 1.5rem 2rem;
      overflow-y: auto;
    }

    /* 3. Sidebar Navigation */
    .sidebar {
      background-color: var(--card);
      border-right: 1px solid var(--border);
      transition: all 0.3s ease-in-out;
      display: flex;
      flex-direction: column;
    }
    .brand {
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      border-bottom: 1px solid var(--border);
    }
    .brand .logo {
      font-size: 2rem;
    }
    .nav-caption {
      font-size: 0.75rem;
      color: var(--muted);
    }
    .nav-list {
      padding: 1rem 0;
      flex-grow: 1;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.5rem;
      margin: 0.25rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
      color: #374151;
      border-left: 4px solid transparent;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .nav-item i {
      width: 1.25rem;
      text-align: center;
      color: #9ca3af;
    }
    .nav-item:hover {
      background-color: #f3f4f6;
      transform: translateX(4px);
      color: var(--primary);
    }
    .nav-item.active {
      background: linear-gradient(90deg, rgba(79,70,229,0.08), rgba(16,185,129,0.03));
      border-left: 4px solid var(--primary);
      color: var(--primary);
      font-weight: 600;
    }
    .nav-item.active i {
      color: var(--primary);
    }

    /* 4. Top Bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background-color: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      position: sticky;
      top: 1.5rem;
      z-index: 10;
      margin-bottom: 1.5rem;
    }
    .search-input {
      position: relative;
    }
    .search-input i {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
    }
    .search-input input {
      padding-left: 2.5rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      transition: all 0.2s ease;
    }
    .search-input input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79,70,229,0.1);
      outline: none;
    }
    .top-bar .btn-primary {
      background-color: var(--primary);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    .top-bar .btn-primary:hover {
      background-color: #4338ca;
    }
    .top-bar .btn-secondary {
       background-color: var(--card);
       border: 1px solid var(--border);
    }

    /* 5. Content Cards & Tables */
    .data-card {
      background-color: var(--card);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.03);
    }
    .grid-4 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 9999px;
    }
    .badge.model1 { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }
    .badge.model2 { background: #eef2ff; color: #3730a3; border: 1px solid #c7d2fe; }
    .badge.model3 { background: #fff7ed; color: #9a3412; border: 1px solid #fed7aa; }
    .badge.model4 { background: #f5f3ff; color: #5b21b6; border: 1px solid #ddd6fe; }
    
    table thead th {
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, #f9fafb, #ffffff);
      z-index: 5;
    }
    table tr:hover td {
      background: rgba(79,70,229,0.03);
    }

    /* 6. Modals */
    #moreFiltersModal {
      transition: opacity 0.3s ease;
    }
    .modal-content {
       background-color: white;
       border-radius: 1rem;
       padding: 1.5rem;
       box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
       max-height: 90vh;
       overflow-y: auto;
       transform: scale(0.95);
       opacity: 0;
       transition: all 0.3s ease;
    }
    #moreFiltersModal:not(.hidden) .modal-content {
        transform: scale(1);
        opacity: 1;
    }
    .input {
        border: 1px solid #D1D5DB;
        border-radius: 8px;
        padding: 8px;
        width: 100%;
        transition: box-shadow 0.2s, border-color 0.2s;
    }
    .input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79,70,229,0.1);
    }
    
    /* 7. Responsiveness */
    @media (max-width: 900px) {
      .app-shell {
        grid-template-columns: 60px 1fr;
      }
      .sidebar {
        padding: 0.5rem;
      }
      .sidebar .brand .logo { display: flex; justify-content: center; width: 100%;}
      .sidebar .brand div:not(.logo), .sidebar .nav-item span {
        display: none;
      }
      .nav-item {
        justify-content: center;
        margin: 0.25rem 0;
      }
      .main-content-area {
        padding: 1rem;
      }
      .top-bar {
        flex-direction: column;
        gap: 0.75rem;
        align-items: stretch;
      }
    }

    /* 8. Original Styles Preservation (for JS compatibility) */
    .fav-btn { background: transparent; border: none; cursor: pointer; font-size: 16px; }
    .star-fav { color: #f59e0b; }
    .star-normal { color: #cbd5e1; }
    .star-blue { color: #3b82f6; }
    .star-green { color: #22c55e; }
    #tableHeaders th, #insightsTableHeaders th, #comparisonTableHeaders th { cursor: pointer; position: relative; }
    .sorted-asc::after { content: ' ▲'; color: #3b82f6; font-size: 0.8em; position: absolute; right: 4px; top: 50%; transform: translateY(-50%); }
    .sorted-desc::after { content: ' ▼'; color: #ef4444; font-size: 0.8em; position: absolute; right: 4px; top: 50%; transform: translateY(-50%); }
    .summary-card {
      flex: 1 1 22%; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 16px; text-align: center;
    }
    .summary-card h3 { font-size: 1rem; color: #4b5563; margin-bottom: 8px; font-weight: 500;}
    .summary-card p { font-size: 1.75rem; font-weight: bold; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Original Tab Buttons (Hidden but required for original JS logic) -->
  <div id="original-tabs" class="hidden">
    <button class="tab-btn" data-tab="dashboard"></button>
    <button class="tab-btn" data-tab="all"></button>
    <button class="tab-btn" data-tab="best"></button>
    <button class="tab-btn" data-tab="favourites"></button>
    <button class="tab-btn" data-tab="insights"></button>
    <button class="tab-btn" data-tab="comparison"></button>
    <button class="tab-btn" data-tab="insight-analytics"></button>
    <button class="tab-btn" data-tab="yesterday"></button>
    <button class="tab-btn" data-tab="analytics"></button>
  </div>

  <div class="app-shell">
    <!-- 1. Sidebar Navigation -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">⚽</div>
        <div>
          <div class="text-lg font-bold">Smart Analytics</div>
          <div class="nav-caption">Console · Insights</div>
        </div>
      </div>
      <nav class="nav-list">
        <button class="nav-item active" data-tab="dashboard"><i class="fa-solid fa-chart-pie"></i><span>Dashboard</span></button>
        <button class="nav-item" data-tab="all"><i class="fa-solid fa-table-list"></i><span>All Matches</span></button>
        <button class="nav-item" data-tab="best"><i class="fa-solid fa-star"></i><span>Best Predictions</span></button>
        <button class="nav-item" data-tab="favourites"><i class="fa-solid fa-heart"></i><span>Favourites</span></button>
        <button class="nav-item" data-tab="insights"><i class="fa-solid fa-lightbulb"></i><span>Insights</span></button>
        <button class="nav-item" data-tab="comparison"><i class="fa-solid fa-layer-group"></i><span>Comparison</span></button>
        <button class="nav-item" data-tab="insight-analytics"><i class="fa-solid fa-magnifying-glass-chart"></i><span>Insight Analytics</span></button>
        <button class="nav-item" data-tab="yesterday"><i class="fa-solid fa-calendar-day"></i><span>Yesterday</span></button>
        <button class="nav-item" data-tab="analytics"><i class="fa-solid fa-chart-simple"></i><span>Analytics</span></button>
      </nav>
      <div class="p-4 border-t border-[var(--border)]">
         <button id="refreshBtn" class="w-full flex items-center justify-center gap-2 text-sm px-3 py-2 bg-indigo-50 text-indigo-800 rounded-lg hover:bg-indigo-100 font-medium">
            <i class="fa-solid fa-arrows-rotate"></i>
            <span class="hidden sm:inline">Refresh Data</span>
        </button>
      </div>
    </aside>

    <!-- 2. Main Content Area -->
    <div class="main-content-area">
      <!-- Top Bar -->
      <header class="top-bar">
        <h1 id="pageTitle" class="text-2xl font-bold">Dashboard</h1>
        <div class="flex items-center gap-4">
          <div class="search-input">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input id="searchInput" type="text" placeholder="Search match..." class="w-64 px-3 py-1.5"/>
          </div>
          <button id="dashboardMoreFiltersBtn" class="btn-primary">More Filters</button>
        </div>
      </header>
      
      <!-- Content container for all tabs -->
      <main id="content">
        <!-- Dashboard Tab Content -->
        <div id="dashboardTab" class="tab-content space-y-6">
            <div id="dashboardCharts" class="grid-4">
                <div class="data-card"><h2 class="text-lg font-semibold text-gray-700 mb-3 flex justify-between items-center">Model 1 Overview <span class="badge model1">Prediction</span></h2><div style="height: 300px;"><canvas id="model1PerformanceChart"></canvas></div></div>
                <div class="data-card"><h2 class="text-lg font-semibold text-gray-700 mb-3 flex justify-between items-center">Model 2 Overview <span class="badge model2">Outcome</span></h2><div style="height: 300px;"><canvas id="model2PerformanceChart"></canvas></div></div>
                <div class="data-card"><h2 class="text-lg font-semibold text-gray-700 mb-3 flex justify-between items-center">Model 3 Overview <span class="badge model3">Outcome 1</span></h2><div style="height: 300px;"><canvas id="model3PerformanceChart"></canvas></div></div>
                <div class="data-card"><h2 class="text-lg font-semibold text-gray-700 mb-3 flex justify-between items-center">Model 4 Overview <span class="badge model4">Outcome 3</span></h2><div style="height: 300px;"><canvas id="model4PerformanceChart"></canvas></div></div>
            </div>
            <div id="dashboardFilters" class="data-card">
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 items-end">
                    <div class="filter-group flex flex-col"><label for="dashboardMatchDateFilter" class="text-sm font-medium mb-1">Match Date:</label><select id="dashboardMatchDateFilter" class="border rounded-md p-1.5"></select></div>
                    <div class="filter-group flex flex-col"><label class="text-sm font-medium mb-1">Winning Streak:</label><div class="flex gap-2"><input type="number" id="dashboardMinWinStreak" placeholder="Min" class="border rounded-md p-1.5 w-full"><input type="number" id="dashboardMaxWinStreak" placeholder="Max" class="border rounded-md p-1.5 w-full"></div></div>
                    <div class="filter-group flex flex-col"><label class="text-sm font-medium mb-1">Losing Streak:</label><div class="flex gap-2"><input type="number" id="dashboardMinLoseStreak" placeholder="Min" class="border rounded-md p-1.5 w-full"><input type="number" id="dashboardMaxLoseStreak" placeholder="Max" class="border rounded-md p-1.5 w-full"></div></div>
                    <div class="flex items-center justify-end gap-2 col-start-auto lg:col-start-5">
                      <button id="dashboardClearFilters" class="bg-gray-200 text-gray-800 px-4 py-1.5 rounded-md text-sm hover:bg-gray-300 font-medium">Clear</button>
                    </div>
                </div>
            </div>
            <div id="dashboardCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="dashboardTables" class="space-y-8">
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <div id="dashboardTable1Container"></div>
                    <div id="dashboardTable2Container"></div>
                </div>
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <div id="dashboardTable3Container"></div>
                    <div id="dashboardTable4Container"></div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab Content -->
        <div id="analyticsTab" class="tab-content hidden"><div id="analyticsCharts" class="grid-4"></div></div>
        
        <!-- Generic Main Content for other tabs -->
        <div id="mainContent" class="tab-content hidden space-y-6">
          <div id="predictionSummaryCard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
          <div id="summaryCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
          <div class="data-card">
              <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 items-end">
                  <div class="filter-group flex flex-col"><label for="mainMatchDateFilter">Match Date:</label><select id="mainMatchDateFilter" class="border rounded-md p-1.5"></select></div>
                  <div class="filter-group flex flex-col"><label for="mainModel1PredFilter">Model 1 Pred:</label><select id="mainModel1PredFilter" class="border rounded-md p-1.5"></select></div>
                  <div class="filter-group flex flex-col"><label>Prob 1 (%):</label><div class="flex gap-2"><input type="number" id="mainMinProb1" placeholder="Min" class="border rounded-md p-1.5 w-full"><input type="number" id="mainMaxProb1" placeholder="Max" class="border rounded-md p-1.5 w-full"></div></div>
                  <div class="filter-group flex flex-col"><label for="mainModel2PredFilter">Model 2 Pred:</label><select id="mainModel2PredFilter" class="border rounded-md p-1.5"></select></div>
                  <div class="filter-group flex flex-col"><label>Prob 2 (%):</label><div class="flex gap-2"><input type="number" id="mainMinProb2" placeholder="Min" class="border rounded-md p-1.5 w-full"><input type="number" id="mainMaxProb2" placeholder="Max" class="border rounded-md p-1.5 w-full"></div></div>
                  <div class="filter-group flex flex-col"><label for="mainModel3PredFilter">Model 3 Pred:</label><select id="mainModel3PredFilter" class="border rounded-md p-1.5"></select></div>
                  <div class="filter-group flex flex-col"><label>Prob 3 (%):</label><div class="flex gap-2"><input type="number" id="mainMinProb3" placeholder="Min" class="border rounded-md p-1.5 w-full"><input type="number" id="mainMaxProb3" placeholder="Max" class="border rounded-md p-1.5 w-full"></div></div>
                  <div class="flex items-center justify-end gap-2">
                    <button id="mainClearFilters" class="bg-gray-200 text-gray-800 px-4 py-1.5 rounded-md text-sm hover:bg-gray-300 font-medium">Clear</button>
                  </div>
              </div>
          </div>
          <div class="data-card overflow-x-auto">
              <table id="matchesTable" class="min-w-full text-sm">
                <thead class="bg-gray-100"><tr id="tableHeaders">
                    <th class="p-2 text-left" data-column="star">★</th><th class="p-2 text-left" data-column="MatchDate">Date</th><th class="p-2 text-left" data-column="Match">Match</th><th class="p-2 text-left" data-column="Model 1">Model 1 (Pred)</th><th class="p-2 text-left" data-column="Probability 1">Prob 1 (%)</th><th class="p-2 text-left" data-column="Model 2">Model 2 (Pred)</th><th class="p-2 text-left" data-column="Probability 2">Prob 2 (%)</th><th class="p-2 text-left" data-column="Predicted Odd">Predicted Odd</th><th class="p-2 text-left" data-column="Model 3">Model 3 (Pred)</th><th class="p-2 text-left" data-column="Probability 3">Prob 3 (%)</th><th class="p-2 text-left" data-column="Prediction">Prediction</th><th class="p-2 text-left" data-column="Stake">Stake</th><th class="p-2 text-left" data-column="Tip Probability">Tip Prob (%)</th><th class="p-2 text-left" data-column="Match Tip">Match Tip</th><th class="p-2 text-left" data-column="Result">Result</th><th class="p-2 text-left">View</th>
                </tr></thead>
                <tbody id="tableBody"></tbody>
              </table>
          </div>
          <div id="paginationControls" class="flex justify-center items-center gap-4"><button id="prevPageBtn" class="bg-white border border-gray-300 px-4 py-2 rounded-md disabled:opacity-50" disabled>Previous</button><span id="pageIndicator">Page 1 of 1</span><button id="nextPageBtn" class="bg-white border border-gray-300 px-4 py-2 rounded-md disabled:opacity-50" disabled>Next</button></div>
        </div>

        <!-- Insights Tab Content -->
        <div id="insightsTab" class="tab-content hidden space-y-6">
            <div id="insightsSummaryCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div class="data-card">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-x-4 gap-y-2 items-start">
                    <div class="filter-group flex flex-col lg:col-span-1"><label for="insightsMatchDateFilter">Match Date:</label><select id="insightsMatchDateFilter" multiple class="border h-24 rounded-md"></select></div>
                    <div class="filter-group flex flex-col lg:col-span-1"><label for="insightsLeagueFilter">League:</label><select id="insightsLeagueFilter" multiple class="border h-24 rounded-md"></select></div>
                    <div class="filter-group flex flex-col lg:col-span-1"><label for="insightsAnalysisFilter">Match Analysis:</label><select id="insightsAnalysisFilter" multiple class="border h-24 rounded-md"></select></div>
                    <div class="filter-group flex flex-col lg:col-span-1 space-y-2"><label>Winning Streak:</label><div class="flex gap-2"><input type="number" id="insightsMinWinStreak" placeholder="Min" class="border w-1/2 p-1.5 rounded-md"><input type="number" id="insightsMaxWinStreak" placeholder="Max" class="border w-1/2 p-1.5 rounded-md"></div></div>
                    <div class="filter-group flex flex-col lg:col-span-1 space-y-2"><label>Losing Streak:</label><div class="flex gap-2"><input type="number" id="insightsMinLoseStreak" placeholder="Min" class="border w-1/2 p-1.5 rounded-md"><input type="number" id="insightsMaxLoseStreak" placeholder="Max" class="border w-1/2 p-1.5 rounded-md"></div></div>
                    <div class="flex items-end justify-end h-full lg:col-span-1"><button id="insightsClearFilters" class="bg-gray-200 text-gray-800 px-4 py-1.5 rounded-md text-sm hover:bg-gray-300">Clear Filters</button></div>
                </div>
            </div>
            <div class="data-card overflow-x-auto">
                <table id="insightsTable" class="min-w-full text-sm">
                    <thead class="bg-gray-100"><tr id="insightsTableHeaders">
                        <th class="p-2 text-left" data-column="star">★</th><th class="p-2 text-left">C</th><th class="p-2 text-left" data-column="MatchDate">Match Date</th><th class="p-2 text-left" data-column="Match">Match</th><th class="p-2 text-left" data-column="Result">Result</th><th class="p-2 text-left" data-column="Model 1">Model 1</th><th class="p-2 text-left" data-column="Probability 1">Probability 1</th><th class="p-2 text-left" data-column="Model 2">Model 2</th><th class="p-2 text-left" data-column="Probability 2">Probability 2</th><th class="p-2 text-left" data-column="Model 3">Model 3</th><th class="p-2 text-left" data-column="Probability 3">Probability 3</th><th class="p-2 text-left" data-column="Prediction">Prediction</th><th class="p-2 text-left" data-column="Stake">Stake</th><th class="p-2 text-left" data-column="Tip Probability">Tip Prob (%)</th><th class="p-2 text-left" data-column="Match Tip">Match Tip</th><th class="p-2 text-left">View</th>
                    </tr></thead><tbody id="insightsTableBody"></tbody>
                </table>
            </div>
            <div id="insightsPaginationControls" class="flex justify-center items-center gap-4"><button id="insightsPrevPageBtn" class="bg-white border border-gray-300 px-4 py-2 rounded-md disabled:opacity-50" disabled>Previous</button><span id="insightsPageIndicator">Page 1 of 1</span><button id="insightsNextPageBtn" class="bg-white border border-gray-300 px-4 py-2 rounded-md disabled:opacity-50" disabled>Next</button></div>
        </div>

        <!-- Comparison Tab Content -->
        <div id="comparisonTab" class="tab-content hidden space-y-6">
            <div id="comparisonStatsCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div class="data-card">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-x-4 gap-y-2 items-start">
                    <div class="filter-group flex flex-col lg:col-span-1"><label for="comparisonMatchDateFilter">Match Date:</label><select id="comparisonMatchDateFilter" multiple class="border h-24 rounded-md"></select></div>
                    <div class="filter-group flex flex-col lg:col-span-1"><label for="comparisonLeagueFilter">League:</label><select id="comparisonLeagueFilter" multiple class="border h-24 rounded-md"></select></div>
                    <div class="filter-group flex flex-col lg:col-span-1"><label for="comparisonAnalysisFilter">Match Analysis:</label><select id="comparisonAnalysisFilter" multiple class="border h-24 rounded-md"></select></div>
                    <div class="filter-group flex flex-col lg:col-span-1 space-y-2"><label>Winning Streak:</label><div class="flex gap-2"><input type="number" id="comparisonMinWinStreak" placeholder="Min" class="border w-1/2 p-1.5 rounded-md"><input type="number" id="comparisonMaxWinStreak" placeholder="Max" class="border w-1/2 p-1.5 rounded-md"></div></div>
                    <div class="filter-group flex flex-col lg:col-span-1 space-y-2"><label>Losing Streak:</label><div class="flex gap-2"><input type="number" id="comparisonMinLoseStreak" placeholder="Min" class="border w-1/2 p-1.5 rounded-md"><input type="number" id="comparisonMaxLoseStreak" placeholder="Max" class="border w-1/2 p-1.5 rounded-md"></div></div>
                    <div class="flex items-end justify-between h-full lg:col-span-1">
                      <button id="comparisonClearFilters" class="bg-gray-200 text-gray-800 px-4 py-1.5 rounded-md text-sm hover:bg-gray-300">Clear</button>
                      <button id="bookmarkBtn" class="bg-yellow-400 text-yellow-900 px-4 py-2 rounded-md text-sm hover:bg-yellow-500 font-semibold">🔖 Bookmark</button>
                    </div>
                </div>
            </div>
            <details id="comparisonTableContainer" open class="data-card">
                <summary class="text-xl font-semibold cursor-pointer hover:text-[var(--primary)]">Comparison Table</summary>
                <p class="text-sm text-gray-600 my-4">Select matches from the 'Insights' tab using the 'C' checkbox column to compare them here.</p>
                <div class="overflow-x-auto">
                    <table id="comparisonTable" class="min-w-full text-sm">
                        <thead class="bg-gray-100"><tr id="comparisonTableHeaders">
                            <th class="p-2 text-left"><input type="checkbox" id="selectAllBookmark"></th><th class="p-2 text-left" data-column="Match">Match</th><th class="p-2 text-left" data-column="MatchDate">Match Date</th><th class="p-2 text-left" data-column="Prediction Model 1">Prediction Model 1</th><th class="p-2 text-left" data-column="Confidence Model 1">Confidence Model 1</th><th class="p-2 text-left" data-column="Prediction Model 2">Prediction Model 2</th><th class="p-2 text-left" data-column="Confidence Model 2">Confidence Model 2</th><th class="p-2 text-left" data-column="Prediction Model 3">Prediction Model 3</th><th class="p-2 text-left" data-column="Confidence Model 3">Confidence Model 3</th><th class="p-2 text-left" data-column="Prediction">Prediction</th><th class="p-2 text-left" data-column="Stake">Stake</th><th class="p-2 text-left" data-column="Tip Probability">Tip Prob (%)</th><th class="p-2 text-left" data-column="Match Tip">Match Tip</th><th class="p-2 text-left" data-column="Result">Result</th><th class="p-2 text-left">Remove</th>
                        </tr></thead>
                        <tbody id="comparisonTableBody"></tbody>
                    </table>
                </div>
            </details>
            <div id="bookmarkSection"></div>
            <div id="comparisonAnalyticsSection" class="data-card">
              <h2 class="text-2xl font-bold text-center mb-6">Comparison Analytics</h2>
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                  <div class="border rounded-lg p-4"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 1: Win % by Prediction Type</h3><div style="height:300px"><canvas id="model1WinRateChart"></canvas></div></div>
                  <div class="border rounded-lg p-4"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 2: Win % by Prediction Type</h3><div style="height:300px"><canvas id="model2WinRateChart"></canvas></div></div>
                  <div class="border rounded-lg p-4"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 3: Win % by Prediction Type</h3><div style="height:300px"><canvas id="model3WinRateChart"></canvas></div></div>
              </div>
              <div class="border rounded-lg p-4"><h3 class="font-semibold text-center mb-2 text-gray-700">Wins by Probability Range (All Models)</h3><div style="height: 400px;"><canvas id="probabilityWinChart"></canvas></div></div>
            </div>
        </div>
        
        <!-- Insight Analytics Tab Content -->
        <div id="insightAnalyticsTab" class="tab-content hidden space-y-6">
            <div id="insightAnalyticsSummaryCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div class="data-card">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-x-4 gap-y-2 items-start">
                    <div class="filter-group flex flex-col lg:col-span-1"><label for="iaMatchDateFilter">Match Date:</label><select id="iaMatchDateFilter" multiple class="border h-24 rounded-md"></select></div>
                    <div class="filter-group flex flex-col lg:col-span-1"><label for="iaLeagueFilter">League:</label><select id="iaLeagueFilter" multiple class="border h-24 rounded-md"></select></div>
                    <div class="filter-group flex flex-col lg:col-span-1"><label for="iaAnalysisFilter">Match Analysis:</label><select id="iaAnalysisFilter" multiple class="border h-24 rounded-md"></select></div>
                    <div class="filter-group flex flex-col lg:col-span-1 space-y-2"><label>Winning Streak:</label><div class="flex gap-2"><input type="number" id="iaMinWinStreak" placeholder="Min" class="border w-1/2 p-1.5 rounded-md"><input type="number" id="iaMaxWinStreak" placeholder="Max" class="border w-1/2 p-1.5 rounded-md"></div></div>
                    <div class="filter-group flex flex-col lg:col-span-1 space-y-2"><label>Losing Streak:</label><div class="flex gap-2"><input type="number" id="iaMinLoseStreak" placeholder="Min" class="border w-1/2 p-1.5 rounded-md"><input type="number" id="iaMaxLoseStreak" placeholder="Max" class="border w-1/2 p-1.5 rounded-md"></div></div>
                    <div class="flex items-end justify-end h-full lg:col-span-1"><button id="iaClearFilters" class="bg-gray-200 text-gray-800 px-4 py-1.5 rounded-md text-sm hover:bg-gray-300">Clear Filters</button></div>
                </div>
            </div>
            <div id="iaOverviewTableContainer" class="data-card"></div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="data-card"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 1: Performance by Category</h3><div style="height:300px"><canvas id="iaModel1CatChart"></canvas></div></div>
                <div class="data-card"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 2: Performance by Category</h3><div style="height:300px"><canvas id="iaModel2CatChart"></canvas></div></div>
                <div class="data-card"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 3: Performance by Category</h3><div style="height:300px"><canvas id="iaModel3CatChart"></canvas></div></div>
                <div class="data-card"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 1: Wins by Probability</h3><div style="height:300px"><canvas id="iaModel1ProbChart"></canvas></div></div>
                <div class="data-card"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 2: Wins by Probability</h3><div style="height:300px"><canvas id="iaModel2ProbChart"></canvas></div></div>
                <div class="data-card"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 3: Wins by Probability</h3><div style="height:300px"><canvas id="iaModel3ProbChart"></canvas></div></div>
            </div>
        </div>

      </main>
    </div>
  </div>

  <!-- Modals -->
  <div id="moreFiltersModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="modal-content w-11/12 max-w-6xl">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">More Filters</h2>
        <button id="closeMoreFiltersModal" class="text-gray-400 hover:text-gray-700 text-3xl leading-none">&times;</button>
      </div>
  
      <div class="space-y-6">
        <!-- Section for Predictions & Tips -->
        <div>
          <h3 class="text-lg text-gray-700 font-semibold mb-3 border-b pb-2">Predictions & Tips</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div><label for="mfPredictionFilter" class="block text-sm font-medium mb-1">Prediction:</label><select id="mfPredictionFilter" class="input"></select></div>
            <div><label class="block text-sm font-medium mb-1">Stake:</label><div class="flex gap-2"><input type="number" id="mfStakeMin" placeholder="Min" class="input"><input type="number" id="mfStakeMax" placeholder="Max" class="input"></div></div>
            <div><label class="block text-sm font-medium mb-1">Tip Probability (%):</label><div class="flex gap-2"><input type="number" id="mfTipProbMin" placeholder="Min" class="input"><input type="number" id="mfTipProbMax" placeholder="Max" class="input"></div></div>
            <div><label for="mfMatchTipFilter" class="block text-sm font-medium mb-1">Match Tip:</label><select id="mfMatchTipFilter" class="input"></select></div>
          </div>
        </div>
        <!-- Sections for Home/Away Stats -->
        <div><h3 class="text-lg text-gray-700 font-semibold mb-3 border-b pb-2">Home Team Stats</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label class="block text-sm font-medium mb-1">Home Wins:</label><div class="flex gap-2"><input type="number" id="mfHomeWinsMin" placeholder="Min" class="input"><input type="number" id="mfHomeWinsMax" placeholder="Max" class="input"></div></div><div><label class="block text-sm font-medium mb-1">Home Draws:</label><div class="flex gap-2"><input type="number" id="mfHomeDrawsMin" placeholder="Min" class="input"><input type="number" id="mfHomeDrawsMax" placeholder="Max" class="input"></div></div><div><label class="block text-sm font-medium mb-1">Home Losses:</label><div class="flex gap-2"><input type="number" id="mfHomeLossesMin" placeholder="Min" class="input"><input type="number" id="mfHomeLossesMax" placeholder="Max" class="input"></div></div><div><label class="block text-sm font-medium mb-1">Home Scored:</label><div class="flex gap-2"><input type="number" id="mfHomeScoredMin" placeholder="Min" class="input"><input type="number" id="mfHomeScoredMax" placeholder="Max" class="input"></div></div><div><label class="block text-sm font-medium mb-1">Home Scored (Avg):</label><div class="flex gap-2"><input type="number" id="mfHomeScoredAvgMin" placeholder="Min" class="input"><input type="number" id="mfHomeScoredAvgMax" placeholder="Max" class="input"></div></div><div><label class="block text-sm font-medium mb-1">Home Conceded:</label><div class="flex gap-2"><input type="number" id="mfHomeConcededMin" placeholder="Min" class="input"><input type="number" id="mfHomeConcededMax" placeholder="Max" class="input"></div></div><div><label class="block text-sm font-medium mb-1">Home Conceded (Avg):</label><div class="flex gap-2"><input type="number" id="mfHomeConcededAvgMin" placeholder="Min" class="input"><input type="number" id="mfHomeConcededAvgMax" placeholder="Max" class="input"></div></div></div></div>
        <div><h3 class="text-lg text-gray-700 font-semibold mb-3 border-b pb-2">Away Team Stats</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label class="block text-sm font-medium mb-1">Away Wins:</label><div class="flex gap-2"><input type="number" id="mfAwayWinsMin" placeholder="Min" class="input"><input type="number" id="mfAwayWinsMax" placeholder="Max" class="input"></div></div><div><label class="block text-sm font-medium mb-1">Away Draws:</label><div class="flex gap-2"><input type="number" id="mfAwayDrawsMin" placeholder="Min" class="input"><input type="number" id="mfAwayDrawsMax" placeholder="Max" class="input"></div></div><div><label class="block text-sm font-medium mb-1">Away Losses:</label><div class="flex gap-2"><input type="number" id="mfAwayLossesMin" placeholder="Min" class="input"><input type="number" id="mfAwayLossesMax" placeholder="Max" class="input"></div></div><div><label class="block text-sm font-medium mb-1">Away Scored:</label><div class="flex gap-2"><input type="number" id="mfAwayScoredMin" placeholder="Min" class="input"><input type="number" id="mfAwayScoredMax" placeholder="Max" class="input"></div></div><div><label class="block text-sm font-medium mb-1">Away Scored (Avg):</label><div class="flex gap-2"><input type="number" id="mfAwayScoredAvgMin" placeholder="Min" class="input"><input type="number" id="mfAwayScoredAvgMax" placeholder="Max" class="input"></div></div><div><label class="block text-sm font-medium mb-1">Away Conceded:</label><div class="flex gap-2"><input type="number" id="mfAwayConcededMin" placeholder="Min" class="input"><input type="number" id="mfAwayConcededMax" placeholder="Max" class="input"></div></div><div><label class="block text-sm font-medium mb-1">Away Conceded (Avg):</label><div class="flex gap-2"><input type="number" id="mfAwayConcededAvgMin" placeholder="Min" class="input"><input type="number" id="mfAwayConcededAvgMax" placeholder="Max" class="input"></div></div></div></div>
        <div><h3 class="text-lg text-gray-700 font-semibold mb-3 border-b pb-2">Streaks & Analysis</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label class="block text-sm font-medium mb-1">Winning Streak:</label><div class="flex gap-2"><input type="number" id="mfWinningStreakMin" placeholder="Min" class="input"><input type="number" id="mfWinningStreakMax" placeholder="Max" class="input"></div></div><div><label class="block text-sm font-medium mb-1">Losing Streak:</label><div class="flex gap-2"><input type="number" id="mfLosingStreakMin" placeholder="Min" class="input"><input type="number" id="mfLosingStreakMax" placeholder="Max" class="input"></div></div><div><label for="mfMatchAnalysisFilter" class="block text-sm font-medium mb-1">Match Analysis:</label><select id="mfMatchAnalysisFilter" class="input"></select></div><div><label for="mfTotalGoalsPredictionFilter" class="block text-sm font-medium mb-1">Total Goals Prediction:</label><select id="mfTotalGoalsPredictionFilter" class="input"></select></div></div></div>
        <div><h3 class="text-lg text-gray-700 font-semibold mb-3 border-b pb-2">H2H & Position Stats</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label class="block text-sm font-medium mb-1">H2H Home Wins:</label><div class="flex gap-2"><input type="number" id="mfH2HHomeWinsMin" placeholder="Min" class="input"><input type="number" id="mfH2HHomeWinsMax" placeholder="Max" class="input"></div></div><div><label class="block text-sm font-medium mb-1">H2H Away Wins:</label><div class="flex gap-2"><input type="number" id="mfH2HAwayWinsMin" placeholder="Min" class="input"><input type="number" id="mfH2HAwayWinsMax" placeholder="Max" class="input"></div></div><div><label class="block text-sm font-medium mb-1">H2H Draws:</label><div class="flex gap-2"><input type="number" id="mfH2HDrawsMin" placeholder="Min" class="input"><input type="number" id="mfH2HDrawsMax" placeholder="Max" class="input"></div></div><div class="grid grid-cols-2 gap-2"><div><label class="block text-sm font-medium mb-1">Home Pos:</label><div class="flex gap-2"><input type="number" id="mfHomeTeamPositionMin" placeholder="Min" class="input"><input type="number"id="mfHomeTeamPositionMax" placeholder="Max" class="input"></div></div><div><label class="block text-sm font-medium mb-1">Away Pos:</label><div class="flex gap-2"><input type="number" id="mfAwayTeamPositionMin" placeholder="Min" class="input"><input type="number" id="mfAwayTeamPositionMax" placeholder="Max" class="input"></div></div></div></div></div>
      </div>
  
      <div class="mt-8 flex justify-end space-x-4">
        <button id="resetMoreFilters" class="font-medium bg-gray-200 text-gray-700 px-5 py-2 rounded-lg hover:bg-gray-300 transition-colors">Clear</button>
        <button id="applyMoreFilters" class="font-medium bg-[var(--primary)] text-white px-5 py-2 rounded-lg hover:bg-indigo-700 transition-colors">Apply Filters</button>
      </div>
    </div>
  </div>

  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-40 p-4"><div class="bg-white rounded-lg w-full max-w-3xl p-6 relative max-h-screen overflow-y-auto"><button id="closeModal" class="absolute top-4 right-4 text-gray-500 text-xl">✖</button><div id="modalContent"></div></div></div>
  <div id="bookmarkNameModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-40 p-4"><div class="bg-white rounded-lg w-full max-w-sm p-6 relative"><button id="closeBookmarkModal" class="absolute top-3 right-4 text-gray-500 text-xl">✖</button><h3 class="text-lg font-bold mb-4">Name Bookmark Group</h3><p class="text-sm text-gray-600 mb-3">Enter a name for this group of matches. If the name already exists, matches will be added to it.</p><input type="text" id="bookmarkGroupName" placeholder="e.g., Weekend Wins" class="border w-full rounded px-3 py-2"><div class="mt-4 flex justify-end gap-3"><button id="cancelBookmark" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">Cancel</button><button id="saveBookmark" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button></div></div></div>
  <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div id="loadingText" class="text-white text-xl animate-pulse">Loading data...</div></div>

  <!-- New UI Interaction Script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');
        const pageTitle = document.getElementById('pageTitle');
        const originalTabButtons = document.querySelectorAll('#original-tabs .tab-btn');

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const tabName = item.dataset.tab;

                // Update sidebar UI
                navItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                // Update page title
                pageTitle.textContent = item.querySelector('span').textContent;

                // Hide all main content tabs
                tabContents.forEach(content => content.classList.add('hidden'));

                // Show the correct main content tab
                let contentToShowId;
                switch(tabName) {
                    case 'dashboard': contentToShowId = 'dashboardTab'; break;
                    case 'analytics': contentToShowId = 'analyticsTab'; break;
                    case 'insights': contentToShowId = 'insightsTab'; break;
                    case 'comparison': contentToShowId = 'comparisonTab'; break;
                    case 'insight-analytics': contentToShowId = 'insightAnalyticsTab'; break;
                    default: contentToShowId = 'mainContent'; break;
                }
                document.getElementById(contentToShowId).classList.remove('hidden');

                // Programmatically click the original hidden button to trigger existing logic
                const originalButton = Array.from(originalTabButtons).find(btn => btn.dataset.tab === tabName);
                if (originalButton) {
                    originalButton.click();
                }
            });
        });
    });
  </script>

  <!-- Original, Unmodified Application Logic -->
  <script>
    // --- State & Config ---
    const DATA_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH-Uue5Ctuo4aU-4S81U9QvoXxslOq6YjKHnVkPjyOeJqci4p19cs2iZ8y5GgzsSh_vQHxPYb-gl-5/pub?gid=0&single=true&output=csv';
    let allMatches = [], filteredMatches = [], favourites = new Set(), currentTab = 'dashboard';
    let insightsMatches = [], filteredInsightsMatches = [], matchesForComparison = new Set();
    let filteredInsightAnalyticsMatches = [];
    let bookmarkedMatches = {};
    let charts = {};
    let currentPage = 1, insightsCurrentPage = 1, bookmarkPages = {};
    const rowsPerPage = 30;
    let sortConfig = { column: 'MatchDate', direction: 'desc' };
    let insightsSortConfig = { column: 'MatchDate', direction: 'desc' };
    let comparisonSortConfig = { column: 'MatchDate', direction: 'desc' };
    let filterTimeout;

    // --- Data Fetching & Processing ---
    async function fetchCsv(url) {
        const cacheBustUrl = `${url}&_=${new Date().getTime()}`;
        try {
            const response = await fetch(cacheBustUrl);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const csvText = await response.text();
            return new Promise((resolve, reject) => {
                Papa.parse(csvText, {
                    header: true, skipEmptyLines: true, transformHeader: h => h.trim(),
                    complete: results => resolve(results.data),
                    error: err => reject(new Error(`Failed to parse CSV: ${err.message}`))
                });
            });
        } catch (e) { throw new Error(`Failed to fetch CSV: ${e.message}`); }
    }

    function normalizeRows(rows) {
        return rows.filter(r => r && r.Match).map(r => {
            const row = {};
            for (const k in r) row[k.trim()] = (r[k] || '').toString().trim();
            
            row.MatchDate = row['Match Date'] || 'N/A';
            row.uniqueId = encodeURIComponent(`${row.Match}-${row.MatchDate}`);
            
            const numericKeys = [
                'Probability (%)', 'Prediction Confidence (%)', 'Winning Probability', 'Probability of 3 Goals', 
                'Winning Chance', 'Outcome Probability', 'Winning Streak', 'Losing Streak', 
                'Home Wins', 'Home Draws', 'Home Losses', 'Home Scored', 'Home Scored (Avg)', 'Home Conceded', 'Home Conceded (Avg)', 
                'Away Wins', 'Away Draws', 'Away Losses', 'Away Scored', 'Away Scored (Avg)', 'Away Conceded', 'Away Conceded (Avg)', 
                'Home Odds', 'Draw Odds', 'Away Odds',
                'Odds (Prediction)', 'Stake', 'Total Goals Prediction',
                'H2H Home Wins', 'H2H Away Wins', 'H2H Draws', 'Home Team Position', 'Away Team Position',
                'Tip Probability'
            ];
            numericKeys.forEach(key => { row[key] = parseFloat(String(row[key] || '').replace(/[^0-9.\-%]/g, '')) || 0; });

            if (row['Predicted Outcome3'] === 'Home Win') {
                row['Predicted Odd'] = row['Home Odds'];
            } else if (row['Predicted Outcome3'] === 'Away Win') {
                row['Predicted Odd'] = row['Away Odds'];
            } else if (row['Predicted Outcome3'] === 'Draw') {
                row['Predicted Odd'] = row['Draw Odds'];
            } else {
                row['Predicted Odd'] = 0;
            }
            return row;
        });
    }
    
    function showErrorOverlay(message) {
        const overlay = document.getElementById('loadingOverlay');
        const text = document.getElementById('loadingText');
        text.textContent = message;
        text.classList.remove('animate-pulse');
        overlay.classList.remove('hidden');
    }

    async function loadData() {
        document.getElementById('loadingOverlay').classList.remove('hidden');
        document.getElementById('loadingText').textContent = 'Loading data...';
        try {
            const rawData = await fetchCsv(DATA_CSV_URL);
            allMatches = normalizeRows(rawData);
            insightsMatches = allMatches;
            filteredInsightAnalyticsMatches = allMatches;
            populateAllFilters(allMatches);
            populateDynamicFilters(allMatches);
            applyFilters();
            applyInsightsFilters();
            renderInsightAnalyticsPage(filteredInsightAnalyticsMatches);
            renderDashboard();
        } catch (err) { 
            console.error('Failed to load CSV data:', err);
            showErrorOverlay(`Failed to load data. Error: ${err.message}`);
        } finally { document.getElementById('loadingOverlay').classList.add('hidden'); }
    }
    
    // --- Filter Population & Logic ---
    function populateAllFilters(data) {
        const createOptions = (arr, sort = 'desc') => {
            const opts = [...new Set(arr)].filter(Boolean).sort();
            if (sort === 'numeric-asc') opts.sort((a,b) => a - b);
            else if (sort === 'numeric-desc') opts.sort((a,b) => b - a);
            else if (sort === 'asc') opts.sort();
            else opts.reverse();
            return opts;
        }
        const matchDates = createOptions(data.map(r => r.MatchDate), 'desc');
        const leagues = createOptions(data.map(r => r.League), 'asc');
        const analyses = createOptions(data.map(r => r['Match Analysis']), 'asc');
        const predictions = createOptions(data.map(r => r['Prediction']), 'asc');
        const matchTips = createOptions(data.map(r => r['Match Tip']), 'asc');

        const predictionTypes = createOptions(data.flatMap(r => [r['Predicted Outcome'], r['Predicted Outcome3'], r['Prediction Outcome1']]));
        populateSelect('mainMatchDateFilter', matchDates);
        populateSelect('dashboardMatchDateFilter', matchDates);
        populateSelect('mainModel1PredFilter', predictionTypes);
        populateSelect('mainModel2PredFilter', predictionTypes);
        populateSelect('mainModel3PredFilter', predictionTypes);
        
        populateSelect('insightsMatchDateFilter', matchDates, true);
        populateSelect('insightsLeagueFilter', leagues, true);
        populateSelect('insightsAnalysisFilter', analyses, true);
        
        populateSelect('comparisonMatchDateFilter', matchDates, true);
        populateSelect('comparisonLeagueFilter', leagues, true);
        populateSelect('comparisonAnalysisFilter', analyses, true);
        
        populateSelect('iaMatchDateFilter', matchDates, true);
        populateSelect('iaLeagueFilter', leagues, true);
        populateSelect('iaAnalysisFilter', analyses, true);
        
        populateSelect('mfPredictionFilter', predictions);
        populateSelect('mfMatchTipFilter', matchTips);
    }
    
    function populateSelect(id, options, isMulti = false) {
        const select = document.getElementById(id);
        if (!select) return;
        select.innerHTML = isMulti ? '' : '<option value="">All</option>';
        options.forEach(opt => select.add(new Option(opt, opt)));
    }

    function populateDynamicFilters(data) {
        const numericColumns = {
            'Home Wins': 'mfHomeWins', 'Home Draws': 'mfHomeDraws', 'Home Losses': 'mfHomeLosses',
            'Away Wins': 'mfAwayWins', 'Away Draws': 'mfAwayDraws', 'Away Losses': 'mfAwayLosses',
            'Home Scored': 'mfHomeScored', 'Home Scored (Avg)': 'mfHomeScoredAvg',
            'Home Conceded': 'mfHomeConceded', 'Home Conceded (Avg)': 'mfHomeConcededAvg',
            'Away Scored': 'mfAwayScored', 'Away Scored (Avg)': 'mfAwayScoredAvg',
            'Away Conceded': 'mfAwayConceded', 'Away Conceded (Avg)': 'mfAwayConcededAvg',
            'Winning Streak': 'mfWinningStreak', 'Losing Streak': 'mfLosingStreak',
            'H2H Home Wins': 'mfH2HHomeWins', 'H2H Away Wins': 'mfH2HAwayWins', 'H2H Draws': 'mfH2HDraws',
            'Home Team Position': 'mfHomeTeamPosition', 'Away Team Position': 'mfAwayTeamPosition',
            'Tip Probability': 'mfTipProb',
            'Stake': 'mfStake'
        };
        const dropdownColumns = { 'Match Analysis': 'mfMatchAnalysisFilter', 'Total Goals Prediction': 'mfTotalGoalsPredictionFilter' };

        for (const colName in numericColumns) {
            const values = data.map(row => row[colName]).filter(v => v !== null && v !== undefined && v !== '');
            if (values.length === 0) continue;
            const min = Math.min(...values);
            const max = Math.max(...values);
            const idPrefix = numericColumns[colName];
            const minEl = document.getElementById(`${idPrefix}Min`);
            const maxEl = document.getElementById(`${idPrefix}Max`);
            if (minEl) minEl.placeholder = `Min (${min})`;
            if (maxEl) maxEl.placeholder = `Max (${max})`;
        }

        for (const colName in dropdownColumns) {
            const uniqueVals = [...new Set(data.map(row => row[colName]))].filter(Boolean).sort();
            const selectId = dropdownColumns[colName];
            populateSelect(selectId, uniqueVals, false);
        }
    }


    function getSelectedOptions(id) { return Array.from(document.getElementById(id).selectedOptions).map(o => o.value); }

    function applyGenericFilters(data, prefix = '') {
        const getNum = id => parseFloat(document.getElementById(id)?.value.trim());

        const selectedDates = getSelectedOptions(`${prefix}MatchDateFilter`);
        const selectedLeagues = getSelectedOptions(`${prefix}LeagueFilter`);
        const selectedAnalyses = getSelectedOptions(`${prefix}AnalysisFilter`);
        const minWinStreak = getNum(`${prefix}MinWinStreak`);
        const maxWinStreak = getNum(`${prefix}MaxWinStreak`);
        const minLoseStreak = getNum(`${prefix}MinLoseStreak`);
        const maxLoseStreak = getNum(`${prefix}MaxLoseStreak`);

        return data.filter(r => {
            const winStreak = r['Winning Streak'];
            const loseStreak = r['Losing Streak'];
            
            return (selectedDates.length === 0 || selectedDates.includes(r.MatchDate)) &&
                   (selectedLeagues.length === 0 || selectedLeagues.includes(r.League)) &&
                   (selectedAnalyses.length === 0 || selectedAnalyses.includes(r['Match Analysis'])) &&
                   (isNaN(minWinStreak) || winStreak >= minWinStreak) &&
                   (isNaN(maxWinStreak) || winStreak <= maxWinStreak) &&
                   (isNaN(minLoseStreak) || loseStreak >= minLoseStreak) &&
                   (isNaN(maxLoseStreak) || loseStreak <= maxLoseStreak);
        });
    }

    function _getFilteredData(dataToFilter) {
        const getVal = id => document.getElementById(id)?.value.trim() || '';
        const getNum = id => parseFloat(getVal(id));

        const mf = {
            prediction: getVal('mfPredictionFilter'),
            stakeMin: getNum('mfStakeMin'), stakeMax: getNum('mfStakeMax'),
            tipProbMin: getNum('mfTipProbMin'), tipProbMax: getNum('mfTipProbMax'),
            matchTip: getVal('mfMatchTipFilter'),
            homeWinsMin: getNum('mfHomeWinsMin'), homeWinsMax: getNum('mfHomeWinsMax'),
            homeDrawsMin: getNum('mfHomeDrawsMin'), homeDrawsMax: getNum('mfHomeDrawsMax'),
            homeLossesMin: getNum('mfHomeLossesMin'), homeLossesMax: getNum('mfHomeLossesMax'),
            homeScoredMin: getNum('mfHomeScoredMin'), homeScoredMax: getNum('mfHomeScoredMax'),
            homeScoredAvgMin: getNum('mfHomeScoredAvgMin'), homeScoredAvgMax: getNum('mfHomeScoredAvgMax'),
            homeConcededMin: getNum('mfHomeConcededMin'), homeConcededMax: getNum('mfHomeConcededMax'),
            homeConcededAvgMin: getNum('mfHomeConcededAvgMin'), homeConcededAvgMax: getNum('mfHomeConcededAvgMax'),
            awayWinsMin: getNum('mfAwayWinsMin'), awayWinsMax: getNum('mfAwayWinsMax'),
            awayDrawsMin: getNum('mfAwayDrawsMin'), awayDrawsMax: getNum('mfAwayDrawsMax'),
            awayLossesMin: getNum('mfAwayLossesMin'), awayLossesMax: getNum('mfAwayLossesMax'),
            awayScoredMin: getNum('mfAwayScoredMin'), awayScoredMax: getNum('mfAwayScoredMax'),
            awayScoredAvgMin: getNum('mfAwayScoredAvgMin'), awayScoredAvgMax: getNum('mfAwayScoredAvgMax'),
            awayConcededMin: getNum('mfAwayConcededMin'), awayConcededMax: getNum('mfAwayConcededMax'),
            awayConcededAvgMin: getNum('mfAwayConcededAvgMin'), awayConcededAvgMax: getNum('mfAwayConcededAvgMax'),
            winningStreakMin: getNum('mfWinningStreakMin'), winningStreakMax: getNum('mfWinningStreakMax'),
            losingStreakMin: getNum('mfLosingStreakMin'), losingStreakMax: getNum('mfLosingStreakMax'),
            matchAnalysis: getVal('mfMatchAnalysisFilter'),
            totalGoalsPrediction: getVal('mfTotalGoalsPredictionFilter'),
            h2hHomeWinsMin: getNum('mfH2HHomeWinsMin'), h2hHomeWinsMax: getNum('mfH2HHomeWinsMax'),
            h2hAwayWinsMin: getNum('mfH2HAwayWinsMin'), h2hAwayWinsMax: getNum('mfH2HAwayWinsMax'),
            h2hDrawsMin: getNum('mfH2HDrawsMin'), h2hDrawsMax: getNum('mfH2HDrawsMax'),
            homeTeamPositionMin: getNum('mfHomeTeamPositionMin'), homeTeamPositionMax: getNum('mfHomeTeamPositionMax'),
            awayTeamPositionMin: getNum('mfAwayTeamPositionMin'), awayTeamPositionMax: getNum('mfAwayTeamPositionMax'),
        };
        
        let tabDate, model1Pred, minProb1, maxProb1, model2Pred, minProb2, maxProb2, model3Pred, minProb3, maxProb3;
        let tabMinWinStreak, tabMaxWinStreak, tabMinLoseStreak, tabMaxLoseStreak;

        if (currentTab === 'dashboard') {
            tabDate = getVal("dashboardMatchDateFilter");
            tabMinWinStreak = getNum('dashboardMinWinStreak');
            tabMaxWinStreak = getNum('dashboardMaxWinStreak');
            tabMinLoseStreak = getNum('dashboardMinLoseStreak');
            tabMaxLoseStreak = getNum('dashboardMaxLoseStreak');
        } else {
            tabDate = getVal("mainMatchDateFilter");
            model1Pred = getVal("mainModel1PredFilter"); minProb1 = getNum('mainMinProb1'); maxProb1 = getNum('mainMaxProb1');
            model2Pred = getVal("mainModel2PredFilter"); minProb2 = getNum('mainMinProb2'); maxProb2 = getNum('mainMaxProb2');
            model3Pred = getVal("mainModel3PredFilter"); minProb3 = getNum('mainMinProb3'); maxProb3 = getNum('mainMaxProb3');
        }

        let tempFiltered = dataToFilter.filter(r => {
            const checkRange = (val, min, max) => (isNaN(min) || val >= min) && (isNaN(max) || val <= max);
            
            const effectiveMinWin = Math.max(tabMinWinStreak || -Infinity, mf.winningStreakMin || -Infinity);
            const effectiveMaxWin = Math.min(tabMaxWinStreak || Infinity, mf.winningStreakMax || Infinity);
            const effectiveMinLose = Math.max(tabMinLoseStreak || -Infinity, mf.losingStreakMin || -Infinity);
            const effectiveMaxLose = Math.min(tabMaxLoseStreak || Infinity, mf.losingStreakMax || Infinity);

            return (!tabDate || r.MatchDate === tabDate) &&
                   (!model1Pred || r['Predicted Outcome'] === model1Pred) && checkRange(r['Probability (%)'], minProb1, maxProb1) &&
                   (!model2Pred || r['Predicted Outcome3'] === model2Pred) && checkRange(r['Prediction Confidence (%)'], minProb2, maxProb2) &&
                   (!model3Pred || r['Prediction Outcome1'] === model3Pred) && checkRange(r['Winning Probability'], minProb3, maxProb3) &&
                   (!mf.prediction || r['Prediction'] === mf.prediction) && checkRange(r['Stake'], mf.stakeMin, mf.stakeMax) &&
                   checkRange(r['Tip Probability'], mf.tipProbMin, mf.tipProbMax) &&
                   (!mf.matchTip || r['Match Tip'] === mf.matchTip) &&
                   checkRange(r['Home Wins'], mf.homeWinsMin, mf.homeWinsMax) && checkRange(r['Home Draws'], mf.homeDrawsMin, mf.homeDrawsMax) &&
                   checkRange(r['Home Losses'], mf.homeLossesMin, mf.homeLossesMax) && checkRange(r['Home Scored'], mf.homeScoredMin, mf.homeScoredMax) &&
                   checkRange(r['Home Scored (Avg)'], mf.homeScoredAvgMin, mf.homeScoredAvgMax) && checkRange(r['Home Conceded'], mf.homeConcededMin, mf.homeConcededMax) &&
                   checkRange(r['Home Conceded (Avg)'], mf.homeConcededAvgMin, mf.homeConcededAvgMax) && checkRange(r['Away Wins'], mf.awayWinsMin, mf.awayWinsMax) &&
                   checkRange(r['Away Draws'], mf.awayDrawsMin, mf.awayDrawsMax) && checkRange(r['Away Losses'], mf.awayLossesMin, mf.awayLossesMax) &&
                   checkRange(r['Away Scored'], mf.awayScoredMin, mf.awayScoredMax) && checkRange(r['Away Scored (Avg)'], mf.awayScoredAvgMin, mf.awayScoredAvgMax) &&
                   checkRange(r['Away Conceded'], mf.awayConcededMin, mf.awayConcededMax) && checkRange(r['Away Conceded (Avg)'], mf.awayConcededAvgMin, mf.awayConcededAvgMax) &&
                   checkRange(r['Winning Streak'], effectiveMinWin, effectiveMaxWin) && checkRange(r['Losing Streak'], effectiveMinLose, effectiveMaxLose) &&
                   (!mf.matchAnalysis || r['Match Analysis'] === mf.matchAnalysis) && (!mf.totalGoalsPrediction || r['Total Goals Prediction'] == mf.totalGoalsPrediction) &&
                   checkRange(r['H2H Home Wins'], mf.h2hHomeWinsMin, mf.h2hHomeWinsMax) && checkRange(r['H2H Away Wins'], mf.h2hAwayWinsMin, mf.h2hAwayWinsMax) &&
                   checkRange(r['H2H Draws'], mf.h2hDrawsMin, mf.h2hDrawsMax) && checkRange(r['Home Team Position'], mf.homeTeamPositionMin, mf.homeTeamPositionMax) &&
                   checkRange(r['Away Team Position'], mf.awayTeamPositionMin, mf.awayTeamPositionMax);
        });
        
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        if (q) {
            tempFiltered = tempFiltered.filter(r => (r.Match || '').toLowerCase().includes(q));
        }

        return tempFiltered;
    }

    function applyFilters(resetPage = true) {
        if (resetPage) currentPage = 1;
        
        let tempFiltered = _getFilteredData(allMatches);
        
        if (currentTab !== 'dashboard') {
            if (currentTab === 'best') {
                tempFiltered = tempFiltered.filter(r => {
                    const predConf = r['Prediction Confidence (%)'];
                    const predOdds = r['Predicted Odd'];
                    return predConf > 50 && predOdds >= 1.4 && predOdds <= 1.9;
                });
            } else if (currentTab === 'favourites') {
                tempFiltered = tempFiltered.filter(r => {
                    const m1 = r['Predicted Outcome'];
                    const m2 = r['Predicted Outcome3'];
                    const m3 = r['Prediction Outcome1'];
                    return m1 && m1 === m2 && m2 === m3;
                });
            } else if (currentTab === 'yesterday') {
                const y = new Date(); y.setDate(y.getDate() - 1);
                const yesterdayStr = y.toISOString().split('T')[0];
                tempFiltered = tempFiltered.filter(r => r.MatchDate === yesterdayStr);
            }
        }
        
        if (sortConfig.column) {
            tempFiltered.sort((a,b) => {
                let valA = a[sortConfig.column];
                let valB = b[sortConfig.column];
                if (sortConfig.column.startsWith('Probability')) {
                    const keyMap = {'Probability 1': 'Probability (%)', 'Probability 2': 'Prediction Confidence (%)', 'Probability 3': 'Winning Probability', 'Tip Probability': 'Tip Probability'};
                    valA = a[keyMap[sortConfig.column]] || 0;
                    valB = b[keyMap[sortConfig.column]] || 0;
                }
                if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        filteredMatches = tempFiltered;
        if (!['dashboard', 'analytics', 'insights', 'comparison', 'insight-analytics'].includes(currentTab)) {
            updateSummaryCards(filteredMatches);
            renderPredictionSummary(filteredMatches);
        }
        
        if (currentTab === 'analytics') renderAnalytics(filteredMatches);
        else if (currentTab === 'dashboard') renderDashboard();
        else if (!['insights', 'comparison', 'insight-analytics'].includes(currentTab)) renderPaginatedTable(filteredMatches);
    }

    function applyInsightsFilters(resetPage = true) {
        if (resetPage) insightsCurrentPage = 1;
        let tempFiltered = applyGenericFilters(insightsMatches, 'insights');
        
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        if (q) {
            tempFiltered = tempFiltered.filter(r => (r.Match || '').toLowerCase().includes(q));
        }

        if (insightsSortConfig.column) tempFiltered.sort((a,b) => (String(a[insightsSortConfig.column] || '') > String(b[insightsSortConfig.column] || '') ? 1 : -1) * (insightsSortConfig.direction === 'asc' ? 1 : -1));
        filteredInsightsMatches = tempFiltered;
        updateInsightsSummaryCards(filteredInsightsMatches);
        renderInsightsPaginatedTable(filteredInsightsMatches);
    }

    function applyInsightAnalyticsFilters() {
      filteredInsightAnalyticsMatches = applyGenericFilters(allMatches, 'ia');
      renderInsightAnalyticsPage(filteredInsightAnalyticsMatches);
    }
    
    // --- Rendering Functions ---
    function evaluatePrediction(predicted, result) {
      if (!predicted || !result || !result.includes('-')) return null;
      const scores = result.split(/[:-]/).map(s => parseInt(s.trim(), 10));
      if (scores.some(isNaN) || scores.length !== 2) return null;
      const [home, away] = scores;
      const outcome = home > away ? "Home Win" : home < away ? "Away Win" : "Draw";
      if (predicted === "Draw") return outcome === "Draw";
      if (predicted === "Home Win" || predicted === "Home") return outcome === "Home Win";
      if (predicted === "Away Win" || predicted === "Away") return outcome === "Away Win";
      return false;
    }

    const getPredictionBgClass = (isCorrect) => {
        if (isCorrect === null) return '';
        return isCorrect ? 'bg-green-200' : 'bg-red-200';
    };

    const detectOutcome = (res) => {
      if (!res || !res.includes('-')) return null;
      const scores = res.split(/[:-]/).map(Number);
      if (scores.length !== 2) return null;
      if (scores[0] > scores[1]) return 'Home';
      if (scores[0] < scores[1]) return 'Away';
      return 'Draw';
    };

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = data.length ? '' : `<tr><td colspan="16" class="text-center p-4">No matches found.</td></tr>`;
        data.forEach(row => {
            const id = row.uniqueId;
            const isCorrect1 = evaluatePrediction(row['Predicted Outcome'], row.Result);
            const isCorrect2 = evaluatePrediction(row['Predicted Outcome3'], row.Result);
            const isCorrect3 = evaluatePrediction(row['Prediction Outcome1'], row.Result);
            
            const actualOutcome = detectOutcome(row.Result);
            const prediction = row.Prediction;
            let predictionBgClass = '';
            if(actualOutcome && prediction) {
                predictionBgClass = (actualOutcome.toLowerCase() === prediction.toLowerCase()) ? 'bg-green-200' : 'bg-red-200';
            }

            const tr = document.createElement('tr');
            tr.className = 'border-b hover:bg-gray-50';

            let starClass;
            const m1 = row['Predicted Outcome'];
            const m2 = row['Predicted Outcome3'];
            const m3 = row['Prediction Outcome1'];
            const allModelsMatch = m1 && m1 === m2 && m2 === m3;

            if (allModelsMatch) {
                if (!favourites.has(id)) {
                    favourites.add(id);
                    localStorage.setItem('favourites', JSON.stringify([...favourites]));
                }
                starClass = evaluatePrediction(m1, row.Result) === true ? 'star-green' : 'star-blue';
            } else {
                starClass = favourites.has(id) ? 'star-fav' : 'star-normal';
            }

            tr.innerHTML = `
              <td class='p-2 text-center'><button class='fav-btn ${starClass}' data-id='${id}'>★</button></td>
              <td class='p-2'>${row.MatchDate}</td><td class='p-2 font-medium'>${row.Match}</td>
              <td class='p-2 ${getPredictionBgClass(isCorrect1)}'>${row['Predicted Outcome'] || 'N/A'}</td>
              <td class='p-2'>${row['Probability (%)']}%</td>
              <td class='p-2 ${getPredictionBgClass(isCorrect2)}'>${row['Predicted Outcome3'] || 'N/A'}</td>
              <td class='p-2'>${row['Prediction Confidence (%)']}%</td>
              <td class='p-2 font-semibold'>${row['Predicted Odd'] > 0 ? row['Predicted Odd'].toFixed(2) : 'N/A'}</td>
              <td class='p-2 ${getPredictionBgClass(isCorrect3)}'>${row['Prediction Outcome1'] || 'N/A'}</td>
              <td class='p-2'>${row['Winning Probability']}%</td>
              <td class='p-2 ${predictionBgClass}'>${row['Prediction'] || 'N/A'}</td>
              <td class='p-2'>${row['Stake'] || 'N/A'}</td>
              <td class='p-2'>${row['Tip Probability'] || 'N/A'}%</td>
              <td class='p-2'>${row['Match Tip'] || 'N/A'}</td>
              <td class='p-2'>${row.Result || '—'}</td>
              <td class='p-2'><button class='view-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-xs' data-match='${encodeURIComponent(JSON.stringify(row))}'>View</button></td>`;
            tbody.appendChild(tr);
        });
    }

    function renderInsightsTable(data) {
        const tbody = document.getElementById('insightsTableBody');
        const q = document.getElementById('searchInput').value.trim();
        const emptyMessage = q ? 'No matches found for your search.' : 'No matches found.';
        tbody.innerHTML = data.length ? '' : `<tr><td colspan="16" class="text-center p-4">${emptyMessage}</td></tr>`;
        
        data.forEach(row => {
            const id = row.uniqueId;
            const tr = document.createElement('tr');
            tr.className = 'border-b hover:bg-gray-50';
            
            const m1 = row['Predicted Outcome'];
            const m2 = row['Predicted Outcome3'];
            const m3 = row['Prediction Outcome1'];
            const allModelsMatch = m1 && m1 === m2 && m2 === m3;

            let starClass;
            if (allModelsMatch) {
                if (!favourites.has(id)) {
                    favourites.add(id);
                    localStorage.setItem('favourites', JSON.stringify([...favourites]));
                }
                starClass = evaluatePrediction(m1, row.Result) === true ? 'star-green' : 'star-blue';
            } else {
                starClass = favourites.has(id) ? 'star-fav' : 'star-normal';
            }

            const isCorrect1 = evaluatePrediction(m1, row.Result);
            const isCorrect2 = evaluatePrediction(m2, row.Result);
            const isCorrect3 = evaluatePrediction(m3, row.Result);
            
            const actualOutcome = detectOutcome(row.Result);
            const prediction = row.Prediction;
            let predictionBgClass = '';
            if(actualOutcome && prediction) {
                predictionBgClass = (actualOutcome.toLowerCase() === prediction.toLowerCase()) ? 'bg-green-200' : 'bg-red-200';
            }

            tr.innerHTML = `
                <td class='p-2 text-center'><button class='fav-btn ${starClass}' data-id='${id}'>★</button></td>
                <td class='p-2 text-center'><input type="checkbox" class="compare-checkbox" data-id='${id}' ${matchesForComparison.has(id) ? 'checked' : ''}></td>
                <td class='p-2'>${row.MatchDate}</td>
                <td class='p-2 font-medium'>${row.Match}</td>
                <td class='p-2'>${row.Result || '—'}</td>
                <td class='p-2 ${getPredictionBgClass(isCorrect1)}'>${m1 || 'N/A'}</td>
                <td class='p-2'>${row['Probability (%)']}%</td>
                <td class='p-2 ${getPredictionBgClass(isCorrect2)}'>${m2 || 'N/A'}</td>
                <td class='p-2'>${row['Prediction Confidence (%)']}%</td>
                <td class='p-2 ${getPredictionBgClass(isCorrect3)}'>${m3 || 'N/A'}</td>
                <td class='p-2'>${row['Winning Probability']}%</td>
                <td class='p-2 ${predictionBgClass}'>${row['Prediction'] || 'N/A'}</td>
                <td class='p-2'>${row['Stake'] || 'N/A'}</td>
                <td class='p-2'>${row['Tip Probability'] || 'N/A'}%</td>
                <td class='p-2'>${row['Match Tip'] || 'N/A'}</td>
                <td class='p-2'><button class='view-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-xs' data-match='${encodeURIComponent(JSON.stringify(row))}'>View</button></td>`;
            tbody.appendChild(tr);
        });
    }
    
    function renderPaginatedTable(data) {
        const start = (currentPage - 1) * rowsPerPage;
        renderTable(data.slice(start, start + rowsPerPage));
        const totalPages = Math.ceil(data.length / rowsPerPage) || 1;
        document.getElementById('pageIndicator').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prevPageBtn').disabled = currentPage === 1;
        document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
    }

     function renderInsightsPaginatedTable(data) {
        const start = (insightsCurrentPage - 1) * rowsPerPage;
        renderInsightsTable(data.slice(start, start + rowsPerPage));
        const totalPages = Math.ceil(data.length / rowsPerPage) || 1;
        document.getElementById('insightsPageIndicator').textContent = `Page ${insightsCurrentPage} of ${totalPages}`;
        document.getElementById('insightsPrevPageBtn').disabled = insightsCurrentPage === 1;
        document.getElementById('insightsNextPageBtn').disabled = insightsCurrentPage >= totalPages;
    }
    
    function updateSummaryCards(data) {
        const container = document.getElementById('summaryCards');
        if (!data || !container) return;
        const total = data.length;
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        const won1 = completed.filter(r => evaluatePrediction(r['Predicted Outcome'], r.Result)).length;
        const won2 = completed.filter(r => evaluatePrediction(r['Predicted Outcome3'], r.Result)).length;
        const won3 = completed.filter(r => evaluatePrediction(r['Prediction Outcome1'], r.Result)).length;
        
        container.innerHTML = `<div class="summary-card bg-blue-100"><h3>Total Matches</h3><p class="text-blue-800">${total}</p></div><div class="summary-card bg-green-100"><h3>Model 1 Wins</h3><p class="text-green-800">${won1}</p></div><div class="summary-card bg-green-100"><h3>Model 2 Wins</h3><p class="text-green-800">${won2}</p></div><div class="summary-card bg-green-100"><h3>Model 3 Wins</h3><p class="text-green-800">${won3}</p></div>`;
    }

    function renderPredictionSummary(data) {
        const container = document.getElementById('predictionSummaryCard');
        if (!container) return;

        const completed = data.filter(r => r.Result && r.Result.includes('-') && r.Prediction);
        const totalPredictions = completed.length;
        
        let wins = 0;
        completed.forEach(row => {
            const actualOutcome = detectOutcome(row.Result);
            const prediction = row.Prediction;
            if (actualOutcome && prediction && actualOutcome.toLowerCase() === prediction.toLowerCase()) {
                wins++;
            }
        });

        const winPercentage = totalPredictions > 0 ? ((wins / totalPredictions) * 100).toFixed(1) : 0;

        container.innerHTML = `
            <div class="summary-card bg-white col-span-full">
                <h3 class="font-bold text-gray-700">Prediction Summary</h3>
                <div class="flex justify-center items-center gap-8 mt-2">
                    <div>
                        <p class="text-green-600 text-2xl">${wins}</p>
                        <p class="text-sm text-gray-600">Total Wins</p>
                    </div>
                    <div>
                        <p class="text-blue-600 text-2xl">${winPercentage}%</p>
                        <p class="text-sm text-gray-600">Winning Percentage</p>
                    </div>
                </div>
            </div>
        `;
    }

    function updateInsightsSummaryCards(data) {
        const container = document.getElementById('insightsSummaryCards');
        if (!data || !container) return;
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        if (completed.length === 0) { container.innerHTML = `<div class="summary-card bg-gray-100"><h3>Model 1 Wins</h3><p>0 (0%)</p></div><div class="summary-card bg-gray-100"><h3>Model 2 Wins</h3><p>0 (0%)</p></div><div class="summary-card bg-gray-100"><h3>Model 3 Wins</h3><p>0 (0%)</p></div>`; return; }
        const model1Wins = completed.filter(r => evaluatePrediction(r['Predicted Outcome'], r.Result)).length;
        const model2Wins = completed.filter(r => evaluatePrediction(r['Predicted Outcome3'], r.Result)).length;
        const model3Wins = completed.filter(r => evaluatePrediction(r['Prediction Outcome1'], r.Result)).length;
        container.innerHTML = `<div class="summary-card bg-green-100"><h3>Model 1 Wins</h3><p class="text-green-800">${model1Wins} (${((model1Wins / completed.length) * 100).toFixed(0)}%)</p></div><div class="summary-card bg-green-100"><h3>Model 2 Wins</h3><p class="text-green-800">${model2Wins} (${((model2Wins / completed.length) * 100).toFixed(0)}%)</p></div><div class="summary-card bg-green-100"><h3>Model 3 Wins</h3><p class="text-green-800">${model3Wins} (${((model3Wins / completed.length) * 100).toFixed(0)}%)</p></div>`;
    }
    
    function renderAnalytics(data) {
        const container = document.getElementById('analyticsCharts');
        container.innerHTML = '';
        if (!data.length) { container.innerHTML = '<p class="col-span-full text-center py-8 text-gray-500">No data available for analytics.</p>'; return; }
        const chartFields = ['Goals Analysis', 'Winning Probability', 'Probability of 3 Goals', 'Winning Chance', 'Over 3 Goals', 'Match Prediction', 'Outcome Probability', 'Total Goals Prediction'];
        chartFields.forEach(field => {
            const canvasContainer = document.createElement('div');
            canvasContainer.className = 'data-card';
            const chartId = `chart-${field.replace(/[^a-zA-Z0-9]/g, '')}`;
            canvasContainer.innerHTML = `<h3 class="font-semibold text-center mb-2 text-gray-700">${field}</h3><div style="height:300px"><canvas id="${chartId}"></canvas></div>`;
            container.appendChild(canvasContainer);
            const counts = data.reduce((acc, r) => { const val = r[field] || 'N/A'; acc[val] = (acc[val] || 0) + 1; return acc; }, {});
            createChart(chartId, 'bar', field, Object.keys(counts), Object.values(counts));
        });
    }

    function renderDashboard() {
        const completedMatches = allMatches.filter(r => r.Result && r.Result.includes('-'));
        const performanceByDate = completedMatches.reduce((acc, match) => {
            const date = match.MatchDate;
            if (!acc[date]) acc[date] = { model1: 0, model2: 0, model3: 0, model4: 0 };
            if (evaluatePrediction(match['Prediction'], match.Result)) acc[date].model1++;
            if (evaluatePrediction(match['Predicted Outcome'], match.Result)) acc[date].model2++;
            if (evaluatePrediction(match['Prediction Outcome1'], match.Result)) acc[date].model3++;
            if (evaluatePrediction(match['Predicted Outcome3'], match.Result)) acc[date].model4++;
            return acc;
        }, {});

        const dates = Object.keys(performanceByDate).sort();
        
        createChart('model1PerformanceChart', 'bar', 'Wins', dates, dates.map(d => performanceByDate[d].model1), { backgroundColor: '#10b981' });
        createChart('model2PerformanceChart', 'bar', 'Wins', dates, dates.map(d => performanceByDate[d].model2), { backgroundColor: '#4f46e5' });
        createChart('model3PerformanceChart', 'bar', 'Wins', dates, dates.map(d => performanceByDate[d].model3), { backgroundColor: '#f97316' });
        createChart('model4PerformanceChart', 'bar', 'Wins', dates, dates.map(d => performanceByDate[d].model4), { backgroundColor: '#8b5cf6' });

        const container = document.getElementById('dashboardCards');
        container.innerHTML = '';
        const models = [
            { name: 'Model 1', predKey: 'Predicted Outcome' }, { name: 'Model 2', predKey: 'Predicted Outcome3' }, { name: 'Model 3', predKey: 'Prediction Outcome1' },
        ];
        
        models.forEach(model => {
            const modelMatches = allMatches.filter(r => r[model.predKey]);
            const pending = modelMatches.filter(r => !r.Result || !r.Result.includes('-')).length;
            const completed = modelMatches.filter(r => r.Result && r.Result.includes('-'));
            const wins = completed.filter(r => evaluatePrediction(r[model.predKey], r.Result)).length;
            const winPercent = completed.length > 0 ? ((wins / completed.length) * 100).toFixed(1) : 0;
            
            const card = document.createElement('div');
            card.className = 'summary-card bg-white';
            card.innerHTML = `<h3 class="font-bold">${model.name}</h3><p class="text-blue-600">${wins} <span class="text-base font-normal">Wins</span></p><div class="text-sm text-gray-500 mt-2"><span>${winPercent}% Won</span> | <span>${pending} Pending</span></div>`;
            container.appendChild(card);
        });
        
        renderDashboardTables();
    }

    function renderDashboardTables() {
        const filters = {
            table1: r => r['Probability (%)'] > 58 && r['Predicted Odd'] > 1.35,
            table2: r => r['Outcome Probability'] > 58 && r['Predicted Odd'] > 1.35,
            table3: r => r['Prediction Confidence (%)'] > 58 && r['Predicted Odd'] > 1.35,
            table4: r => r['Match Tip'] === 'Home Win'
        };
        
        const filteredData1 = _getFilteredData(allMatches.filter(filters.table1));
        const filteredData2 = _getFilteredData(allMatches.filter(filters.table2));
        const filteredData3 = _getFilteredData(allMatches.filter(filters.table3));
        const filteredData4 = _getFilteredData(allMatches.filter(filters.table4));

        renderDashboardTable('dashboardTable1Container', 'Predicted Outcome', filteredData1, 'Predicted Outcome');
        renderDashboardTable('dashboardTable2Container', 'Prediction Outcome1', filteredData2, 'Prediction Outcome1');
        renderDashboardTable('dashboardTable3Container', 'Predicted Outcome3', filteredData3, 'Predicted Outcome3');
        renderDashboardTable('dashboardTable4Container', 'Match Tip', filteredData4, 'Match Tip');
    }
    
    function renderDashboardTable(containerId, title, data, valueKey) {
        const container = document.getElementById(containerId);
        let tableHTML = `<div class="data-card"><div class="flex justify-between items-center mb-2"><h3 class="font-semibold">${title}</h3></div><div class="overflow-x-auto"><table class="min-w-full text-xs"><thead class="bg-gray-100"><tr><th class="p-2 text-left">Home</th><th class="p-2 text-left">Away</th><th class="p-2 text-left">Date</th><th class="p-2 text-left">${valueKey}</th><th class="p-2 text-left">Result</th><th class="p-2 text-left">View</th></tr></thead><tbody>`;
        if (data.length === 0) tableHTML += `<tr><td colspan="6" class="text-center p-4 text-gray-500">No matching matches.</td></tr>`;
        else data.slice(0, 20).forEach(row => { const teams = row.Match.split(' vs '); tableHTML += `<tr class="border-b"><td class="p-2">${teams[0] || 'N/A'}</td><td class="p-2">${teams[1] || 'N/A'}</td><td class="p-2">${row.MatchDate}</td><td class="p-2">${row[valueKey] || 'N/A'}</td><td class="p-2">${row.Result || '—'}</td><td class="p-2"><button class='view-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-0.5 rounded' data-match='${encodeURIComponent(JSON.stringify(row))}'>View</button></td></tr>`; });
        tableHTML += `</tbody></table></div></div>`;
        container.innerHTML = tableHTML;
    }

    function createChart(id, type, label, labels, data, chartOptions = {}) {
        const ctx = document.getElementById(id)?.getContext('2d');
        if (!ctx) return;
        if (charts[id]) charts[id].destroy();
        const datasets = chartOptions.datasets || [{ label, data, backgroundColor: chartOptions.backgroundColor || ['#3b82f6', '#ef4444', '#22c55e', '#f59e0b', '#8b5cf6', '#6b7280'] }];
        charts[id] = new Chart(ctx, { type, data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: !!chartOptions.datasets } }, scales: type === 'bar' ? { y: { beginAtZero: true, suggestedMax: chartOptions.yMax } } : {} } });
    }

    function showMatchModal(data) {
        const modalContent = document.getElementById('modalContent');
        const getStat = (key, def = 'N/A') => data[key] || def;
        const isCorrect1 = evaluatePrediction(data['Predicted Outcome'], data.Result), isCorrect2 = evaluatePrediction(data['Predicted Outcome3'], data.Result), isCorrect3 = evaluatePrediction(data['Prediction Outcome1'], data.Result);
        const getResultContent = (isCorrect) => isCorrect === null ? `<span class="badge bg-gray-200 text-gray-700">Pending</span>` : isCorrect ? `<span class="badge bg-green-200 text-green-800">Correct ✅</span>` : `<span class="badge bg-red-200 text-red-800">Incorrect ❌</span>`;
        modalContent.innerHTML = `<div class="text-center border-b pb-4 mb-4"><h3 class="text-2xl font-bold">${getStat('Match')}</h3><p class="text-sm text-gray-500">${getStat('MatchDate')}</p><p class="text-lg font-bold mt-2">Result: ${getStat('Result', '—')}</p></div><div class="space-y-4 mb-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="bg-gray-50 p-3 rounded-lg border shadow-sm"><h5 class="font-bold text-gray-700 mb-2 text-center">Home Team Stats</h5><div class="grid grid-cols-3 gap-2 text-center text-sm"><div><p class="text-xs text-gray-500">Wins</p><p class="font-semibold text-base">${getStat('Home Wins')}</p></div><div><p class="text-xs text-gray-500">Draws</p><p class="font-semibold text-base">${getStat('Home Draws')}</p></div><div><p class="text-xs text-gray-500">Losses</p><p class="font-semibold text-base">${getStat('Home Losses')}</p></div></div></div><div class="bg-gray-50 p-3 rounded-lg border shadow-sm"><h5 class="font-bold text-gray-700 mb-2 text-center">Away Team Stats</h5><div class="grid grid-cols-3 gap-2 text-center text-sm"><div><p class="text-xs text-gray-500">Wins</p><p class="font-semibold text-base">${getStat('Away Wins')}</p></div><div><p class="text-xs text-gray-500">Draws</p><p class="font-semibold text-base">${getStat('Away Draws')}</p></div><div><p class="text-xs text-gray-500">Losses</p><p class="font-semibold text-base">${getStat('Away Losses')}</p></div></div></div></div><div class="bg-gray-50 p-3 rounded-lg border shadow-sm"><div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center text-sm"><div><p class="text-xs text-gray-500">Home Scored (Avg)</p><p class="font-semibold">${getStat('Home Scored')} (${getStat('Home Scored (Avg)')})</p></div><div><p class="text-xs text-gray-500">Home Conceded (Avg)</p><p class="font-semibold">${getStat('Home Conceded')} (${getStat('Home Conceded (Avg)')})</p></div><div><p class="text-xs text-gray-500">Away Scored (Avg)</p><p class="font-semibold">${getStat('Away Scored')} (${getStat('Away Scored (Avg)')})</p></div><div><p class="text-xs text-gray-500">Away Conceded (Avg)</p><p class="font-semibold">${getStat('Away Conceded')} (${getStat('Away Conceded (Avg)')})</p></div></div></div><div class="bg-gray-50 p-3 rounded-lg border shadow-sm"><h5 class="font-bold text-gray-700 mb-2 text-center">Odds</h5><div class="grid grid-cols-3 gap-2 text-center text-sm"><div><p class="text-xs text-gray-500">Home Odds</p><p class="font-semibold text-base">${getStat('Home Odds', 'N/A')}</p></div><div><p class="text-xs text-gray-500">Draw Odds</p><p class="font-semibold text-base">${getStat('Draw Odds', 'N/A')}</p></div><div><p class="text-xs text-gray-500">Away Odds</p><p class="font-semibold text-base">${getStat('Away Odds', 'N/A')}</p></div></div></div><div class="bg-gray-50 p-3 rounded-lg border shadow-sm"><h5 class="font-bold text-gray-700 mb-2 text-center">Head-to-Head & Standings</h5><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"><div class="text-center"><p class="text-xs text-gray-500">H2H</p><div class="grid grid-cols-3 gap-1 mt-1"><div><p class="font-semibold text-base">${getStat('H2H Home Wins')}</p><p class="text-xs">Home</p></div><div><p class="font-semibold text-base">${getStat('H2H Draws')}</p><p class="text-xs">Draws</p></div><div><p class="font-semibold text-base">${getStat('H2H Away Wins')}</p><p class="text-xs">Away</p></div></div></div><div class="text-center"><p class="text-xs text-gray-500">League Position</p><div class="grid grid-cols-2 gap-1 mt-1"><div><p class="font-semibold text-base">${getStat('Home Team Position')}</p><p class="text-xs">Home</p></div><div><p class="font-semibold text-base">${getStat('Away Team Position')}</p><p class="text-xs">Away</p></div></div></div></div></div></div><h4 class="text-lg font-semibold text-gray-800 mb-3 text-center">Model Predictions</h4><div class="bg-gray-50 rounded-xl p-4 shadow-inner space-y-2"><div class="flex justify-between items-center py-2 border-b"><span class="flex items-center gap-3 text-sm text-gray-600"><i class="fa-solid fa-bullseye w-5 text-blue-500"></i> Model 1</span><span class="font-semibold">${getStat('Predicted Outcome')} at ${getStat('Probability (%)')}%</span>${getResultContent(isCorrect1)}</div><div class="flex justify-between items-center py-2 border-b"><span class="flex items-center gap-3 text-sm text-gray-600"><i class="fa-solid fa-bullseye w-5 text-indigo-500"></i> Model 2</span><span class="font-semibold">${getStat('Predicted Outcome3')} at ${getStat('Prediction Confidence (%)')}%</span>${getResultContent(isCorrect2)}</div><div class="flex justify-between items-center py-2 border-b"><span class="flex items-center gap-3 text-sm text-gray-600"><i class="fa-solid fa-bullseye w-5 text-purple-500"></i> Model 3</span><span class="font-semibold">${getStat('Prediction Outcome1')} at ${getStat('Winning Probability')}%</span>${getResultContent(isCorrect3)}</div><div class="flex justify-between items-center py-2"><span class="flex items-center gap-3 text-sm text-gray-600"><i class="fa-solid fa-lightbulb w-5 text-yellow-500"></i> Prediction</span><span class="font-semibold">${getStat('Prediction')} (Stake: ${getStat('Stake')})</span></div></div><a href="${getStat('URL', '#')}" target="_blank" class="block text-center mt-6 text-blue-600 hover:underline">View Source <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>`;
        document.getElementById('modal').classList.remove('hidden');
    }
    
    function renderComparisonPage() {
        let currentComparisonData = allMatches.filter(m => matchesForComparison.has(m.uniqueId));
        currentComparisonData = applyGenericFilters(currentComparisonData, 'comparison');
        
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        if (q) currentComparisonData = currentComparisonData.filter(r => (r.Match || '').toLowerCase().includes(q));

        if (comparisonSortConfig.column) currentComparisonData.sort((a,b) => (String(a[comparisonSortConfig.column] || '') > String(b[comparisonSortConfig.column] || '') ? 1 : -1) * (comparisonSortConfig.direction === 'asc' ? 1 : -1));
        updateComparisonStats(currentComparisonData);
        renderComparisonTable(currentComparisonData);
        renderBookmarkSection();
        renderComparisonAnalytics(currentComparisonData);
    }

    function updateComparisonStats(data) {
        const container = document.getElementById('comparisonStatsCards');
        if (!data) return;
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        if (completed.length === 0) { container.innerHTML = `<div class="summary-card bg-gray-100"><h3>Model 1 Win %</h3><p>N/A</p></div><div class="summary-card bg-gray-100"><h3>Model 2 Win %</h3><p>N/A</p></div><div class="summary-card bg-gray-100"><h3>Model 3 Win %</h3><p>N/A</p></div>`; return; }
        const model1Wins = completed.filter(r => evaluatePrediction(r['Predicted Outcome'], r.Result)).length;
        const model2Wins = completed.filter(r => evaluatePrediction(r['Predicted Outcome3'], r.Result)).length;
        const model3Wins = completed.filter(r => evaluatePrediction(r['Prediction Outcome1'], r.Result)).length;
        container.innerHTML = `<div class="summary-card bg-blue-100"><h3>Prediction Model 1 Win %</h3><p class="text-blue-800">${((model1Wins/completed.length)*100).toFixed(0)}%</p></div><div class="summary-card bg-indigo-100"><h3>Prediction Model 2 Win %</h3><p class="text-indigo-800">${((model2Wins/completed.length)*100).toFixed(0)}%</p></div><div class="summary-card bg-purple-100"><h3>Prediction Model 3 Win %</h3><p class="text-purple-800">${((model3Wins/completed.length)*100).toFixed(0)}%</p></div>`;
    }

    function renderComparisonTable(data) {
        const table = document.getElementById('comparisonTable');
        const tbody = document.getElementById('comparisonTableBody');
        const q = document.getElementById('searchInput').value.trim();
        let emptyMessage = 'No matches selected for comparison.';
        if (matchesForComparison.size > 0 && q && data.length === 0) emptyMessage = 'No matches found for your search.';
        tbody.innerHTML = data.length ? '' : `<tr><td colspan="15" class="text-center p-4">${emptyMessage}</td></tr>`;
        
        let wins1 = 0, wins2 = 0, wins3 = 0;
        data.forEach(row => {
            const isCorrect1 = evaluatePrediction(row['Predicted Outcome'], row.Result), isCorrect2 = evaluatePrediction(row['Predicted Outcome3'], row.Result), isCorrect3 = evaluatePrediction(row['Prediction Outcome1'], row.Result);
            if (isCorrect1) wins1++; if (isCorrect2) wins2++; if (isCorrect3) wins3++;
            const actualOutcome = detectOutcome(row.Result), prediction = row.Prediction;
            let predictionBgClass = '';
            if(actualOutcome && prediction) predictionBgClass = (actualOutcome.toLowerCase() === prediction.toLowerCase()) ? 'bg-green-200' : 'bg-red-200';
            const tr = document.createElement('tr');
            tr.className = 'border-b hover:bg-gray-50';
            tr.innerHTML = `<td class="p-2 text-center"><input type="checkbox" class="bookmark-checkbox" data-id="${row.uniqueId}"></td><td class="p-2 font-medium">${row.Match}</td><td class="p-2">${row.MatchDate}</td><td class="p-2 ${getPredictionBgClass(isCorrect1)}">${row['Predicted Outcome']}</td><td class="p-2">${row['Probability (%)']}%</td><td class="p-2 ${getPredictionBgClass(isCorrect2)}">${row['Predicted Outcome3']}</td><td class="p-2">${row['Prediction Confidence (%)']}%</td><td class="p-2 ${getPredictionBgClass(isCorrect3)}">${row['Prediction Outcome1']}</td><td class="p-2">${row['Winning Probability']}%</td><td class='p-2 ${predictionBgClass}'>${row['Prediction'] || 'N/A'}</td><td class='p-2'>${row['Stake'] || 'N/A'}</td><td class='p-2'>${row['Tip Probability'] || 'N/A'}%</td><td class='p-2'>${row['Match Tip'] || 'N/A'}</td><td class="p-2">${row.Result || '—'}</td><td class="p-2 text-center"><button class="remove-comparison-btn text-red-500 hover:text-red-700 text-lg" data-id="${row.uniqueId}" title="Remove">✖</button></td>`;
            tbody.appendChild(tr);
        });
        const existingTfoot = table.querySelector('tfoot'); if (existingTfoot) existingTfoot.remove();
        if (data.length > 0) { const tfoot = table.createTFoot(); const footerRow = tfoot.insertRow(); footerRow.className = 'bg-blue-100 font-bold'; footerRow.innerHTML = `<td class="p-2" colspan="3">Number of Wins</td><td class="p-2 text-center">${wins1}</td><td class="p-2"></td><td class="p-2 text-center">${wins2}</td><td class="p-2"></td><td class="p-2 text-center">${wins3}</td><td class="p-2" colspan="7"></td>`; }
    }

    function renderBookmarkSection() { 
        const container = document.getElementById('bookmarkSection');
        container.innerHTML = '';
        const groupNames = Object.keys(bookmarkedMatches);
        if (groupNames.length === 0) { container.innerHTML = `<div class="data-card mt-8"><h2 class="text-xl font-semibold">Bookmarked Matches</h2><p class="text-gray-500 mt-2">No bookmarks yet. Select matches and click 'Bookmark'.</p></div>`; return; }
        groupNames.sort().forEach(groupName => {
            const groupContainer = document.createElement('div');
            groupContainer.className = 'data-card mt-8';
            const matches = bookmarkedMatches[groupName];
            let wins1 = 0, wins2 = 0, wins3 = 0;
            matches.forEach(row => { if (evaluatePrediction(row['Predicted Outcome'], row.Result)) wins1++; if (evaluatePrediction(row['Predicted Outcome3'], row.Result)) wins2++; if (evaluatePrediction(row['Prediction Outcome1'], row.Result)) wins3++; });
            const page = bookmarkPages[groupName] || 1, totalPages = Math.ceil(matches.length / rowsPerPage) || 1, start = (page - 1) * rowsPerPage, paginatedMatches = matches.slice(start, start + rowsPerPage);
            let tableHTML = `<div class="flex justify-between items-center mb-2"><h2 class="text-xl font-semibold">Bookmarks: ${groupName} (${matches.length})</h2></div><div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-yellow-200"><tr><th class="p-2 text-left">Match</th><th class="p-2 text-left">Date</th><th class="p-2 text-left">Model 1</th><th class="p-2 text-left">Conf 1</th><th class="p-2 text-left">Model 2</th><th class="p-2 text-left">Conf 2</th><th class="p-2 text-left">Model 3</th><th class="p-2 text-left">Conf 3</th><th class="p-2 text-left">Result</th><th class="p-2 text-left">Remove</th></tr></thead><tbody>`;
            paginatedMatches.forEach(row => { tableHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-2 font-medium">${row.Match}</td><td class="p-2">${row.MatchDate}</td><td class="p-2 ${getPredictionBgClass(evaluatePrediction(row['Predicted Outcome'], row.Result))}">${row['Predicted Outcome']}</td><td class="p-2">${row['Probability (%)']}%</td><td class="p-2 ${getPredictionBgClass(evaluatePrediction(row['Predicted Outcome3'], row.Result))}">${row['Predicted Outcome3']}</td><td class="p-2">${row['Prediction Confidence (%)']}%</td><td class="p-2 ${getPredictionBgClass(evaluatePrediction(row['Prediction Outcome1'], row.Result))}">${row['Prediction Outcome1']}</td><td class="p-2">${row['Winning Probability']}%</td><td class="p-2">${row.Result || '—'}</td><td class="p-2 text-center"><button class="remove-bookmark-btn text-red-500 hover:text-red-700" data-id="${row.uniqueId}" data-group="${groupName}">✖</button></td></tr>`; });
            tableHTML += `</tbody>`;
            if (matches.length > 0) tableHTML += `<tfoot class="bg-yellow-100 font-bold"><tr><td class="p-2" colspan="2">Number of Wins</td><td class="p-2 text-center">${wins1}</td><td class="p-2"></td><td class="p-2 text-center">${wins2}</td><td class="p-2"></td><td class="p-2 text-center">${wins3}</td><td class="p-2" colspan="3"></td></tr></tfoot>`;
            tableHTML += `</table></div>`;
            let paginationHTML = `<div class="flex justify-center items-center gap-4 my-3"><button class="bookmark-prev-btn bg-gray-200 px-3 py-1 rounded-md text-xs ${page === 1 ? 'opacity-50' : ''}" data-group="${groupName}" ${page === 1 ? 'disabled' : ''}>Prev</button><span>Page ${page} of ${totalPages}</span><button class="bookmark-next-btn bg-gray-200 px-3 py-1 rounded-md text-xs ${page >= totalPages ? 'opacity-50' : ''}" data-group="${groupName}" ${page >= totalPages ? 'disabled' : ''}>Next</button></div>`;
            groupContainer.innerHTML = tableHTML + paginationHTML;
            container.appendChild(groupContainer);
        });
    }

    function renderComparisonAnalytics(data) { 
        const calculateWinRate = (dataset, modelPredKey, predictionType) => {
            const relevant = dataset.filter(r => r[modelPredKey] === predictionType && r.Result && r.Result.includes('-'));
            if (relevant.length === 0) return 0;
            const wins = relevant.filter(r => evaluatePrediction(r[modelPredKey], r.Result)).length;
            return (wins / relevant.length) * 100;
        };
        const predictionTypes = ['Home Win', 'Away Win', 'Draw'];
        createChart('model1WinRateChart', 'bar', 'Win %', predictionTypes, predictionTypes.map(type => calculateWinRate(data, 'Predicted Outcome', type)));
        createChart('model2WinRateChart', 'bar', 'Win %', predictionTypes, predictionTypes.map(type => calculateWinRate(data, 'Predicted Outcome3', type)));
        createChart('model3WinRateChart', 'bar', 'Win %', predictionTypes, predictionTypes.map(type => calculateWinRate(data, 'Prediction Outcome1', type)));
        const calculateWinsInProbRanges = (dataset, modelPredKey, modelProbKey) => {
            const wins = dataset.filter(r => evaluatePrediction(r[modelPredKey], r.Result));
            const ranges = { '0-50%': 0, '51-70%': 0, '71-100%': 0 };
            wins.forEach(win => { const prob = win[modelProbKey]; if (prob <= 50) ranges['0-50%']++; else if (prob <= 70) ranges['51-70%']++; else ranges['71-100%']++; });
            return Object.values(ranges);
        };
        const probLabels = ['0-50%', '51-70%', '71-100%'];
        const probChartData = { datasets: [ { label: 'Model 1', data: calculateWinsInProbRanges(data, 'Predicted Outcome', 'Probability (%)'), backgroundColor: '#3b82f6' }, { label: 'Model 2', data: calculateWinsInProbRanges(data, 'Predicted Outcome3', 'Prediction Confidence (%)'), backgroundColor: '#8b5cf6' }, { label: 'Model 3', data: calculateWinsInProbRanges(data, 'Prediction Outcome1', 'Winning Probability'), backgroundColor: '#10b981' } ] };
        createChart('probabilityWinChart', 'bar', 'Wins', probLabels, [], probChartData);
    }
    
    // --- INSIGHT ANALYTICS TAB FUNCTIONS ---
    function renderInsightAnalyticsPage(data) {
        updateInsightAnalyticsSummaryCards(data);
        renderOverviewTable(data);
        renderModelCategoryGraphs(data);
        renderProbabilityWinsGraphs(data);
    }

    function getModelStats(data) {
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        const models = [
            { name: 'Model 1', predKey: 'Predicted Outcome', wins: 0, matches: 0 },
            { name: 'Model 2', predKey: 'Predicted Outcome3', wins: 0, matches: 0 },
            { name: 'Model 3', predKey: 'Prediction Outcome1', wins: 0, matches: 0 },
        ];
        models.forEach(model => {
            const modelMatches = completed.filter(r => r[model.predKey]);
            model.matches = modelMatches.length;
            model.wins = modelMatches.filter(r => evaluatePrediction(r[model.predKey], r.Result)).length;
            model.winRate = model.matches > 0 ? (model.wins / model.matches) * 100 : 0;
        });
        return { models, totalMatches: data.length, totalCompleted: completed.length };
    }

    function updateInsightAnalyticsSummaryCards(data) {
        const container = document.getElementById('insightAnalyticsSummaryCards');
        const { models, totalMatches } = getModelStats(data);
        const totalWinRate = models.reduce((acc, m) => acc + m.winRate, 0) / models.length;
        const bestModel = models.reduce((best, current) => current.winRate > best.winRate ? current : best, models[0]);
        container.innerHTML = `<div class="summary-card bg-blue-100"><h3>Total Matches Analyzed</h3><p class="text-blue-800">${totalMatches}</p></div><div class="summary-card bg-yellow-100"><h3>Avg. Win Rate</h3><p class="text-yellow-800">${totalWinRate.toFixed(1)}%</p></div><div class="summary-card bg-green-100"><h3>Best Performing Model</h3><p class="text-green-800">${bestModel.name} (${bestModel.winRate.toFixed(1)}%)</p></div>`;
    }

    function renderOverviewTable(data) {
        const container = document.getElementById('iaOverviewTableContainer');
        const categories = ['Home Win', 'Draw', 'Away Win'];
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        let tableHTML = `<h2 class="text-xl font-semibold mb-4">Model Performance Overview</h2><div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-gray-100"><tr class="text-left"><th class="p-2 font-semibold">Model</th><th class="p-2 font-semibold">Category</th><th class="p-2 font-semibold">Total Wins</th><th class="p-2 font-semibold">Total Matches</th><th class="p-2 font-semibold">Win Percentage</th></tr></thead><tbody>`;
        ['Model 1', 'Model 2', 'Model 3'].forEach(modelName => {
            categories.forEach(cat => {
                const predKey = modelName === 'Model 1' ? 'Predicted Outcome' : modelName === 'Model 2' ? 'Predicted Outcome3' : 'Prediction Outcome1';
                const catMatches = completed.filter(r => r[predKey] === cat);
                const totalCatMatches = catMatches.length;
                const totalCatWins = catMatches.filter(r => evaluatePrediction(r[predKey], r.Result)).length;
                const winPercent = totalCatMatches > 0 ? ((totalCatWins / totalCatMatches) * 100).toFixed(1) + '%' : 'N/A';
                tableHTML += `<tr class="border-b"><td class="p-2">${modelName}</td><td class="p-2">${cat}</td><td class="p-2">${totalCatWins}</td><td class="p-2">${totalCatMatches}</td><td class="p-2">${winPercent}</td></tr>`;
            });
        });
        tableHTML += `</tbody></table></div>`;
        container.innerHTML = tableHTML;
    }

    function renderModelCategoryGraphs(data) {
        const categories = ['Home Win', 'Draw', 'Away Win'];
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        const calcWinRate = (predKey, cat) => {
            const catMatches = completed.filter(r => r[predKey] === cat);
            if (catMatches.length === 0) return 0;
            const wins = catMatches.filter(r => evaluatePrediction(r[predKey], r.Result)).length;
            return (wins / catMatches.length) * 100;
        };
        createChart('iaModel1CatChart', 'bar', 'Win %', categories, categories.map(cat => calcWinRate('Predicted Outcome', cat)), { yMax: 100 });
        createChart('iaModel2CatChart', 'bar', 'Win %', categories, categories.map(cat => calcWinRate('Predicted Outcome3', cat)), { yMax: 100 });
        createChart('iaModel3CatChart', 'bar', 'Win %', categories, categories.map(cat => calcWinRate('Prediction Outcome1', cat)), { yMax: 100 });
    }

    function renderProbabilityWinsGraphs(data) {
        const probLabels = ['0-50%', '51-70%', '71-100%'];
        const calcWinsInRanges = (predKey, probKey) => {
            const wins = data.filter(r => evaluatePrediction(r[predKey], r.Result));
            const ranges = { '0-50%': 0, '51-70%': 0, '71-100%': 0 };
            wins.forEach(win => { const prob = win[probKey]; if (prob <= 50) ranges['0-50%']++; else if (prob <= 70) ranges['51-70%']++; else ranges['71-100%']++; });
            return Object.values(ranges);
        };
        const generateChartForModel = (chartId, predKey, probKey) => {
            const modelData = calcWinsInRanges(predKey, probKey);
            createChart(chartId, 'bar', '# of Wins', probLabels, modelData);
        };
        generateChartForModel('iaModel1ProbChart', 'Predicted Outcome', 'Probability (%)');
        generateChartForModel('iaModel2ProbChart', 'Predicted Outcome3', 'Prediction Confidence (%)');
        generateChartForModel('iaModel3ProbChart', 'Prediction Outcome1', 'Winning Probability');
    }

    // --- Setup Event Listeners ---
    function setupEventListeners() {
        document.getElementById('refreshBtn').addEventListener('click', loadData);
        
        document.querySelectorAll('#original-tabs .tab-btn').forEach(btn => btn.addEventListener('click', e => {
            currentTab = e.currentTarget.dataset.tab;
            if (currentTab === 'insights') applyInsightsFilters();
            else if (currentTab === 'comparison') renderComparisonPage();
            else if (currentTab === 'insight-analytics') applyInsightAnalyticsFilters();
            else applyFilters();
        }));

        document.getElementById('mainClearFilters').addEventListener('click', () => {
             const form = document.querySelector('#mainContent .data-card');
             form.querySelectorAll('select, input').forEach(el => { el.value = ''; });
             applyFilters();
        });

        ['insightsClearFilters', 'comparisonClearFilters', 'iaClearFilters'].forEach(id => {
            document.getElementById(id)?.addEventListener('click', (e) => {
                const form = e.target.closest('.data-card');
                form.querySelectorAll('select, input').forEach(el => {
                    if (el.type === 'number') el.value = '';
                    else if (el.multiple) Array.from(el.options).forEach(o => o.selected = false);
                    else el.value = '';
                });
                if (id.startsWith('insights')) applyInsightsFilters();
                else if (id.startsWith('comparison')) renderComparisonPage();
                else if (id.startsWith('ia')) applyInsightAnalyticsFilters();
            });
        });
        
        const mainFilterHandler = () => { clearTimeout(filterTimeout); filterTimeout = setTimeout(applyFilters, 300); };
        document.querySelectorAll('#mainContent select, #mainContent input').forEach(el => { el.addEventListener('input', mainFilterHandler); el.addEventListener('change', mainFilterHandler); });
        
        const filterHandler = (tab) => { clearTimeout(filterTimeout); filterTimeout = setTimeout(() => { if (tab === 'insights') applyInsightsFilters(); else if (tab === 'comparison') renderComparisonPage(); else if (tab === 'ia') applyInsightAnalyticsFilters(); }, 300); };
        ['insights', 'comparison', 'ia'].forEach(prefix => {
            ['MatchDateFilter', 'LeagueFilter', 'AnalysisFilter'].forEach(filter => document.getElementById(`${prefix}${filter}`)?.addEventListener('change', () => filterHandler(prefix)));
            ['MinWinStreak', 'MaxWinStreak', 'MinLoseStreak', 'MaxLoseStreak'].forEach(filter => document.getElementById(`${prefix}${filter}`)?.addEventListener('input', () => filterHandler(prefix)));
        });
        
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                switch (currentTab) {
                    case 'insights': applyInsightsFilters(); break;
                    case 'comparison': renderComparisonPage(); break;
                    case 'dashboard': renderDashboard(); break;
                    default: applyFilters(); break;
                }
            }, 300);
        });
        
        document.body.addEventListener('click', e => {
            const viewBtn = e.target.closest('.view-btn');
            if (viewBtn) showMatchModal(JSON.parse(decodeURIComponent(viewBtn.dataset.match)));
            if (e.target.id === 'closeModal' || e.target.id === 'modal') document.getElementById('modal').classList.add('hidden');
            const favBtn = e.target.closest('.fav-btn');
            if (favBtn) { const id = favBtn.dataset.id; if(favourites.has(id)) favourites.delete(id); else favourites.add(id); localStorage.setItem('favourites', JSON.stringify([...favourites])); if (currentTab === 'insights') applyInsightsFilters(false); else applyFilters(false); }
            if (e.target.matches('.compare-checkbox')) { const id = e.target.dataset.id; if (e.target.checked) matchesForComparison.add(id); else matchesForComparison.delete(id); }
            const removeBookmarkBtn = e.target.closest('.remove-bookmark-btn');
            if (removeBookmarkBtn) { const {id, group} = removeBookmarkBtn.dataset; bookmarkedMatches[group] = bookmarkedMatches[group].filter(m => m.uniqueId !== id); if(bookmarkedMatches[group].length === 0) delete bookmarkedMatches[group]; localStorage.setItem('bookmarkedMatches', JSON.stringify(bookmarkedMatches)); renderComparisonPage(); }
            const removeComparisonBtn = e.target.closest('.remove-comparison-btn');
            if (removeComparisonBtn) { const id = removeComparisonBtn.dataset.id; matchesForComparison.delete(id); renderComparisonPage(); const insightsCheckbox = document.querySelector(`#insightsTableBody .compare-checkbox[data-id='${id}']`); if (insightsCheckbox) insightsCheckbox.checked = false; }
            const prevBookmarkBtn = e.target.closest('.bookmark-prev-btn');
            if (prevBookmarkBtn) { const group = prevBookmarkBtn.dataset.group; if(bookmarkPages[group] > 1) bookmarkPages[group]--; renderBookmarkSection(); }
            const nextBookmarkBtn = e.target.closest('.bookmark-next-btn');
            if (nextBookmarkBtn) { const group = nextBookmarkBtn.dataset.group; const totalPages = Math.ceil((bookmarkedMatches[group] || []).length / rowsPerPage); if(!bookmarkPages[group]) bookmarkPages[group] = 1; if(bookmarkPages[group] < totalPages) bookmarkPages[group]++; renderBookmarkSection(); }
        });

        document.getElementById('tableHeaders').addEventListener('click', e => {
            const th = e.target.closest('th[data-column]');
            if(!th) return;
            const column = th.dataset.column;
            document.querySelectorAll('#tableHeaders th').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
            sortConfig.direction = (sortConfig.column === column && sortConfig.direction === 'asc') ? 'desc' : 'asc';
            sortConfig.column = column;
            th.classList.add(sortConfig.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
            applyFilters(false);
        });

        document.getElementById('dashboardMoreFiltersBtn').addEventListener('click', () => document.getElementById('moreFiltersModal').classList.remove('hidden'));
        document.getElementById('closeMoreFiltersModal').addEventListener('click', () => document.getElementById('moreFiltersModal').classList.add('hidden'));
        document.getElementById('applyMoreFilters').addEventListener('click', () => { if (currentTab === 'dashboard') renderDashboard(); else if (currentTab === 'insights') applyInsightsFilters(); else applyFilters(); document.getElementById('moreFiltersModal').classList.add('hidden'); });
        document.getElementById('resetMoreFilters').addEventListener('click', () => { document.getElementById('moreFiltersModal').querySelectorAll('input[type="number"], select').forEach(el => el.value = ''); if (currentTab === 'dashboard') renderDashboard(); else applyFilters(); });

        const dashboardFilterHandler = () => { clearTimeout(filterTimeout); filterTimeout = setTimeout(renderDashboard, 300); };
        ['dashboardMatchDateFilter', 'dashboardMinWinStreak', 'dashboardMaxWinStreak', 'dashboardMinLoseStreak', 'dashboardMaxLoseStreak'].forEach(id => { const el = document.getElementById(id); if (el) { el.addEventListener('input', dashboardFilterHandler); el.addEventListener('change', dashboardFilterHandler); } });
        document.getElementById('dashboardClearFilters').addEventListener('click', () => { document.getElementById('dashboardMatchDateFilter').value = ''; document.getElementById('dashboardMinWinStreak').value = ''; document.getElementById('dashboardMaxWinStreak').value = ''; document.getElementById('dashboardMinLoseStreak').value = ''; document.getElementById('dashboardMaxLoseStreak').value = ''; document.getElementById('moreFiltersModal').querySelectorAll('input[type="number"], select').forEach(el => el.value = ''); renderDashboard(); });

        ['prevPageBtn', 'nextPageBtn'].forEach(id => document.getElementById(id).addEventListener('click', e => { const totalPages = Math.ceil(filteredMatches.length/rowsPerPage); if(e.target.id==='nextPageBtn' && currentPage < totalPages) currentPage++; else if(e.target.id==='prevPageBtn' && currentPage > 1) currentPage--; renderPaginatedTable(filteredMatches); }));
        ['insightsPrevPageBtn', 'insightsNextPageBtn'].forEach(id => document.getElementById(id).addEventListener('click', e => { const totalPages = Math.ceil(filteredInsightsMatches.length/rowsPerPage); if(e.target.id==='insightsNextPageBtn' && insightsCurrentPage < totalPages) insightsCurrentPage++; else if(e.target.id==='insightsPrevPageBtn' && insightsCurrentPage > 1) insightsCurrentPage--; renderInsightsPaginatedTable(filteredInsightsMatches); }));
        
        document.getElementById('bookmarkBtn').addEventListener('click', () => { if (document.querySelectorAll('.bookmark-checkbox:checked').length > 0) document.getElementById('bookmarkNameModal').classList.remove('hidden'); else alert('Please select at least one match to bookmark.'); });
        ['closeBookmarkModal', 'cancelBookmark'].forEach(id => document.getElementById(id).addEventListener('click', () => { document.getElementById('bookmarkGroupName').value = ''; document.getElementById('bookmarkNameModal').classList.add('hidden'); }));
        document.getElementById('saveBookmark').addEventListener('click', () => {
            const groupName = document.getElementById('bookmarkGroupName').value.trim();
            if (!groupName) { alert('Please enter a group name.'); return; }
            if (!bookmarkedMatches[groupName]) bookmarkedMatches[groupName] = [];
            const existingIds = new Set(bookmarkedMatches[groupName].map(m => m.uniqueId));
            const selectedIds = new Set(Array.from(document.querySelectorAll('#comparisonTableBody .bookmark-checkbox:checked')).map(cb => cb.dataset.id));
            const matchesToAdd = allMatches.filter(m => selectedIds.has(m.uniqueId) && !existingIds.has(m.uniqueId));
            bookmarkedMatches[groupName].push(...matchesToAdd);
            localStorage.setItem('bookmarkedMatches', JSON.stringify(bookmarkedMatches));
            document.querySelectorAll('#comparisonTableBody .bookmark-checkbox:checked').forEach(cb => cb.checked = false);
            document.getElementById('selectAllBookmark').checked = false;
            document.getElementById('bookmarkGroupName').value = '';
            document.getElementById('bookmarkNameModal').classList.add('hidden');
            renderComparisonPage();
        });
        document.getElementById('selectAllBookmark').addEventListener('click', e => document.querySelectorAll('#comparisonTableBody .bookmark-checkbox').forEach(cb => cb.checked = e.target.checked));
    }

    // --- Initial Load ---
    window.addEventListener('load', () => {
      favourites = new Set(JSON.parse(localStorage.getItem('favourites') || '[]'));
      bookmarkedMatches = JSON.parse(localStorage.getItem('bookmarkedMatches') || '{}');
      setupEventListeners();
      loadData();
      document.querySelector('.nav-item[data-tab="dashboard"]').click();
    });
  </script>
</body>
</html>
