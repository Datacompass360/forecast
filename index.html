<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataCompass 360 - Smart Football Insights</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for Dashboard & In-depth Analysis -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF & Excel Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>

    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        // Tailwind CSS Configuration
        tailwind.config = {
            darkMode: 'class', // Enable dark mode
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#3f51b5',
                        'primary-purple': '#673ab7',
                        'accent-green': '#00c853',
                        'accent-orange': '#ff9800',
                        // Light theme colors
                        'base-bg': '#f4f7fa',
                        'panel-bg': '#ffffff',
                        'filter-panel-bg': '#eef3f9',
                        'text-primary': '#0a0a2a',
                        'text-secondary': '#4a5568',
                        // Dark theme colors
                        'dark-base-bg': '#1a202c',
                        'dark-panel-bg': '#2d3748',
                        'dark-filter-panel-bg': '#252c3a',
                        'dark-text-primary': '#f7fafc',
                        'dark-text-secondary': '#a0aec0',
                    },
                    borderRadius: { 'xl': '14px' },
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        :root {
            --glow-color-blue: rgba(63, 81, 181, 0.4);
            --glow-color-green: rgba(0, 200, 83, 0.5);
            --naviblue: #3f51b5; /* Navy Blue from login page */
        }
        body { 
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(to bottom, #d1fae5, #ffffff);
        }
        .dark body {
             background: var(--dark-base-bg);
        }


        /* Keyframe animations */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes twinkle {
            0% { box-shadow: 0 0 6px var(--glow-color-green), 0 0 12px var(--glow-color-green); }
            50% { box-shadow: 0 0 18px var(--glow-color-green), 0 0 30px var(--glow-color-green); }
            100% { box-shadow: 0 0 6px var(--glow-color-green), 0 0 12px var(--glow-color-green); }
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes dash { to { stroke-dashoffset: 0; } }

        /* Navigation Tabs Styling */
        .nav-tabs-container { position: relative; display: flex; align-items: center; justify-content: center; }
        .nav-tab { transition: color 0.3s ease, background-color 0.3s ease, transform 0.2s ease; }
        .nav-tab.active { transform: translateY(-2px); }
        #nav-underline { transition: left 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), width 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }

        /* Modal styling */
        .modal-backdrop { 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease; 
        }
        .modal-backdrop.active { 
            opacity: 1;
            pointer-events: auto;
            animation: fadeIn 0.3s ease forwards; 
        }
        .modal-content {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        .modal-content.active { 
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Table styles */
        .table-row-hover:hover { 
            transform: scale(1.01); 
            transition: transform 0.2s ease, background-color 0.2s ease;
            cursor: pointer; 
        }
        .pinned-row { border-left: 4px solid var(--accent-orange) !important; }
        
        .interactive-glow:hover {
            box-shadow: 0 0 15px var(--glow-color-blue);
            transform: translateY(-2px);
            transition: all 0.2s ease-out;
        }

        .glow-win { animation: twinkle 3s 1 ease-in-out; } /* Animate once for 3 seconds */

        /* Animated Logo Styles */
        #animated-logo .compass-needle { transform-origin: center; animation: spin 8s linear infinite; }
        #animated-logo .graph-line { stroke-dasharray: 100; stroke-dashoffset: 100; animation: dash 3s ease-in-out infinite alternate; }

        /* Collapsible Section */
        .collapsible-content { max-height: 1000px; transition: max-height 0.5s ease-out, padding 0.5s ease-out, margin 0.5s ease-out; overflow: hidden; }
        .collapsible-content.collapsed { max-height: 0; padding-top: 0; padding-bottom: 0; margin-top: 0 !important; }
        .collapse-icon { transition: transform 0.3s ease; }
        .collapsed .collapse-icon { transform: rotate(-90deg); }
        
        /* Tooltip for quick stats */
        #quick-stats-tooltip {
            position: fixed;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 100;
        }
        
        /* Less Risky Table Styling */
        .less-risky-table {
            border-collapse: collapse;
            width: 100%;
        }
        .less-risky-table th, .less-risky-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .less-risky-table th {
            background-color: #004d40; /* Dark green */
            color: white;
            font-weight: bold;
        }
        .less-risky-table tr:nth-child(even) {
            background-color: #f2f2f2; /* Light gray */
        }
        .dark .less-risky-table tr:nth-child(even) {
            background-color: #374151;
        }
        .dark .less-risky-table th, .dark .less-risky-table td {
             border-color: #4a5568;
        }

        /* --- Login Page Styles --- */
        .form-container {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .strength-bar {
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        .text-naviblue {
            color: var(--naviblue);
        }
        .compass-container {
            animation: compass-load-pulse 0.8s ease-out forwards;
        }
        .compass {
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #f0fdf4 50%, #dcfce7 100%);
            border: 4px solid #10b981;
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: compass-glow 3s infinite ease-in-out;
        }
        .needle {
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 40px solid #ef4444; /* Red */
            position: absolute;
            top: 6px;
            transform-origin: bottom center;
            animation: swing 3s infinite ease-in-out;
        }
        .needle::after {
            content: '';
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 24px solid #4b5563; /* Gray */
            position: absolute;
            bottom: -40px;  
            left: -5px;
        }
        @keyframes swing {
            0%, 100% { transform: rotate(-15deg); }
            50% { transform: rotate(15deg); }
        }
        @keyframes compass-load-pulse {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }
        @keyframes compass-glow {
            0%, 100% { box-shadow: 0 0 8px #10b981, inset 0 0 5px rgba(0,0,0,0.1); }
            50% { box-shadow: 0 0 16px #34d399, inset 0 0 8px rgba(0,0,0,0.2); }
        }

    </style>
</head>
<body class="bg-base-bg text-text-primary dark:bg-dark-base-bg dark:text-dark-text-primary transition-colors duration-300">

    <!-- Authentication Container -->
    <div id="auth-view" class="min-h-screen flex flex-col items-center justify-center p-4 hidden">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <div class="compass-container w-24 h-24 mx-auto mb-4 flex items-center justify-center">
                    <div class="compass">
                        <div class="needle"></div>
                    </div>
                </div>
                <h1 class="text-4xl md:text-5xl font-bold text-naviblue">DataCompass 360</h1>
            </div>
            <div class="bg-white rounded-2xl shadow-2xl p-8">
                <div class="flex border-b border-gray-200 mb-6">
                    <button id="login-tab" class="w-1/2 py-3 text-center font-semibold text-emerald-600 border-b-2 border-emerald-600 transition-colors duration-300">Login</button>
                    <button id="signup-tab" class="w-1/2 py-3 text-center font-semibold text-gray-500 transition-colors duration-300">Sign Up</button>
                </div>
                <div id="auth-message-box" class="hidden p-3 mb-4 text-sm rounded-lg text-center font-medium"></div>
                <div id="login-form" class="form-container">
                    <form onsubmit="handleLogin(event)">
                        <div class="mb-4">
                            <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            <input type="email" id="login-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" required>
                        </div>
                        <div class="mb-4 relative">
                            <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" required>
                            <span class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer top-7" onclick="togglePasswordVisibility('login-password', this)">
                               <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            </span>
                        </div>
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <input id="remember-me" type="checkbox" class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                <label for="remember-me" class="ml-2 block text-sm text-gray-900">Remember me</label>
                            </div>
                            <a href="#" onclick="handleForgotPassword(event)" class="text-sm font-medium text-emerald-600 hover:text-emerald-500">Forgot Password?</a>
                        </div>
                        <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 shadow-lg">Login</button>
                        <div class="my-4 flex items-center">
                            <div class="flex-grow border-t border-gray-300"></div><span class="flex-shrink mx-4 text-gray-400">or</span><div class="flex-grow border-t border-gray-300"></div>
                        </div>
                         <button type="button" onclick="handleGoogleLogin()" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-50 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300 shadow-lg flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691c-1.219 2.456-1.91 5.21-1.91 8.13s.691 5.674 1.91 8.13l-5.657 5.657C.252 32.553 0 28.461 0 24c0-4.461.252-8.553 1.074-12.309L6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-5.657-5.657C30.01 35.083 27.202 36 24 36c-5.222 0-9.641-3.341-11.288-7.938l-5.657 5.657C9.043 40.023 15.959 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083L43.595 20H24v8h11.303a12.04 12.04 0 0 1-4.087 7.585l5.657 5.657C41.386 36.626 44 30.636 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                            Sign in with Google
                        </button>
                    </form>
                </div>
                <div id="signup-form" class="hidden form-container">
                    <form onsubmit="handleSignup(event)">
                        <div class="mb-4">
                            <label for="signup-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                            <input type="text" id="signup-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" required>
                        </div>
                        <div class="mb-4">
                            <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            <input type="email" id="signup-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" required>
                        </div>
                        <div class="mb-4 relative">
                            <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="signup-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" oninput="checkPasswordStrength(this.value)" required>
                             <span class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer top-7" onclick="togglePasswordVisibility('signup-password', this)">
                               <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            </span>
                        </div>
                        <div class="mb-4">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="strength-bar" class="strength-bar bg-red-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <p id="strength-text" class="text-xs text-gray-500 mt-1"></p>
                        </div>
                        <div class="mb-6 relative">
                            <label for="signup-confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                            <input type="password" id="signup-confirm-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" required>
                             <span class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer top-7" onclick="togglePasswordVisibility('signup-confirm-password', this)">
                               <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            </span>
                        </div>
                        <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 shadow-lg">Create Account</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Application Container -->
    <div id="app-container" class="hidden">
        <!-- Top Bar: Logo + Navigation -->
        <div class="max-w-7xl mx-auto mb-6 flex justify-between items-center px-4">
            <div id="animated-logo" class="w-16 h-16 flex-shrink-0">
                 <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="45" fill="none" class="stroke-text-primary dark:stroke-dark-text-primary" stroke-width="4"/>
                    <path class="graph-line" d="M 20 60 Q 40 30, 60 50 T 80 40" fill="none" stroke="#00c853" stroke-width="4" stroke-linecap="round"/>
                    <g class="compass-needle"><path d="M 50 10 L 45 50 L 50 90 L 55 50 Z" fill="#ef4444"/><path d="M 50 10 L 45 50 L 50 90 L 55 50 Z" fill-opacity="0.5" fill="white"/></g>
                    <circle cx="50" cy="50" r="5" class="fill-text-primary dark:fill-dark-text-primary"/>
                </svg>
            </div>

            <div id="nav-container" class="nav-tabs-container flex-grow">
                <div id="nav-tabs" class="flex space-x-2 p-1 bg-gray-200/50 dark:bg-gray-700/50 rounded-full">
                    <!-- Navigation Tabs -->
                    <button id="tab-dashboard" onclick="handleTabClick('dashboard', this)" class="nav-tab flex items-center py-2 px-5 text-sm font-bold bg-panel-bg text-text-primary dark:bg-dark-panel-bg dark:text-dark-text-primary rounded-full shadow-sm"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>📊 Dashboard</button>
                    <button id="tab-less-risky" onclick="handleTabClick('less-risky', this)" class="nav-tab flex items-center py-2 px-5 text-sm font-bold bg-panel-bg text-text-primary dark:bg-dark-panel-bg dark:text-dark-text-primary rounded-full shadow-sm"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>🛡️ Less Risky</button>
                    <button id="tab-all" onclick="handleTabClick('all', this)" class="nav-tab flex items-center py-2 px-5 text-sm font-bold bg-panel-bg text-text-primary dark:bg-dark-panel-bg dark:text-dark-text-primary rounded-full shadow-sm"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>⚽ All Matches</button>
                    <button id="tab-best" onclick="handleTabClick('best', this)" class="nav-tab flex items-center py-2 px-5 text-sm font-bold bg-panel-bg text-text-primary dark:bg-dark-panel-bg dark:text-dark-text-primary rounded-full shadow-sm"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>🎯 Best Tips</button>
                    <button id="tab-extrapolation" onclick="handleTabClick('extrapolation', this)" class="nav-tab flex items-center py-2 px-5 text-sm font-bold bg-panel-bg text-text-primary dark:bg-dark-panel-bg dark:text-dark-text-primary rounded-full shadow-sm"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>📈 Winning Extrapolation</button>
                    <button id="tab-favorites" onclick="handleTabClick('favorites', this)" class="nav-tab flex items-center py-2 px-5 text-sm font-bold bg-panel-bg text-text-primary dark:bg-dark-panel-bg dark:text-dark-text-primary rounded-full shadow-sm"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>⭐ Favorites</button>
                </div>
                <div id="nav-underline" class="absolute bottom-[-8px] h-[3px] bg-gradient-to-r from-primary-blue to-primary-purple rounded-full"></div>
            </div>

            <div class="w-16 h-16 flex-shrink-0 flex items-center justify-end space-x-2">
                <button id="dark-mode-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-text-primary dark:text-dark-text-primary">
                    <svg id="sun-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 12a5 5 0 100-10 5 5 0 000 10z"></path></svg>
                    <svg id="moon-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
                <button onclick="handleLogout()" class="p-2 rounded-full bg-red-500 text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                </button>
            </div>
        </div>
        
        <div class="max-w-7xl mx-auto">
            <!-- Main Header -->
            <header class="mb-8 p-8 bg-gradient-to-br from-primary-blue to-primary-purple shadow-2xl rounded-xl text-center overflow-hidden">
                <h1 class="text-4xl md:text-5xl font-extrabold text-white mt-4">DataCompass 360</h1>
                <p class="text-white/80 mt-2 text-sm md:text-base">Welcome, <span id="user-name"></span>! Smart Football Insights Dashboard</p>
            </header>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="mb-6 p-4 bg-blue-100 dark:bg-blue-900/50 border border-blue-200 dark:border-blue-700 text-sm font-medium text-text-primary dark:text-dark-text-primary rounded-xl flex items-center justify-center hidden"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-primary-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></path><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Loading Data...</div>

            <!-- Filters Panel (Collapsible) -->
            <div id="filters-container" class="mb-6 bg-filter-panel-bg dark:bg-dark-filter-panel-bg shadow-xl rounded-xl relative hidden">
                <div id="filters-header" class="p-4 cursor-pointer flex justify-between items-center">
                    <h2 class="text-2xl font-extrabold text-text-primary dark:text-dark-text-primary flex items-center"><svg class="w-6 h-6 mr-3 text-primary-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414A1 1 0 0012 15.586V21h-2v-5.414a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>Refine Insights</h2>
                    <svg class="w-6 h-6 collapse-icon text-text-secondary dark:text-dark-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div id="filters-panel" class="collapsible-content p-6 pt-0">
                     <div class="flex justify-between items-center mb-6">
                        <div></div> <!-- Spacer -->
                        <button onclick="clearFilters()" class="px-4 py-2 text-sm font-bold bg-red-500 text-white rounded-lg hover:bg-red-600 transition flex items-center interactive-glow"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>Clear Filters</button>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                          <div class="relative"><label class="block text-sm font-semibold text-text-secondary dark:text-dark-text-secondary mb-2">Search</label><input type="text" id="team-search-input" placeholder="e.g., Chelsea" class="w-full p-3 bg-panel-bg dark:bg-dark-panel-bg border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm" oninput="handleFilterChange()"></div>
                          <div class="relative"><label class="block text-sm font-semibold text-text-secondary dark:text-dark-text-secondary mb-2">Match Date</label><select id="filter-date" onchange="handleFilterChange()" class="w-full p-3 bg-panel-bg dark:bg-dark-panel-bg border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm"></select></div>
                          <div class="relative"><label class="block text-sm font-semibold text-text-secondary dark:text-dark-text-secondary mb-2">League</label><select id="filter-league" onchange="handleFilterChange()" class="w-full p-3 bg-panel-bg dark:bg-dark-panel-bg border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm"></select></div>
                          <div class="relative"><label class="block text-sm font-semibold text-text-secondary dark:text-dark-text-secondary mb-2">Prediction</label><select id="filter-prediction" onchange="handleFilterChange()" class="w-full p-3 bg-panel-bg dark:bg-dark-panel-bg border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm"></select></div>
                          <div class="relative"><label class="block text-sm font-semibold text-text-secondary dark:text-dark-text-secondary mb-2">Correct Score</label><select id="filter-correct-score" onchange="handleFilterChange()" class="w-full p-3 bg-panel-bg dark:bg-dark-panel-bg border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm"></select></div>
                          <div class="relative"><label class="block text-sm font-semibold text-text-secondary dark:text-dark-text-secondary mb-2">Match Analysis</label><select id="filter-match-analysis" onchange="handleFilterChange()" class="w-full p-3 bg-panel-bg dark:bg-dark-panel-bg border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm"></select></div>
                          <div class="relative"><label class="block text-sm font-semibold text-text-secondary dark:text-dark-text-secondary mb-2">Goals Analysis</label><select id="filter-goals-analysis" onchange="handleFilterChange()" class="w-full p-3 bg-panel-bg dark:bg-dark-panel-bg border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm"></select></div>
                          <div class="relative"><label class="block text-sm font-semibold text-text-secondary dark:text-dark-text-secondary mb-2">Home Odds (Min)</label><input type="number" id="filter-home-odds" placeholder="e.g., 1.5" class="w-full p-3 bg-panel-bg dark:bg-dark-panel-bg border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm" oninput="handleFilterChange()"></div>
                          <div class="relative col-span-1 md:col-span-1">
                            <label class="block text-sm font-semibold text-text-secondary dark:text-dark-text-secondary mb-2">Stake</label>
                            <div class="flex space-x-2">
                                <input type="number" id="filter-stake-min" placeholder="Min" class="w-1/2 p-3 bg-panel-bg dark:bg-dark-panel-bg border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm" oninput="handleFilterChange()">
                                <input type="number" id="filter-stake-max" placeholder="Max" class="w-1/2 p-3 bg-panel-bg dark:bg-dark-panel-bg border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm" oninput="handleFilterChange()">
                            </div>
                          </div>
                          <div class="relative col-span-1 md:col-span-1">
                            <label class="block text-sm font-semibold text-text-secondary dark:text-dark-text-secondary mb-2">Winning Streak</label>
                            <div class="flex space-x-2">
                                <input type="number" id="filter-winning-streak-min" placeholder="Min" class="w-1/2 p-3 bg-panel-bg dark:bg-dark-panel-bg border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm" oninput="handleFilterChange()">
                                <input type="number" id="filter-winning-streak-max" placeholder="Max" class="w-1/2 p-3 bg-panel-bg dark:bg-dark-panel-bg border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm" oninput="handleFilterChange()">
                            </div>
                          </div>
                          <div class="relative col-span-1 md:col-span-1">
                            <label class="block text-sm font-semibold text-text-secondary dark:text-dark-text-secondary mb-2">Losing Streak</label>
                            <div class="flex space-x-2">
                                <input type="number" id="filter-losing-streak-min" placeholder="Min" class="w-1/2 p-3 bg-panel-bg dark:bg-dark-panel-bg border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm" oninput="handleFilterChange()">
                                <input type="number" id="filter-losing-streak-max" placeholder="Max" class="w-1/2 p-3 bg-panel-bg dark:bg-dark-panel-bg border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm" oninput="handleFilterChange()">
                            </div>
                          </div>
                     </div>
                 </div>
                 <button onclick="showFilterModal()" class="absolute -bottom-5 right-6 px-5 py-3 bg-accent-orange text-white font-bold rounded-full shadow-lg hover:bg-accent-orange/90 transition flex items-center interactive-glow"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6V4m0 16v-2m8-6h2m-16 0H4m14.243-7.757l1.414-1.414M5.343 18.657l-1.414 1.414m14.142 0l-1.414-1.414M6.757 5.343l-1.414-1.414M12 18a6 6 0 100-12 6 6 0 000 12z"></path></svg>More Filters</button>
            </div>

            <!-- Main Content Area -->
            <div id="main-content" class="hidden">
                <div id="table-container" class="bg-panel-bg dark:bg-dark-panel-bg shadow-2xl rounded-xl overflow-hidden mt-8">
                    <div class="overflow-x-auto">
                        <table id="data-table" class="min-w-full">
                            <thead class="sticky top-0 z-10 bg-panel-bg dark:bg-dark-panel-bg"><tr></tr></thead>
                            <tbody id="table-body" class="divide-y divide-gray-200/50 dark:divide-gray-700"></tbody>
                            <tfoot id="table-footer" class="hidden bg-gray-50 dark:bg-gray-700"></tfoot>
                        </table>
                    </div>
                    <div id="message-box" class="p-8 text-center hidden"><p class="text-lg font-semibold text-text-primary dark:text-dark-text-primary">No data found.</p></div>
                </div>
                <!-- Summary Table Container -->
                <div id="summary-table-container" class="bg-filter-panel-bg dark:bg-dark-filter-panel-bg shadow-xl rounded-xl overflow-hidden">
                     <div id="summary-content"></div>
                </div>
                <div id="pagination-controls" class="mt-6 flex justify-between items-center hidden"></div>
            </div>
            
            <!-- Dashboard Content -->
            <div id="dashboard-content" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="p-6 bg-panel-bg dark:bg-dark-panel-bg rounded-xl shadow-lg"><h3 class="text-sm font-bold text-text-secondary">WIN RATE</h3><p id="stat-win-rate" class="text-3xl font-extrabold text-accent-green mt-1">0%</p></div>
                    <div class="p-6 bg-panel-bg dark:bg-dark-panel-bg rounded-xl shadow-lg"><h3 class="text-sm font-bold text-text-secondary">PREDICTION ACCURACY</h3><p id="stat-accuracy" class="text-3xl font-extrabold text-text-primary dark:text-dark-text-primary mt-1">0%</p></div>
                    <div class="p-6 bg-panel-bg dark:bg-dark-panel-bg rounded-xl shadow-lg"><h3 class="text-sm font-bold text-text-secondary">TOTAL TIPS</h3><p id="stat-total-tips" class="text-3xl font-extrabold text-gray-700 dark:text-gray-300 mt-1">0</p></div>
                    <div class="p-6 bg-panel-bg dark:bg-dark-panel-bg rounded-xl shadow-lg"><h3 class="text-sm font-bold text-text-secondary">TOP TIP</h3><p id="stat-top-tip" class="text-xl font-bold text-text-primary dark:text-dark-text-primary mt-1">N/A</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 place-items-center">
                    <div class="p-6 bg-panel-bg dark:bg-dark-panel-bg rounded-xl shadow-lg w-full flex flex-col items-center"><h3 class="text-lg font-bold text-text-primary dark:text-dark-text-primary mb-4">Outcome Distribution</h3><div class="relative w-full max-w-[480px] aspect-square"><canvas id="outcome-pie-chart"></canvas></div></div>
                    <div class="p-6 bg-panel-bg dark:bg-dark-panel-bg rounded-xl shadow-lg w-full flex flex-col items-center"><h3 class="text-lg font-bold text-text-primary dark:text-dark-text-primary mb-4">Prediction vs. Result</h3><div class="relative w-full max-w-[480px] aspect-square"><canvas id="prediction-bar-chart"></canvas></div></div>
                </div>
            </div>
            
            <!-- Less Risky Content -->
            <div id="less-risky-content" class="hidden p-4 md:p-6 bg-panel-bg dark:bg-dark-panel-bg rounded-xl shadow-2xl">
                <div class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-extrabold text-text-primary dark:text-dark-text-primary">Less Risky Picks Dashboard</h1>
                    <p class="text-text-secondary dark:text-dark-text-secondary mt-2">Filtered daily insights from WinnersPredict & HeroPredict</p>
                </div>

                <!-- Date Filter and Navigation -->
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 p-4 bg-filter-panel-bg dark:bg-dark-filter-panel-bg rounded-lg shadow">
                    <div class="flex items-center space-x-2 mb-4 md:mb-0">
                        <button onclick="filterLessRiskyByDate('yesterday')" class="px-4 py-2 text-sm font-bold bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition">Yesterday</button>
                        <button onclick="filterLessRiskyByDate('today')" class="px-4 py-2 text-sm font-bold bg-primary-blue text-white rounded-lg hover:bg-primary-purple transition">Today</button>
                        <button onclick="filterLessRiskyByDate('tomorrow')" class="px-4 py-2 text-sm font-bold bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition">Tomorrow</button>
                    </div>
                    <div class="relative">
                        <label for="less-risky-date-filter" class="text-sm font-semibold text-text-secondary dark:text-dark-text-secondary mr-2">Select Date:</label>
                        <select id="less-risky-date-filter" onchange="filterLessRiskyByDate(this.value)" class="p-2 bg-panel-bg dark:bg-dark-panel-bg border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm"></select>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="p-6 bg-white dark:bg-dark-panel-bg rounded-xl shadow-lg flex items-center space-x-4"><div class="text-3xl">🏟️</div><div><h3 class="text-sm font-bold text-text-secondary dark:text-dark-text-secondary">TOTAL MATCHES TODAY</h3><p id="lr-stat-total-matches" class="text-3xl font-extrabold text-primary-blue mt-1">0</p></div></div>
                    <div class="p-6 bg-white dark:bg-dark-panel-bg rounded-xl shadow-lg flex items-center space-x-4"><div class="text-3xl">📊</div><div><h3 class="text-sm font-bold text-text-secondary dark:text-dark-text-secondary">TIPS DISTRIBUTION</h3><p id="lr-stat-tips-dist" class="text-lg font-bold text-text-primary dark:text-dark-text-primary mt-1">N/A</p></div></div>
                    <div class="p-6 bg-white dark:bg-dark-panel-bg rounded-xl shadow-lg flex items-center space-x-4"><div class="text-3xl">📈</div><div><h3 class="text-sm font-bold text-text-secondary dark:text-dark-text-secondary">WIN RATE YESTERDAY</h3><p id="lr-stat-win-rate" class="text-3xl font-extrabold text-accent-green mt-1">0%</p></div></div>
                </div>

                <!-- Tables Side by Side -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-text-primary dark:text-dark-text-primary">Winners</h2>
                        <div class="overflow-x-auto rounded-lg shadow">
                            <table id="winners-table" class="less-risky-table min-w-full">
                                <thead><tr><th>Date</th><th>League</th><th>Time</th><th>Home Team</th><th>Away Team</th><th>Tip</th><th>Score</th></tr></thead>
                                <tbody id="winners-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-text-primary dark:text-dark-text-primary">Hero</h2>
                        <div class="overflow-x-auto rounded-lg shadow">
                             <table id="hero-table" class="less-risky-table min-w-full">
                                <thead><tr><th>Date</th><th>League</th><th>Time</th><th>Home Team</th><th>Away Team</th><th>Tip</th><th>Score</th></tr></thead>
                                <tbody id="hero-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                 <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="p-6 bg-white dark:bg-dark-panel-bg rounded-xl shadow-lg w-full flex flex-col items-center"><h3 class="text-lg font-bold text-text-primary dark:text-dark-text-primary mb-4">Distribution of Tips</h3><div class="relative w-full max-w-[400px] aspect-square"><canvas id="lr-tip-pie-chart"></canvas></div></div>
                    <div class="p-6 bg-white dark:bg-dark-panel-bg rounded-xl shadow-lg w-full flex flex-col items-center"><h3 class="text-lg font-bold text-text-primary dark:text-dark-text-primary mb-4">Daily Matches (Last 7 Days)</h3><div class="relative w-full h-64"><canvas id="lr-daily-matches-chart"></canvas></div></div>
                </div>
            </div>

            <!-- Favorites Content -->
            <div id="favorites-content" class="hidden">
                <div class="bg-panel-bg dark:bg-dark-panel-bg shadow-2xl rounded-xl overflow-hidden p-6">
                     <div class="flex justify-between items-center mb-4">
                         <h2 class="text-2xl font-extrabold text-text-primary dark:text-dark-text-primary">⭐ Your Favorite Matches</h2>
                         <div class="flex space-x-2">
                            <button onclick="exportFavorites('pdf')" class="px-4 py-2 text-sm font-bold bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg interactive-glow">PDF</button>
                            <button onclick="exportFavorites('csv')" class="px-4 py-2 text-sm font-bold bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg interactive-glow">CSV</button>
                            <button onclick="exportFavorites('xlsx')" class="px-4 py-2 text-sm font-bold bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg interactive-glow">Excel</button>
                         </div>
                     </div>
                     <div id="favorites-table-container" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="details-modal" class="modal-backdrop" onclick="hideDetailsModal(event)"></div>
    <div id="more-filters-modal" class="modal-backdrop" onclick="hideFilterModal(event)"></div>

    <!-- Tooltip -->
    <div id="quick-stats-tooltip" class="p-3 bg-gray-800 text-white text-sm rounded-lg shadow-lg"></div>

    <script type="text/javascript">
    const { jsPDF } = window.jspdf;

    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyB7P5UCzyp5dnMO0E81PQwp5esUDNFCKzg",
        authDomain: "datacompass360-3b5d9.firebaseapp.com",
        projectId: "datacompass360-3b5d9",
        storageBucket: "datacompass360-3b5d9.appspot.com",
        messagingSenderId: "836940314719",
        appId: "1:836940314719:web:7088bbdf2a6c446dddc3ea",
        measurementId: "G-PSE21XN3KL"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // --- Configuration ---
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH-Uue5Ctuo4aU-4S81U9QvoXxslOq6YjKHnVkPjyOeJqci4p19cs2iZ8y5GgzsSh_vQHxPYb-gl-5/pub?gid=0&single=true&output=csv';
    const LESS_RISKY_XLSX_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQjoi3SalPo7WPlbc67fZ16gWU98v7ctwZeQ5zfiFOJGqwzPGfnV_cu_Em6hPazADOAgH6pEeXWE-yw/pub?output=xlsx';

    const HIDDEN_COLUMNS = ['Home Team', 'Away Team', 'Home Wins', 'Home Draws', 'Home Losses', 'Away Wins', 'Away Draws', 'Away Losses', 'Home Avg Scored', 'Home Conceded', 'Home Avg Conceded', 'Away Avg Scored', 'Away Conceded', 'Away Avg Conceded', 'Match Analysis', 'Goals Analysis'];
    const COLUMN_MAP = [
        { key: 'Match Date', label: 'Date' }, { key: 'League', label: 'League' }, { key: 'Match', label: 'Match' }, { key: 'Prediction', label: 'Prediction' }, { key: 'Outcome', label: 'Outcome' }, { key: 'Result', label: 'Result' }, { key: 'Correct Score', label: 'Score' }, { key: 'Home Odds', label: '1', type: 'number' }, { key: 'Draw Odds', label: 'X', type: 'number' }, { key: 'Away Odds', label: '2', type: 'number' }, 
        { key: 'Home Team', type: 'string' }, { key: 'Away Team', type: 'string' }, { key: 'Winning Streak', type: 'number' }, { key: 'Losing Streak', type: 'number' }, { key: 'Stake', type: 'number' }, { key: 'Home Wins', type: 'number' }, { key: 'Home Draws', type: 'number' }, { key: 'Home Losses', type: 'number' }, { key: 'Away Wins', type: 'number' }, { key: 'Away Draws', type: 'number' }, { key: 'Away Losses', type: 'number' }, { key: 'Home Team Scored', type: 'number' }, { key: 'Home Avg Scored', type: 'number' }, { key: 'Home Conceded', type: 'number' }, { key: 'Home Avg Conceded', type: 'number' }, { key: 'Away Team Scored', type: 'number' }, { key: 'Away Avg Scored', type: 'number' }, { key: 'Away Conceded', type: 'number' }, { key: 'Away Avg Conceded', type: 'number' }, { key: 'Match Analysis', type: 'string' }, { key: 'Goals Analysis', type: 'string' }
    ];
    
    // --- STATE MANAGEMENT ---
    let allData = [], currentData = [], favorites = [], pinnedMatches = [], viewedRows = new Set(), outcomeChart, predictionChart, filteredFavorites = [], lostMatches = new Set();
    let winnersData = [], heroData = [];
    let lrTipPieChart, lrDailyMatchesChart;
    let sortColumn = 'Match Date', sortDirection = 'desc', rowsPerPage = 30, currentPage = 1, activeTab = 'dashboard';
    const initialFilters = { 
        league: 'All', prediction: 'All', teamSearch: '', matchDate: 'All Dates', homeOddsMin: null,
        correctScore: 'All',
        stake: {min: null, max: null},
        winningStreak: {min: null, max: null},
        losingStreak: {min: null, max: null},
        matchAnalysis: 'All',
        goalsAnalysis: 'All',
        homeWins: {min: null, max: null}, homeDraws: {min: null, max: null}, homeLosses: {min: null, max: null},
        awayWins: {min: null, max: null}, awayDraws: {min: null, max: null}, awayLosses: {min: null, max: null},
        homeAvgScored: {min: null, max: null}, homeAvgConceded: {min: null, max: null},
        awayAvgScored: {min: null, max: null}, awayAvgConceded: {min: null, max: null},
        homeOdds: {min: null, max: null}, drawOdds: {min: null, max: null}, awayOdds: {min: null, max: null},
        predictionOdds: {min: null, max: null}
    };
    let filters = { ...initialFilters };

    // --- DOM ELEMENTS ---
    const dom = {
        html: document.documentElement,
        authView: document.getElementById('auth-view'),
        appContainer: document.getElementById('app-container'),
        userName: document.getElementById('user-name'),
        loading: document.getElementById('loading-indicator'),
        mainContent: document.getElementById('main-content'),
        dashboardContent: document.getElementById('dashboard-content'),
        lessRiskyContent: document.getElementById('less-risky-content'),
        favoritesContent: document.getElementById('favorites-content'),
        tableBody: document.getElementById('table-body'),
        tableHeadRow: document.querySelector('#data-table thead tr'),
        tableFooter: document.getElementById('table-footer'),
        messageBox: document.getElementById('message-box'),
        pagination: document.getElementById('pagination-controls'),
        navUnderline: document.getElementById('nav-underline'),
        detailsModal: document.getElementById('details-modal'),
        filtersModal: document.getElementById('more-filters-modal'),
        filtersContainer: document.getElementById('filters-container'),
        filtersPanel: document.getElementById('filters-panel'),
        filtersHeader: document.getElementById('filters-header'),
        summaryContainer: document.getElementById('summary-table-container'),
        summaryContent: document.getElementById('summary-content'),
        tooltip: document.getElementById('quick-stats-tooltip'),
        darkModeToggle: document.getElementById('dark-mode-toggle'),
        sunIcon: document.getElementById('sun-icon'),
        moonIcon: document.getElementById('moon-icon'),
        loginTab: document.getElementById('login-tab'),
        signupTab: document.getElementById('signup-tab'),
        loginForm: document.getElementById('login-form'),
        signupForm: document.getElementById('signup-form'),
        authMessageBox: document.getElementById('auth-message-box'),
    };
    
    // --- ICONS ---
    const ICONS = {
        goal: '⚽', shield: '🛡️', streak: '🔥', pin: '📌', star: '⭐', starOutline: '☆'
    };

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        setupAuthListeners();
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                dom.userName.textContent = user.displayName || user.email;
                dom.authView.classList.add('hidden');
                dom.appContainer.classList.remove('hidden');
                initializeApp(); 
            } else {
                // User is signed out
                dom.authView.classList.remove('hidden');
                dom.appContainer.classList.add('hidden');
            }
        });
    });

    function setupAuthListeners() {
        dom.loginTab.addEventListener('click', () => {
            dom.loginTab.classList.add('text-emerald-600', 'border-emerald-600');
            dom.loginTab.classList.remove('text-gray-500');
            dom.signupTab.classList.add('text-gray-500');
            dom.signupTab.classList.remove('text-emerald-600', 'border-emerald-600');
            dom.loginForm.classList.remove('hidden');
            dom.signupForm.classList.add('hidden');
            hideAuthMessage();
        });

        dom.signupTab.addEventListener('click', () => {
            dom.signupTab.classList.add('text-emerald-600', 'border-emerald-600');
            dom.signupTab.classList.remove('text-gray-500');
            dom.loginTab.classList.add('text-gray-500');
            dom.loginTab.classList.remove('text-emerald-600', 'border-emerald-600');
            dom.signupForm.classList.remove('hidden');
            dom.loginForm.classList.add('hidden');
            hideAuthMessage();
        });
    }

    async function initializeApp() {
        if (allData.length > 0) return; // Already initialized

        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            dom.html.classList.add('dark');
            if(dom.sunIcon) dom.sunIcon.classList.add('hidden');
            if(dom.moonIcon) dom.moonIcon.classList.remove('hidden');
        }
        if(dom.darkModeToggle) dom.darkModeToggle.addEventListener('click', toggleDarkMode);
        if(dom.filtersHeader) dom.filtersHeader.addEventListener('click', () => {
            dom.filtersContainer.classList.toggle('collapsed');
            dom.filtersPanel.classList.toggle('collapsed');
        });
        dom.loading.classList.remove('hidden');
        try {
            const [csvResponse, _] = await Promise.all([
                fetch(CSV_URL),
                loadLessRiskyData() // Fire and forget, will update UI when done
            ]);
            
            if (!csvResponse.ok) throw new Error('Network response was not ok for main data');
            const csvText = await csvResponse.text();
            allData = parseCSV(csvText);
            const savedFavorites = JSON.parse(localStorage.getItem('favorites')) || [];
            favorites = allData.filter(item => savedFavorites.includes(item.uniqueId));
            const savedPins = JSON.parse(localStorage.getItem('pinnedMatches')) || [];
            pinnedMatches = allData.filter(item => savedPins.includes(item.uniqueId)).map(i => i.uniqueId);
            buildAdvancedFiltersModal();
            populateFilterDropdowns();
            const initialTab = document.getElementById('tab-dashboard');
            if (initialTab) handleTabClick('dashboard', initialTab);
            else updateUiForTab();
        } catch (error) {
            console.error('Failed to load or parse data:', error);
            dom.mainContent.innerHTML = `<p class="text-center text-red-500">Error loading data.</p>`;
        } finally {
            dom.loading.classList.add('hidden');
        }
    }

    // --- AUTHENTICATION LOGIC ---
    function showAuthMessage(message, isError = false) {
        dom.authMessageBox.textContent = message;
        dom.authMessageBox.classList.remove('hidden');
        dom.authMessageBox.className = 'p-3 mb-4 text-sm rounded-lg text-center font-medium ';
        if (isError) {
            dom.authMessageBox.classList.add('bg-red-100', 'text-red-700');
        } else {
            dom.authMessageBox.classList.add('bg-green-100', 'text-green-700');
        }
    }
    
    function hideAuthMessage() {
        dom.authMessageBox.classList.add('hidden');
    }

    async function handleSignup(event) {
        event.preventDefault();
        const name = document.getElementById('signup-name').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const confirmPassword = document.getElementById('signup-confirm-password').value;
        
        if (password !== confirmPassword) {
            showAuthMessage("Passwords do not match.", true);
            return;
        }

        const strength = checkPasswordStrength(password, true);
        if (strength < 75) {
             showAuthMessage("Password is not strong enough.", true);
             return;
        }

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            await userCredential.user.updateProfile({
                displayName: name
            });
            showAuthMessage("Account created successfully! Logging you in...", false);
        } catch (error) {
            showAuthMessage(error.message, true);
        }
    }

    async function handleLogin(event) {
        event.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const rememberMe = document.getElementById('remember-me').checked;

        try {
            const persistence = rememberMe ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;
            await auth.setPersistence(persistence);
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            showAuthMessage(error.message, true);
        }
    }
    
    async function handleGoogleLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
            await auth.signInWithPopup(provider);
        } catch(error) {
            showAuthMessage(error.message, true);
        }
    }

    async function handleForgotPassword(event) {
        event.preventDefault();
        const email = document.getElementById('login-email').value;
        if (!email) {
            showAuthMessage("Please enter your email address to reset your password.", true);
            return;
        }
        try {
            await auth.sendPasswordResetEmail(email);
            showAuthMessage("Password reset email sent! Please check your inbox.", false);
        } catch (error) {
            showAuthMessage(error.message, true);
        }
    }
    
    function handleLogout() {
        auth.signOut();
    }

    function togglePasswordVisibility(fieldId, iconElement) {
        const passwordField = document.getElementById(fieldId);
        const isPassword = passwordField.type === "password";
        passwordField.type = isPassword ? "text" : "password";
        
        iconElement.innerHTML = isPassword 
            ? '<svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064-7 9.542-7 1.428 0 2.793.371 4.038 1.037M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.582 17.582A8.948 8.948 0 0112 19c-4.478 0-8.268-2.943-9.542-7a13.94 13.94 0 013.958-5.323M15 12a3 3 0 11-6 0 3 3 0 016 0zM1 1l22 22"></path></svg>'
            : '<svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>';
    }

    function checkPasswordStrength(password, forSubmit = false) {
        let score = 0;
        const strengthBar = document.getElementById('strength-bar');
        const strengthText = document.getElementById('strength-text');
        
        const hasLength = password.length >= 8;
        const hasNumber = /\d/.test(password);
        const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
        const hasUpper = /[A-Z]/.test(password);
        const hasLower = /[a-z]/.test(password);

        if (hasLength) score += 20;
        if (hasNumber) score += 20;
        if (hasSpecial) score += 20;
        if (hasUpper) score += 20;
        if (hasLower) score += 20;
        
        if (forSubmit) return score;

        strengthBar.style.width = score + '%';
        
        if (score < 50) {
            strengthBar.className = 'strength-bar bg-red-500 h-2.5 rounded-full';
            strengthText.textContent = 'Weak. Needs 8+ chars, a number, and a symbol.';
        } else if (score < 75) {
            strengthBar.className = 'strength-bar bg-yellow-500 h-2.5 rounded-full';
            strengthText.textContent = 'Medium. Consider adding uppercase letters.';
        } else {
            strengthBar.className = 'strength-bar bg-emerald-500 h-2.5 rounded-full';
            strengthText.textContent = 'Strong!';
        }

        return score;
    }


    // --- DARK MODE ---
    function toggleDarkMode() {
        dom.html.classList.toggle('dark');
        dom.sunIcon.classList.toggle('hidden');
        dom.moonIcon.classList.toggle('hidden');
        localStorage.setItem('theme', dom.html.classList.contains('dark') ? 'dark' : 'light');
        if (activeTab === 'dashboard' && allData.length > 0) renderDashboard(currentData);
        if (activeTab === 'less-risky') {
            filterLessRiskyByDate(document.getElementById('less-risky-date-filter').value);
        }
    }
    
    // --- PARSING & FILTERING ---
    const parseCSV = (csvText) => {
        const lines = csvText.trim().split("\n");
        const headers = lines[0].split(",").map(h => h.trim().replace(/"/g, ""));
        return lines.slice(1).map(line => {
            if (!line.trim()) return null;
            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ''));
            const rowObject = {};
            COLUMN_MAP.forEach(col => {
                const index = headers.indexOf(col.key);
                if (index !== -1 && values[index] !== undefined) {
                    rowObject[col.key] = col.type === 'number' ? (isNaN(parseFloat(values[index])) ? null : parseFloat(values[index])) : values[index];
                } else {
                    rowObject[col.key] = col.type === 'number' ? null : "";
                }
            });
            rowObject.uniqueId = `${rowObject.Match}-${rowObject['Match Date']}`;
            return rowObject;
        }).filter(row => row && row.Match);
    };

    const applyFilters = () => {
        currentPage = 1;
        let sourceData;
        
        switch(activeTab) {
            case 'favorites':
                sourceData = favorites;
                break;
            case 'less-risky':
                // This tab has its own filtering logic
                return; 
            default:
                sourceData = allData;
        }

        let filteredData = sourceData;

        if (activeTab === 'best') {
            const bestTipsValues = ["Best Away Tip", "Best Home Tip", "Home Tip", "Good Away Tip", "Home Good Tip", "Away Tip"];
            filteredData = filteredData.filter(item => bestTipsValues.includes(item["Match Analysis"]));
        }
        
        const searchTerm = filters.teamSearch.toLowerCase().trim();
        if (searchTerm) filteredData = filteredData.filter(item => item.Match.toLowerCase().includes(searchTerm));
        if (filters.league !== 'All') filteredData = filteredData.filter(item => item.League === filters.league);
        if (filters.prediction !== 'All') filteredData = filteredData.filter(item => item.Prediction === filters.prediction);
        if (filters.matchDate !== 'All Dates') filteredData = filteredData.filter(item => item['Match Date'] === filters.matchDate);
        if (filters.correctScore !== 'All') filteredData = filteredData.filter(item => item['Correct Score'] === filters.correctScore);
        if (filters.homeOddsMin) filteredData = filteredData.filter(item => item['Home Odds'] >= filters.homeOddsMin);

        if (filters.matchAnalysis !== 'All') filteredData = filteredData.filter(item => item['Match Analysis'] === filters.matchAnalysis);
        if (filters.goalsAnalysis !== 'All') filteredData = filteredData.filter(item => item['Goals Analysis'] === filters.goalsAnalysis);
        
        if (filters.stake.min !== null) filteredData = filteredData.filter(item => (item['Stake'] || 0) >= filters.stake.min);
        if (filters.stake.max !== null) filteredData = filteredData.filter(item => (item['Stake'] || 0) <= filters.stake.max);

        if (filters.winningStreak.min !== null) filteredData = filteredData.filter(item => (item['Winning Streak'] || 0) >= filters.winningStreak.min);
        if (filters.winningStreak.max !== null) filteredData = filteredData.filter(item => (item['Winning Streak'] || 0) <= filters.winningStreak.max);
        
        if (filters.losingStreak.min !== null) filteredData = filteredData.filter(item => (item['Losing Streak'] || 0) >= filters.losingStreak.min);
        if (filters.losingStreak.max !== null) filteredData = filteredData.filter(item => (item['Losing Streak'] || 0) <= filters.losingStreak.max);

        const rangeFilters = [
            { key: 'homeWins', dataKey: 'Home Wins' }, { key: 'homeDraws', dataKey: 'Home Draws' }, { key: 'homeLosses', dataKey: 'Home Losses' },
            { key: 'awayWins', dataKey: 'Away Wins' }, { key: 'awayDraws', dataKey: 'Away Draws' }, { key: 'awayLosses', dataKey: 'Away Losses' },
            { key: 'homeAvgScored', dataKey: 'Home Avg Scored' }, { key: 'homeAvgConceded', dataKey: 'Home Avg Conceded' },
            { key: 'awayAvgScored', dataKey: 'Away Avg Scored' }, { key: 'awayAvgConceded', dataKey: 'Away Avg Conceded' },
            { key: 'homeOdds', dataKey: 'Home Odds' }, { key: 'drawOdds', dataKey: 'Draw Odds' }, { key: 'awayOdds', dataKey: 'Away Odds' }
        ];
        rangeFilters.forEach(f => {
            const range = filters[f.key];
            if (range) {
                if (range.min !== null) filteredData = filteredData.filter(item => (item[f.dataKey] || 0) >= range.min);
                if (range.max !== null) filteredData = filteredData.filter(item => (item[f.dataKey] || 0) <= range.max);
            }
        });
        
        currentData = filteredData;
        if (activeTab === 'dashboard') renderDashboard(currentData);
        else if (activeTab === 'favorites') { filteredFavorites = currentData; renderFavorites(); }
        else { applySort(); }
    };
    
    // --- DATA RENDERING ---
    const applySort = () => {
        currentData.sort((a, b) => {
            const isAPinned = pinnedMatches.includes(a.uniqueId);
            const isBPinned = pinnedMatches.includes(b.uniqueId);
            if (isAPinned && !isBPinned) return -1;
            if (!isAPinned && isBPinned) return 1;
            const valA = a[sortColumn], valB = b[sortColumn];
            if (sortColumn === 'Match Date') {
                 const dateA = new Date(valA.split('/').reverse().join('-'));
                 const dateB = new Date(valB.split('/').reverse().join('-'));
                 return sortDirection === 'asc' ? dateA - dateB : dateB - dateA;
            }
            if (typeof valA === 'number') return sortDirection === 'asc' ? (valA || 0) - (valB || 0) : (valB || 0) - (valA || 0);
            return sortDirection === 'asc' ? String(valA || "").localeCompare(String(valB || "")) : String(valB || "").localeCompare(String(valA || ""));
        });
        renderTableHead();
        renderPage();
    };

    const renderPage = () => {
        const totalPages = Math.ceil(currentData.length / rowsPerPage);
        const start = (currentPage - 1) * rowsPerPage;
        renderTableBody(currentData.slice(start, start + rowsPerPage));
        dom.pagination.innerHTML = currentData.length > rowsPerPage ? `<button onclick="handlePrevPage()" class="px-4 py-2 text-sm font-medium rounded-full bg-panel-bg dark:bg-dark-panel-bg shadow interactive-glow" ${currentPage === 1 ? 'disabled' : ''}>Prev</button><span class="text-sm font-semibold">Page ${currentPage} of ${totalPages}</span><button onclick="handleNextPage()" class="px-4 py-2 text-sm font-medium rounded-full bg-panel-bg dark:bg-dark-panel-bg shadow interactive-glow" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}>Next</button>` : "";
        dom.pagination.classList.toggle('hidden', currentData.length <= rowsPerPage);
        dom.tableFooter.classList.toggle('hidden', activeTab !== 'extrapolation');
        if (activeTab === 'extrapolation') updateTotals();
    };

    const renderTableBody = (data) => {
        dom.tableBody.innerHTML = "";
        if (data.length === 0) {
            dom.messageBox.classList.remove("hidden");
            dom.messageBox.querySelector("p").textContent = "No results match your criteria.";
            return;
        }
        dom.messageBox.classList.add("hidden");
        if (activeTab === 'extrapolation') { renderExtrapolationTable(data); } 
        else { renderStandardTable(data); }
    };

    const renderTableHead = () => {
        if (activeTab === 'extrapolation') {
            dom.tableHeadRow.innerHTML = `
                <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Date</th>
                <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Match</th>
                <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Prediction</th>
                <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Odds</th>
                <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Stake</th>
                <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Potential Win</th>
                <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Profit</th>
                <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Loss</th>
            `;
            return;
        }
        
        let headHTML = '';
        const baseCols = COLUMN_MAP.filter(c => c.label && !HIDDEN_COLUMNS.includes(c.key));
        const sortableHeader = (key, label) => `<th onclick="handleSort('${key}')" class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider cursor-pointer"><div class="flex items-center">${label}${key === sortColumn ? `<svg class="w-4 h-4 ml-2 sort-icon ${sortDirection === 'desc' ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 15l7-7 7 7"></path></svg>` : ''}</div></th>`;
        
        headHTML += '<th class="w-10"></th><th class="w-10"></th>'; // Pin & Star
        baseCols.forEach(col => {
            headHTML += sortableHeader(col.key, col.label);
            if (col.key === 'Match Date') {
                 headHTML += `<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">View</th>`;
            }
        });
        dom.tableHeadRow.innerHTML = headHTML;
    };

    const renderStandardTable = (data) => {
        const visibleCols = COLUMN_MAP.filter(c => c.label && !HIDDEN_COLUMNS.includes(c.key));
        dom.tableBody.innerHTML = "";
        data.forEach(item => {
            const row = document.createElement("tr");
            const itemJSON = encodeURIComponent(JSON.stringify(item));
            const isPinned = pinnedMatches.includes(item.uniqueId);
            row.className = `transition-all duration-200 even:bg-panel-bg odd:bg-gray-50 dark:even:bg-dark-panel-bg dark:odd:bg-gray-800/50 table-row-hover ${viewedRows.has(item.uniqueId) ? "viewed-row" : ""} ${isPinned ? 'pinned-row' : ''}`;
            
            row.addEventListener('dblclick', () => showDetailsModal(item));
            row.addEventListener('mouseenter', (e) => showQuickStats(e, item));
            row.addEventListener('mouseleave', hideQuickStats);
            row.addEventListener('mousemove', moveQuickStats);

            const isFavorited = favorites.some(f => f.uniqueId === item.uniqueId);

            let rowHTML = `
                <td class="px-2 py-3 text-center"><span onclick="event.stopPropagation(); togglePin('${item.uniqueId}')" class="text-xl cursor-pointer transition transform hover:scale-125 ${isPinned ? 'text-accent-orange' : 'text-gray-300 dark:text-gray-600'}">${ICONS.pin}</span></td>
                <td class="px-2 py-3 text-center"><span onclick="event.stopPropagation(); toggleFavorite('${item.uniqueId}')" class="text-2xl cursor-pointer transition transform hover:scale-125 ${isFavorited ? "text-yellow-400" : "text-gray-300 dark:text-gray-600"}">${isFavorited ? ICONS.star : ICONS.starOutline}</span></td>`;
            
            visibleCols.forEach(col => {
                const value = item[col.key] || "N/A";
                if (col.key === 'Outcome') {
                    const [bgColor, text, isWin] = getOutcomeColor(item.Prediction, value);
                    rowHTML += `<td class="px-4 py-3 whitespace-nowrap text-sm"><span class="px-3 py-1 text-xs font-bold rounded-full text-white ${bgColor} shadow-md ${isWin ? 'glow-win' : ''}">${text}</span></td>`;
                } else if (col.key === 'Match') {
                    rowHTML += `<td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-text-primary dark:text-dark-text-primary">${getLeagueLogo(item.League)} ${value}</td>`;
                } else {
                    rowHTML += `<td class="px-4 py-3 whitespace-nowrap text-sm text-text-secondary dark:text-dark-text-secondary">${value}</td>`;
                }
                 if (col.key === 'Match Date') {
                    rowHTML += `<td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                                    <button onclick="event.stopPropagation(); showDetailsModal(JSON.parse(decodeURIComponent('${itemJSON}')))" 
                                            class="p-2 text-xs font-bold text-white bg-primary-blue rounded-full shadow-md hover:bg-primary-purple transition-all duration-200 ease-in-out transform hover:scale-105 interactive-glow">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                    </button>
                                </td>`;
                }
            });
            
            row.innerHTML = rowHTML;
            dom.tableBody.appendChild(row);
        });
    };

    const getOutcomeColor = (prediction, outcome) => {
        if (!prediction || !outcome || outcome === "N/A" || outcome.trim() === '') return ["bg-gray-400", "Pending", false];
        const p = prediction.toLowerCase(), o = outcome.toLowerCase();
        if ((p.includes("home") && o.includes("home")) || (p.includes("away") && o.includes("away")) || (p.includes("draw") && o.includes("draw"))) {
            return ["bg-accent-green", outcome, true];
        }
        return ["bg-red-500", outcome, false];
    };
    
    // --- NEWLY ADDED/FIXED FUNCTIONS ---
    const renderExtrapolationTable = (data) => {
        dom.tableBody.innerHTML = "";
        data.forEach(item => {
            const row = document.createElement("tr");
            const isPinned = pinnedMatches.includes(item.uniqueId);
            row.className = `transition-colors duration-200 even:bg-panel-bg odd:bg-gray-50 dark:even:bg-dark-panel-bg dark:odd:bg-gray-800/50 ${isPinned ? 'pinned-row' : ''}`;
            
            const prediction = item.Prediction || '';
            let odds = 0;
            if (prediction.toLowerCase().includes('home')) odds = item['Home Odds'];
            else if (prediction.toLowerCase().includes('away')) odds = item['Away Odds'];
            else if (prediction.toLowerCase().includes('draw')) odds = item['Draw Odds'];
            
            const stake = 100;
            let potentialWin = stake * odds;
            let profit = potentialWin - stake;
            
            const outcome = item.Outcome || 'N/A';
            let isLoss = false;
            if (outcome !== 'N/A') {
                isLoss = !((prediction.toLowerCase().includes('home') && outcome.toLowerCase().includes('home')) ||
                         (prediction.toLowerCase().includes('away') && outcome.toLowerCase().includes('away')) ||
                         (prediction.toLowerCase().includes('draw') && outcome.toLowerCase().includes('draw')));
            }

            if (isLoss) {
                potentialWin = 0;
                profit = -100;
            }

            row.innerHTML = `
                <td class="px-4 py-3 text-sm">${item['Match Date']}</td>
                <td class="px-4 py-3 text-sm font-semibold">${item.Match}</td>
                <td class="px-4 py-3 text-sm">${item.Prediction}</td>
                <td class="px-4 py-3 text-sm">${odds || 'N/A'}</td>
                <td class="px-4 py-3 text-sm font-bold text-blue-600 dark:text-blue-400">€${stake.toFixed(2)}</td>
                <td class="px-4 py-3 text-sm font-bold text-green-600 dark:text-green-400">€${potentialWin.toFixed(2)}</td>
                <td class="px-4 py-3 text-sm font-bold ${profit >= 0 ? 'text-accent-green' : 'text-red-500'}">€${profit.toFixed(2)}</td>
                <td class="px-4 py-3 text-center"><input type="checkbox" ${isLoss ? 'checked' : ''} onchange="handleLossChange(this, '${item.uniqueId}')"></td>
            `;
            dom.tableBody.appendChild(row);
        });
    };
    
    const updateTotals = () => {
        const footerRow = dom.tableFooter.querySelector('tr') || dom.tableFooter.appendChild(document.createElement('tr'));
        const totalStake = currentData.length * 100;
        
        const { totalProfit, totalPotentialWin } = currentData.reduce((acc, item) => {
            const prediction = item.Prediction || '';
            let odds = 0;
            if (prediction.toLowerCase().includes('home')) odds = item['Home Odds'];
            else if (prediction.toLowerCase().includes('away')) odds = item['Away Odds'];
            else if (prediction.toLowerCase().includes('draw')) odds = item['Draw Odds'];
            
            const stake = 100;
            const potentialWin = stake * odds;
            
            const outcome = item.Outcome || 'N/A';
            let isLoss = lostMatches.has(item.uniqueId);

            if (!lostMatches.has(item.uniqueId) && outcome !== 'N/A') {
                 isLoss = !((prediction.toLowerCase().includes('home') && outcome.toLowerCase().includes('home')) ||
                         (prediction.toLowerCase().includes('away') && outcome.toLowerCase().includes('away')) ||
                         (prediction.toLowerCase().includes('draw') && outcome.toLowerCase().includes('draw')));
            }

            if(isLoss) {
                acc.totalProfit -= 100;
            } else {
                acc.totalProfit += (potentialWin - stake);
                acc.totalPotentialWin += potentialWin;
            }

            return acc;
        }, { totalProfit: 0, totalPotentialWin: 0 });

        footerRow.className = "font-extrabold text-text-primary dark:text-dark-text-primary text-sm";
        footerRow.innerHTML = `
            <td colspan="4" class="px-4 py-3 text-right">Totals:</td>
            <td class="px-4 py-3 text-blue-600 dark:text-blue-400">€${totalStake.toFixed(2)}</td>
            <td class="px-4 py-3 text-green-600 dark:text-green-400">€${totalPotentialWin.toFixed(2)}</td>
            <td class="px-4 py-3 ${totalProfit >= 0 ? 'text-accent-green' : 'text-red-500'}">€${totalProfit.toFixed(2)}</td>
            <td></td>
        `;
    };

    window.handleLossChange = (checkbox, uniqueId) => {
        if (checkbox.checked) {
            lostMatches.add(uniqueId);
        } else {
            lostMatches.delete(uniqueId);
        }
        updateTotals();
    };
    
    const renderFavorites = () => {
        const container = document.getElementById('favorites-table-container');
        if (filteredFavorites.length === 0) {
            container.innerHTML = `<p class="text-center p-8 text-text-secondary dark:text-dark-text-secondary">You haven't added any matches to your favorites yet. Click the star icon (☆) on any match to add it.</p>`;
            return;
        }
        const visibleCols = COLUMN_MAP.filter(c => c.label && !HIDDEN_COLUMNS.includes(c.key));
        let tableHTML = `<table class="min-w-full"><thead class="bg-filter-panel-bg dark:bg-dark-filter-panel-bg"><tr>`;
        visibleCols.forEach(col => {
            tableHTML += `<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">${col.label}</th>`;
        });
        tableHTML += `<th></th></tr></thead><tbody class="divide-y divide-gray-200/50 dark:divide-gray-700">`;
        filteredFavorites.forEach(item => {
            const itemJSON = encodeURIComponent(JSON.stringify(item));
            tableHTML += `<tr class="transition-colors duration-200 even:bg-panel-bg odd:bg-gray-50 dark:even:bg-dark-panel-bg dark:odd:bg-gray-800/50" ondblclick="showDetailsModal(JSON.parse(decodeURIComponent('${itemJSON}')))">`;
            visibleCols.forEach(col => {
                const value = item[col.key] || "N/A";
                if (col.key === 'Outcome') {
                    const [bgColor, text, isWin] = getOutcomeColor(item.Prediction, value);
                    tableHTML += `<td class="px-4 py-3 whitespace-nowrap text-sm"><span class="px-2 py-1 text-xs font-bold rounded-full text-white ${bgColor} ${isWin ? 'glow-win' : ''}">${text}</span></td>`;
                } else if (col.key === 'Match') {
                    tableHTML += `<td class="px-4 py-3 whitespace-nowrap text-sm font-semibold">${getLeagueLogo(item.League)} ${value}</td>`;
                } else {
                    tableHTML += `<td class="px-4 py-3 whitespace-nowrap text-sm text-text-secondary dark:text-dark-text-secondary">${value}</td>`;
                }
            });
            tableHTML += `</tr>`;
        });
        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;
    };
    
    // --- FEATURE IMPLEMENTATIONS ---
    const renderDashboard = (data) => {
        if (!document.getElementById('stat-win-rate')) return;
        const completed = data.filter(d => d.Outcome && d.Outcome !== 'N/A' && d.Outcome.trim() !== '');
        const totalCompleted = completed.length;
        const wins = completed.filter(d => getOutcomeColor(d.Prediction, d.Outcome)[2]).length;
        document.getElementById('stat-win-rate').textContent = totalCompleted > 0 ? `${((wins / totalCompleted) * 100).toFixed(1)}%` : '0%';
        document.getElementById('stat-accuracy').textContent = totalCompleted > 0 ? `${((wins / totalCompleted) * 100).toFixed(1)}%` : '0%';
        document.getElementById('stat-total-tips').textContent = data.length;
        const topTip = data.find(d => ["Best Home Tip", "Best Away Tip"].includes(d['Match Analysis']));
        document.getElementById('stat-top-tip').textContent = topTip ? topTip.Match : 'N/A';
        const outcomeCounts = completed.reduce((acc, d) => { const outcomeText = getOutcomeColor(d.Prediction, d.Outcome)[2] ? 'Win' : 'Loss'; acc[outcomeText] = (acc[outcomeText] || 0) + 1; return acc; }, {});
        if (outcomeChart) outcomeChart.destroy();
        const isDark = dom.html.classList.contains('dark');
        const chartTextColor = isDark ? 'white' : 'black';
        outcomeChart = new Chart(document.getElementById('outcome-pie-chart').getContext('2d'), { type: 'pie', data: { labels: Object.keys(outcomeCounts), datasets: [{ data: Object.values(outcomeCounts), backgroundColor: ['#00c853', '#ef4444'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: chartTextColor } } } } });
        const predictionCounts = data.reduce((acc, d) => { acc[d.Prediction] = (acc[d.Prediction] || 0) + 1; return acc; }, {});
        if (predictionChart) predictionChart.destroy();
        predictionChart = new Chart(document.getElementById('prediction-bar-chart').getContext('2d'), { type: 'bar', data: { labels: Object.keys(predictionCounts), datasets: [{ label: 'Prediction Count', data: Object.values(predictionCounts), backgroundColor: '#0a0a2a' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: chartTextColor } }, y: { ticks: { color: chartTextColor, beginAtZero: true } } }, plugins: { legend: { labels: { color: chartTextColor } } } } });
    };
    
    // --- Less Risky Tab Functions ---
    async function loadLessRiskyData() {
        try {
            const response = await fetch(LESS_RISKY_XLSX_URL);
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'buffer' });

            const winnersSheetName = 'winnerspredict';
            const heroSheetName = 'heropredict';

            if (workbook.SheetNames.includes(winnersSheetName)) {
                const winnersSheet = workbook.Sheets[winnersSheetName];
                winnersData = XLSX.utils.sheet_to_json(winnersSheet, {
                    raw: false, // Format dates
                    defval: ""
                });
            } else {
                console.warn(`Sheet "${winnersSheetName}" not found.`);
            }

            if (workbook.SheetNames.includes(heroSheetName)) {
                const heroSheet = workbook.Sheets[heroSheetName];
                heroData = XLSX.utils.sheet_to_json(heroSheet, {
                    raw: false,
                    defval: ""
                });
            } else {
                console.warn(`Sheet "${heroSheetName}" not found.`);
            }
            
            // Normalize data and extract team names
            const toProperCase = (str) => {
                if (!str) return '';
                return str.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
            };

            const processLessRiskyRow = (row) => {
                // Normalize Date from Excel serial number
                if (row.Date && typeof row.Date === 'number') {
                    const date = new Date(Math.round((row.Date - 25569) * 86400 * 1000));
                    row.Date = date.toISOString().split('T')[0];
                }

                // Extract Home and Away teams from MatchID
                if (row.MatchID && typeof row.MatchID === 'string') {
                    const parts = row.MatchID.split('_vs_');
                    if (parts.length === 2) {
                        const homePart = parts[0];
                        // Assumes format is YYYY-MM-DD_home_team, gets everything after first underscore
                        const homeTeamRaw = homePart.substring(homePart.indexOf('_') + 1);
                        row['Home Team'] = toProperCase(homeTeamRaw.replace(/_/g, ' '));

                        const awayTeamRaw = parts[1];
                        row['Away Team'] = toProperCase(awayTeamRaw.replace(/_/g, ' '));
                    }
                }
                return row;
            };

            winnersData = winnersData.map(processLessRiskyRow);
            heroData = heroData.map(processLessRiskyRow);

            populateLessRiskyDateFilter();
            filterLessRiskyByDate('today');

        } catch (error) {
            console.error("Error loading Less Risky data:", error);
        }
    }

    function populateLessRiskyDateFilter() {
        const allDates = [...new Set([...winnersData.map(r => r.Date), ...heroData.map(r => r.Date)])];
        const sortedDates = allDates.filter(Boolean).sort((a,b) => new Date(b) - new Date(a));
        
        const dateFilter = document.getElementById('less-risky-date-filter');
        dateFilter.innerHTML = sortedDates.map(date => `<option value="${date}">${date}</option>`).join('');
    }

    function filterLessRiskyByDate(date) {
        let targetDate;
        const today = new Date();
        const yyyy_mm_dd = (d) => d.toISOString().split('T')[0];

        if (date === 'today') {
            targetDate = yyyy_mm_dd(today);
        } else if (date === 'yesterday') {
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            targetDate = yyyy_mm_dd(yesterday);
        } else if (date === 'tomorrow') {
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            targetDate = yyyy_mm_dd(tomorrow);
        } else {
            targetDate = date;
        }
        
        const dateFilterSelect = document.getElementById('less-risky-date-filter');
        if (dateFilterSelect) {
             dateFilterSelect.value = targetDate;
        }

        const filteredWinners = winnersData.filter(row => row.Date === targetDate);
        const filteredHero = heroData.filter(row => row.Date === targetDate);

        renderLessRiskyTables(filteredWinners, filteredHero);
        updateLessRiskySummaryCards(targetDate);
        updateLessRiskyCharts(targetDate);
    }

    function renderLessRiskyTables(winners, hero) {
        const winnersBody = document.getElementById('winners-table-body');
        const heroBody = document.getElementById('hero-table-body');

        const createRow = (row) => {
            const tr = document.createElement('tr');
            const tip = row.Tip || '-';
            let tipColorClass = '';
            if (tip === '1' || tip === '1x') {
                tipColorClass = 'bg-green-100 dark:bg-green-900 font-bold text-green-700 dark:text-green-300';
            } else if (['Over 1.5', 'Home ov 1.5', '2+'].includes(tip)) {
                tipColorClass = 'bg-orange-100 dark:bg-orange-900 font-bold text-orange-700 dark:text-orange-300';
            } else if (tip === '-') {
                tipColorClass = 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300';
            }
            
            tr.innerHTML = `
                <td>${row.Date || ''}</td>
                <td>${row.League || ''}</td>
                <td>${row.Time || ''}</td>
                <td>${row['Home Team'] || ''}</td>
                <td>${row['Away Team'] || ''}</td>
                <td class="${tipColorClass}">${tip}</td>
                <td>${row.Score || ''}</td>
            `;
            return tr;
        };

        winnersBody.innerHTML = '';
        winners.forEach(row => winnersBody.appendChild(createRow(row)));
        if(winners.length === 0) winnersBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">No matches for this date.</td></tr>';


        heroBody.innerHTML = '';
        hero.forEach(row => heroBody.appendChild(createRow(row)));
        if(hero.length === 0) heroBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">No matches for this date.</td></tr>';
    }
    
    function updateLessRiskySummaryCards(selectedDate) {
        const winnersToday = winnersData.filter(r => r.Date === selectedDate);
        const heroToday = heroData.filter(r => r.Date === selectedDate);
        document.getElementById('lr-stat-total-matches').textContent = winnersToday.length + heroToday.length;
        
        const allToday = [...winnersToday, ...heroToday];
        const tipCounts = allToday.reduce((acc, row) => {
            const tip = row.Tip || '-';
            acc[tip] = (acc[tip] || 0) + 1;
            return acc;
        }, {});
        
        const tipsDistText = Object.entries(tipCounts).map(([tip, count]) => `${tip}: ${count}`).join(', ');
        document.getElementById('lr-stat-tips-dist').textContent = tipsDistText || 'N/A';

        // Win Rate Yesterday
        const today = new Date(selectedDate);
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        
        const winnersYesterday = winnersData.filter(r => r.Date === yesterdayStr && r.Score);
        const heroYesterday = heroData.filter(r => r.Date === yesterdayStr && r.Score);
        const allYesterday = [...winnersYesterday, ...heroYesterday];
        
        let correctCount = 0;
        allYesterday.forEach(match => {
           // Basic win rate logic, can be expanded
           const [homeScore, awayScore] = (match.Score || "0-0").split('-').map(Number);
           const tip = match.Tip;
           let win = false;
           if(tip === '1' && homeScore > awayScore) win = true;
           if(tip === '2' && awayScore > homeScore) win = true;
           if(tip === 'x' && homeScore === awayScore) win = true;
           if(tip === '1x' && (homeScore > awayScore || homeScore === awayScore)) win = true;
           if(tip === '2x' && (awayScore > homeScore || homeScore === awayScore)) win = true;
           if(tip === 'Over 1.5' && (homeScore + awayScore) > 1.5) win = true;
           if(tip === 'Home ov 1.5' && homeScore > 1.5) win = true;

           if(win) correctCount++;
        });

        const winRate = allYesterday.length > 0 ? ((correctCount / allYesterday.length) * 100).toFixed(1) : 0;
        document.getElementById('lr-stat-win-rate').textContent = `${winRate}%`;
    }
    
    function updateLessRiskyCharts(selectedDate) {
        const allToday = [...winnersData.filter(r => r.Date === selectedDate), ...heroData.filter(r => r.Date === selectedDate)];
        const tipCounts = allToday.reduce((acc, row) => {
            const tip = row.Tip || '-';
            acc[tip] = (acc[tip] || 0) + 1;
            return acc;
        }, {});
        
        const isDark = dom.html.classList.contains('dark');
        const chartTextColor = isDark ? 'white' : 'black';

        if(lrTipPieChart) lrTipPieChart.destroy();
        lrTipPieChart = new Chart(document.getElementById('lr-tip-pie-chart').getContext('2d'), {
            type: 'pie',
            data: {
                labels: Object.keys(tipCounts),
                datasets: [{
                    data: Object.values(tipCounts),
                    backgroundColor: ['#3f51b5', '#673ab7', '#00c853', '#ff9800', '#f44336', '#9e9e9e'],
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: chartTextColor } } } }
        });

        const last7DaysData = {};
        for (let i = 6; i >= 0; i--) {
            const d = new Date(selectedDate);
            d.setDate(d.getDate() - i);
            const dateStr = d.toISOString().split('T')[0];
            last7DaysData[dateStr] = 0;
        }

        [...winnersData, ...heroData].forEach(row => {
            if(last7DaysData.hasOwnProperty(row.Date)) {
                last7DaysData[row.Date]++;
            }
        });

        if(lrDailyMatchesChart) lrDailyMatchesChart.destroy();
        lrDailyMatchesChart = new Chart(document.getElementById('lr-daily-matches-chart').getContext('2d'), {
            type: 'line',
            data: {
                labels: Object.keys(last7DaysData),
                datasets: [{
                    label: 'Total Matches',
                    data: Object.values(last7DaysData),
                    borderColor: '#3f51b5',
                    backgroundColor: 'rgba(63, 81, 181, 0.2)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { x: { ticks: { color: chartTextColor } }, y: { ticks: { color: chartTextColor, beginAtZero: true } } },
                plugins: { legend: { labels: { color: chartTextColor } } }
            }
        });
    }


    window.togglePin = (uniqueId) => {
        const index = pinnedMatches.indexOf(uniqueId);
        if (index > -1) pinnedMatches.splice(index, 1);
        else pinnedMatches.push(uniqueId);
        localStorage.setItem('pinnedMatches', JSON.stringify(pinnedMatches));
        applySort();
    };

    const showQuickStats = (event, item) => {
        dom.tooltip.style.display = 'block';
        const forms = ['W', 'D', 'L', 'W', 'W'].map(f => `<span class="px-2 py-1 rounded text-xs ${f==='W'?'bg-green-500':f==='D'?'bg-gray-500':'bg-red-500'}">${f}</span>`).join(' ');
        dom.tooltip.innerHTML = `<strong>Last 5:</strong><div class="flex space-x-1 mt-1">${forms}</div>`;
        setTimeout(() => dom.tooltip.style.opacity = 1, 10);
        moveQuickStats(event);
    };
    const hideQuickStats = () => { dom.tooltip.style.opacity = 0; setTimeout(() => dom.tooltip.style.display = 'none', 300); };
    const moveQuickStats = (event) => { dom.tooltip.style.left = `${event.pageX + 15}px`; dom.tooltip.style.top = `${event.pageY + 15}px`; };

    window.showDetailsModal = (item) => {
        const homeTeam = item['Home Team'] || 'Home';
        const awayTeam = item['Away Team'] || 'Away';
        const isFavorited = favorites.some(f => f.uniqueId === item.uniqueId);

        const modalContentHTML = `
            <div class="modal-content bg-[#eef6fb] dark:bg-dark-panel-bg w-full max-w-4xl mx-4 rounded-xl shadow-2xl text-text-primary dark:text-dark-text-primary relative" onclick="event.stopPropagation()">
                <button onclick="hideDetailsModal(event)" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 dark:hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <button onclick="toggleFavorite('${item.uniqueId}'); showDetailsModal(allData.find(d => d.uniqueId === '${item.uniqueId}'));" class="absolute top-4 right-12 text-2xl ${isFavorited ? 'text-yellow-400' : 'text-gray-400'}">
                    ${isFavorited ? ICONS.star : ICONS.starOutline}
                </button>

                <div class="p-8">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-bold text-center border-b-2 border-primary-blue pb-2 mb-4">${homeTeam} (Home)</h3>
                            <div class="space-y-3">
                                <h4 class="font-bold text-lg mb-2 flex items-center">🏆 Results</h4>
                                <div class="flex justify-between text-sm"><span class="font-semibold text-text-secondary dark:text-dark-text-secondary">Wins:</span> <span class="font-bold">${item['Home Wins'] || 0}</span></div>
                                <div class="flex justify-between text-sm"><span class="font-semibold text-text-secondary dark:text-dark-text-secondary">Draws:</span> <span class="font-bold">${item['Home Draws'] || 0}</span></div>
                                <div class="flex justify-between text-sm"><span class="font-semibold text-text-secondary dark:text-dark-text-secondary">Losses:</span> <span class="font-bold">${item['Home Losses'] || 0}</span></div>
                                
                                <h4 class="font-bold text-lg mb-2 mt-4 flex items-center">⚽ Scoring</h4>
                                <div class="flex justify-between text-sm"><span class="font-semibold text-text-secondary dark:text-dark-text-secondary">Scored:</span> <span class="font-bold">${item['Home Team Scored'] || 0}</span></div>
                                <div class="flex justify-between text-sm"><span class="font-semibold text-text-secondary dark:text-dark-text-secondary">Avg Scored:</span> <span class="font-bold text-green-500">${item['Home Avg Scored']?.toFixed(2) || '0.00'}</span></div>
                                <div class="flex justify-between text-sm"><span class="font-semibold text-text-secondary dark:text-dark-text-secondary">Conceded:</span> <span class="font-bold">${item['Home Conceded'] || 0}</span></div>
                                <div class="flex justify-between text-sm"><span class="font-semibold text-text-secondary dark:text-dark-text-secondary">Avg Conceded:</span> <span class="font-bold text-red-500">${item['Home Avg Conceded']?.toFixed(2) || '0.00'}</span></div>
                            </div>
                        </div>
                        <div>
                             <h3 class="text-xl font-bold text-center border-b-2 border-accent-orange pb-2 mb-4">${awayTeam} (Away)</h3>
                            <div class="space-y-3">
                                <h4 class="font-bold text-lg mb-2 flex items-center">🏆 Results</h4>
                                <div class="flex justify-between text-sm"><span class="font-semibold text-text-secondary dark:text-dark-text-secondary">Wins:</span> <span class="font-bold">${item['Away Wins'] || 0}</span></div>
                                <div class="flex justify-between text-sm"><span class="font-semibold text-text-secondary dark:text-dark-text-secondary">Draws:</span> <span class="font-bold">${item['Away Draws'] || 0}</span></div>
                                <div class="flex justify-between text-sm"><span class="font-semibold text-text-secondary dark:text-dark-text-secondary">Losses:</span> <span class="font-bold">${item['Away Losses'] || 0}</span></div>
                                
                                <h4 class="font-bold text-lg mb-2 mt-4 flex items-center">⚽ Scoring</h4>
                                <div class="flex justify-between text-sm"><span class="font-semibold text-text-secondary dark:text-dark-text-secondary">Scored:</span> <span class="font-bold">${item['Away Team Scored'] || 0}</span></div>
                                <div class="flex justify-between text-sm"><span class="font-semibold text-text-secondary dark:text-dark-text-secondary">Avg Scored:</span> <span class="font-bold text-green-500">${item['Away Avg Scored']?.toFixed(2) || '0.00'}</span></div>
                                <div class="flex justify-between text-sm"><span class="font-semibold text-text-secondary dark:text-dark-text-secondary">Conceded:</span> <span class="font-bold">${item['Away Conceded'] || 0}</span></div>
                                <div class="flex justify-between text-sm"><span class="font-semibold text-text-secondary dark:text-dark-text-secondary">Avg Conceded:</span> <span class="font-bold text-red-500">${item['Away Avg Conceded']?.toFixed(2) || '0.00'}</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Analysis Section -->
                    <div class="mt-8 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <h4 class="font-bold text-lg mb-2 flex items-center">📊 Analysis</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <p class="text-sm text-text-secondary dark:text-dark-text-secondary bg-filter-panel-bg dark:bg-dark-filter-panel-bg p-4 rounded-md"><strong>Match Analysis:</strong> ${item['Match Analysis'] || 'No analysis available.'}</p>
                            <p class="text-sm text-text-secondary dark:text-dark-text-secondary bg-filter-panel-bg dark:bg-dark-filter-panel-bg p-4 rounded-md"><strong>Goals Analysis:</strong> ${item['Goals Analysis'] || 'No analysis available.'}</p>
                            <p class="text-sm text-text-secondary dark:text-dark-text-secondary bg-filter-panel-bg dark:bg-dark-filter-panel-bg p-4 rounded-md"><strong>Winning Streak:</strong> ${item['Winning Streak'] || 0}</p>
                            <p class="text-sm text-text-secondary dark:text-dark-text-secondary bg-filter-panel-bg dark:bg-dark-filter-panel-bg p-4 rounded-md"><strong>Losing Streak:</strong> ${item['Losing Streak'] || 0}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;

        dom.detailsModal.innerHTML = modalContentHTML;
        dom.detailsModal.classList.add('active');
        setTimeout(() => {
            const modalContent = document.querySelector('#details-modal .modal-content');
            if(modalContent) {
                modalContent.classList.add('active');
            }
        }, 10);
    };

    const getLeagueLogo = (leagueName) => '⚽';
    window.exportFavorites = (format) => {
        if (favorites.length === 0) return;
        const headers = COLUMN_MAP.filter(c => c.label && !HIDDEN_COLUMNS.includes(c.key)).map(c => c.label);
        const body = favorites.map(item => {
            return COLUMN_MAP.filter(c => c.label && !HIDDEN_COLUMNS.includes(c.key)).map(c => item[c.key] || '');
        });

        if (format === 'pdf') {
            const doc = new jsPDF();
            doc.autoTable({ head: [headers], body: body });
            doc.save('favorites.pdf');
        } else if (format === 'csv') {
            let csvContent = "data:text/csv;charset=utf-8," 
                + headers.join(",") + "\n" 
                + body.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "favorites.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else if (format === 'xlsx') {
            const worksheet = XLSX.utils.aoa_to_sheet([headers, ...body]);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Favorites");
            XLSX.writeFile(workbook, 'favorites.xlsx');
        }
    };

    // --- All other handlers and utility functions ---
    window.handleTabClick = (tab, element) => {
        activeTab = tab;
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active', 'bg-gradient-to-r', 'from-primary-blue', 'to-primary-purple', 'text-white', 'shadow-lg'));
        element.classList.add('active', 'bg-gradient-to-r', 'from-primary-blue', 'to-primary-purple', 'text-white', 'shadow-lg');
        const container = document.getElementById('nav-tabs');
        const containerRect = container.getBoundingClientRect();
        const elRect = element.getBoundingClientRect();
        dom.navUnderline.style.width = `${elRect.width}px`;
        dom.navUnderline.style.left = `${elRect.left - containerRect.left}px`;
        updateUiForTab();
    };
    const updateUiForTab = () => {
        const isDashboard = activeTab === 'dashboard', isFavorites = activeTab === 'favorites', isLessRisky = activeTab === 'less-risky';
        dom.dashboardContent.classList.toggle('hidden', !isDashboard);
        dom.favoritesContent.classList.toggle('hidden', !isFavorites);
        dom.lessRiskyContent.classList.toggle('hidden', !isLessRisky);
        dom.mainContent.classList.toggle('hidden', isDashboard || isFavorites || isLessRisky);
        dom.filtersContainer.classList.toggle('hidden', isDashboard || isLessRisky);

        if (isFavorites) {
            document.querySelectorAll('#favorites-content button').forEach(btn => {
                btn.disabled = favorites.length === 0;
                if(btn.disabled) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
        }
        applyFilters();
    };
    window.handleFilterChange = () => {
        filters.league = document.getElementById("filter-league").value; 
        filters.prediction = document.getElementById("filter-prediction").value; 
        filters.teamSearch = document.getElementById("team-search-input").value;
        filters.matchDate = document.getElementById("filter-date").value;
        filters.correctScore = document.getElementById("filter-correct-score").value;
        filters.homeOddsMin = parseFloat(document.getElementById("filter-home-odds").value) || null;
        
        filters.matchAnalysis = document.getElementById("filter-match-analysis").value;
        filters.goalsAnalysis = document.getElementById("filter-goals-analysis").value;
        filters.stake = {
            min: parseFloat(document.getElementById("filter-stake-min").value) || null,
            max: parseFloat(document.getElementById("filter-stake-max").value) || null
        };
        filters.winningStreak = {
            min: parseFloat(document.getElementById("filter-winning-streak-min").value) || null,
            max: parseFloat(document.getElementById("filter-winning-streak-max").value) || null
        };
        filters.losingStreak = {
            min: parseFloat(document.getElementById("filter-losing-streak-min").value) || null,
            max: parseFloat(document.getElementById("filter-losing-streak-max").value) || null
        };

        applyFilters(); 
    };
    window.handleAdvancedFilterChange = () => {
        const getMinMax = id => ({
            min: document.getElementById(`${id}-min`).value ? parseFloat(document.getElementById(`${id}-min`).value) : null,
            max: document.getElementById(`${id}-max`).value ? parseFloat(document.getElementById(`${id}-max`).value) : null,
        });
        filters.homeWins = getMinMax('adv-home-wins');
        filters.homeDraws = getMinMax('adv-home-draws');
        filters.homeLosses = getMinMax('adv-home-losses');
        filters.awayWins = getMinMax('adv-away-wins');
        filters.awayDraws = getMinMax('adv-away-draws');
        filters.awayLosses = getMinMax('adv-away-losses');
        filters.homeAvgScored = getMinMax('adv-home-avg-scored');
        filters.homeAvgConceded = getMinMax('adv-home-avg-conceded');
        filters.awayAvgScored = getMinMax('adv-away-avg-scored');
        filters.awayAvgConceded = getMinMax('adv-away-avg-conceded');
        filters.homeOdds = getMinMax('adv-home-odds');
        filters.drawOdds = getMinMax('adv-draw-odds');
        filters.awayOdds = getMinMax('adv-away-odds');
        filters.predictionOdds = getMinMax('adv-prediction-odds');
        hideFilterModal();
        applyFilters();
    };
    window.clearAdvancedFilters = () => {
        document.querySelectorAll('#more-filters-modal input[type="number"]').forEach(input => input.value = '');
    };
    window.clearFilters = () => {
        filters = { ...initialFilters };
        document.querySelectorAll('#filters-panel input, #filters-panel select').forEach(el => {
            if (el.tagName === 'SELECT') el.selectedIndex = 0;
            else el.value = '';
        });
        clearAdvancedFilters();
        applyFilters();
    };
    const buildAdvancedFiltersModal = () => {
        const createMinMaxInput = (id, label) => `<div class="grid grid-cols-2 gap-2 items-center"><label for="${id}-min" class="text-sm font-medium text-text-secondary dark:text-dark-text-secondary">${label}</label><div class="grid grid-cols-2 gap-2"><input type="number" id="${id}-min" placeholder="Min" class="w-full bg-panel-bg dark:bg-dark-panel-bg p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm"><input type="number" id="${id}-max" placeholder="Max" class="w-full bg-panel-bg dark:bg-dark-panel-bg p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm"></div></div>`;
        dom.filtersModal.innerHTML = `<div class="modal-content bg-panel-bg dark:bg-dark-panel-bg w-full max-w-4xl mx-4 p-8 rounded-xl shadow-2xl relative" onclick="event.stopPropagation()"><button onclick="hideFilterModal(event)" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg></button><h3 class="text-2xl font-bold text-text-primary dark:text-dark-text-primary mb-6">Advanced Filters</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="space-y-4 p-4 rounded-lg bg-filter-panel-bg dark:bg-dark-filter-panel-bg"><h4 class="font-semibold text-gray-800 dark:text-gray-200 border-b pb-2 mb-3">Performance Stats</h4>${createMinMaxInput('adv-home-wins', 'Home Wins')}${createMinMaxInput('adv-home-draws', 'Home Draws')}${createMinMaxInput('adv-home-losses', 'Home Losses')}${createMinMaxInput('adv-away-wins', 'Away Wins')}${createMinMaxInput('adv-away-draws', 'Away Draws')}${createMinMaxInput('adv-away-losses', 'Away Losses')}</div><div class="space-y-4 p-4 rounded-lg bg-filter-panel-bg dark:bg-dark-filter-panel-bg"><h4 class="font-semibold text-gray-800 dark:text-gray-200 border-b pb-2 mb-3">Scoring Stats</h4>${createMinMaxInput('adv-home-avg-scored', 'Home Avg Scored')}${createMinMaxInput('adv-home-avg-conceded', 'Home Avg Conceded')}${createMinMaxInput('adv-away-avg-scored', 'Away Avg Scored')}${createMinMaxInput('adv-away-avg-conceded', 'Away Avg Conceded')}</div><div class="space-y-4 p-4 rounded-lg bg-filter-panel-bg dark:bg-dark-filter-panel-bg"><h4 class="font-semibold text-gray-800 dark:text-gray-200 border-b pb-2 mb-3">Odds Filters</h4>${createMinMaxInput('adv-home-odds', 'Home Odds')}${createMinMaxInput('adv-draw-odds', 'Draw Odds')}${createMinMaxInput('adv-away-odds', 'Away Odds')}${createMinMaxInput('adv-prediction-odds', 'Prediction Odds')}</div></div><div class="mt-8 flex justify-between items-center"><button onclick="clearAdvancedFilters()" class="px-6 py-3 bg-gray-500 text-white font-bold rounded-lg shadow-md hover:bg-gray-600 transition">Clear All Filters</button><button onclick="handleAdvancedFilterChange()" class="px-6 py-3 bg-gradient-to-r from-primary-blue to-primary-purple text-white font-bold rounded-lg shadow-md interactive-glow">Apply Filters</button></div></div>`;
    };
    const populateFilterDropdowns = () => {
        const leagues = ['All', ...new Set(allData.map(item => item.League).filter(Boolean))];
        const dates = ['All Dates', ...new Set(allData.map(item => item['Match Date']).filter(Boolean))];
        const predictions = ['All', ...new Set(allData.map(item => item.Prediction).filter(Boolean))];
        const correctScores = ['All', ...new Set(allData.map(item => item['Correct Score']).filter(Boolean))];
        const matchAnalyses = ['All', ...new Set(allData.map(item => item['Match Analysis']).filter(Boolean))];
        const goalsAnalyses = ['All', ...new Set(allData.map(item => item['Goals Analysis']).filter(Boolean))];
        
        const leagueSelect = document.getElementById('filter-league');
        leagueSelect.innerHTML = leagues.map(l => `<option value="${l}">${l}</option>`).join('');
        const dateSelect = document.getElementById('filter-date');
        dateSelect.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
        const predictionSelect = document.getElementById('filter-prediction');
        predictionSelect.innerHTML = predictions.map(p => `<option value="${p}">${p}</option>`).join('');
        const correctScoreSelect = document.getElementById('filter-correct-score');
        correctScoreSelect.innerHTML = correctScores.map(s => `<option value="${s}">${s}</option>`).join('');
        const matchAnalysisSelect = document.getElementById('filter-match-analysis');
        matchAnalysisSelect.innerHTML = matchAnalyses.map(m => `<option value="${m}">${m}</option>`).join('');
        const goalsAnalysisSelect = document.getElementById('filter-goals-analysis');
        goalsAnalysisSelect.innerHTML = goalsAnalyses.map(g => `<option value="${g}">${g}</option>`).join('');
    };
    window.handleSort = (key) => { sortColumn === key ? sortDirection = (sortDirection === 'asc' ? 'desc' : 'asc') : (sortColumn = key, sortDirection = 'asc'); applySort(); };
    window.handlePrevPage = () => { if (currentPage > 1) { currentPage--; renderPage(); } };
    window.handleNextPage = () => { if (currentPage < Math.ceil(currentData.length / rowsPerPage)) { currentPage++; renderPage(); } };
    window.hideDetailsModal = (event) => {
        if (event.target === dom.detailsModal || event.target.closest('button')) {
             dom.detailsModal.classList.remove('active');
        }
    };
    window.hideFilterModal = (event) => { if (event && event.target !== dom.filtersModal && !event.target.closest('.modal-content')) return; dom.filtersModal.classList.remove('active'); };
    window.showFilterModal = () => { dom.filtersModal.classList.add('active'); setTimeout(() => document.querySelector('#more-filters-modal .modal-content').classList.add('active'), 10);};
    window.toggleFavorite = (uniqueId) => {
        const index = favorites.findIndex(fav => fav.uniqueId === uniqueId);
        if (index > -1) {
            favorites.splice(index, 1);
        } else {
            const itemToAdd = allData.find(item => item.uniqueId === uniqueId);
            if (itemToAdd) favorites.push(itemToAdd);
        }
        localStorage.setItem('favorites', JSON.stringify(favorites.map(f => f.uniqueId)));
        if (activeTab === 'favorites') {
            applyFilters();
        } else {
            const row = Array.from(dom.tableBody.querySelectorAll('tr')).find(r => r.innerHTML.includes(uniqueId));
            if(row){
                const star = row.querySelector('.text-2xl');
                if(star){
                    star.innerHTML = index === -1 ? ICONS.star : ICONS.starOutline;
                    star.classList.toggle('text-yellow-400', index === -1);
                    star.classList.toggle('text-gray-300', index > -1);
                    star.classList.toggle('dark:text-gray-600', index > -1);
                }
            }
        }
    };

    </script>
</body>
</html>
