<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF--8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Analytics Console</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    .active { font-weight: 600; }
    .fav-btn { background: transparent; border: none; cursor: pointer; font-size: 16px; transition: color 0.2s, filter 0.2s, transform 0.3s; }
    
    .summary-card {
      flex: 1 1 22%; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 16px; text-align: center; transition: transform 0.2s, box-shadow 0.2s;
    }
    .summary-card:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .summary-card h3 { font-size: 1rem; color: #4b5563; margin-bottom: 8px; font-weight: 500;}
    .summary-card p { font-size: 1.75rem; font-weight: bold; }

    .star-fav { color: #f59e0b; } /* Yellow for manual favorite */
    .star-normal { color: #cbd5e1; } /* Grey for normal */
    .star-blue { color: #3b82f6; } /* Blue for same predictions */
    .star-green { color: #22c55e; } /* Green for correct predictions */
    
    .favorite-highlight {
      color: #007bff; /* bright blue */
      text-shadow: 0 0 8px rgba(0, 123, 255, 0.6);
      transform: scale(1.2);
    }

    #tableHeaders th, #insightsTableHeaders th, #comparisonTableHeaders th { cursor: pointer; position: relative; }
    .sorted-asc::after { content: ' ‚ñ≤'; color: #3b82f6; font-size: 0.8em; position: absolute; right: 4px; top: 50%; transform: translateY(-50%); }
    .sorted-desc::after { content: ' ‚ñº'; color: #ef4444; font-size: 0.8em; position: absolute; right: 4px; top: 50%; transform: translateY(-50%); }

    /* Filter & Modal Styles */
    .filter-group input, .filter-group select { padding: 4px 8px; font-size: 0.875rem; border-radius: 6px; }
    .filter-group label { margin-bottom: 2px; font-size: 0.8rem; font-weight: 500; color: #374151;}
    .range-filter { display: flex; gap: 4px; align-items: center; }
    .range-filter input { width: 70px; }
    .tab-btn.active { background-color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    /* Modal Redesign Styles */
    #modalContent .stat-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb; }
    #modalContent .stat-item:last-child { border-bottom: none; }
    #modalContent .stat-label { display: flex; align-items: center; gap: 0.75rem; color: #4b5563; font-size: 0.875rem; }
    #modalContent .stat-value { font-weight: 600; }
    #modalContent .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 600; line-height: 1.2; }
    .badge-green { background-color: #dcfce7; color: #166534; }
    .badge-red { background-color: #fee2e2; color: #991b1b; }
    .badge-blue { background-color: #dbeafe; color: #1e40af; }
    .badge-gray { background-color: #f3f4f6; color: #4b5563; }
    #closeModal, #closeBookmarkModal, #closeMoreFiltersModal { transition: color 0.2s; }
    #closeModal:hover, #closeBookmarkModal:hover, #closeMoreFiltersModal:hover { color: #111827; }

    /* Chart Resizing */
    .chart-container-4x3 { width: 100%; max-width: 400px; height: 300px; margin: 0 auto; }
    #analyticsCharts > div, #dashboardTab > div:not(#dashboardCards) { display: flex; flex-direction: column; align-items: center; }
    
    /* Custom multi-select dropdown style to indicate it's a dropdown */
    select[multiple] { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <nav class="flex justify-between items-center bg-white shadow px-6 py-3 sticky top-0 z-20">
    <div class="flex items-center gap-4">
      <h1 class="text-xl font-bold text-blue-600">‚öΩ Smart Analytics Console</h1>
      <button id="refreshBtn" class="text-sm px-3 py-1 bg-blue-100 text-blue-800 rounded hover:bg-blue-200" title="Refresh data from source">üîÑ Refresh Data</button>
    </div>
    <input id="searchInput" type="text" placeholder="Search match..." class="border rounded px-3 py-1 text-sm" />
  </nav>

  <div class="tabs flex flex-wrap justify-center bg-blue-100 py-2 space-x-2 sticky top-[68px] z-20">
    <button class="tab-btn px-4 py-1 rounded" data-tab="dashboard"><i class="fa-solid fa-chart-pie mr-2"></i>Dashboard</button>
    <button class="tab-btn active px-4 py-1 rounded" data-tab="all">All Matches</button>
    <button class="tab-btn px-4 py-1 rounded" data-tab="insights">üìä Insights</button>
    <button class="tab-btn px-4 py-1 rounded" data-tab="comparison">üóÇÔ∏è Comparison</button>
    <button class="tab-btn px-4 py-1 rounded" data-tab="insight-analytics">üß© Insight Analytics</button>
    <button class="tab-btn px-4 py-1 rounded" data-tab="best">Best Predictions</button>
    <button class="tab-btn px-4 py-1 rounded" data-tab="favourites">Favourites</button>
    <button class="tab-btn px-4 py-1 rounded" data-tab="yesterday">Yesterday</button>
    <button class="tab-btn px-4 py-1 rounded" data-tab="analytics"><i class="fa-solid fa-chart-simple mr-2"></i>Analytics</button>
  </div>

  <main id="content" class="p-4">
    <div id="dashboardTab" class="hidden"> 
        <div id="dashboardCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-6"></div>
        <div class="bg-white p-4 rounded-lg shadow"><h3 class="font-semibold mb-2">Prediction Type Distribution</h3><div class="chart-container-4x3"><canvas id="predictionPieChart"></canvas></div></div>
    </div>
    <div id="analyticsTab" class="hidden"><div id="analyticsCharts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div></div>
    
    <div id="mainContent">
      <div id="summaryCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 my-4"></div>
      <div class="bg-white p-4 rounded-lg shadow mb-4">
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 items-end">
              <div class="filter-group flex flex-col"><label for="mainMatchDateFilter">Match Date:</label><select id="mainMatchDateFilter" class="border"></select></div>
              <div class="filter-group flex flex-col"><label for="mainModel1PredFilter">Model 1 Pred:</label><select id="mainModel1PredFilter" class="border"></select></div>
              <div class="filter-group flex flex-col"><label>Prob 1 (%):</label><div class="range-filter"><input type="number" id="mainMinProb1" placeholder="Min" class="border"><input type="number" id="mainMaxProb1" placeholder="Max" class="border"></div></div>
              <div class="filter-group flex flex-col"><label for="mainModel2PredFilter">Model 2 Pred:</label><select id="mainModel2PredFilter" class="border"></select></div>
              <div class="filter-group flex flex-col"><label>Prob 2 (%):</label><div class="range-filter"><input type="number" id="mainMinProb2" placeholder="Min" class="border"><input type="number" id="mainMaxProb2" placeholder="Max" class="border"></div></div>
              <div class="filter-group flex flex-col"><label for="mainModel3PredFilter">Model 3 Pred:</label><select id="mainModel3PredFilter" class="border"></select></div>
              <div class="filter-group flex flex-col"><label>Prob 3 (%):</label><div class="range-filter"><input type="number" id="mainMinProb3" placeholder="Min" class="border"><input type="number" id="mainMaxProb3" placeholder="Max" class="border"></div></div>
              <div class="flex items-center justify-end gap-2">
                <button id="moreFiltersBtn" class="bg-blue-600 text-white px-4 py-1.5 rounded text-sm hover:bg-blue-700">More Filters</button>
                <button id="mainClearFilters" class="bg-gray-200 text-gray-800 px-4 py-1.5 rounded text-sm hover:bg-gray-300">Clear</button>
              </div>
          </div>
      </div>
      <table id="matchesTable" class="min-w-full bg-white rounded shadow overflow-hidden text-sm">
        <thead class="bg-blue-200"><tr id="tableHeaders">
            <th class="p-2 text-left" data-column="star">‚òÖ</th><th class="p-2 text-left" data-column="MatchDate">Date</th><th class="p-2 text-left" data-column="Match">Match</th><th class="p-2 text-left" data-column="Model 1">Model 1 (Pred)</th><th class="p-2 text-left" data-column="Probability 1">Prob 1 (%)</th><th class="p-2 text-left" data-column="Model 2">Model 2 (Pred)</th><th class="p-2 text-left" data-column="Probability 2">Prob 2 (%)</th><th class="p-2 text-left" data-column="Predicted Odd">Predicted Odd</th><th class="p-2 text-left" data-column="Model 3">Model 3 (Pred)</th><th class="p-2 text-left" data-column="Probability 3">Prob 3 (%)</th><th class="p-2 text-left" data-column="Result">Result</th><th class="p-2 text-left">View</th>
        </tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div id="paginationControls" class="flex justify-center items-center gap-4 my-3"><button id="prevPageBtn" class="bg-gray-200 px-4 py-2 rounded disabled:opacity-50" disabled>Previous</button><span id="pageIndicator">Page 1 of 1</span><button id="nextPageBtn" class="bg-gray-200 px-4 py-2 rounded disabled:opacity-50" disabled>Next</button></div>
    </div>

    <!-- INSIGHTS TAB -->
    <div id="insightsTab" class="hidden">
        <div id="insightsSummaryCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 my-4"></div>
        <div class="bg-white p-4 rounded-lg shadow mb-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-x-4 gap-y-2 items-start">
                <div class="filter-group flex flex-col lg:col-span-1"><label for="insightsMatchDateFilter">Match Date:</label><select id="insightsMatchDateFilter" multiple class="border h-24"></select></div>
                <div class="filter-group flex flex-col lg:col-span-1"><label for="insightsLeagueFilter">League:</label><select id="insightsLeagueFilter" multiple class="border h-24"></select></div>
                <div class="filter-group flex flex-col lg:col-span-1"><label for="insightsAnalysisFilter">Match Analysis:</label><select id="insightsAnalysisFilter" multiple class="border h-24"></select></div>
                <div class="filter-group flex flex-col lg:col-span-1 space-y-2"><label>Winning Streak:</label><div class="range-filter flex gap-2"><input type="number" id="insightsMinWinStreak" placeholder="Min" class="border w-1/2 p-1.5"><input type="number" id="insightsMaxWinStreak" placeholder="Max" class="border w-1/2 p-1.5"></div></div>
                <div class="filter-group flex flex-col lg:col-span-1 space-y-2"><label>Losing Streak:</label><div class="range-filter flex gap-2"><input type="number" id="insightsMinLoseStreak" placeholder="Min" class="border w-1/2 p-1.5"><input type="number" id="insightsMaxLoseStreak" placeholder="Max" class="border w-1/2 p-1.5"></div></div>
                <div class="flex items-end justify-end h-full lg:col-span-1"><button id="insightsClearFilters" class="bg-gray-200 text-gray-800 px-4 py-1.5 rounded text-sm hover:bg-gray-300">Clear Filters</button></div>
            </div>
        </div>
        <table id="insightsTable" class="min-w-full bg-white rounded shadow overflow-hidden text-sm">
            <thead class="bg-blue-200"><tr id="insightsTableHeaders">
                <th class="p-2 text-left" data-column="star">‚òÖ</th><th class="p-2 text-left">C</th><th class="p-2 text-left" data-column="MatchDate">Match Date</th><th class="p-2 text-left" data-column="Match">Match</th><th class="p-2 text-left" data-column="Result">Result</th><th class="p-2 text-left" data-column="Model 1">Model 1</th><th class="p-2 text-left" data-column="Probability 1">Probability 1</th><th class="p-2 text-left" data-column="Model 2">Model 2</th><th class="p-2 text-left" data-column="Probability 2">Probability 2</th><th class="p-2 text-left" data-column="Model 3">Model 3</th><th class="p-2 text-left" data-column="Probability 3">Probability 3</th><th class="p-2 text-left">View</th>
            </tr></thead><tbody id="insightsTableBody"></tbody>
        </table>
        <div id="insightsPaginationControls" class="flex justify-center items-center gap-4 my-3"><button id="insightsPrevPageBtn" class="bg-gray-200 px-4 py-2 rounded disabled:opacity-50" disabled>Previous</button><span id="insightsPageIndicator">Page 1 of 1</span><button id="insightsNextPageBtn" class="bg-gray-200 px-4 py-2 rounded disabled:opacity-50" disabled>Next</button></div>
    </div>

    <!-- COMPARISON TAB -->
    <div id="comparisonTab" class="hidden">
        <div id="comparisonStatsCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 my-4"></div>
        <div class="bg-white p-4 rounded-lg shadow mb-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-x-4 gap-y-2 items-start">
                <div class="filter-group flex flex-col lg:col-span-1"><label for="comparisonMatchDateFilter">Match Date:</label><select id="comparisonMatchDateFilter" multiple class="border h-24"></select></div>
                <div class="filter-group flex flex-col lg:col-span-1"><label for="comparisonLeagueFilter">League:</label><select id="comparisonLeagueFilter" multiple class="border h-24"></select></div>
                <div class="filter-group flex flex-col lg:col-span-1"><label for="comparisonAnalysisFilter">Match Analysis:</label><select id="comparisonAnalysisFilter" multiple class="border h-24"></select></div>
                <div class="filter-group flex flex-col lg:col-span-1 space-y-2"><label>Winning Streak:</label><div class="range-filter flex gap-2"><input type="number" id="comparisonMinWinStreak" placeholder="Min" class="border w-1/2 p-1.5"><input type="number" id="comparisonMaxWinStreak" placeholder="Max" class="border w-1/2 p-1.5"></div></div>
                <div class="filter-group flex flex-col lg:col-span-1 space-y-2"><label>Losing Streak:</label><div class="range-filter flex gap-2"><input type="number" id="comparisonMinLoseStreak" placeholder="Min" class="border w-1/2 p-1.5"><input type="number" id="comparisonMaxLoseStreak" placeholder="Max" class="border w-1/2 p-1.5"></div></div>
                <div class="flex items-end justify-between h-full lg:col-span-1">
                  <button id="comparisonClearFilters" class="bg-gray-200 text-gray-800 px-4 py-1.5 rounded text-sm hover:bg-gray-300">Clear</button>
                  <button id="bookmarkBtn" class="bg-yellow-500 text-white px-4 py-2 rounded text-sm hover:bg-yellow-600">üîñ Bookmark</button>
                </div>
            </div>
        </div>
        <details class="mt-4" id="comparisonTableContainer" open>
            <summary class="text-xl font-semibold mb-2 cursor-pointer hover:text-blue-600">Comparison Table</summary>
            <p class="text-sm text-gray-600 my-4">Select matches from the 'Insights' tab using the 'C' checkbox column to compare them here.</p>
            <div class="overflow-x-auto">
                <table id="comparisonTable" class="min-w-full bg-white rounded shadow overflow-hidden text-sm">
                    <thead class="bg-blue-200"><tr id="comparisonTableHeaders">
                        <th class="p-2 text-left"><input type="checkbox" id="selectAllBookmark"></th><th class="p-2 text-left" data-column="Match">Match</th><th class="p-2 text-left" data-column="MatchDate">Match Date</th><th class="p-2 text-left" data-column="Prediction Model 1">Prediction Model 1</th><th class="p-2 text-left" data-column="Confidence Model 1">Confidence Model 1</th><th class="p-2 text-left" data-column="Prediction Model 2">Prediction Model 2</th><th class="p-2 text-left" data-column="Confidence Model 2">Confidence Model 2</th><th class="p-2 text-left" data-column="Prediction Model 3">Prediction Model 3</th><th class="p-2 text-left" data-column="Confidence Model 3">Confidence Model 3</th><th class="p-2 text-left" data-column="Result">Result</th><th class="p-2 text-left">Remove</th>
                    </tr></thead>
                    <tbody id="comparisonTableBody"></tbody>
                </table>
            </div>
        </details>
        <div id="bookmarkSection" class="mt-8"></div>
        <div id="comparisonAnalyticsSection" class="mt-8 pt-8 border-t">
          <h2 class="text-2xl font-bold text-center mb-6">Comparison Analytics</h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
              <div class="bg-white p-4 rounded-lg shadow"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 1: Win % by Prediction Type</h3><div class="chart-container-4x3"><canvas id="model1WinRateChart"></canvas></div></div>
              <div class="bg-white p-4 rounded-lg shadow"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 2: Win % by Prediction Type</h3><div class="chart-container-4x3"><canvas id="model2WinRateChart"></canvas></div></div>
              <div class="bg-white p-4 rounded-lg shadow"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 3: Win % by Prediction Type</h3><div class="chart-container-4x3"><canvas id="model3WinRateChart"></canvas></div></div>
          </div>
          <div class="bg-white p-4 rounded-lg shadow"><h3 class="font-semibold text-center mb-2 text-gray-700">Wins by Probability Range (All Models)</h3><div style="height: 400px;"><canvas id="probabilityWinChart"></canvas></div></div>
        </div>
    </div>
    
    <!-- INSIGHT ANALYTICS TAB -->
    <div id="insightAnalyticsTab" class="hidden">
        <div id="insightAnalyticsSummaryCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 my-4"></div>
        <div class="bg-white p-4 rounded-lg shadow mb-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-x-4 gap-y-2 items-start">
                <div class="filter-group flex flex-col lg:col-span-1"><label for="iaMatchDateFilter">Match Date:</label><select id="iaMatchDateFilter" multiple class="border h-24"></select></div>
                <div class="filter-group flex flex-col lg:col-span-1"><label for="iaLeagueFilter">League:</label><select id="iaLeagueFilter" multiple class="border h-24"></select></div>
                <div class="filter-group flex flex-col lg:col-span-1"><label for="iaAnalysisFilter">Match Analysis:</label><select id="iaAnalysisFilter" multiple class="border h-24"></select></div>
                <div class="filter-group flex flex-col lg:col-span-1 space-y-2"><label>Winning Streak:</label><div class="range-filter flex gap-2"><input type="number" id="iaMinWinStreak" placeholder="Min" class="border w-1/2 p-1.5"><input type="number" id="iaMaxWinStreak" placeholder="Max" class="border w-1/2 p-1.5"></div></div>
                <div class="filter-group flex flex-col lg:col-span-1 space-y-2"><label>Losing Streak:</label><div class="range-filter flex gap-2"><input type="number" id="iaMinLoseStreak" placeholder="Min" class="border w-1/2 p-1.5"><input type="number" id="iaMaxLoseStreak" placeholder="Max" class="border w-1/2 p-1.5"></div></div>
                <div class="flex items-end justify-end h-full lg:col-span-1"><button id="iaClearFilters" class="bg-gray-200 text-gray-800 px-4 py-1.5 rounded text-sm hover:bg-gray-300">Clear Filters</button></div>
            </div>
        </div>
        <div id="iaOverviewTableContainer" class="bg-white p-4 rounded-lg shadow mb-8"></div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-4 rounded-lg shadow"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 1: Performance by Category</h3><div class="chart-container-4x3"><canvas id="iaModel1CatChart"></canvas></div></div>
            <div class="bg-white p-4 rounded-lg shadow"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 2: Performance by Category</h3><div class="chart-container-4x3"><canvas id="iaModel2CatChart"></canvas></div></div>
            <div class="bg-white p-4 rounded-lg shadow"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 3: Performance by Category</h3><div class="chart-container-4x3"><canvas id="iaModel3CatChart"></canvas></div></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-white p-4 rounded-lg shadow"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 1: Wins by Probability</h3><div class="chart-container-4x3"><canvas id="iaModel1ProbChart"></canvas></div></div>
            <div class="bg-white p-4 rounded-lg shadow"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 2: Wins by Probability</h3><div class="chart-container-4x3"><canvas id="iaModel2ProbChart"></canvas></div></div>
            <div class="bg-white p-4 rounded-lg shadow"><h3 class="font-semibold text-center mb-2 text-gray-700">Model 3: Wins by Probability</h3><div class="chart-container-4x3"><canvas id="iaModel3ProbChart"></canvas></div></div>
        </div>
    </div>

  </main>

  <!-- Modals -->
  <div id="moreFiltersModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-30 p-4">
    <div class="bg-white rounded-lg w-full max-w-4xl p-6 relative max-h-[90vh] overflow-y-auto">
        <button id="closeMoreFiltersModal" class="absolute top-4 right-4 text-gray-500 text-xl">&times;</button>
        <h3 class="text-lg font-bold mb-4">More Filters</h3>
        <div class="space-y-2">
            <details class="bg-gray-50 p-3 rounded" open>
                <summary class="font-semibold cursor-pointer">Home Team Stats</summary>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">
                    <div class="filter-group flex flex-col"><label>Home Wins:</label><div class="range-filter"><input type="number" id="mfHomeWinsMin" placeholder="Min" class="border"><input type="number" id="mfHomeWinsMax" placeholder="Max" class="border"></div></div>
                    <div class="filter-group flex flex-col"><label>Home Draws:</label><div class="range-filter"><input type="number" id="mfHomeDrawsMin" placeholder="Min" class="border"><input type="number" id="mfHomeDrawsMax" placeholder="Max" class="border"></div></div>
                    <div class="filter-group flex flex-col"><label>Home Losses:</label><div class="range-filter"><input type="number" id="mfHomeLossesMin" placeholder="Min" class="border"><input type="number" id="mfHomeLossesMax" placeholder="Max" class="border"></div></div>
                    <div class="filter-group flex flex-col"><label>Home Scored:</label><div class="range-filter"><input type="number" id="mfHomeScoredMin" placeholder="Min" class="border"><input type="number" id="mfHomeScoredMax" placeholder="Max" class="border"></div></div>
                    <div class="filter-group flex flex-col"><label>Home Scored (Avg):</label><div class="range-filter"><input type="number" id="mfHomeScoredAvgMin" placeholder="Min" class="border"><input type="number" id="mfHomeScoredAvgMax" placeholder="Max" class="border"></div></div>
                    <div class="filter-group flex flex-col"><label>Home Conceded:</label><div class="range-filter"><input type="number" id="mfHomeConcededMin" placeholder="Min" class="border"><input type="number" id="mfHomeConcededMax" placeholder="Max" class="border"></div></div>
                    <div class="filter-group flex flex-col"><label>Home Conceded (Avg):</label><div class="range-filter"><input type="number" id="mfHomeConcededAvgMin" placeholder="Min" class="border"><input type="number" id="mfHomeConcededAvgMax" placeholder="Max" class="border"></div></div>
                </div>
            </details>
            <details class="bg-gray-50 p-3 rounded" open>
                <summary class="font-semibold cursor-pointer">Away Team Stats</summary>
                 <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">
                    <div class="filter-group flex flex-col"><label>Away Wins:</label><div class="range-filter"><input type="number" id="mfAwayWinsMin" placeholder="Min" class="border"><input type="number" id="mfAwayWinsMax" placeholder="Max" class="border"></div></div>
                    <div class="filter-group flex flex-col"><label>Away Draws:</label><div class="range-filter"><input type="number" id="mfAwayDrawsMin" placeholder="Min" class="border"><input type="number" id="mfAwayDrawsMax" placeholder="Max" class="border"></div></div>
                    <div class="filter-group flex flex-col"><label>Away Losses:</label><div class="range-filter"><input type="number" id="mfAwayLossesMin" placeholder="Min" class="border"><input type="number" id="mfAwayLossesMax" placeholder="Max" class="border"></div></div>
                    <div class="filter-group flex flex-col"><label>Away Scored:</label><div class="range-filter"><input type="number" id="mfAwayScoredMin" placeholder="Min" class="border"><input type="number" id="mfAwayScoredMax" placeholder="Max" class="border"></div></div>
                    <div class="filter-group flex flex-col"><label>Away Scored (Avg):</label><div class="range-filter"><input type="number" id="mfAwayScoredAvgMin" placeholder="Min" class="border"><input type="number" id="mfAwayScoredAvgMax" placeholder="Max" class="border"></div></div>
                    <div class="filter-group flex flex-col"><label>Away Conceded:</label><div class="range-filter"><input type="number" id="mfAwayConcededMin" placeholder="Min" class="border"><input type="number" id="mfAwayConcededMax" placeholder="Max" class="border"></div></div>
                    <div class="filter-group flex flex-col"><label>Away Conceded (Avg):</label><div class="range-filter"><input type="number" id="mfAwayConcededAvgMin" placeholder="Min" class="border"><input type="number" id="mfAwayConcededAvgMax" placeholder="Max" class="border"></div></div>
                </div>
            </details>
            <details class="bg-gray-50 p-3 rounded" open>
                <summary class="font-semibold cursor-pointer">Streaks & Analysis</summary>
                 <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">
                    <div class="filter-group flex flex-col"><label>Winning Streak:</label><div class="range-filter"><input type="number" id="mfWinningStreakMin" placeholder="Min" class="border"><input type="number" id="mfWinningStreakMax" placeholder="Max" class="border"></div></div>
                    <div class="filter-group flex flex-col"><label>Losing Streak:</label><div class="range-filter"><input type="number" id="mfLosingStreakMin" placeholder="Min" class="border"><input type="number" id="mfLosingStreakMax" placeholder="Max" class="border"></div></div>
                    <div class="filter-group flex flex-col"><label for="mfMatchAnalysisFilter">Match Analysis:</label><select id="mfMatchAnalysisFilter" class="border"></select></div>
                    <div class="filter-group flex flex-col"><label for="mfTotalGoalsPredictionFilter">Total Goals Prediction:</label><select id="mfTotalGoalsPredictionFilter" class="border"></select></div>
                </div>
            </details>
        </div>
        <div class="mt-6 flex justify-end gap-3">
            <button id="resetMoreFilters" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">Reset</button>
            <button id="applyMoreFilters" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Apply Filters</button>
        </div>
    </div>
  </div>
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-40 p-4"><div class="bg-white rounded-lg w-full max-w-3xl p-6 relative max-h-screen overflow-y-auto"><button id="closeModal" class="absolute top-4 right-4 text-gray-500 text-xl">‚úñ</button><div id="modalContent"></div></div></div>
  <div id="bookmarkNameModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-40 p-4"><div class="bg-white rounded-lg w-full max-w-sm p-6 relative"><button id="closeBookmarkModal" class="absolute top-3 right-4 text-gray-500 text-xl">‚úñ</button><h3 class="text-lg font-bold mb-4">Name Bookmark Group</h3><p class="text-sm text-gray-600 mb-3">Enter a name for this group of matches. If the name already exists, matches will be added to it.</p><input type="text" id="bookmarkGroupName" placeholder="e.g., Weekend Wins, High Confidence" class="border w-full rounded px-3 py-2"><div class="mt-4 flex justify-end gap-3"><button id="cancelBookmark" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">Cancel</button><button id="saveBookmark" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button></div></div></div>
  <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div id="loadingText" class="text-white text-xl animate-pulse">Loading data...</div></div>

  <script>
    // --- State & Config ---
    const DATA_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH-Uue5Ctuo4aU-4S81U9QvoXxslOq6YjKHnVkPjyOeJqci4p19cs2iZ8y5GgzsSh_vQHxPYb-gl-5/pub?gid=0&single=true&output=csv';
    let allMatches = [], filteredMatches = [], favourites = new Set(), currentTab = 'all';
    let insightsMatches = [], filteredInsightsMatches = [], matchesForComparison = new Set();
    let filteredInsightAnalyticsMatches = [];
    let bookmarkedMatches = {};
    let charts = {};
    let currentPage = 1, insightsCurrentPage = 1, bookmarkPages = {};
    const rowsPerPage = 30;
    let sortConfig = { column: 'MatchDate', direction: 'desc' };
    let insightsSortConfig = { column: 'MatchDate', direction: 'desc' };
    let comparisonSortConfig = { column: 'MatchDate', direction: 'desc' };
    let filterTimeout;

    // --- Data Fetching & Processing ---
    async function fetchCsv(url) {
        const cacheBustUrl = `${url}&_=${new Date().getTime()}`;
        try {
            const response = await fetch(cacheBustUrl);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const csvText = await response.text();
            return new Promise((resolve, reject) => {
                Papa.parse(csvText, {
                    header: true, skipEmptyLines: true, transformHeader: h => h.trim(),
                    complete: results => resolve(results.data),
                    error: err => reject(new Error(`Failed to parse CSV: ${err.message}`))
                });
            });
        } catch (e) { throw new Error(`Failed to fetch CSV: ${e.message}`); }
    }

    function normalizeRows(rows) {
        return rows.filter(r => r && r.Match).map(r => {
            const row = {};
            for (const k in r) row[k.trim()] = (r[k] || '').toString().trim();
            
            row.MatchDate = row['Match Date'] || 'N/A';
            row.uniqueId = encodeURIComponent(`${row.Match}-${row.MatchDate}`);
            
            const numericKeys = [
                'Probability (%)', 'Prediction Confidence (%)', 'Winning Probability', 'Probability of 3 Goals', 
                'Winning Chance', 'Outcome Probability', 'Winning Streak', 'Losing Streak', 
                'Home Wins', 'Home Draws', 'Home Losses', 'Home Scored', 'Home Scored (Avg)', 'Home Conceded', 'Home Conceded (Avg)', 
                'Away Wins', 'Away Draws', 'Away Losses', 'Away Scored', 'Away Scored (Avg)', 'Away Conceded', 'Away Conceded (Avg)', 
                'Home Odds', 'Draw Odds', 'Away Odds',
                'Odds (Prediction)', 'Stake', 'Total Goals Prediction'
            ];
            numericKeys.forEach(key => { row[key] = parseFloat(String(row[key] || '').replace(/[^0-9.\-%]/g, '')) || 0; });

            // Calculate Predicted Odd based on Predicted Outcome3
            if (row['Predicted Outcome3'] === 'Home Win') {
                row['Predicted Odd'] = row['Home Odds'];
            } else if (row['Predicted Outcome3'] === 'Away Win') {
                row['Predicted Odd'] = row['Away Odds'];
            } else if (row['Predicted Outcome3'] === 'Draw') {
                row['Predicted Odd'] = row['Draw Odds'];
            } else {
                row['Predicted Odd'] = 0; // Default if no prediction
            }

            return row;
        });
    }
    
    function showErrorOverlay(message) {
        const overlay = document.getElementById('loadingOverlay');
        const text = document.getElementById('loadingText');
        text.textContent = message;
        text.classList.remove('animate-pulse');
        overlay.classList.remove('hidden');
    }

    async function loadData() {
        document.getElementById('loadingOverlay').classList.remove('hidden');
        document.getElementById('loadingText').textContent = 'Loading data...';
        try {
            const rawData = await fetchCsv(DATA_CSV_URL);
            allMatches = normalizeRows(rawData);
            insightsMatches = allMatches; // Insights uses the same data
            filteredInsightAnalyticsMatches = allMatches;
            populateAllFilters(allMatches);
            populateDynamicFilters(allMatches);
            applyFilters();
            applyInsightsFilters();
            renderInsightAnalyticsPage(filteredInsightAnalyticsMatches);
        } catch (err) { 
            console.error('Failed to load CSV data:', err);
            showErrorOverlay(`Failed to load data. Error: ${err.message}`);
        } finally { document.getElementById('loadingOverlay').classList.add('hidden'); }
    }
    
    // --- Filter Population & Logic ---
    function populateAllFilters(data) {
        const createOptions = (arr, sort = 'desc') => {
            const opts = [...new Set(arr)].filter(Boolean).sort();
            if (sort === 'numeric-asc') opts.sort((a,b) => a - b);
            else if (sort === 'numeric-desc') opts.sort((a,b) => b - a);
            else if (sort === 'asc') opts.sort();
            else opts.reverse();
            return opts;
        }
        const matchDates = createOptions(data.map(r => r.MatchDate), 'desc'); // Changed to desc for recent dates first
        const leagues = createOptions(data.map(r => r.League), 'asc');
        const analyses = createOptions(data.map(r => r['Match Analysis']), 'asc');
        
        const predictionTypes = createOptions(data.flatMap(r => [r['Predicted Outcome'], r['Predicted Outcome3'], r['Prediction Outcome1']]));
        populateSelect('mainMatchDateFilter', matchDates);
        populateSelect('mainModel1PredFilter', predictionTypes);
        populateSelect('mainModel2PredFilter', predictionTypes);
        populateSelect('mainModel3PredFilter', predictionTypes);
        
        populateSelect('insightsMatchDateFilter', matchDates, true);
        populateSelect('insightsLeagueFilter', leagues, true);
        populateSelect('insightsAnalysisFilter', analyses, true);
        
        populateSelect('comparisonMatchDateFilter', matchDates, true);
        populateSelect('comparisonLeagueFilter', leagues, true);
        populateSelect('comparisonAnalysisFilter', analyses, true);
        
        populateSelect('iaMatchDateFilter', matchDates, true);
        populateSelect('iaLeagueFilter', leagues, true);
        populateSelect('iaAnalysisFilter', analyses, true);
    }
    
    function populateSelect(id, options, isMulti = false) {
        const select = document.getElementById(id);
        if (!select) return;
        select.innerHTML = isMulti ? '' : '<option value="">All</option>';
        options.forEach(opt => select.add(new Option(opt, opt)));
    }

    function populateDynamicFilters(data) {
        const numericColumns = {
            'Home Wins': 'mfHomeWins', 'Home Draws': 'mfHomeDraws', 'Home Losses': 'mfHomeLosses',
            'Away Wins': 'mfAwayWins', 'Away Draws': 'mfAwayDraws', 'Away Losses': 'mfAwayLosses',
            'Home Scored': 'mfHomeScored', 'Home Scored (Avg)': 'mfHomeScoredAvg',
            'Home Conceded': 'mfHomeConceded', 'Home Conceded (Avg)': 'mfHomeConcededAvg',
            'Away Scored': 'mfAwayScored', 'Away Scored (Avg)': 'mfAwayScoredAvg',
            'Away Conceded': 'mfAwayConceded', 'Away Conceded (Avg)': 'mfAwayConcededAvg',
            'Winning Streak': 'mfWinningStreak', 'Losing Streak': 'mfLosingStreak'
        };
        const dropdownColumns = { 'Match Analysis': 'mfMatchAnalysisFilter', 'Total Goals Prediction': 'mfTotalGoalsPredictionFilter' };

        for (const colName in numericColumns) {
            const values = data.map(row => row[colName]).filter(v => v !== null && v !== undefined && v !== '');
            if (values.length === 0) continue;
            const min = Math.min(...values);
            const max = Math.max(...values);
            const idPrefix = numericColumns[colName];
            const minEl = document.getElementById(`${idPrefix}Min`);
            const maxEl = document.getElementById(`${idPrefix}Max`);
            if (minEl) minEl.placeholder = `Min (${min})`;
            if (maxEl) maxEl.placeholder = `Max (${max})`;
        }

        for (const colName in dropdownColumns) {
            const uniqueVals = [...new Set(data.map(row => row[colName]))].filter(Boolean).sort();
            const selectId = dropdownColumns[colName];
            populateSelect(selectId, uniqueVals, false);
        }
    }


    function getSelectedOptions(id) { return Array.from(document.getElementById(id).selectedOptions).map(o => o.value); }

    function applyGenericFilters(data, prefix = '') {
        const getNum = id => parseFloat(document.getElementById(id)?.value.trim());

        const selectedDates = getSelectedOptions(`${prefix}MatchDateFilter`);
        const selectedLeagues = getSelectedOptions(`${prefix}LeagueFilter`);
        const selectedAnalyses = getSelectedOptions(`${prefix}AnalysisFilter`);
        const minWinStreak = getNum(`${prefix}MinWinStreak`);
        const maxWinStreak = getNum(`${prefix}MaxWinStreak`);
        const minLoseStreak = getNum(`${prefix}MinLoseStreak`);
        const maxLoseStreak = getNum(`${prefix}MaxLoseStreak`);

        return data.filter(r => {
            const winStreak = r['Winning Streak'];
            const loseStreak = r['Losing Streak'];
            
            return (selectedDates.length === 0 || selectedDates.includes(r.MatchDate)) &&
                   (selectedLeagues.length === 0 || selectedLeagues.includes(r.League)) &&
                   (selectedAnalyses.length === 0 || selectedAnalyses.includes(r['Match Analysis'])) &&
                   (isNaN(minWinStreak) || winStreak >= minWinStreak) &&
                   (isNaN(maxWinStreak) || winStreak <= maxWinStreak) &&
                   (isNaN(minLoseStreak) || loseStreak >= minLoseStreak) &&
                   (isNaN(maxLoseStreak) || loseStreak <= maxLoseStreak);
        });
    }

    function applyFilters(resetPage = true) {
        if (resetPage) currentPage = 1;
        
        const getVal = id => document.getElementById(id).value.trim();
        const getNum = id => parseFloat(getVal(id));
        const getNumMf = id => parseFloat(document.getElementById(id)?.value.trim());
        const getValMf = id => document.getElementById(id)?.value.trim();

        const mainDate = getVal("mainMatchDateFilter");
        const model1Pred = getVal("mainModel1PredFilter"), minProb1 = getNum('mainMinProb1'), maxProb1 = getNum('mainMaxProb1');
        const model2Pred = getVal("mainModel2PredFilter"), minProb2 = getNum('mainMinProb2'), maxProb2 = getNum('mainMaxProb2');
        const model3Pred = getVal("mainModel3PredFilter"), minProb3 = getNum('mainMinProb3'), maxProb3 = getNum('mainMaxProb3');
        
        const mf = {
            homeWinsMin: getNumMf('mfHomeWinsMin'), homeWinsMax: getNumMf('mfHomeWinsMax'),
            homeDrawsMin: getNumMf('mfHomeDrawsMin'), homeDrawsMax: getNumMf('mfHomeDrawsMax'),
            homeLossesMin: getNumMf('mfHomeLossesMin'), homeLossesMax: getNumMf('mfHomeLossesMax'),
            homeScoredMin: getNumMf('mfHomeScoredMin'), homeScoredMax: getNumMf('mfHomeScoredMax'),
            homeScoredAvgMin: getNumMf('mfHomeScoredAvgMin'), homeScoredAvgMax: getNumMf('mfHomeScoredAvgMax'),
            homeConcededMin: getNumMf('mfHomeConcededMin'), homeConcededMax: getNumMf('mfHomeConcededMax'),
            homeConcededAvgMin: getNumMf('mfHomeConcededAvgMin'), homeConcededAvgMax: getNumMf('mfHomeConcededAvgMax'),
            awayWinsMin: getNumMf('mfAwayWinsMin'), awayWinsMax: getNumMf('mfAwayWinsMax'),
            awayDrawsMin: getNumMf('mfAwayDrawsMin'), awayDrawsMax: getNumMf('mfAwayDrawsMax'),
            awayLossesMin: getNumMf('mfAwayLossesMin'), awayLossesMax: getNumMf('mfAwayLossesMax'),
            awayScoredMin: getNumMf('mfAwayScoredMin'), awayScoredMax: getNumMf('mfAwayScoredMax'),
            awayScoredAvgMin: getNumMf('mfAwayScoredAvgMin'), awayScoredAvgMax: getNumMf('mfAwayScoredAvgMax'),
            awayConcededMin: getNumMf('mfAwayConcededMin'), awayConcededMax: getNumMf('mfAwayConcededMax'),
            awayConcededAvgMin: getNumMf('mfAwayConcededAvgMin'), awayConcededAvgMax: getNumMf('mfAwayConcededAvgMax'),
            winningStreakMin: getNumMf('mfWinningStreakMin'), winningStreakMax: getNumMf('mfWinningStreakMax'),
            losingStreakMin: getNumMf('mfLosingStreakMin'), losingStreakMax: getNumMf('mfLosingStreakMax'),
            matchAnalysis: getValMf('mfMatchAnalysisFilter'),
            totalGoalsPrediction: getValMf('mfTotalGoalsPredictionFilter'),
        };

        let tempFiltered = allMatches.filter(r => {
            const checkRange = (val, min, max) => (isNaN(min) || val >= min) && (isNaN(max) || val <= max);

            return (!mainDate || r.MatchDate === mainDate) &&
                   (!model1Pred || r['Predicted Outcome'] === model1Pred) && checkRange(r['Probability (%)'], minProb1, maxProb1) &&
                   (!model2Pred || r['Predicted Outcome3'] === model2Pred) && checkRange(r['Prediction Confidence (%)'], minProb2, maxProb2) &&
                   (!model3Pred || r['Prediction Outcome1'] === model3Pred) && checkRange(r['Winning Probability'], minProb3, maxProb3) &&
                   checkRange(r['Home Wins'], mf.homeWinsMin, mf.homeWinsMax) &&
                   checkRange(r['Home Draws'], mf.homeDrawsMin, mf.homeDrawsMax) &&
                   checkRange(r['Home Losses'], mf.homeLossesMin, mf.homeLossesMax) &&
                   checkRange(r['Home Scored'], mf.homeScoredMin, mf.homeScoredMax) &&
                   checkRange(r['Home Scored (Avg)'], mf.homeScoredAvgMin, mf.homeScoredAvgMax) &&
                   checkRange(r['Home Conceded'], mf.homeConcededMin, mf.homeConcededMax) &&
                   checkRange(r['Home Conceded (Avg)'], mf.homeConcededAvgMin, mf.homeConcededAvgMax) &&
                   checkRange(r['Away Wins'], mf.awayWinsMin, mf.awayWinsMax) &&
                   checkRange(r['Away Draws'], mf.awayDrawsMin, mf.awayDrawsMax) &&
                   checkRange(r['Away Losses'], mf.awayLossesMin, mf.awayLossesMax) &&
                   checkRange(r['Away Scored'], mf.awayScoredMin, mf.awayScoredMax) &&
                   checkRange(r['Away Scored (Avg)'], mf.awayScoredAvgMin, mf.awayScoredAvgMax) &&
                   checkRange(r['Away Conceded'], mf.awayConcededMin, mf.awayConcededMax) &&
                   checkRange(r['Away Conceded (Avg)'], mf.awayConcededAvgMin, mf.awayConcededAvgMax) &&
                   checkRange(r['Winning Streak'], mf.winningStreakMin, mf.winningStreakMax) &&
                   checkRange(r['Losing Streak'], mf.losingStreakMin, mf.losingStreakMax) &&
                   (!mf.matchAnalysis || r['Match Analysis'] === mf.matchAnalysis) &&
                   (!mf.totalGoalsPrediction || r['Total Goals Prediction'] == mf.totalGoalsPrediction);
        });
        
        if (currentTab === 'best') {
             tempFiltered = tempFiltered.filter(r => r['Prediction Confidence (%)'] > 66);
        } else if (currentTab === 'favourites') {
            tempFiltered = tempFiltered.filter(r => favourites.has(r.uniqueId) && r['Prediction Confidence (%)'] > 55);
        } else if (currentTab === 'yesterday') { 
            const y = new Date(); y.setDate(y.getDate() - 1); 
            tempFiltered = tempFiltered.filter(r => r.MatchDate === y.toISOString().split('T')[0]); 
        }
        
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        if (q) tempFiltered = tempFiltered.filter(r => (r.Match || '').toLowerCase().includes(q));

        if (sortConfig.column) {
            tempFiltered.sort((a,b) => {
                let valA = a[sortConfig.column];
                let valB = b[sortConfig.column];
                if (sortConfig.column.startsWith('Probability')) {
                    const keyMap = {'Probability 1': 'Probability (%)', 'Probability 2': 'Prediction Confidence (%)', 'Probability 3': 'Winning Probability'};
                    valA = a[keyMap[sortConfig.column]] || 0;
                    valB = b[keyMap[sortConfig.column]] || 0;
                }
                if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        filteredMatches = tempFiltered;
        if (!['dashboard', 'analytics', 'insights', 'comparison', 'insight-analytics'].includes(currentTab)) updateSummaryCards(filteredMatches);
        
        if (currentTab === 'analytics') renderAnalytics(filteredMatches);
        else if (currentTab === 'dashboard') renderDashboard(filteredMatches);
        else if (!['insights', 'comparison', 'insight-analytics'].includes(currentTab)) renderPaginatedTable(filteredMatches);
    }

    function applyInsightsFilters(resetPage = true) {
        if (resetPage) insightsCurrentPage = 1;
        let tempFiltered = applyGenericFilters(insightsMatches, 'insights');
        
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        if (q) {
            tempFiltered = tempFiltered.filter(r => (r.Match || '').toLowerCase().includes(q));
        }

        if (insightsSortConfig.column) tempFiltered.sort((a,b) => (String(a[insightsSortConfig.column] || '') > String(b[insightsSortConfig.column] || '') ? 1 : -1) * (insightsSortConfig.direction === 'asc' ? 1 : -1));
        filteredInsightsMatches = tempFiltered;
        updateInsightsSummaryCards(filteredInsightsMatches);
        renderInsightsPaginatedTable(filteredInsightsMatches);
    }

    function applyInsightAnalyticsFilters() {
      filteredInsightAnalyticsMatches = applyGenericFilters(allMatches, 'ia');
      renderInsightAnalyticsPage(filteredInsightAnalyticsMatches);
    }
    
    // --- Rendering Functions ---
    function evaluatePrediction(predicted, result) {
      if (!predicted || !result || !result.includes('-')) return null;
      const scores = result.split(/[:-]/).map(s => parseInt(s.trim(), 10));
      if (scores.some(isNaN) || scores.length !== 2) return null;
      const [home, away] = scores;
      const outcome = home > away ? "Home Win" : home < away ? "Away Win" : "Draw";
      if (predicted === "Draw") return outcome === "Draw";
      if (predicted === "Home Win") return outcome === "Home Win";
      if (predicted === "Away Win") return outcome === "Away Win";
      return false;
    }

    const getPredictionBgClass = (isCorrect) => {
        if (isCorrect === null) return '';
        return isCorrect ? 'bg-green-200' : 'bg-red-200';
    };

    const totalGoalsFromResult = (res) => res ? (res.split(/[:-]/).map(Number).reduce((s,c)=>s+c,0) || null) : null;
    const detectOutcome = (res) => {
      if (!res || !res.includes('-')) return null;
      const scores = res.split(/[:-]/).map(Number);
      if (scores.length !== 2) return null;
      if (scores[0] > scores[1]) return 'Home';
      if (scores[0] < scores[1]) return 'Away';
      return 'Draw';
    };

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = data.length ? '' : `<tr><td colspan="12" class="text-center p-4">No matches found.</td></tr>`;
        data.forEach(row => {
            const id = row.uniqueId;
            const isCorrect1 = evaluatePrediction(row['Predicted Outcome'], row.Result);
            const isCorrect2 = evaluatePrediction(row['Predicted Outcome3'], row.Result);
            const isCorrect3 = evaluatePrediction(row['Prediction Outcome1'], row.Result);
            
            const tr = document.createElement('tr');
            tr.className = 'border-b hover:bg-gray-50';

            let starClass;
            const m1 = row['Predicted Outcome'];
            const m2 = row['Predicted Outcome3'];
            const m3 = row['Prediction Outcome1'];
            const allModelsMatch = m1 && m1 === m2 && m2 === m3;

            if (allModelsMatch) {
                if (!favourites.has(id)) {
                    favourites.add(id);
                    localStorage.setItem('favourites', JSON.stringify([...favourites]));
                }
                starClass = evaluatePrediction(m1, row.Result) === true ? 'star-green' : 'star-blue';
            } else {
                starClass = favourites.has(id) ? 'star-fav' : 'star-normal';
            }

            tr.innerHTML = `
              <td class='p-2 text-center'><button class='fav-btn ${starClass}' data-id='${id}'>‚òÖ</button></td>
              <td class='p-2'>${row.MatchDate}</td><td class='p-2 font-medium'>${row.Match}</td>
              <td class='p-2 ${getPredictionBgClass(isCorrect1)}'>${row['Predicted Outcome'] || 'N/A'}</td>
              <td class='p-2'>${row['Probability (%)']}%</td>
              <td class='p-2 ${getPredictionBgClass(isCorrect2)}'>${row['Predicted Outcome3'] || 'N/A'}</td>
              <td class='p-2'>${row['Prediction Confidence (%)']}%</td>
              <td class='p-2 font-semibold'>${row['Predicted Odd'] > 0 ? row['Predicted Odd'].toFixed(2) : 'N/A'}</td>
              <td class='p-2 ${getPredictionBgClass(isCorrect3)}'>${row['Prediction Outcome1'] || 'N/A'}</td>
              <td class='p-2'>${row['Winning Probability']}%</td>
              <td class='p-2'>${row.Result || '‚Äî'}</td>
              <td class='p-2'><button class='view-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-xs' data-match='${encodeURIComponent(JSON.stringify(row))}'>View</button></td>`;
            tbody.appendChild(tr);
        });
    }

    function renderInsightsTable(data) {
        const tbody = document.getElementById('insightsTableBody');
        const q = document.getElementById('searchInput').value.trim();
        const emptyMessage = q ? 'No matches found for your search.' : 'No matches found.';
        tbody.innerHTML = data.length ? '' : `<tr><td colspan="12" class="text-center p-4">${emptyMessage}</td></tr>`;
        
        data.forEach(row => {
            const id = row.uniqueId;
            const tr = document.createElement('tr');
            tr.className = 'border-b hover:bg-gray-50';
            
            const m1 = row['Predicted Outcome'];
            const m2 = row['Predicted Outcome3'];
            const m3 = row['Prediction Outcome1'];
            const allModelsMatch = m1 && m1 === m2 && m2 === m3;

            let starClass;
            if (allModelsMatch) {
                if (!favourites.has(id)) {
                    favourites.add(id);
                    localStorage.setItem('favourites', JSON.stringify([...favourites]));
                }
                starClass = evaluatePrediction(m1, row.Result) === true ? 'star-green' : 'star-blue';
            } else {
                starClass = favourites.has(id) ? 'star-fav' : 'star-normal';
            }

            const isCorrect1 = evaluatePrediction(m1, row.Result);
            const isCorrect2 = evaluatePrediction(m2, row.Result);
            const isCorrect3 = evaluatePrediction(m3, row.Result);

            tr.innerHTML = `
                <td class='p-2 text-center'><button class='fav-btn ${starClass}' data-id='${id}'>‚òÖ</button></td>
                <td class='p-2 text-center'><input type="checkbox" class="compare-checkbox" data-id='${id}' ${matchesForComparison.has(id) ? 'checked' : ''}></td>
                <td class='p-2'>${row.MatchDate}</td>
                <td class='p-2 font-medium'>${row.Match}</td>
                <td class='p-2'>${row.Result || '‚Äî'}</td>
                <td class='p-2 ${getPredictionBgClass(isCorrect1)}'>${m1 || 'N/A'}</td>
                <td class='p-2'>${row['Probability (%)']}%</td>
                <td class='p-2 ${getPredictionBgClass(isCorrect2)}'>${m2 || 'N/A'}</td>
                <td class='p-2'>${row['Prediction Confidence (%)']}%</td>
                <td class='p-2 ${getPredictionBgClass(isCorrect3)}'>${m3 || 'N/A'}</td>
                <td class='p-2'>${row['Winning Probability']}%</td>
                <td class='p-2'><button class='view-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-xs' data-match='${encodeURIComponent(JSON.stringify(row))}'>View</button></td>`;
            tbody.appendChild(tr);
        });
    }
    
    function renderPaginatedTable(data) {
        const start = (currentPage - 1) * rowsPerPage;
        renderTable(data.slice(start, start + rowsPerPage));
        const totalPages = Math.ceil(data.length / rowsPerPage) || 1;
        document.getElementById('pageIndicator').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prevPageBtn').disabled = currentPage === 1;
        document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
    }

     function renderInsightsPaginatedTable(data) {
        const start = (insightsCurrentPage - 1) * rowsPerPage;
        renderInsightsTable(data.slice(start, start + rowsPerPage));
        const totalPages = Math.ceil(data.length / rowsPerPage) || 1;
        document.getElementById('insightsPageIndicator').textContent = `Page ${insightsCurrentPage} of ${totalPages}`;
        document.getElementById('insightsPrevPageBtn').disabled = insightsCurrentPage === 1;
        document.getElementById('insightsNextPageBtn').disabled = insightsCurrentPage >= totalPages;
    }
    
    function updateSummaryCards(data) {
        const container = document.getElementById('summaryCards');
        if (!data || !container) return;
        const total = data.length;
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        const won1 = completed.filter(r => evaluatePrediction(r['Predicted Outcome'], r.Result)).length;
        const won2 = completed.filter(r => evaluatePrediction(r['Predicted Outcome3'], r.Result)).length;
        const won3 = completed.filter(r => evaluatePrediction(r['Prediction Outcome1'], r.Result)).length;
        
        container.innerHTML = `<div class="summary-card bg-blue-100"><h3>Total Matches</h3><p class="text-blue-800">${total}</p></div><div class="summary-card bg-green-100"><h3>Model 1 Wins</h3><p class="text-green-800">${won1}</p></div><div class="summary-card bg-green-100"><h3>Model 2 Wins</h3><p class="text-green-800">${won2}</p></div><div class="summary-card bg-green-100"><h3>Model 3 Wins</h3><p class="text-green-800">${won3}</p></div>`;
    }

    function updateInsightsSummaryCards(data) {
        const container = document.getElementById('insightsSummaryCards');
        if (!data || !container) return;
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        if (completed.length === 0) { container.innerHTML = `<div class="summary-card bg-gray-100"><h3>Model 1 Wins</h3><p>0 (0%)</p></div><div class="summary-card bg-gray-100"><h3>Model 2 Wins</h3><p>0 (0%)</p></div><div class="summary-card bg-gray-100"><h3>Model 3 Wins</h3><p>0 (0%)</p></div>`; return; }
        const model1Wins = completed.filter(r => evaluatePrediction(r['Predicted Outcome'], r.Result)).length;
        const model2Wins = completed.filter(r => evaluatePrediction(r['Predicted Outcome3'], r.Result)).length;
        const model3Wins = completed.filter(r => evaluatePrediction(r['Prediction Outcome1'], r.Result)).length;
        container.innerHTML = `<div class="summary-card bg-green-100"><h3>Model 1 Wins</h3><p class="text-green-800">${model1Wins} (${((model1Wins / completed.length) * 100).toFixed(0)}%)</p></div><div class="summary-card bg-green-100"><h3>Model 2 Wins</h3><p class="text-green-800">${model2Wins} (${((model2Wins / completed.length) * 100).toFixed(0)}%)</p></div><div class="summary-card bg-green-100"><h3>Model 3 Wins</h3><p class="text-green-800">${model3Wins} (${((model3Wins / completed.length) * 100).toFixed(0)}%)</p></div>`;
    }
    
    function renderAnalytics(data) {
        const container = document.getElementById('analyticsCharts');
        container.innerHTML = '';
        if (!data.length) { container.innerHTML = '<p class="col-span-full text-center py-8 text-gray-500">No data available for analytics.</p>'; return; }
        const chartFields = ['Goals Analysis', 'Winning Probability', 'Probability of 3 Goals', 'Winning Chance', 'Over 3 Goals', 'Match Prediction', 'Outcome Probability', 'Total Goals Prediction'];
        chartFields.forEach(field => {
            const canvasContainer = document.createElement('div');
            canvasContainer.className = 'bg-white p-4 rounded-lg shadow';
            const chartId = `chart-${field.replace(/[^a-zA-Z0-9]/g, '')}`;
            canvasContainer.innerHTML = `<h3 class="font-semibold text-center mb-2 text-gray-700">${field}</h3><div class="chart-container-4x3"><canvas id="${chartId}"></canvas></div>`;
            container.appendChild(canvasContainer);
            const counts = data.reduce((acc, r) => { const val = r[field] || 'N/A'; acc[val] = (acc[val] || 0) + 1; return acc; }, {});
            createChart(chartId, 'bar', field, Object.keys(counts), Object.values(counts));
        });
    }

    function renderDashboard(data) {
        const container = document.getElementById('dashboardCards');
        if (!data.length) { container.innerHTML = '<p class="col-span-full text-center py-8 text-gray-500">No data for dashboard view.</p>'; return; }
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        const won = completed.filter(r => { const o = detectOutcome(r.Result), p=(r['Match Prediction'] || r.Prediction ||'').toLowerCase(); return o && ( (o==='Home'&&p.includes('home')) || (o==='Away'&&p.includes('away')) || (o==='Draw'&&p.includes('draw')) ); }).length;
        container.innerHTML = `<div class="summary-card bg-gray-100"><h3>Total Matches</h3><p>${data.length}</p></div><div class="summary-card bg-green-100"><h3>Total Wins ‚úÖ</h3><p>${won}</p></div><div class="summary-card bg-red-100"><h3>Total Losses ‚ùå</h3><p>${completed.length - won}</p></div><div class="summary-card bg-blue-100"><h3>Avg. Win Prob.</h3><p>${(data.reduce((s, r) => s + r['Winning Probability'], 0) / data.length).toFixed(1)}%</p></div><div class="summary-card bg-indigo-100"><h3>Matches w/ 3+ Goals</h3><p>${data.filter(r => totalGoalsFromResult(r.Result) >= 3).length}</p></div>`;
        const predCounts = data.reduce((acc, r) => { const val = r['Match Prediction'] || r.Prediction || 'N/A'; acc[val] = (acc[val] || 0) + 1; return acc; }, {});
        createChart('predictionPieChart', 'pie', 'Predictions', Object.keys(predCounts), Object.values(predCounts));
    }
    
    function createChart(id, type, label, labels, data, chartOptions = {}) {
        const ctx = document.getElementById(id)?.getContext('2d');
        if (!ctx) return;
        if (charts[id]) charts[id].destroy();
        const datasets = chartOptions.datasets || [{ label, data, backgroundColor: chartOptions.backgroundColor || ['#3b82f6', '#ef4444', '#22c55e', '#f59e0b', '#8b5cf6', '#6b7280'] }];
        charts[id] = new Chart(ctx, { type, data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: !!chartOptions.datasets } }, scales: type === 'bar' ? { y: { beginAtZero: true, suggestedMax: chartOptions.yMax } } : {} } });
    }

    function showMatchModal(data) {
        const modalContent = document.getElementById('modalContent');
        const getStat = (key, def = 'N/A') => data[key] || def;

        const isCorrect1 = evaluatePrediction(data['Predicted Outcome'], data.Result);
        const isCorrect2 = evaluatePrediction(data['Predicted Outcome3'], data.Result);
        const isCorrect3 = evaluatePrediction(data['Prediction Outcome1'], data.Result);

        const getResultContent = (isCorrect) => {
            if (isCorrect === null) return `<span class="badge badge-gray">Pending</span>`;
            return isCorrect 
                ? `<span class="badge badge-green">Correct ‚úÖ</span>` 
                : `<span class="badge badge-red">Incorrect ‚ùå</span>`;
        };

        modalContent.innerHTML = `
            <div class="modal-header text-center border-b pb-4 mb-4">
              <h3 class="text-2xl font-bold">${getStat('Match')}</h3>
              <p class="text-sm text-gray-500">${getStat('MatchDate')}</p>
              <p class="text-lg font-bold mt-2">Result: ${getStat('Result', '‚Äî')}</p>
            </div>

            <div class="space-y-4 mb-6">
                <!-- Home & Away Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-3 rounded-lg border shadow-sm">
                        <h5 class="font-bold text-gray-700 mb-2 text-center">Home Team Stats</h5>
                        <div class="grid grid-cols-3 gap-2 text-center text-sm">
                            <div><p class="text-xs text-gray-500">Wins</p><p class="font-semibold text-base">${getStat('Home Wins')}</p></div>
                            <div><p class="text-xs text-gray-500">Draws</p><p class="font-semibold text-base">${getStat('Home Draws')}</p></div>
                            <div><p class="text-xs text-gray-500">Losses</p><p class="font-semibold text-base">${getStat('Home Losses')}</p></div>
                        </div>
                    </div>
                     <div class="bg-gray-50 p-3 rounded-lg border shadow-sm">
                        <h5 class="font-bold text-gray-700 mb-2 text-center">Away Team Stats</h5>
                        <div class="grid grid-cols-3 gap-2 text-center text-sm">
                            <div><p class="text-xs text-gray-500">Wins</p><p class="font-semibold text-base">${getStat('Away Wins')}</p></div>
                            <div><p class="text-xs text-gray-500">Draws</p><p class="font-semibold text-base">${getStat('Away Draws')}</p></div>
                            <div><p class="text-xs text-gray-500">Losses</p><p class="font-semibold text-base">${getStat('Away Losses')}</p></div>
                        </div>
                    </div>
                </div>

                <!-- Goal Stats -->
                <div class="bg-gray-50 p-3 rounded-lg border shadow-sm">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center text-sm">
                        <div><p class="text-xs text-gray-500">Home Scored (Avg)</p><p class="font-semibold">${getStat('Home Scored')} (${getStat('Home Scored (Avg)')})</p></div>
                        <div><p class="text-xs text-gray-500">Home Conceded (Avg)</p><p class="font-semibold">${getStat('Home Conceded')} (${getStat('Home Conceded (Avg)')})</p></div>
                        <div><p class="text-xs text-gray-500">Away Scored (Avg)</p><p class="font-semibold">${getStat('Away Scored')} (${getStat('Away Scored (Avg)')})</p></div>
                        <div><p class="text-xs text-gray-500">Away Conceded (Avg)</p><p class="font-semibold">${getStat('Away Conceded')} (${getStat('Away Conceded (Avg)')})</p></div>
                    </div>
                </div>

                <!-- Odds -->
                <div class="bg-gray-50 p-3 rounded-lg border shadow-sm">
                     <h5 class="font-bold text-gray-700 mb-2 text-center">Odds</h5>
                     <div class="grid grid-cols-3 gap-2 text-center text-sm">
                        <div><p class="text-xs text-gray-500">Home Odds</p><p class="font-semibold text-base">${getStat('Home Odds', 'N/A')}</p></div>
                        <div><p class="text-xs text-gray-500">Draw Odds</p><p class="font-semibold text-base">${getStat('Draw Odds', 'N/A')}</p></div>
                        <div><p class="text-xs text-gray-500">Away Odds</p><p class="font-semibold text-base">${getStat('Away Odds', 'N/A')}</p></div>
                     </div>
                </div>
            </div>

            <h4 class="text-lg font-semibold text-gray-800 mb-3 text-center">Model Predictions</h4>
            <div class="bg-gray-50 rounded-xl p-4 shadow-inner space-y-2">
                <div class="stat-item">
                    <span class="stat-label"><i class="fa-solid fa-bullseye w-5 text-blue-500"></i> Model 1</span>
                    <span class="stat-value">${getStat('Predicted Outcome')} at ${getStat('Probability (%)')}%</span>
                    ${getResultContent(isCorrect1)}
                </div>
                <div class="stat-item">
                    <span class="stat-label"><i class="fa-solid fa-bullseye w-5 text-indigo-500"></i> Model 2</span>
                    <span class="stat-value">${getStat('Predicted Outcome3')} at ${getStat('Prediction Confidence (%)')}%</span>
                    ${getResultContent(isCorrect2)}
                </div>
                <div class="stat-item">
                    <span class="stat-label"><i class="fa-solid fa-bullseye w-5 text-purple-500"></i> Model 3</span>
                    <span class="stat-value">${getStat('Prediction Outcome1')} at ${getStat('Winning Probability')}%</span>
                    ${getResultContent(isCorrect3)}
                </div>
            </div>
            <a href="${getStat('URL', '#')}" target="_blank" class="block text-center mt-6 text-blue-600 hover:underline">View Source <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
        `;
        document.getElementById('modal').classList.remove('hidden');
    }
    
    function renderComparisonPage() {
        let currentComparisonData = allMatches.filter(m => matchesForComparison.has(m.uniqueId));
        currentComparisonData = applyGenericFilters(currentComparisonData, 'comparison');
        
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        if (q) {
            currentComparisonData = currentComparisonData.filter(r => (r.Match || '').toLowerCase().includes(q));
        }

        if (comparisonSortConfig.column) currentComparisonData.sort((a,b) => (String(a[comparisonSortConfig.column] || '') > String(b[comparisonSortConfig.column] || '') ? 1 : -1) * (comparisonSortConfig.direction === 'asc' ? 1 : -1));
        updateComparisonStats(currentComparisonData);
        renderComparisonTable(currentComparisonData);
        renderBookmarkSection();
        renderComparisonAnalytics(currentComparisonData);
    }

    function updateComparisonStats(data) {
        const container = document.getElementById('comparisonStatsCards');
        if (!data) return;
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        if (completed.length === 0) { container.innerHTML = `<div class="summary-card bg-gray-100"><h3>Model 1 Win %</h3><p>N/A</p></div><div class="summary-card bg-gray-100"><h3>Model 2 Win %</h3><p>N/A</p></div><div class="summary-card bg-gray-100"><h3>Model 3 Win %</h3><p>N/A</p></div>`; return; }
        const model1Wins = completed.filter(r => evaluatePrediction(r['Predicted Outcome'], r.Result)).length;
        const model2Wins = completed.filter(r => evaluatePrediction(r['Predicted Outcome3'], r.Result)).length;
        const model3Wins = completed.filter(r => evaluatePrediction(r['Prediction Outcome1'], r.Result)).length;
        container.innerHTML = `<div class="summary-card bg-blue-100"><h3>Prediction Model 1 Win %</h3><p class="text-blue-800">${((model1Wins/completed.length)*100).toFixed(0)}%</p></div><div class="summary-card bg-indigo-100"><h3>Prediction Model 2 Win %</h3><p class="text-indigo-800">${((model2Wins/completed.length)*100).toFixed(0)}%</p></div><div class="summary-card bg-purple-100"><h3>Prediction Model 3 Win %</h3><p class="text-purple-800">${((model3Wins/completed.length)*100).toFixed(0)}%</p></div>`;
    }

    function renderComparisonTable(data) {
        const table = document.getElementById('comparisonTable');
        const tbody = document.getElementById('comparisonTableBody');
        const q = document.getElementById('searchInput').value.trim();
        let emptyMessage = 'No matches selected for comparison.';
        if (matchesForComparison.size > 0 && q && data.length === 0) {
            emptyMessage = 'No matches found for your search.';
        }
        tbody.innerHTML = data.length ? '' : `<tr><td colspan="11" class="text-center p-4">${emptyMessage}</td></tr>`;
        
        let wins1 = 0, wins2 = 0, wins3 = 0;

        data.forEach(row => {
            const isCorrect1 = evaluatePrediction(row['Predicted Outcome'], row.Result);
            const isCorrect2 = evaluatePrediction(row['Predicted Outcome3'], row.Result);
            const isCorrect3 = evaluatePrediction(row['Prediction Outcome1'], row.Result);
            
            if (isCorrect1) wins1++;
            if (isCorrect2) wins2++;
            if (isCorrect3) wins3++;

            const tr = document.createElement('tr');
            tr.className = 'border-b hover:bg-gray-50';
            tr.innerHTML = `
              <td class="p-2 text-center"><input type="checkbox" class="bookmark-checkbox" data-id="${row.uniqueId}"></td>
              <td class="p-2 font-medium">${row.Match}</td>
              <td class="p-2">${row.MatchDate}</td>
              <td class="p-2 ${getPredictionBgClass(isCorrect1)}">${row['Predicted Outcome']}</td>
              <td class="p-2">${row['Probability (%)']}%</td>
              <td class="p-2 ${getPredictionBgClass(isCorrect2)}">${row['Predicted Outcome3']}</td>
              <td class="p-2">${row['Prediction Confidence (%)']}%</td>
              <td class="p-2 ${getPredictionBgClass(isCorrect3)}">${row['Prediction Outcome1']}</td>
              <td class="p-2">${row['Winning Probability']}%</td>
              <td class="p-2">${row.Result || '‚Äî'}</td>
              <td class="p-2 text-center"><button class="remove-comparison-btn text-red-500 hover:text-red-700 text-lg" data-id="${row.uniqueId}" title="Remove from comparison">‚úñ</button></td>`;
            tbody.appendChild(tr);
        });

        const existingTfoot = table.querySelector('tfoot');
        if (existingTfoot) existingTfoot.remove();

        if (data.length > 0) {
            const tfoot = table.createTFoot();
            const footerRow = tfoot.insertRow();
            footerRow.className = 'bg-blue-100 font-bold';
            footerRow.innerHTML = `
                <td class="p-2" colspan="3">Number of Wins</td>
                <td class="p-2 text-center">${wins1}</td>
                <td class="p-2"></td>
                <td class="p-2 text-center">${wins2}</td>
                <td class="p-2"></td>
                <td class="p-2 text-center">${wins3}</td>
                <td class="p-2" colspan="3"></td>
            `;
        }
    }

    function renderBookmarkSection() { 
        const container = document.getElementById('bookmarkSection');
        container.innerHTML = '';
        const groupNames = Object.keys(bookmarkedMatches);
        if (groupNames.length === 0) { container.innerHTML = `<h2 class="text-xl font-semibold mt-8 mb-2">Bookmarked Matches</h2><p class="text-gray-500">No bookmarks yet. Select matches and click 'Bookmark'.</p>`; return; }
        groupNames.sort().forEach(groupName => {
            const groupContainer = document.createElement('div');
            groupContainer.className = 'mb-8';
            const matches = bookmarkedMatches[groupName];

            let wins1 = 0, wins2 = 0, wins3 = 0;
            matches.forEach(row => {
                if (evaluatePrediction(row['Predicted Outcome'], row.Result)) wins1++;
                if (evaluatePrediction(row['Predicted Outcome3'], row.Result)) wins2++;
                if (evaluatePrediction(row['Prediction Outcome1'], row.Result)) wins3++;
            });

            const page = bookmarkPages[groupName] || 1;
            const totalPages = Math.ceil(matches.length / rowsPerPage) || 1;
            const start = (page - 1) * rowsPerPage;
            const paginatedMatches = matches.slice(start, start + rowsPerPage);
            let tableHTML = `<div class="flex justify-between items-center mb-2"><h2 class="text-xl font-semibold">Bookmarks: ${groupName} (${matches.length})</h2></div><div class="overflow-x-auto"><table class="min-w-full bg-white rounded shadow text-sm"><thead class="bg-yellow-200"><tr><th class="p-2 text-left">Match</th><th class="p-2 text-left">Date</th><th class="p-2 text-left">Model 1</th><th class="p-2 text-left">Conf 1</th><th class="p-2 text-left">Model 2</th><th class="p-2 text-left">Conf 2</th><th class="p-2 text-left">Model 3</th><th class="p-2 text-left">Conf 3</th><th class="p-2 text-left">Result</th><th class="p-2 text-left">Remove</th></tr></thead><tbody>`;
            
            paginatedMatches.forEach(row => {
                tableHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-2 font-medium">${row.Match}</td><td class="p-2">${row.MatchDate}</td><td class="p-2 ${getPredictionBgClass(evaluatePrediction(row['Predicted Outcome'], row.Result))}">${row['Predicted Outcome']}</td><td class="p-2">${row['Probability (%)']}%</td><td class="p-2 ${getPredictionBgClass(evaluatePrediction(row['Predicted Outcome3'], row.Result))}">${row['Predicted Outcome3']}</td><td class="p-2">${row['Prediction Confidence (%)']}%</td><td class="p-2 ${getPredictionBgClass(evaluatePrediction(row['Prediction Outcome1'], row.Result))}">${row['Prediction Outcome1']}</td><td class="p-2">${row['Winning Probability']}%</td><td class="p-2">${row.Result || '‚Äî'}</td><td class="p-2 text-center"><button class="remove-bookmark-btn text-red-500 hover:text-red-700" data-id="${row.uniqueId}" data-group="${groupName}">‚úñ</button></td></tr>`;
            });

            tableHTML += `</tbody>`;

            if (matches.length > 0) {
                tableHTML += `
                    <tfoot class="bg-yellow-100 font-bold">
                        <tr>
                            <td class="p-2" colspan="2">Number of Wins</td>
                            <td class="p-2 text-center">${wins1}</td>
                            <td class="p-2"></td>
                            <td class="p-2 text-center">${wins2}</td>
                            <td class="p-2"></td>
                            <td class="p-2 text-center">${wins3}</td>
                            <td class="p-2" colspan="3"></td>
                        </tr>
                    </tfoot>
                `;
            }

            tableHTML += `</table></div>`;
            let paginationHTML = `<div class="flex justify-center items-center gap-4 my-3"><button class="bookmark-prev-btn bg-gray-200 px-3 py-1 rounded text-xs ${page === 1 ? 'opacity-50' : ''}" data-group="${groupName}" ${page === 1 ? 'disabled' : ''}>Prev</button><span>Page ${page} of ${totalPages}</span><button class="bookmark-next-btn bg-gray-200 px-3 py-1 rounded text-xs ${page >= totalPages ? 'opacity-50' : ''}" data-group="${groupName}" ${page >= totalPages ? 'disabled' : ''}>Next</button></div>`;
            groupContainer.innerHTML = tableHTML + paginationHTML;
            container.appendChild(groupContainer);
        });
    }

    function renderComparisonAnalytics(data) { 
        const calculateWinRate = (dataset, modelPredKey, predictionType) => {
            const relevant = dataset.filter(r => r[modelPredKey] === predictionType && r.Result && r.Result.includes('-'));
            if (relevant.length === 0) return 0;
            const wins = relevant.filter(r => evaluatePrediction(r[modelPredKey], r.Result)).length;
            return (wins / relevant.length) * 100;
        };
        const predictionTypes = ['Home Win', 'Away Win', 'Draw'];
        createChart('model1WinRateChart', 'bar', 'Win %', predictionTypes, predictionTypes.map(type => calculateWinRate(data, 'Predicted Outcome', type)));
        createChart('model2WinRateChart', 'bar', 'Win %', predictionTypes, predictionTypes.map(type => calculateWinRate(data, 'Predicted Outcome3', type)));
        createChart('model3WinRateChart', 'bar', 'Win %', predictionTypes, predictionTypes.map(type => calculateWinRate(data, 'Prediction Outcome1', type)));
        const calculateWinsInProbRanges = (dataset, modelPredKey, modelProbKey) => {
            const wins = dataset.filter(r => evaluatePrediction(r[modelPredKey], r.Result));
            const ranges = { '0-50%': 0, '51-70%': 0, '71-100%': 0 };
            wins.forEach(win => { const prob = win[modelProbKey]; if (prob <= 50) ranges['0-50%']++; else if (prob <= 70) ranges['51-70%']++; else ranges['71-100%']++; });
            return Object.values(ranges);
        };
        const probLabels = ['0-50%', '51-70%', '71-100%'];
        const probChartData = { datasets: [ { label: 'Model 1', data: calculateWinsInProbRanges(data, 'Predicted Outcome', 'Probability (%)'), backgroundColor: '#3b82f6' }, { label: 'Model 2', data: calculateWinsInProbRanges(data, 'Predicted Outcome3', 'Prediction Confidence (%)'), backgroundColor: '#8b5cf6' }, { label: 'Model 3', data: calculateWinsInProbRanges(data, 'Prediction Outcome1', 'Winning Probability'), backgroundColor: '#10b981' } ] };
        createChart('probabilityWinChart', 'bar', 'Wins', probLabels, [], probChartData);
    }
    
    // --- INSIGHT ANALYTICS TAB FUNCTIONS ---
    function renderInsightAnalyticsPage(data) {
        updateInsightAnalyticsSummaryCards(data);
        renderOverviewTable(data);
        renderModelCategoryGraphs(data);
        renderProbabilityWinsGraphs(data);
    }

    function getModelStats(data) {
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        const models = [
            { name: 'Model 1', predKey: 'Predicted Outcome', probKey: 'Probability (%)', wins: 0, matches: 0 },
            { name: 'Model 2', predKey: 'Predicted Outcome3', probKey: 'Prediction Confidence (%)', wins: 0, matches: 0 },
            { name: 'Model 3', predKey: 'Prediction Outcome1', probKey: 'Winning Probability', wins: 0, matches: 0 },
        ];
        models.forEach(model => {
            const modelMatches = completed.filter(r => r[model.predKey]);
            model.matches = modelMatches.length;
            model.wins = modelMatches.filter(r => evaluatePrediction(r[model.predKey], r.Result)).length;
            model.winRate = model.matches > 0 ? (model.wins / model.matches) * 100 : 0;
        });
        return { models, totalMatches: data.length, totalCompleted: completed.length };
    }

    function updateInsightAnalyticsSummaryCards(data) {
        const container = document.getElementById('insightAnalyticsSummaryCards');
        const { models, totalMatches } = getModelStats(data);
        const totalWinRate = models.reduce((acc, m) => acc + m.winRate, 0) / models.length;
        const bestModel = models.reduce((best, current) => current.winRate > best.winRate ? current : best, models[0]);
        container.innerHTML = `
            <div class="summary-card bg-blue-100"><h3>Total Matches Analyzed</h3><p class="text-blue-800">${totalMatches}</p></div>
            <div class="summary-card bg-yellow-100"><h3>Avg. Win Rate (All Models)</h3><p class="text-yellow-800">${totalWinRate.toFixed(1)}%</p></div>
            <div class="summary-card bg-green-100"><h3>Best Performing Model</h3><p class="text-green-800">${bestModel.name} (${bestModel.winRate.toFixed(1)}%)</p></div>`;
    }

    function renderOverviewTable(data) {
        const container = document.getElementById('iaOverviewTableContainer');
        const categories = ['Home Win', 'Draw', 'Away Win'];
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        let tableHTML = `<h2 class="text-xl font-semibold mb-4">Model Performance Overview</h2>
            <div class="overflow-x-auto"><table class="min-w-full text-sm">
            <thead class="bg-gray-100"><tr class="text-left">
                <th class="p-2 font-semibold">Model</th><th class="p-2 font-semibold">Category</th><th class="p-2 font-semibold">Total Wins</th><th class="p-2 font-semibold">Total Matches</th><th class="p-2 font-semibold">Win Percentage</th>
            </tr></thead><tbody>`;
        
        ['Model 1', 'Model 2', 'Model 3'].forEach(modelName => {
            categories.forEach(cat => {
                const predKey = modelName === 'Model 1' ? 'Predicted Outcome' : modelName === 'Model 2' ? 'Predicted Outcome3' : 'Prediction Outcome1';
                const catMatches = completed.filter(r => r[predKey] === cat);
                const totalCatMatches = catMatches.length;
                const totalCatWins = catMatches.filter(r => evaluatePrediction(r[predKey], r.Result)).length;
                const winPercent = totalCatMatches > 0 ? ((totalCatWins / totalCatMatches) * 100).toFixed(1) + '%' : 'N/A';
                tableHTML += `<tr class="border-b"><td class="p-2">${modelName}</td><td class="p-2">${cat}</td><td class="p-2">${totalCatWins}</td><td class="p-2">${totalCatMatches}</td><td class="p-2">${winPercent}</td></tr>`;
            });
        });
        tableHTML += `</tbody></table></div>`;
        container.innerHTML = tableHTML;
    }

    function renderModelCategoryGraphs(data) {
        const categories = ['Home Win', 'Draw', 'Away Win'];
        const completed = data.filter(r => r.Result && r.Result.includes('-'));
        const calcWinRate = (predKey, cat) => {
            const catMatches = completed.filter(r => r[predKey] === cat);
            if (catMatches.length === 0) return 0;
            const wins = catMatches.filter(r => evaluatePrediction(r[predKey], r.Result)).length;
            return (wins / catMatches.length) * 100;
        };
        const model1Data = categories.map(cat => calcWinRate('Predicted Outcome', cat));
        const model2Data = categories.map(cat => calcWinRate('Predicted Outcome3', cat));
        const model3Data = categories.map(cat => calcWinRate('Prediction Outcome1', cat));
        createChart('iaModel1CatChart', 'bar', 'Win %', categories, model1Data, { yMax: 100 });
        createChart('iaModel2CatChart', 'bar', 'Win %', categories, model2Data, { yMax: 100 });
        createChart('iaModel3CatChart', 'bar', 'Win %', categories, model3Data, { yMax: 100 });
    }

    function renderProbabilityWinsGraphs(data) {
        const probLabels = ['0-50%', '51-70%', '71-100%'];
        const calcWinsInRanges = (predKey, probKey) => {
            const wins = data.filter(r => evaluatePrediction(r[predKey], r.Result));
            const ranges = { '0-50%': 0, '51-70%': 0, '71-100%': 0 };
            wins.forEach(win => { const prob = win[probKey]; if (prob <= 50) ranges['0-50%']++; else if (prob <= 70) ranges['51-70%']++; else ranges['71-100%']++; });
            return Object.values(ranges);
        };
        const generateChartForModel = (chartId, predKey, probKey) => {
            const modelData = calcWinsInRanges(predKey, probKey);
            const maxWins = Math.max(...modelData);
            const bgColors = modelData.map(d => d === maxWins && maxWins > 0 ? '#22c55e' : '#3b82f6');
            createChart(chartId, 'bar', '# of Wins', probLabels, modelData, { backgroundColor: bgColors });
        };
        generateChartForModel('iaModel1ProbChart', 'Predicted Outcome', 'Probability (%)');
        generateChartForModel('iaModel2ProbChart', 'Predicted Outcome3', 'Prediction Confidence (%)');
        generateChartForModel('iaModel3ProbChart', 'Prediction Outcome1', 'Winning Probability');
    }

    // --- Setup Event Listeners ---
    function setupEventListeners() {
        document.getElementById('refreshBtn').addEventListener('click', loadData);
        document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', e => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const currentButton = e.currentTarget;
            currentButton.classList.add('active');
            currentTab = currentButton.dataset.tab;
            const contentIds = ['dashboardTab', 'analyticsTab', 'mainContent', 'insightsTab', 'comparisonTab', 'insightAnalyticsTab'];
            contentIds.forEach(id => document.getElementById(id).classList.add('hidden'));
            
            if (currentTab === 'dashboard') document.getElementById('dashboardTab').classList.remove('hidden');
            else if (currentTab === 'analytics') document.getElementById('analyticsTab').classList.remove('hidden');
            else if (currentTab === 'insights') document.getElementById('insightsTab').classList.remove('hidden');
            else if (currentTab === 'comparison') document.getElementById('comparisonTab').classList.remove('hidden');
            else if (currentTab === 'insight-analytics') document.getElementById('insightAnalyticsTab').classList.remove('hidden');
            else document.getElementById('mainContent').classList.remove('hidden');
            
            if (currentTab === 'insights') applyInsightsFilters();
            else if (currentTab === 'comparison') renderComparisonPage();
            else if (currentTab === 'insight-analytics') applyInsightAnalyticsFilters();
            else applyFilters();
        }));

        document.getElementById('mainClearFilters').addEventListener('click', () => {
             const form = document.querySelector('#mainContent .bg-white');
             form.querySelectorAll('select, input').forEach(el => { el.value = ''; });
             applyFilters();
        });

        ['insightsClearFilters', 'comparisonClearFilters', 'iaClearFilters'].forEach(id => {
            document.getElementById(id)?.addEventListener('click', (e) => {
                const form = e.target.closest('.bg-white');
                form.querySelectorAll('select, input').forEach(el => {
                    if (el.type === 'number') el.value = '';
                    else if (el.multiple) Array.from(el.options).forEach(o => o.selected = false);
                    else el.value = '';
                });
                if (id.startsWith('insights')) applyInsightsFilters();
                else if (id.startsWith('comparison')) renderComparisonPage();
                else if (id.startsWith('ia')) applyInsightAnalyticsFilters();
            });
        });
        
        const mainFilterHandler = () => {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(applyFilters, 300);
        };

        document.querySelectorAll('#mainContent select, #mainContent input').forEach(el => {
            el.addEventListener('input', mainFilterHandler);
            el.addEventListener('change', mainFilterHandler);
        });
        
        const filterHandler = (tab) => {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                if (tab === 'insights') applyInsightsFilters();
                else if (tab === 'comparison') renderComparisonPage();
                else if (tab === 'ia') applyInsightAnalyticsFilters();
            }, 300);
        };

        ['insights', 'comparison', 'ia'].forEach(prefix => {
            ['MatchDateFilter', 'LeagueFilter', 'AnalysisFilter'].forEach(filter => {
                document.getElementById(`${prefix}${filter}`)?.addEventListener('change', () => filterHandler(prefix));
            });
            ['MinWinStreak', 'MaxWinStreak', 'MinLoseStreak', 'MaxLoseStreak'].forEach(filter => {
                document.getElementById(`${prefix}${filter}`)?.addEventListener('input', () => filterHandler(prefix));
            });
        });
        
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                switch (currentTab) {
                    case 'insights':
                        applyInsightsFilters();
                        break;
                    case 'comparison':
                        renderComparisonPage();
                        break;
                    case 'all':
                    case 'best':
                    case 'favourites':
                    case 'yesterday':
                        applyFilters();
                        break;
                }
            }, 300);
        });
        
        document.body.addEventListener('click', e => {
            const viewBtn = e.target.closest('.view-btn');
            if (viewBtn) showMatchModal(JSON.parse(decodeURIComponent(viewBtn.dataset.match)));
            if (e.target.id === 'closeModal' || e.target.id === 'modal') document.getElementById('modal').classList.add('hidden');
            const favBtn = e.target.closest('.fav-btn');
            if (favBtn) { 
                const id = favBtn.dataset.id; 
                if(favourites.has(id)) {
                    favourites.delete(id);
                } else {
                    favourites.add(id);
                }
                localStorage.setItem('favourites', JSON.stringify([...favourites])); 
                if (currentTab === 'insights') {
                    applyInsightsFilters(false);
                } else {
                    applyFilters(false);
                }
            }
            if (e.target.matches('.compare-checkbox')) { 
                const id = e.target.dataset.id; 
                if (e.target.checked) matchesForComparison.add(id); 
                else matchesForComparison.delete(id); 
            }
            const removeBookmarkBtn = e.target.closest('.remove-bookmark-btn');
            if (removeBookmarkBtn) { 
                const {id, group} = removeBookmarkBtn.dataset; 
                bookmarkedMatches[group] = bookmarkedMatches[group].filter(m => m.uniqueId !== id); 
                if(bookmarkedMatches[group].length === 0) delete bookmarkedMatches[group]; 
                localStorage.setItem('bookmarkedMatches', JSON.stringify(bookmarkedMatches)); 
                renderComparisonPage(); 
            }
            const removeComparisonBtn = e.target.closest('.remove-comparison-btn');
            if (removeComparisonBtn) {
                const id = removeComparisonBtn.dataset.id;
                matchesForComparison.delete(id);
                renderComparisonPage();
                const insightsCheckbox = document.querySelector(`#insightsTableBody .compare-checkbox[data-id='${id}']`);
                if (insightsCheckbox) {
                    insightsCheckbox.checked = false;
                }
            }
            const prevBookmarkBtn = e.target.closest('.bookmark-prev-btn');
            if (prevBookmarkBtn) { const group = prevBookmarkBtn.dataset.group; if(bookmarkPages[group] > 1) bookmarkPages[group]--; renderBookmarkSection(); }
            const nextBookmarkBtn = e.target.closest('.bookmark-next-btn');
            if (nextBookmarkBtn) { const group = nextBookmarkBtn.dataset.group; const totalPages = Math.ceil((bookmarkedMatches[group] || []).length / rowsPerPage); if(!bookmarkPages[group]) bookmarkPages[group] = 1; if(bookmarkPages[group] < totalPages) bookmarkPages[group]++; renderBookmarkSection(); }
        });

        document.getElementById('tableHeaders').addEventListener('click', e => {
            const th = e.target.closest('th[data-column]');
            if(!th) return;
            const column = th.dataset.column;
            document.querySelectorAll('#tableHeaders th').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
            sortConfig.direction = (sortConfig.column === column && sortConfig.direction === 'asc') ? 'desc' : 'asc';
            sortConfig.column = column;
            th.classList.add(sortConfig.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
            applyFilters(false);
        });

        document.getElementById('moreFiltersBtn').addEventListener('click', () => document.getElementById('moreFiltersModal').classList.remove('hidden'));
        document.getElementById('closeMoreFiltersModal').addEventListener('click', () => document.getElementById('moreFiltersModal').classList.add('hidden'));
        document.getElementById('applyMoreFilters').addEventListener('click', () => {
            applyFilters();
            document.getElementById('moreFiltersModal').classList.add('hidden');
        });
        document.getElementById('resetMoreFilters').addEventListener('click', () => {
            const modal = document.getElementById('moreFiltersModal');
            modal.querySelectorAll('input[type="number"], select').forEach(el => el.value = '');
            applyFilters();
        });


        ['prevPageBtn', 'nextPageBtn'].forEach(id => document.getElementById(id).addEventListener('click', e => { const totalPages = Math.ceil(filteredMatches.length/rowsPerPage); if(e.target.id==='nextPageBtn' && currentPage < totalPages) currentPage++; else if(e.target.id==='prevPageBtn' && currentPage > 1) currentPage--; renderPaginatedTable(filteredMatches); }));
        ['insightsPrevPageBtn', 'insightsNextPageBtn'].forEach(id => document.getElementById(id).addEventListener('click', e => { const totalPages = Math.ceil(filteredInsightsMatches.length/rowsPerPage); if(e.target.id==='insightsNextPageBtn' && insightsCurrentPage < totalPages) insightsCurrentPage++; else if(e.target.id==='insightsPrevPageBtn' && insightsCurrentPage > 1) insightsCurrentPage--; renderInsightsPaginatedTable(filteredInsightsMatches); }));
        
        document.getElementById('bookmarkBtn').addEventListener('click', () => { if (document.querySelectorAll('.bookmark-checkbox:checked').length > 0) document.getElementById('bookmarkNameModal').classList.remove('hidden'); else alert('Please select at least one match to bookmark.'); });
        ['closeBookmarkModal', 'cancelBookmark'].forEach(id => document.getElementById(id).addEventListener('click', () => { document.getElementById('bookmarkGroupName').value = ''; document.getElementById('bookmarkNameModal').classList.add('hidden'); }));
        document.getElementById('saveBookmark').addEventListener('click', () => {
            const groupName = document.getElementById('bookmarkGroupName').value.trim();
            if (!groupName) { alert('Please enter a group name.'); return; }
            if (!bookmarkedMatches[groupName]) bookmarkedMatches[groupName] = [];
            const existingIds = new Set(bookmarkedMatches[groupName].map(m => m.uniqueId));
            const selectedIds = new Set(Array.from(document.querySelectorAll('#comparisonTableBody .bookmark-checkbox:checked')).map(cb => cb.dataset.id));
            const matchesToAdd = allMatches.filter(m => selectedIds.has(m.uniqueId) && !existingIds.has(m.uniqueId));
            
            bookmarkedMatches[groupName].push(...matchesToAdd);
            localStorage.setItem('bookmarkedMatches', JSON.stringify(bookmarkedMatches));
            
            document.querySelectorAll('#comparisonTableBody .bookmark-checkbox:checked').forEach(cb => cb.checked = false);
            document.getElementById('selectAllBookmark').checked = false;

            document.getElementById('bookmarkGroupName').value = '';
            document.getElementById('bookmarkNameModal').classList.add('hidden');
            renderComparisonPage();
        });
        document.getElementById('selectAllBookmark').addEventListener('click', e => {
            document.querySelectorAll('#comparisonTableBody .bookmark-checkbox').forEach(cb => {
                cb.checked = e.target.checked;
            });
        });
    }

    // --- Initial Load ---
    window.addEventListener('load', () => {
      favourites = new Set(JSON.parse(localStorage.getItem('favourites') || '[]'));
      bookmarkedMatches = JSON.parse(localStorage.getItem('bookmarkedMatches') || '{}');
      setupEventListeners();
      loadData();
    });
  </script>
</body>
</html>
